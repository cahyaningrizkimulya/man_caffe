<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Admin - MAN CAFE</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- SUPABASE JS -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <!-- PDF Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script>
        // CONFIGURASI SUPABASE - GANTI DENGAN MILIK ANDA
        const SUPABASE_URL = 'https://cuwtyfggfgykgjhrvdgi.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_4e-uWWuKR2r7_jNaWHh03A_2UVQbPAx';
        
        // Inisialisasi Supabase client
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
            auth: {
                autoRefreshToken: true,
                persistSession: true,
                detectSessionInUrl: false
            },
            db: {
                schema: 'public'
            }
        });
        
        console.log('‚úÖ Supabase client initialized');
    </script>
    <style>
        :root {
            --primary-color: #8B4513;
            --primary-light: #A0522D;
            --primary-dark: #5D2906;
            --secondary-color: #D2691E;
            --accent-color: #FFD700;
            --dark-color: #2C3E50;
            --light-color: #F8F9FA;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --info-color: #17a2b8;
            --border-radius: 10px;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }

        /* Header */
        .admin-header {
            background: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 1rem;
            text-decoration: none;
            color: var(--dark-color);
        }

        .logo i {
            font-size: 2rem;
            color: var(--primary-color);
        }

        .logo-text h1 {
            font-size: 1.5rem;
            margin: 0;
        }

        .logo-text span {
            font-size: 0.9rem;
            color: var(--primary-color);
        }

        .admin-controls {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .notification-bell {
            position: relative;
            cursor: pointer;
            font-size: 1.2rem;
            color: #666;
        }

        .notification-count {
            position: absolute;
            top: -8px;
            right: -8px;
            background: var(--danger-color);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .admin-user {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
        }

        .admin-user img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
        }

        /* Dashboard Layout */
        .dashboard-container {
            display: flex;
            min-height: calc(100vh - 80px);
        }

        /* Sidebar */
        .sidebar {
            width: 250px;
            background: var(--dark-color);
            color: white;
            padding: 2rem 0;
            position: sticky;
            top: 80px;
            height: calc(100vh - 80px);
            overflow-y: auto;
        }

        .sidebar-menu {
            list-style: none;
        }

        .sidebar-menu li {
            margin-bottom: 0.5rem;
        }

        .sidebar-menu a {
            display: flex;
            align-items: center;
            padding: 0.8rem 1.5rem;
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            transition: all 0.3s;
            border-left: 3px solid transparent;
        }

        .sidebar-menu a:hover,
        .sidebar-menu a.active {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border-left-color: var(--primary-color);
        }

        .sidebar-menu i {
            width: 25px;
            margin-right: 1rem;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 1.5rem;
            display: flex;
            align-items: center;
            gap: 1.5rem;
            box-shadow: var(--shadow);
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
        }

        .stat-info h3 {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 0.5rem;
        }

        .stat-number {
            font-size: 1.8rem;
            font-weight: 600;
            color: var(--dark-color);
        }

        .stat-change {
            font-size: 0.9rem;
            margin-top: 0.3rem;
        }

        .stat-change.positive {
            color: var(--success-color);
        }

        .stat-change.negative {
            color: var(--danger-color);
        }

        /* Tables */
        .table-container {
            background: white;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
        }

        .table-header {
            padding: 1.5rem;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-header h2 {
            margin: 0;
            color: var(--dark-color);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            background: #f8f9fa;
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: var(--dark-color);
            border-bottom: 2px solid #eee;
        }

        .data-table td {
            padding: 1rem;
            border-bottom: 1px solid #eee;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        /* Status Badges */
        .status-badge {
            display: inline-block;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-confirmed {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status-completed {
            background: #d4edda;
            color: #155724;
        }

        .status-cancelled {
            background: #f8d7da;
            color: #721c24;
        }

        /* Buttons */
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-success {
            background: var(--success-color);
            color: white;
        }

        .btn-danger {
            background: var(--danger-color);
            color: white;
        }

        .btn-sm {
            padding: 0.3rem 0.8rem;
            font-size: 0.8rem;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 0.5rem;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: var(--border-radius);
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-header h2 {
            margin: 0;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }

        /* Form */
        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 0.8rem;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
        }

        /* File Upload Styles */
        .file-upload-container {
            margin-bottom: 1rem;
        }

        .file-upload {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .file-upload-input {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .file-upload-label {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            border: 2px dashed #ddd;
            border-radius: 8px;
            background: #f9f9f9;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .file-upload-label:hover {
            border-color: var(--primary-color);
            background: #f0f0f0;
        }

        .file-upload-label i {
            font-size: 2rem;
            color: #666;
            margin-bottom: 0.5rem;
        }

        .file-upload-label span {
            color: #666;
            font-size: 0.9rem;
        }

        .file-upload-label small {
            color: #999;
            font-size: 0.8rem;
            margin-top: 0.5rem;
        }

        /* Image Preview */
        .image-preview-container {
            margin-top: 1rem;
            text-align: center;
        }

        .image-preview {
            max-width: 100%;
            max-height: 200px;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            border: 1px solid #ddd;
            background: #f9f9f9;
        }

        .remove-image-btn {
            margin-top: 0.5rem;
            background: #dc3545;
            color: white;
            border: none;
            padding: 0.3rem 0.8rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .remove-image-btn:hover {
            background: #c82333;
        }

        /* Menu Card Display */
        .menu-card-admin {
            background: white;
            border-radius: 8px;
            padding: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 1rem;
        }

        .menu-card-admin img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 6px;
            margin-bottom: 0.5rem;
        }

        /* Toast */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 1rem;
            z-index: 10000;
            transform: translateX(120%);
            transition: transform 0.3s;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.success {
            border-left: 4px solid var(--success-color);
        }

        .toast.error {
            border-left: 4px solid var(--danger-color);
        }

        /* Proof of Payment Styles */
        .proof-badge {
            cursor: pointer;
            color: #007bff;
            text-decoration: underline;
            font-size: 0.85rem;
        }

        .payment-proof-modal .modal-content {
            max-width: 600px;
        }

        .payment-proof-image {
            max-width: 100%;
            max-height: 400px;
            border-radius: 8px;
            margin: 1rem 0;
            border: 1px solid #ddd;
            background: #f9f9f9;
        }

        .no-payment-proof {
            text-align: center;
            padding: 2rem;
            color: #666;
        }

        .no-payment-proof i {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: #ddd;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .dashboard-container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: auto;
                position: static;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Additional Styles */
        .dashboard-section {
            display: block;
        }

        .text-center {
            text-align: center;
        }
        
        /* Loading Spinner */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="admin-header">
        <a href="#" class="logo">
            <i class="fas fa-coffee"></i>
            <div class="logo-text">
                <h1>MAN CAFE</h1>
                <span>Admin Dashboard</span>
            </div>
        </a>
        
        <div class="admin-controls">
            <div class="notification-bell" onclick="showNotifications()">
                <i class="fas fa-bell"></i>
                <span class="notification-count" id="notificationCount">0</span>
            </div>
            
            <div class="admin-user" onclick="logout()">
                <div style="width: 40px; height: 40px; background: var(--primary-color); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white;">
                    <i class="fas fa-user"></i>
                </div>
                <span>Admin</span>
            </div>
        </div>
    </header>

    <!-- Dashboard Layout -->
    <div class="dashboard-container">
        <!-- Sidebar -->
        <nav class="sidebar">
            <ul class="sidebar-menu">
                <li><a href="#" class="active" onclick="showSection('dashboard', event)">
                    <i class="fas fa-tachometer-alt"></i> Dashboard
                </a></li>
                <li><a href="#" onclick="showSection('orders', event)">
                    <i class="fas fa-shopping-cart"></i> Pesanan Baru
                    <span class="notification-count" id="sidebarOrderCount" style="margin-left: auto;">0</span>
                </a></li>
                <li><a href="#" onclick="showSection('reservations', event)">
                    <i class="fas fa-calendar-check"></i> Reservasi
                    <span class="notification-count" id="sidebarReservationCount" style="margin-left: auto;">0</span>
                </a></li>
                <li><a href="#" onclick="showSection('all-orders', event)">
                    <i class="fas fa-clipboard-list"></i> Semua Pesanan
                </a></li>
                <li><a href="#" onclick="showSection('menu', event)">
                    <i class="fas fa-utensils"></i> Kelola Menu
                </a></li>
                <li><a href="#" onclick="showSection('tables', event)">
                    <i class="fas fa-chair"></i> Kelola Meja
                </a></li>
                <li><a href="#" onclick="showSection('reports', event)">
                    <i class="fas fa-chart-bar"></i> Laporan
                </a></li>
                <li><a href="#" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </a></li>
            </ul>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Dashboard Section -->
            <section id="dashboard-section" class="dashboard-section">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #4CAF50, #2E8B57);">
                            <i class="fas fa-shopping-cart"></i>
                        </div>
                        <div class="stat-info">
                            <h3>Pesanan Hari Ini</h3>
                            <p class="stat-number" id="todayOrders">0</p>
                            <p class="stat-change positive">
                                <i class="fas fa-arrow-up"></i> 12% dari kemarin
                            </p>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #2196F3, #0D47A1);">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-info">
                            <h3>Pelanggan Baru</h3>
                            <p class="stat-number" id="newCustomers">0</p>
                            <p class="stat-change positive">
                                <i class="fas fa-arrow-up"></i> 8% dari minggu lalu
                            </p>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #FF9800, #FF5722);">
                            <i class="fas fa-money-bill-wave"></i>
                        </div>
                        <div class="stat-info">
                            <h3>Pendapatan Hari Ini</h3>
                            <p class="stat-number" id="todayRevenue">Rp 0</p>
                            <p class="stat-change positive">
                                <i class="fas fa-arrow-up"></i> 15% dari kemarin
                            </p>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #9C27B0, #6A1B9A);">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="stat-info">
                            <h3>Pesanan Menunggu</h3>
                            <p class="stat-number" id="pendingOrders">0</p>
                            <p class="stat-change negative">
                                <i class="fas fa-clock"></i> Butuh perhatian
                            </p>
                        </div>
                    </div>
                </div>

                <div class="table-container">
                    <div class="table-header">
                        <h2>Aktivitas Terbaru</h2>
                        <button class="btn btn-primary" onclick="refreshData()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Waktu</th>
                                <th>Aktivitas</th>
                                <th>Detail</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="activityTable">
                            <tr>
                                <td colspan="4" style="text-align: center; padding: 2rem;">
                                    <div class="loading"></div> Memuat aktivitas...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- New Orders Section -->
            <section id="orders-section" class="dashboard-section" style="display: none;">
                <div class="table-container">
                    <div class="table-header">
                        <h2>Pesanan Baru</h2>
                        <div class="action-buttons">
                            <button class="btn btn-primary" onclick="refreshOrders()">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                        </div>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>No. Order</th>
                                <th>Pelanggan</th>
                                <th>Total</th>
                                <th>Waktu</th>
                                <th>Status</th>
                                <th>Bukti Transfer</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="newOrdersTable">
                            <tr>
                                <td colspan="7" style="text-align: center; padding: 2rem;">
                                    <div class="loading"></div> Memuat pesanan...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Reservations Section -->
            <section id="reservations-section" class="dashboard-section" style="display: none;">
                <div class="table-container">
                    <div class="table-header">
                        <h2>Reservasi Baru</h2>
                        <button class="btn btn-primary" onclick="refreshReservations()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>No. Reservasi</th>
                                <th>Nama</th>
                                <th>Tanggal</th>
                                <th>Waktu</th>
                                <th>Jumlah</th>
                                <th>Status</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="reservationsTable">
                            <tr>
                                <td colspan="7" style="text-align: center; padding: 2rem;">
                                    <div class="loading"></div> Memuat reservasi...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- All Orders Section -->
            <section id="all-orders-section" class="dashboard-section" style="display: none;">
                <div class="table-container">
                    <div class="table-header">
                        <h2>Semua Pesanan</h2>
                        <div class="action-buttons">
                            <select class="form-control" style="width: 150px;" onchange="filterAllOrders(this.value)">
                                <option value="all">Semua Status</option>
                                <option value="pending">Menunggu</option>
                                <option value="confirmed">Dikonfirmasi</option>
                                <option value="completed">Selesai</option>
                                <option value="cancelled">Dibatalkan</option>
                            </select>
                            <button class="btn btn-primary" onclick="refreshAllOrders()">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                        </div>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>No. Order</th>
                                <th>Pelanggan</th>
                                <th>Total</th>
                                <th>Tanggal</th>
                                <th>Status</th>
                                <th>Bukti Transfer</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="allOrdersTable">
                            <tr>
                                <td colspan="7" style="text-align: center; padding: 2rem;">
                                    <div class="loading"></div> Memuat semua pesanan...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Menu Management Section -->
            <section id="menu-section" class="dashboard-section" style="display: none;">
                <div class="table-container">
                    <div class="table-header">
                        <h2>Kelola Menu</h2>
                        <button class="btn btn-primary" onclick="openAddMenuModal()">
                            <i class="fas fa-plus"></i> Tambah Menu
                        </button>
                    </div>
                    <div id="menuListContainer" style="padding: 1.5rem;">
                        <div style="text-align: center; padding: 3rem; color: #666;">
                            <div class="loading"></div>
                            <p style="margin-top: 1rem;">Memuat menu...</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Tables Management Section -->
            <section id="tables-section" class="dashboard-section" style="display: none;">
                <div class="table-container">
                    <div class="table-header">
                        <h2>Kelola Meja</h2>
                        <button class="btn btn-primary" onclick="openAddTableModal()">
                            <i class="fas fa-plus"></i> Tambah Meja
                        </button>
                    </div>
                    <div id="tablesListContainer" style="padding: 1.5rem;">
                        <div style="text-align: center; padding: 3rem; color: #666;">
                            <div class="loading"></div>
                            <p style="margin-top: 1rem;">Memuat data meja...</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Reports Section -->
            <section id="reports-section" class="dashboard-section" style="display: none;">
                <div class="table-container">
                    <div class="table-header">
                        <h2>Laporan Penjualan</h2>
                        <div class="action-buttons">
                            <select class="form-control" style="width: 150px;" id="reportPeriod" onchange="filterReports(this.value)">
                                <option value="today">Hari Ini</option>
                                <option value="week">Minggu Ini</option>
                                <option value="month">Bulan Ini</option>
                                <option value="custom">Custom</option>
                            </select>
                            <button class="btn btn-primary" onclick="generateReport()">
                                <i class="fas fa-download"></i> Export PDF
                            </button>
                        </div>
                    </div>
                    <div style="padding: 1.5rem;">
                        <div class="stats-grid" style="margin-bottom: 2rem;">
                            <div class="stat-card">
                                <div class="stat-icon" style="background: linear-gradient(135deg, #4CAF50, #2E8B57);">
                                    <i class="fas fa-chart-line"></i>
                                </div>
                                <div class="stat-info">
                                    <h3>Total Pendapatan</h3>
                                    <p class="stat-number" id="totalRevenue">Rp 0</p>
                                    <p class="stat-change positive" id="revenueChange">
                                        <i class="fas fa-arrow-up"></i> 0% dari periode lalu
                                    </p>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon" style="background: linear-gradient(135deg, #2196F3, #0D47A1);">
                                    <i class="fas fa-shopping-cart"></i>
                                </div>
                                <div class="stat-info">
                                    <h3>Total Pesanan</h3>
                                    <p class="stat-number" id="totalOrders">0</p>
                                    <p class="stat-change positive" id="ordersChange">
                                        <i class="fas fa-arrow-up"></i> 0% dari periode lalu
                                    </p>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon" style="background: linear-gradient(135deg, #FF9800, #FF5722);">
                                    <i class="fas fa-users"></i>
                                </div>
                                <div class="stat-info">
                                    <h3>Pelanggan Aktif</h3>
                                    <p class="stat-number" id="activeCustomers">0</p>
                                    <p class="stat-change positive" id="customersChange">
                                        <i class="fas fa-arrow-up"></i> 0% dari periode lalu
                                    </p>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon" style="background: linear-gradient(135deg, #9C27B0, #6A1B9A);">
                                    <i class="fas fa-coffee"></i>
                                </div>
                                <div class="stat-info">
                                    <h3>Menu Terlaris</h3>
                                    <p class="stat-number" id="bestSeller">-</p>
                                    <p class="stat-change positive" id="salesChange">
                                        <i class="fas fa-star"></i> Data penjualan
                                    </p>
                                </div>
                            </div>
                        </div>
                        
                        <div style="background: white; padding: 1.5rem; border-radius: var(--border-radius); box-shadow: var(--shadow); margin-bottom: 2rem;">
                            <h3 style="margin-bottom: 1rem;">Detail Penjualan</h3>
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Tanggal</th>
                                        <th>No. Order</th>
                                        <th>Pelanggan</th>
                                        <th>Items</th>
                                        <th>Total</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="reportsTable">
                                    <tr>
                                        <td colspan="6" style="text-align: center; padding: 2rem;">
                                            <div class="loading"></div> Memuat laporan...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <div style="background: white; padding: 1.5rem; border-radius: var(--border-radius); box-shadow: var(--shadow);">
                            <h3 style="margin-bottom: 1rem;">Statistik Menu</h3>
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Menu</th>
                                        <th>Terjual</th>
                                        <th>Pendapatan</th>
                                        <th>Stok Tersedia</th>
                                    </tr>
                                </thead>
                                <tbody id="menuStatsTable">
                                    <tr>
                                        <td colspan="4" style="text-align: center; padding: 2rem;">
                                            <div class="loading"></div> Memuat statistik menu...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Order Detail Modal -->
    <div id="orderDetailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Detail Pesanan</h2>
                <button class="close-modal" onclick="closeModal('orderDetailModal')">&times;</button>
            </div>
            <div id="orderDetailContent">
                <div style="text-align: center; padding: 2rem;">
                    <div class="loading"></div>
                    <p style="margin-top: 1rem;">Memuat detail pesanan...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Payment Proof Modal -->
    <div id="paymentProofModal" class="modal payment-proof-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Bukti Transfer</h2>
                <button class="close-modal" onclick="closeModal('paymentProofModal')">&times;</button>
            </div>
            <div id="paymentProofContent">
                <div style="text-align: center; padding: 2rem;">
                    <div class="loading"></div>
                    <p style="margin-top: 1rem;">Memuat bukti transfer...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Reservation Detail Modal -->
    <div id="reservationDetailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Detail Reservasi</h2>
                <button class="close-modal" onclick="closeModal('reservationDetailModal')">&times;</button>
            </div>
            <div id="reservationDetailContent">
                <div style="text-align: center; padding: 2rem;">
                    <div class="loading"></div>
                    <p style="margin-top: 1rem;">Memuat detail reservasi...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Menu Modal -->
    <div id="menuModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="menuModalTitle">Tambah Menu</h2>
                <button class="close-modal" onclick="closeModal('menuModal')">&times;</button>
            </div>
            <form id="menuForm">
                <input type="hidden" id="menuId">
                <div class="form-group">
                    <label for="menuName">Nama Menu *</label>
                    <input type="text" class="form-control" id="menuName" required>
                </div>
                <div class="form-group">
                    <label for="menuPrice">Harga *</label>
                    <input type="number" class="form-control" id="menuPrice" required min="1000">
                </div>
                <div class="form-group">
                    <label for="menuCategory">Kategori *</label>
                    <select class="form-control" id="menuCategory" required>
                        <option value="minuman">Minuman</option>
                        <option value="makanan">Makanan</option>
                        <option value="snack">Snack</option>
                        <option value="dessert">Dessert</option>
                    </select>
                </div>
                <!-- Field Stok -->
                <div class="form-group">
                    <label for="menuStock">Stok Tersedia</label>
                    <input type="number" class="form-control" id="menuStock" min="0" value="0">
                </div>

                <div class="form-group">
                    <div style="display: flex; gap: 1rem; margin-bottom: 0.5rem;">
                        <label style="flex: 1;">
                            <input type="checkbox" id="isDailyStock" onchange="toggleDailyStock()">
                            Stok Harian
                        </label>
                    </div>
                </div>

                <div class="form-group" id="dailyStockGroup" style="display: none;">
                    <label for="dailyStock">Stok Harian (per hari)</label>
                    <input type="number" class="form-control" id="dailyStock" min="0" value="0">
                </div>
                
                <!-- File Upload untuk Gambar -->
                <div class="form-group">
                    <label for="menuImage">Gambar Menu</label>
                    <div class="file-upload-container">
                        <div class="file-upload">
                            <input type="file" class="file-upload-input" id="menuImage" accept="image/*">
                            <label for="menuImage" class="file-upload-label">
                                <i class="fas fa-cloud-upload-alt"></i>
                                <span>Klik untuk mengunggah gambar</span>
                                <small>Format: JPG, PNG, GIF (Maks: 2MB)</small>
                            </label>
                        </div>
                        <div class="image-preview-container" id="imagePreviewContainer" style="display: none;">
                            <img src="" alt="Preview" class="image-preview" id="imagePreview">
                            <button type="button" class="remove-image-btn" onclick="removeImage()">
                                <i class="fas fa-trash"></i> Hapus Gambar
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="menuDescription">Deskripsi</label>
                    <textarea class="form-control" id="menuDescription" rows="3" placeholder="Deskripsi menu..."></textarea>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">
                    <i class="fas fa-save"></i> Simpan Menu
                </button>
            </form>
        </div>
    </div>
        <!-- Debug Panel -->
    <div class="debug-panel" id="debugPanel">
        <h4 style="margin: 0 0 10px 0; color: #333;">Debug Tools</h4>
        <button class="debug-btn" onclick="testSupabaseConnection()">
            <i class="fas fa-plug"></i> Test Connection
        </button>
        <button class="debug-btn blue" onclick="createTestOrder()">
            <i class="fas fa-plus"></i> Test Order
        </button>
        <button class="debug-btn" onclick="checkLocalStorage()">
            <i class="fas fa-database"></i> Check Data
        </button>
        <button class="debug-btn red" onclick="clearAllData()">
            <i class="fas fa-trash"></i> Clear Data
        </button>
        <button class="debug-btn blue" onclick="checkTables()">
            <i class="fas fa-table"></i> Check Tables
        </button>
            <!-- Debug Panel -->
    <div class="debug-panel" id="debugPanel">
        <h4 style="margin: 0 0 10px 0; color: #333;">Debug Tools</h4>
        <button class="debug-btn" onclick="testSupabaseConnection()">
            <i class="fas fa-plug"></i> Test Connection
        </button>
        <button class="debug-btn blue" onclick="createTestOrder()">
            <i class="fas fa-plus"></i> Test Order
        </button>
        <button class="debug-btn" onclick="checkLocalStorage()">
            <i class="fas fa-database"></i> Check Data
        </button>
        <button class="debug-btn red" onclick="clearAllData()">
            <i class="fas fa-trash"></i> Clear Data
        </button>
        <button class="debug-btn blue" onclick="checkTables()">
            <i class="fas fa-table"></i> Check Tables
        </button>
        
        <!-- TAMBAHKAN 2 TOMBOL INI -->
        <button class="debug-btn" onclick="checkAdminSystem()">
            <i class="fas fa-user-cog"></i> Check Admin
        </button>
        <button class="debug-btn blue" onclick="testAdminOrder()">
            <i class="fas fa-test"></i> Test Admin Order
        </button>
        
        <hr style="margin: 10px 0;">
        <div id="debugOutput" style="font-size: 11px; max-height: 200px; overflow-y: auto; background: #f5f5f5; padding: 8px; border-radius: 4px;"></div>
    </div>
        <hr style="margin: 10px 0;">
        <div id="debugOutput" style="font-size: 11px; max-height: 200px; overflow-y: auto; background: #f5f5f5; padding: 8px; border-radius: 4px;"></div>
    </div>

    <!-- Table Modal -->
    <div id="tableModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="tableModalTitle">Tambah Meja</h2>
                <button class="close-modal" onclick="closeModal('tableModal')">&times;</button>
            </div>
            <form id="tableForm">
                <input type="hidden" id="tableId">
                <div class="form-group">
                    <label for="tableNumber">Nomor Meja *</label>
                    <input type="text" class="form-control" id="tableNumber" required placeholder="Misal: 1, 2, A1, B2">
                </div>
                <div class="form-group">
                    <label for="tableCapacity">Kapasitas *</label>
                    <input type="number" class="form-control" id="tableCapacity" required min="1" max="20" placeholder="Jumlah kursi">
                </div>
                <div class="form-group">
                    <label for="tableLocation">Lokasi</label>
                    <select class="form-control" id="tableLocation">
                        <option value="indoor">Indoor</option>
                        <option value="outdoor">Outdoor</option>
                        <option value="smoking_area">Smoking Area</option>
                        <option value="vip">VIP Room</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="tableStatus">Status</label>
                    <select class="form-control" id="tableStatus">
                        <option value="available">Tersedia</option>
                        <option value="occupied">Terisi</option>
                        <option value="reserved">Dipesan</option>
                        <option value="maintenance">Perbaikan</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="tableDescription">Keterangan (opsional)</label>
                    <textarea class="form-control" id="tableDescription" rows="2" placeholder="Misal: meja dekat jendela, meja romantis, dll."></textarea>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">
                    <i class="fas fa-save"></i> Simpan Meja
                </button>
            </form>
        </div>
    </div>

    <script>
        // ============================
        // ADMIN SYSTEM DENGAN SUPABASE - DIPERBAIKI
        // ============================
        
        class AdminSystem {
            constructor() {
                this.orders = [];
                this.reservations = [];
                this.allOrders = [];
                this.menus = [];
                this.activities = [];
                this.isOnline = true;
                this.autoRefreshInterval = null;
                this.initialized = false;
            }

            async init() {
                console.log('üîÑ Initializing Admin System...');
                
                try {
                    // Check login
                    const isLoggedIn = localStorage.getItem('adminLoggedIn');
                    if (isLoggedIn !== 'true') {
                        if (confirm('Ingin login sebagai admin? (Demo Mode)')) {
                            localStorage.setItem('adminLoggedIn', 'true');
                            localStorage.setItem('adminUsername', 'admin');
                        } else {
                            window.location.href = 'index.html';
                            return;
                        }
                    }
                    
                    // Check Supabase connection
                    this.isOnline = await this.checkSupabaseConnection();
                    console.log(this.isOnline ? '‚úÖ Online mode' : '‚ö†Ô∏è Offline mode');
                    
                    // Load initial data
                    if (!this.isOnline) {
                        console.warn('‚ö†Ô∏è Running in offline mode');
                        this.loadLocalData();
                    } else {
                        await this.syncFromSupabase();
                    }
                    
                    // Cek dan reset stok harian
                    checkAndResetDailyStocks();
                    
                    // Initialize default tables if empty
                    this.initializeDefaultTables();
                    
                    this.updateStats();
                    this.updateNotifications();
                    
                    // Setup auto refresh
                    this.startAutoRefresh();
                    
                    this.initialized = true;
                    console.log('‚úÖ Admin System initialized successfully');
                    
                    // Load dashboard by default
                    loadDashboard();
                    
                } catch (error) {
                    console.error('‚ùå Error initializing admin system:', error);
                    showToast('Gagal menginisialisasi sistem admin', 'error');
                    
                    // Fallback to local data
                    this.loadLocalData();
                    loadDashboard();
                }
            }

            async checkSupabaseConnection() {
                try {
                    const { data, error } = await supabaseClient
                        .from('menu_items')
                        .select('count', { count: 'exact', head: true })
                        .limit(1);
                    
                    if (error) {
                        console.log('Supabase connection error:', error);
                        return false;
                    }
                    return true;
                } catch (error) {
                    console.log('Supabase connection error:', error);
                    return false;
                }
            }

            loadLocalData() {
                console.log('üì• Loading local data...');
                
                try {
                    // Load from localStorage dengan error handling
                    this.orders = JSON.parse(localStorage.getItem('pending_orders') || '[]');
                    this.reservations = JSON.parse(localStorage.getItem('pending_reservations') || '[]');
                    this.allOrders = JSON.parse(localStorage.getItem('all_orders') || '[]');
                    this.menus = JSON.parse(localStorage.getItem('admin_menus') || '[]');
                    this.activities = JSON.parse(localStorage.getItem('admin_activities') || '[]');
                    
                    // Load default data jika kosong
                    if (this.menus.length === 0) {
                        this.menus = this.getDefaultMenus();
                    }
                    
                    if (this.activities.length === 0) {
                        this.activities = this.getDefaultActivities();
                    }
                    
                    console.log(`üìä Loaded: ${this.orders.length} orders, ${this.menus.length} menus`);
                    
                } catch (error) {
                    console.error('Error loading local data:', error);
                    // Set default data
                    this.menus = this.getDefaultMenus();
                    this.activities = this.getDefaultActivities();
                    this.orders = [];
                    this.reservations = [];
                    this.allOrders = [];
                }
            }

            getDefaultMenus() {
                return [
                    {
                        id: 1,
                        name: "Espresso Premium",
                        description: "Kopi espresso dengan cita rasa kuat dan aroma harum",
                        price: 35000,
                        category: "minuman",
                        image: "",
                        stock: 50,
                        isDailyStock: false,
                        dailyStock: 0,
                        currentDailyStock: 0,
                        isPromo: false,
                        isActive: true
                    },
                    {
                        id: 2,
                        name: "Cappuccino Special",
                        description: "Espresso dengan susu steamed dan busa susu lembut",
                        price: 42000,
                        category: "minuman",
                        image: "",
                        stock: 30,
                        isDailyStock: false,
                        dailyStock: 0,
                        currentDailyStock: 0,
                        isPromo: false,
                        isActive: true
                    },
                    {
                        id: 3,
                        name: "Croissant Almond",
                        description: "Croissant renyah dengan isian almond paste",
                        price: 28000,
                        category: "makanan",
                        image: "",
                        stock: 20,
                        isDailyStock: true,
                        dailyStock: 25,
                        currentDailyStock: 25,
                        isPromo: true,
                        originalPrice: 35000,
                        isActive: true
                    }
                ];
            }

            getDefaultActivities() {
                return [
                    {
                        id: 1,
                        message: "Sistem admin diinisialisasi",
                        time: new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' }),
                        date: new Date().toLocaleDateString('id-ID')
                    },
                    {
                        id: 2,
                        message: "Dashboard dimuat",
                        time: new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' }),
                        date: new Date().toLocaleDateString('id-ID')
                    }
                ];
            }

            // ==================== SYNC FUNCTIONS ====================
            async syncFromSupabase() {
                console.log('üîÑ Syncing from Supabase...');
                try {
                    await Promise.all([
                        this.syncMenusFromSupabase(),
                        this.syncOrdersFromSupabase(),
                        this.syncReservationsFromSupabase()
                    ]);
                } catch (error) {
                    console.error('Error syncing from Supabase:', error);
                }
            }

            async syncMenusFromSupabase() {
                try {
                    console.log('üîÑ Syncing menus from Supabase...');
                    
                    const { data: menus, error } = await supabaseClient
                        .from('menu_items')
                        .select('*')
                        .eq('is_active', true)
                        .order('category')
                        .order('name');
                    
                    if (error) {
                        console.error('‚ùå Error fetching menus:', error);
                        return;
                    }
                    
                    if (menus && menus.length > 0) {
                        this.menus = menus.map(menu => this.formatMenuFromSupabase(menu));
                        localStorage.setItem('admin_menus', JSON.stringify(this.menus));
                        localStorage.setItem('cafe_menus', JSON.stringify(this.menus));
                        console.log(`‚úÖ Synced ${menus.length} menus from Supabase`);
                    }
                    
                } catch (error) {
                    console.error('‚ùå Error syncing menus:', error);
                }
            }

            async syncOrdersFromSupabase() {
                try {
                    const { data: orders, error } = await supabaseClient
                        .from('orders')
                        .select('*')
                        .order('created_at', { ascending: false });
                    
                    if (error) {
                        console.error('‚ùå Error fetching orders:', error);
                        return;
                    }
                    
                    if (orders && orders.length > 0) {
                        this.allOrders = orders.map(order => this.formatOrderFromSupabase(order));
                        this.orders = this.allOrders.filter(order => 
                            order.status === 'pending' || order.status === 'waiting_payment'
                        );
                        
                        localStorage.setItem('all_orders', JSON.stringify(this.allOrders));
                        localStorage.setItem('pending_orders', JSON.stringify(this.orders));
                        localStorage.setItem('customer_orders', JSON.stringify(this.allOrders));
                        
                        console.log(`‚úÖ Synced ${orders.length} orders from Supabase`);
                    }
                    
                } catch (error) {
                    console.error('‚ùå Error syncing orders:', error);
                }
            }

            async syncReservationsFromSupabase() {
                try {
                    const { data: reservations, error } = await supabaseClient
                        .from('reservations')
                        .select('*')
                        .order('created_at', { ascending: false });
                    
                    if (error) {
                        console.error('‚ùå Error fetching reservations:', error);
                        return;
                    }
                    
                    if (reservations && reservations.length > 0) {
                        this.reservations = reservations.map(res => this.formatReservationFromSupabase(res));
                        localStorage.setItem('pending_reservations', JSON.stringify(this.reservations));
                        localStorage.setItem('customer_reservations', JSON.stringify(this.reservations));
                        console.log(`‚úÖ Synced ${reservations.length} reservations from Supabase`);
                    }
                    
                } catch (error) {
                    console.error('‚ùå Error syncing reservations:', error);
                }
            }

            // ==================== FORMAT FUNCTIONS ====================
            formatMenuFromSupabase(menu) {
                return {
                    id: menu.id,
                    name: menu.name,
                    price: menu.price,
                    category: menu.category,
                    image: menu.image_url || '',
                    image_url: menu.image_url || '',
                    description: menu.description || '',
                    isPromo: menu.is_promo || false,
                    originalPrice: menu.original_price || null,
                    isActive: menu.is_active !== false,
                    stock: menu.stock || 0,
                    is_daily_stock: menu.is_daily_stock || false,
                    isDailyStock: menu.is_daily_stock || false,
                    daily_stock: menu.daily_stock || 0,
                    dailyStock: menu.daily_stock || 0,
                    current_daily_stock: menu.current_daily_stock || 0,
                    currentDailyStock: menu.current_daily_stock || 0
                };
            }

            formatOrderFromSupabase(order) {
                return {
                    id: order.id,
                    orderNumber: order.order_number || 'ORD-' + order.id.toString().slice(-6),
                    customer: {
                        name: order.customer_name || 'Pelanggan',
                        phone: order.customer_phone || '',
                        address: order.customer_address || ''
                    },
                    total: order.total_amount || 0,
                    status: order.status || 'pending',
                    paymentProof: order.payment_proof_url || '',
                    createdAt: order.created_at || new Date().toISOString(),
                    adminSeen: order.admin_seen || false
                };
            }

            formatReservationFromSupabase(reservation) {
                return {
                    id: reservation.id,
                    name: reservation.customer_name || '',
                    phone: reservation.customer_phone || '',
                    date: reservation.reservation_date || '',
                    time: reservation.reservation_time || '',
                    guests: reservation.number_of_guests || 1,
                    notes: reservation.notes || '',
                    confirmed: reservation.confirmed || false,
                    createdAt: reservation.created_at || new Date().toISOString(),
                    adminSeen: reservation.admin_seen || false
                };
            }

            // ==================== MENU MANAGEMENT ====================
            async addMenu(menuData) {
                try {
                    console.log('‚ûï Adding menu:', menuData);
                    
                    let supabaseId = null;
                    
                    if (this.isOnline) {
                        const menuToInsert = {
                            name: menuData.name,
                            price: menuData.price,
                            category: menuData.category,
                            description: menuData.description || '',
                            image_url: menuData.image || '',
                            is_promo: menuData.isPromo || false,
                            original_price: menuData.originalPrice || null,
                            stock: menuData.stock || 0,
                            is_daily_stock: menuData.isDailyStock || false,
                            daily_stock: menuData.dailyStock || 0,
                            current_daily_stock: menuData.currentDailyStock || 0,
                            is_active: true
                        };
                        
                        const { data, error } = await supabaseClient
                            .from('menu_items')
                            .insert([menuToInsert])
                            .select()
                            .single();
                        
                        if (error) throw error;
                        
                        supabaseId = data.id;
                        console.log('‚úÖ Menu inserted to Supabase with ID:', supabaseId);
                    }
                    
                    const menu = {
                        id: supabaseId || Date.now(),
                        ...menuData,
                        isActive: true
                    };
                    
                    this.menus.push(menu);
                    this.saveLocalData();
                    
                    // Sync ke customer
                    localStorage.setItem('cafe_menus', JSON.stringify(this.menus));
                    
                    this.addActivity(`Menu "${menuData.name}" ditambahkan`);
                    
                    showToast('Menu berhasil ditambahkan', 'success');
                    return menu;
                    
                } catch (error) {
                    console.error('‚ùå Error adding menu:', error);
                    
                    // Fallback: save locally only
                    const menu = {
                        id: Date.now(),
                        ...menuData,
                        isActive: true
                    };
                    
                    this.menus.push(menu);
                    this.saveLocalData();
                    localStorage.setItem('cafe_menus', JSON.stringify(this.menus));
                    
                    showToast('Menu disimpan secara lokal', 'info');
                    return menu;
                }
            }

            async updateMenu(menuId, menuData) {
                try {
                    if (this.isOnline) {
                        const updateData = {
                            name: menuData.name,
                            price: menuData.price,
                            category: menuData.category,
                            description: menuData.description || '',
                            image_url: menuData.image || '',
                            is_promo: menuData.isPromo || false,
                            original_price: menuData.originalPrice || null,
                            stock: menuData.stock || 0,
                            is_daily_stock: menuData.isDailyStock || false,
                            daily_stock: menuData.dailyStock || 0,
                            current_daily_stock: menuData.currentDailyStock || 0,
                            updated_at: new Date().toISOString()
                        };
                        
                        const { error } = await supabaseClient
                            .from('menu_items')
                            .update(updateData)
                            .eq('id', menuId);
                        
                        if (error) throw error;
                    }
                    
                    const menuIndex = this.menus.findIndex(m => m.id == menuId);
                    if (menuIndex !== -1) {
                        this.menus[menuIndex] = { ...this.menus[menuIndex], ...menuData };
                        this.saveLocalData();
                        
                        localStorage.setItem('cafe_menus', JSON.stringify(this.menus));
                        this.addActivity(`Menu "${menuData.name}" diperbarui`);
                        
                        showToast('Menu berhasil diperbarui', 'success');
                        return true;
                    }
                    
                    return false;
                    
                } catch (error) {
                    console.error('Error updating menu:', error);
                    showToast('Gagal memperbarui menu', 'error');
                    return false;
                }
            }

            async deleteMenu(menuId) {
                try {
                    if (this.isOnline) {
                        const { error } = await supabaseClient
                            .from('menu_items')
                            .update({
                                is_active: false,
                                updated_at: new Date().toISOString()
                            })
                            .eq('id', menuId);
                        
                        if (error) throw error;
                    }
                    
                    const menuIndex = this.menus.findIndex(m => m.id == menuId);
                    if (menuIndex !== -1) {
                        const menuName = this.menus[menuIndex].name;
                        this.menus.splice(menuIndex, 1);
                        this.saveLocalData();
                        
                        localStorage.setItem('cafe_menus', JSON.stringify(this.menus));
                        this.addActivity(`Menu "${menuName}" dihapus`);
                        
                        showToast('Menu berhasil dihapus', 'success');
                        return true;
                    }
                    
                    return false;
                    
                } catch (error) {
                    console.error('Error deleting menu:', error);
                    showToast('Gagal menghapus menu', 'error');
                    return false;
                }
            }

            // ==================== ORDER MANAGEMENT ====================
            async confirmOrder(orderId) {
                try {
                    if (this.isOnline) {
                        const { error } = await supabaseClient
                            .from('orders')
                            .update({
                                status: 'confirmed',
                                admin_seen: true,
                                updated_at: new Date().toISOString()
                            })
                            .eq('id', orderId);
                        
                        if (error) throw error;
                    }
                    
                    const orderIndex = this.allOrders.findIndex(o => o.id == orderId);
                    if (orderIndex !== -1) {
                        this.allOrders[orderIndex].status = 'confirmed';
                        this.allOrders[orderIndex].adminSeen = true;
                        
                        // Update pending orders
                        const pendingIndex = this.orders.findIndex(o => o.id == orderId);
                        if (pendingIndex !== -1) {
                            this.orders.splice(pendingIndex, 1);
                        }
                        
                        this.saveLocalData();
                        localStorage.setItem('customer_orders', JSON.stringify(this.allOrders));
                        
                        this.addActivity(`Pesanan #${this.allOrders[orderIndex].orderNumber} dikonfirmasi`);
                        this.updateNotifications();
                        
                        console.log(`‚úÖ Order ${orderId} confirmed`);
                        return true;
                    }
                    
                    return false;
                    
                } catch (error) {
                    console.error('‚ùå Error confirming order:', error);
                    return false;
                }
            }

            // ==================== UTILITY FUNCTIONS ====================
            saveLocalData() {
                localStorage.setItem('pending_orders', JSON.stringify(this.orders));
                localStorage.setItem('pending_reservations', JSON.stringify(this.reservations));
                localStorage.setItem('all_orders', JSON.stringify(this.allOrders));
                localStorage.setItem('admin_menus', JSON.stringify(this.menus));
                localStorage.setItem('admin_activities', JSON.stringify(this.activities));
            }

            addActivity(message) {
                const activity = {
                    id: Date.now(),
                    message: message,
                    time: new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' }),
                    date: new Date().toLocaleDateString('id-ID')
                };
                this.activities.unshift(activity);
                if (this.activities.length > 10) {
                    this.activities = this.activities.slice(0, 10);
                }
                localStorage.setItem('admin_activities', JSON.stringify(this.activities));
            }

            getNewOrders() {
                return this.orders.filter(order => 
                    (order.adminStatus === 'new' || !order.adminSeen) && 
                    (order.status === 'pending' || order.status === 'waiting_payment')
                );
            }

            getPendingOrders() {
                return this.allOrders.filter(order => 
                    order.status === 'pending' || order.status === 'waiting_payment'
                );
            }

            getTodayOrders() {
                const today = new Date().toISOString().split('T')[0];
                return this.allOrders.filter(order => {
                    const orderDate = new Date(order.createdAt).toISOString().split('T')[0];
                    return orderDate === today;
                });
            }

            getTodayRevenue() {
                const todayOrders = this.getTodayOrders();
                return todayOrders.reduce((sum, order) => sum + (order.total || 0), 0);
            }

            updateStats() {
                try {
                    document.getElementById('todayOrders').textContent = this.getTodayOrders().length;
                    document.getElementById('newCustomers').textContent = Math.floor(Math.random() * 10) + 1;
                    document.getElementById('todayRevenue').textContent = 'Rp ' + this.getTodayRevenue().toLocaleString();
                    document.getElementById('pendingOrders').textContent = this.getPendingOrders().length;
                } catch (error) {
                    console.error('Error updating stats:', error);
                }
            }

            updateNotifications() {
                try {
                    const newOrdersCount = this.getNewOrders().length;
                    const newReservationsCount = this.reservations.filter(r => !r.adminSeen).length;
                    const totalNotifications = newOrdersCount + newReservationsCount;
                    
                    document.getElementById('notificationCount').textContent = totalNotifications;
                    document.getElementById('sidebarOrderCount').textContent = newOrdersCount;
                    document.getElementById('sidebarReservationCount').textContent = newReservationsCount;
                } catch (error) {
                    console.error('Error updating notifications:', error);
                }
            }

            initializeDefaultTables() {
                try {
                    const existingTables = JSON.parse(localStorage.getItem('cafe_tables') || '[]');
                    if (existingTables.length === 0) {
                        const defaultTables = [
                            { id: 1, number: '1', capacity: 4, location: 'indoor', status: 'available', description: 'Meja dekat jendela', createdAt: new Date().toISOString() },
                            { id: 2, number: '2', capacity: 2, location: 'indoor', status: 'available', description: 'Meja romantis', createdAt: new Date().toISOString() },
                            { id: 3, number: '3', capacity: 6, location: 'outdoor', status: 'available', description: 'Meja keluarga', createdAt: new Date().toISOString() },
                        ];
                        localStorage.setItem('cafe_tables', JSON.stringify(defaultTables));
                    }
                } catch (error) {
                    console.error('Error initializing tables:', error);
                }
            }

            startAutoRefresh() {
                if (this.autoRefreshInterval) {
                    clearInterval(this.autoRefreshInterval);
                }
                
                this.autoRefreshInterval = setInterval(async () => {
                    if (this.isOnline) {
                        await this.syncFromSupabase();
                        if (currentSection) {
                            loadSectionData(currentSection);
                        }
                    }
                }, 30000); // Refresh setiap 30 detik
            }
        }

        // ============================
        // GLOBAL VARIABLES
        // ============================
        let adminSystem = null;
        let currentSection = 'dashboard';
        let currentImageBase64 = null;

        // ============================
        // UI FUNCTIONS - DIPERBAIKI
        // ============================
        function showSection(sectionId, event) {
            try {
                if (event) {
                    event.preventDefault();
                    event.stopPropagation();
                }
                
                // Hide all sections
                document.querySelectorAll('.dashboard-section').forEach(section => {
                    section.style.display = 'none';
                });
                
                // Show selected section
                const sectionElement = document.getElementById(sectionId + '-section');
                if (sectionElement) {
                    sectionElement.style.display = 'block';
                }
                
                // Update active menu
                document.querySelectorAll('.sidebar-menu a').forEach(link => {
                    link.classList.remove('active');
                });
                
                const clickedLink = event?.target?.closest('a');
                if (clickedLink) {
                    clickedLink.classList.add('active');
                }
                
                // Load section data
                currentSection = sectionId;
                loadSectionData(sectionId);
                
            } catch (error) {
                console.error('Error showing section:', error);
                showToast('Gagal memuat section', 'error');
            }
        }

        function loadSectionData(sectionId) {
            if (!adminSystem || !adminSystem.initialized) return;
            
            try {
                switch(sectionId) {
                    case 'dashboard':
                        loadDashboard();
                        break;
                    case 'orders':
                        loadNewOrders();
                        break;
                    case 'reservations':
                        loadReservations();
                        break;
                    case 'all-orders':
                        loadAllOrders();
                        break;
                    case 'menu':
                        loadMenuManagement();
                        break;
                    case 'tables':
                        loadTablesManagement();
                        break;
                    case 'reports':
                        loadReports();
                        break;
                }
            } catch (error) {
                console.error(`Error loading section ${sectionId}:`, error);
                showToast(`Gagal memuat ${sectionId}`, 'error');
            }
        }

        function loadDashboard() {
            if (!adminSystem) return;
            
            try {
                // Update stats
                adminSystem.updateStats();
                adminSystem.updateNotifications();
                
                // Load activities
                const activityTable = document.getElementById('activityTable');
                if (adminSystem.activities.length === 0) {
                    activityTable.innerHTML = `
                        <tr>
                            <td colspan="4" style="text-align: center; padding: 2rem; color: #666;">
                                Tidak ada aktivitas terbaru
                            </td>
                        </tr>
                    `;
                } else {
                    activityTable.innerHTML = adminSystem.activities.map(activity => `
                        <tr>
                            <td>${activity.time}</td>
                            <td>Aktivitas Sistem</td>
                            <td>${activity.message}</td>
                            <td>
                                <span class="status-badge status-completed">
                                    Selesai
                                </span>
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                console.error('Error loading dashboard:', error);
                document.getElementById('activityTable').innerHTML = `
                    <tr>
                        <td colspan="4" style="text-align: center; padding: 2rem; color: #666;">
                            Gagal memuat aktivitas
                        </td>
                    </tr>
                `;
            }
        }

        function loadNewOrders() {
            if (!adminSystem) return;
            
            try {
                const newOrders = adminSystem.orders;
                const table = document.getElementById('newOrdersTable');
                
                if (newOrders.length === 0) {
                    table.innerHTML = `
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 2rem; color: #666;">
                                Tidak ada pesanan baru
                            </td>
                        </tr>
                    `;
                } else {
                    table.innerHTML = newOrders.map(order => `
                        <tr>
                            <td>${order.orderNumber || 'ORD-' + order.id.toString().slice(-6)}</td>
                            <td>${order.customer?.name || 'Pelanggan'}</td>
                            <td>Rp ${order.total?.toLocaleString() || '0'}</td>
                            <td>${new Date(order.createdAt).toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' })}</td>
                            <td>
                                <span class="status-badge ${order.status === 'waiting_payment' ? 'status-pending' : 'status-pending'}">
                                    ${order.status === 'waiting_payment' ? 'Menunggu Pembayaran' : 'Menunggu'}
                                </span>
                            </td>
                            <td>
                                ${order.paymentProof ? 
                                    `<span class="proof-badge" onclick="viewPaymentProof('${order.id}')">
                                        <i class="fas fa-receipt"></i> Lihat Bukti
                                    </span>` : 
                                    '<span style="color: #666; font-size: 0.85rem;">Belum ada</span>'
                                }
                            </td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn btn-success btn-sm" onclick="confirmOrder('${order.id}')">
                                        <i class="fas fa-check"></i> Konfirmasi
                                    </button>
                                    <button class="btn btn-danger btn-sm" onclick="cancelOrder('${order.id}')">
                                        <i class="fas fa-times"></i> Tolak
                                    </button>
                                    <button class="btn btn-primary btn-sm" onclick="viewOrderDetail('${order.id}')">
                                        <i class="fas fa-eye"></i> Detail
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `).join('');
                }
                
                adminSystem.updateNotifications();
            } catch (error) {
                console.error('Error loading new orders:', error);
                document.getElementById('newOrdersTable').innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 2rem; color: #666;">
                            Gagal memuat pesanan
                        </td>
                    </tr>
                `;
            }
        }

        function loadReservations() {
            if (!adminSystem) return;
            
            try {
                const newReservations = adminSystem.reservations.filter(r => !r.adminSeen);
                const table = document.getElementById('reservationsTable');
                
                if (newReservations.length === 0) {
                    table.innerHTML = `
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 2rem; color: #666;">
                                Tidak ada reservasi baru
                            </td>
                        </tr>
                    `;
                } else {
                    table.innerHTML = newReservations.map(res => `
                        <tr>
                            <td>#${res.id.toString().slice(-6)}</td>
                            <td>${res.name}</td>
                            <td>${res.date ? new Date(res.date).toLocaleDateString('id-ID') : '-'}</td>
                            <td>${res.time || '-'}</td>
                            <td>${res.guests || 1} orang</td>
                            <td>
                                <span class="status-badge ${res.confirmed ? 'status-confirmed' : 'status-pending'}">
                                    ${res.confirmed ? 'Dikonfirmasi' : 'Menunggu'}
                                </span>
                            </td>
                            <td>
                                <div class="action-buttons">
                                    ${!res.confirmed ? `
                                    <button class="btn btn-success btn-sm" onclick="confirmReservation('${res.id}')">
                                        <i class="fas fa-check"></i> Konfirmasi
                                    </button>` : ''}
                                    <button class="btn btn-primary btn-sm" onclick="viewReservationDetail('${res.id}')">
                                        <i class="fas fa-eye"></i> Detail
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `).join('');
                }
                
                adminSystem.updateNotifications();
            } catch (error) {
                console.error('Error loading reservations:', error);
                document.getElementById('reservationsTable').innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 2rem; color: #666;">
                            Gagal memuat reservasi
                        </td>
                    </tr>
                `;
            }
        }

        function loadAllOrders() {
            if (!adminSystem) return;
            
            try {
                const table = document.getElementById('allOrdersTable');
                
                if (adminSystem.allOrders.length === 0) {
                    table.innerHTML = `
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 2rem; color: #666;">
                                Belum ada pesanan
                            </td>
                        </tr>
                    `;
                } else {
                    table.innerHTML = adminSystem.allOrders.map(order => `
                        <tr>
                            <td>${order.orderNumber || 'ORD-' + order.id.toString().slice(-6)}</td>
                            <td>${order.customer?.name || 'Pelanggan'}</td>
                            <td>Rp ${order.total?.toLocaleString() || '0'}</td>
                            <td>${new Date(order.createdAt).toLocaleDateString('id-ID')}</td>
                            <td>
                                <span class="status-badge status-${order.status || 'pending'}">
                                    ${getStatusText(order.status || 'pending')}
                                </span>
                            </td>
                            <td>
                                ${order.paymentProof ? 
                                    `<span class="proof-badge" onclick="viewPaymentProof('${order.id}')">
                                        <i class="fas fa-receipt"></i> Lihat Bukti
                                    </span>` : 
                                    '<span style="color: #666; font-size: 0.85rem;">Tidak ada</span>'
                                }
                            </td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn btn-primary btn-sm" onclick="viewOrderDetail('${order.id}')">
                                        <i class="fas fa-eye"></i> Detail
                                    </button>
                                    ${order.status === 'confirmed' ? `
                                    <button class="btn btn-success btn-sm" onclick="completeOrder('${order.id}')">
                                        <i class="fas fa-check-double"></i> Selesai
                                    </button>` : ''}
                                </div>
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                console.error('Error loading all orders:', error);
                document.getElementById('allOrdersTable').innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 2rem; color: #666;">
                            Gagal memuat pesanan
                        </td>
                    </tr>
                `;
            }
        }

        function loadMenuManagement() {
            if (!adminSystem || !adminSystem.menus) return;
            
            try {
                const container = document.getElementById('menuListContainer');
                
                if (adminSystem.menus.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 3rem; color: #666;">
                            <i class="fas fa-utensils" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                            <h3>Belum ada menu</h3>
                            <p>Tambahkan menu pertama Anda</p>
                            <button class="btn btn-primary" onclick="openAddMenuModal()" style="margin-top: 1rem;">
                                <i class="fas fa-plus"></i> Tambah Menu Pertama
                            </button>
                        </div>
                    `;
                } else {
                    container.innerHTML = `
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.5rem;">
                            ${adminSystem.menus.map(menu => {
                                // Hitung stok tersedia
                                let availableStock = menu.stock || 0;
                                let stockInfo = '';
                                
                                if (menu.isDailyStock) {
                                    availableStock = menu.currentDailyStock || 0;
                                    stockInfo = `<span style="font-size: 0.8rem; color: #666; margin-left: 0.5rem;">
                                        (Harian: ${menu.dailyStock || 0} | Tersedia: ${availableStock})
                                    </span>`;
                                }
                                
                                return `
                                <div class="menu-card-admin">
                                    ${menu.image || menu.image_url ? 
                                        `<img src="${menu.image || menu.image_url}" 
                                              alt="${menu.name}" 
                                              style="max-height: 150px; object-fit: cover; border-radius: 6px;"
                                              onerror="this.src='https://via.placeholder.com/300x150?text=${encodeURIComponent(menu.name)}'">` : 
                                        `<div style="height: 150px; background: #f0f0f0; border-radius: 6px; display: flex; align-items: center; justify-content: center; color: #666;">
                                            <i class="fas fa-utensils" style="font-size: 3rem;"></i>
                                        </div>`
                                    }
                                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem; margin-top: 0.5rem;">
                                        <h4 style="margin: 0; font-size: 1rem;">${menu.name}</h4>
                                        <span style="font-weight: bold; color: var(--primary-color);">Rp ${menu.price.toLocaleString()}</span>
                                    </div>
                                    <p style="color: #666; font-size: 0.9rem; margin-bottom: 0.5rem; min-height: 40px;">
                                        ${menu.description || 'Tidak ada deskripsi'}
                                    </p>
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                        <div>
                                            <span style="font-size: 0.9rem; color: ${availableStock <= 0 ? '#dc3545' : availableStock <= 5 ? '#ffc107' : '#28a745'};">
                                                <i class="fas fa-box"></i> Stok: ${availableStock}
                                                ${stockInfo}
                                            </span>
                                        </div>
                                        <span style="font-size: 0.8rem; background: #e9ecef; padding: 0.2rem 0.5rem; border-radius: 4px;">
                                            ${getCategoryText(menu.category)}
                                            ${menu.isPromo ? ' ‚Ä¢ PROMO' : ''}
                                        </span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div class="action-buttons">
                                            <button class="btn btn-primary btn-sm" onclick="editMenu('${menu.id}')">
                                                <i class="fas fa-edit"></i> Edit
                                            </button>
                                            <button class="btn btn-danger btn-sm" onclick="deleteMenu('${menu.id}')">
                                                <i class="fas fa-trash"></i> Hapus
                                            </button>
                                            <button class="btn btn-success btn-sm" onclick="addStock('${menu.id}')">
                                                <i class="fas fa-plus"></i> Stok
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                `;
                            }).join('')}
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading menu management:', error);
                const container = document.getElementById('menuListContainer');
                container.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: #666;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                        <h3>Gagal memuat menu</h3>
                        <p>${error.message}</p>
                        <button class="btn btn-primary" onclick="loadMenuManagement()" style="margin-top: 1rem;">
                            <i class="fas fa-sync-alt"></i> Coba Lagi
                        </button>
                    </div>
                `;
            }
        }

        function loadTablesManagement() {
            try {
                const container = document.getElementById('tablesListContainer');
                
                // Load tables dari localStorage
                const tables = JSON.parse(localStorage.getItem('cafe_tables') || '[]');
                
                if (tables.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 3rem; color: #666;">
                            <i class="fas fa-chair" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                            <h3>Belum ada meja</h3>
                            <p>Tambahkan meja pertama Anda</p>
                            <button class="btn btn-primary" onclick="openAddTableModal()" style="margin-top: 1rem;">
                                <i class="fas fa-plus"></i> Tambah Meja Pertama
                            </button>
                        </div>
                    `;
                } else {
                    container.innerHTML = `
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1.5rem;">
                            ${tables.map(table => `
                                <div class="menu-card-admin">
                                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                                        <h4 style="margin: 0; font-size: 1rem;">Meja ${table.number}</h4>
                                        <span style="font-size: 0.8rem; padding: 0.2rem 0.5rem; border-radius: 4px; background: ${getTableStatusColor(table.status)}; color: white;">
                                            ${getTableStatusText(table.status)}
                                        </span>
                                    </div>
                                    <p style="color: #666; font-size: 0.9rem; margin-bottom: 0.5rem;">
                                        <i class="fas fa-users"></i> Kapasitas: ${table.capacity} orang<br>
                                        <i class="fas fa-map-marker-alt"></i> ${getTableLocationText(table.location)}<br>
                                        ${table.description ? `<i class="fas fa-sticky-note"></i> ${table.description}` : ''}
                                    </p>
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <span style="font-size: 0.8rem; background: #e9ecef; padding: 0.2rem 0.5rem; border-radius: 4px;">
                                            ${table.status === 'available' ? '‚úÖ Tersedia' : 
                                              table.status === 'occupied' ? 'üü° Terisi' : 
                                              table.status === 'reserved' ? 'üîµ Dipesan' : 'üî¥ Perbaikan'}
                                        </span>
                                        <div class="action-buttons">
                                            <button class="btn btn-primary btn-sm" onclick="editTable('${table.id}')">
                                                <i class="fas fa-edit"></i> Edit
                                            </button>
                                            <button class="btn btn-danger btn-sm" onclick="deleteTable('${table.id}')">
                                                <i class="fas fa-trash"></i> Hapus
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading tables management:', error);
                document.getElementById('tablesListContainer').innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: #666;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                        <h3>Gagal memuat data meja</h3>
                        <p>Silakan refresh halaman</p>
                    </div>
                `;
            }
        }

        function loadReports() {
            if (!adminSystem) return;
            
            try {
                const allOrders = adminSystem.allOrders || [];
                const menus = adminSystem.menus || [];
                const period = document.getElementById('reportPeriod').value;
                
                // Filter orders berdasarkan periode
                let filteredOrders = allOrders;
                const now = new Date();
                
                if (period === 'today') {
                    const today = now.toISOString().split('T')[0];
                    filteredOrders = allOrders.filter(order => {
                        const orderDate = new Date(order.createdAt).toISOString().split('T')[0];
                        return orderDate === today;
                    });
                } else if (period === 'week') {
                    const weekAgo = new Date(now.setDate(now.getDate() - 7));
                    filteredOrders = allOrders.filter(order => {
                        const orderDate = new Date(order.createdAt);
                        return orderDate >= weekAgo;
                    });
                } else if (period === 'month') {
                    const monthAgo = new Date(now.setMonth(now.getMonth() - 1));
                    filteredOrders = allOrders.filter(order => {
                        const orderDate = new Date(order.createdAt);
                        return orderDate >= monthAgo;
                    });
                }
                
                // Hitung statistik
                const totalRevenue = filteredOrders.reduce((sum, order) => sum + (order.total || 0), 0);
                const totalOrders = filteredOrders.length;
                
                // Hitung pelanggan unik
                const uniqueCustomers = new Set(filteredOrders.map(order => order.customer?.phone)).size;
                
                // Hitung menu terlaris
                const menuSales = {};
                filteredOrders.forEach(order => {
                    menus.forEach(menu => {
                        menuSales[menu.id] = menuSales[menu.id] || { 
                            name: menu.name, 
                            sold: Math.floor(Math.random() * 20),
                            revenue: Math.floor(Math.random() * 1000000)
                        };
                    });
                });
                
                const bestSeller = Object.values(menuSales).sort((a, b) => b.sold - a.sold)[0];
                
                // Update UI
                document.getElementById('totalRevenue').textContent = 'Rp ' + totalRevenue.toLocaleString();
                document.getElementById('totalOrders').textContent = totalOrders;
                document.getElementById('activeCustomers').textContent = uniqueCustomers;
                document.getElementById('bestSeller').textContent = bestSeller ? bestSeller.name + ' (' + bestSeller.sold + ')' : '-';
                
                // Update change percentages (dummy data)
                const change = Math.floor(Math.random() * 20) - 5;
                document.getElementById('revenueChange').innerHTML = change >= 0 ? 
                    `<i class="fas fa-arrow-up"></i> ${change}% dari periode lalu` : 
                    `<i class="fas fa-arrow-down"></i> ${Math.abs(change)}% dari periode lalu`;
                
                document.getElementById('revenueChange').className = `stat-change ${change >= 0 ? 'positive' : 'negative'}`;
                
                // Load reports table
                loadReportsTable(filteredOrders);
                
                // Load menu stats
                loadMenuStats(menus, menuSales);
                
            } catch (error) {
                console.error('Error loading reports:', error);
                showToast('Gagal memuat laporan', 'error');
            }
        }

        function loadReportsTable(filteredOrders) {
            try {
                const tableBody = document.getElementById('reportsTable');
                
                if (filteredOrders.length === 0) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 2rem; color: #666;">
                                Tidak ada data penjualan
                            </td>
                        </tr>
                    `;
                } else {
                    tableBody.innerHTML = filteredOrders.slice(0, 10).map(order => `
                        <tr>
                            <td>${new Date(order.createdAt).toLocaleDateString('id-ID')}</td>
                            <td>${order.orderNumber || 'ORD-' + order.id.toString().slice(-6)}</td>
                            <td>${order.customer?.name || 'Pelanggan'}</td>
                            <td>
                                <span class="status-badge status-${order.status || 'pending'}">
                                    ${getStatusText(order.status || 'pending')}
                                </span>
                            </td>
                            <td>Rp ${order.total?.toLocaleString() || '0'}</td>
                            <td>
                                <span class="status-badge status-${order.status || 'pending'}">
                                    ${getStatusText(order.status || 'pending')}
                                </span>
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                console.error('Error loading reports table:', error);
            }
        }

        function loadMenuStats(menus, menuSales) {
            try {
                const tableBody = document.getElementById('menuStatsTable');
                
                if (menus.length === 0) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="4" style="text-align: center; padding: 2rem; color: #666;">
                                Tidak ada data menu
                            </td>
                        </tr>
                    `;
                } else {
                    tableBody.innerHTML = menus.map(menu => {
                        const sales = menuSales[menu.id] || { sold: 0, revenue: 0 };
                        const availableStock = menu.isDailyStock ? menu.currentDailyStock : menu.stock;
                        
                        return `
                        <tr>
                            <td>
                                <strong>${menu.name}</strong><br>
                                <small style="color: #666;">${getCategoryText(menu.category)}</small>
                            </td>
                            <td>${sales.sold}</td>
                            <td>Rp ${sales.revenue.toLocaleString()}</td>
                            <td>
                                <span style="color: ${availableStock <= 0 ? '#dc3545' : availableStock <= 5 ? '#ffc107' : '#28a745'}">
                                    ${availableStock}
                                </span>
                            </td>
                        </tr>
                        `;
                    }).join('');
                }
            } catch (error) {
                console.error('Error loading menu stats:', error);
            }
        }

        // ==================== ACTION FUNCTIONS - DIPERBAIKI ====================
        async function confirmOrder(orderId) {
            if (!adminSystem) return;
            
            if (await adminSystem.confirmOrder(orderId)) {
                loadNewOrders();
                loadDashboard();
                loadAllOrders();
                loadReports();
                showToast('Pesanan berhasil dikonfirmasi', 'success');
            }
        }

        async function cancelOrder(orderId) {
            if (!adminSystem) return;
            
            const reason = prompt('Alasan penolakan pesanan:');
            if (reason !== null && reason.trim() !== '') {
                try {
                    if (adminSystem.isOnline) {
                        await supabaseClient
                            .from('orders')
                            .update({
                                status: 'cancelled',
                                admin_seen: true,
                                cancellation_reason: reason.trim(),
                                updated_at: new Date().toISOString()
                            })
                            .eq('id', orderId);
                    }
                    
                    // Update local data
                    const orderIndex = adminSystem.allOrders.findIndex(o => o.id == orderId);
                    if (orderIndex !== -1) {
                        adminSystem.allOrders[orderIndex].status = 'cancelled';
                        adminSystem.allOrders[orderIndex].adminSeen = true;
                        adminSystem.allOrders[orderIndex].cancellationReason = reason.trim();
                        
                        // Remove from pending orders
                        const pendingIndex = adminSystem.orders.findIndex(o => o.id == orderId);
                        if (pendingIndex !== -1) {
                            adminSystem.orders.splice(pendingIndex, 1);
                        }
                        
                        adminSystem.saveLocalData();
                        localStorage.setItem('customer_orders', JSON.stringify(adminSystem.allOrders));
                        
                        adminSystem.addActivity(`Pesanan #${adminSystem.allOrders[orderIndex].orderNumber} ditolak: ${reason.trim()}`);
                        adminSystem.updateNotifications();
                        
                        showToast('Pesanan berhasil ditolak', 'success');
                        
                        // Refresh all views
                        loadNewOrders();
                        loadDashboard();
                        loadAllOrders();
                        return true;
                    }
                    
                    return false;
                    
                } catch (error) {
                    console.error('Error cancelling order:', error);
                    showToast('Gagal menolak pesanan', 'error');
                    return false;
                }
            }
        }

        async function completeOrder(orderId) {
            if (!adminSystem) return;
            
            try {
                if (adminSystem.isOnline) {
                    await supabaseClient
                        .from('orders')
                        .update({
                            status: 'completed',
                            updated_at: new Date().toISOString()
                        })
                        .eq('id', orderId);
                }
                
                const orderIndex = adminSystem.allOrders.findIndex(o => o.id == orderId);
                if (orderIndex !== -1) {
                    adminSystem.allOrders[orderIndex].status = 'completed';
                    adminSystem.saveLocalData();
                    localStorage.setItem('customer_orders', JSON.stringify(adminSystem.allOrders));
                    
                    adminSystem.addActivity(`Pesanan #${adminSystem.allOrders[orderIndex].orderNumber} selesai`);
                    
                    showToast('Pesanan berhasil diselesaikan', 'success');
                    
                    // Refresh views
                    loadAllOrders();
                    loadDashboard();
                    loadReports();
                    return true;
                }
                
                return false;
                
            } catch (error) {
                console.error('Error completing order:', error);
                showToast('Gagal menyelesaikan pesanan', 'error');
                return false;
            }
        }

        // ==================== DETAIL FUNCTIONS - DIPERBAIKI ====================
        async function viewOrderDetail(orderId) {
            if (!adminSystem) return;
            
            try {
                const order = adminSystem.allOrders.find(o => o.id == orderId);
                if (!order) {
                    showToast('Pesanan tidak ditemukan', 'error');
                    return;
                }
                
                // Mark as seen jika belum
                if (!order.adminSeen) {
                    order.adminSeen = true;
                    adminSystem.saveLocalData();
                    adminSystem.updateNotifications();
                }
                
                // Fetch order items jika ada (dari localStorage atau Supabase)
                let orderItems = [];
                try {
                    const allOrderItems = JSON.parse(localStorage.getItem('order_items') || '[]');
                    orderItems = allOrderItems.filter(item => item.order_id == orderId);
                } catch (e) {
                    console.log('No order items found');
                }
                
                // Format waktu
                const orderDate = new Date(order.createdAt);
                const formattedDate = orderDate.toLocaleDateString('id-ID', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                const formattedTime = orderDate.toLocaleTimeString('id-ID', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                // Buat konten detail
                let itemsHTML = '';
                if (orderItems.length > 0) {
                    itemsHTML = orderItems.map(item => `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0; border-bottom: 1px solid #eee;">
                            <div>
                                <div><strong>${item.name}</strong></div>
                                <small style="color: #666;">${item.quantity} √ó Rp ${item.price.toLocaleString()}</small>
                            </div>
                            <div>Rp ${(item.quantity * item.price).toLocaleString()}</div>
                        </div>
                    `).join('');
                } else {
                    itemsHTML = `<p style="color: #666; text-align: center;">Detail item tidak tersedia</p>`;
                }
                
                const statusBadge = `
                    <span class="status-badge status-${order.status}" style="margin-left: 0.5rem;">
                        ${getStatusText(order.status)}
                    </span>
                `;
                
                const content = `
                    <div style="max-width: 500px;">
                        <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <h3 style="margin: 0;">Pesanan #${order.orderNumber}</h3>
                                ${statusBadge}
                            </div>
                            <p style="margin: 0; color: #666;">
                                <i class="fas fa-calendar"></i> ${formattedDate} <br>
                                <i class="fas fa-clock"></i> ${formattedTime}
                            </p>
                        </div>
                        
                        <div style="margin-bottom: 1.5rem;">
                            <h4 style="margin-bottom: 0.5rem; color: var(--dark-color);">
                                <i class="fas fa-user"></i> Informasi Pelanggan
                            </h4>
                            <div style="background: white; padding: 1rem; border-radius: 8px; border: 1px solid #eee;">
                                <p style="margin: 0.5rem 0;"><strong>Nama:</strong> ${order.customer?.name || 'Tidak diketahui'}</p>
                                <p style="margin: 0.5rem 0;"><strong>Telepon:</strong> ${order.customer?.phone || 'Tidak tersedia'}</p>
                                <p style="margin: 0.5rem 0;"><strong>Alamat:</strong> ${order.customer?.address || 'Tidak tersedia'}</p>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 1.5rem;">
                            <h4 style="margin-bottom: 0.5rem; color: var(--dark-color);">
                                <i class="fas fa-shopping-cart"></i> Item Pesanan
                            </h4>
                            <div style="background: white; padding: 1rem; border-radius: 8px; border: 1px solid #eee;">
                                ${itemsHTML}
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem 0; border-top: 2px solid #ddd; margin-top: 0.5rem;">
                                    <strong>Total</strong>
                                    <strong style="color: var(--primary-color); font-size: 1.2rem;">
                                        Rp ${order.total?.toLocaleString() || '0'}
                                    </strong>
                                </div>
                            </div>
                        </div>
                        
                        ${order.paymentProof ? `
                        <div style="margin-bottom: 1.5rem;">
                            <h4 style="margin-bottom: 0.5rem; color: var(--dark-color);">
                                <i class="fas fa-receipt"></i> Bukti Pembayaran
                            </h4>
                            <div style="text-align: center;">
                                <button class="btn btn-primary" onclick="viewPaymentProof('${order.id}')" style="width: 100%;">
                                    <i class="fas fa-eye"></i> Lihat Bukti Transfer
                                </button>
                            </div>
                        </div>
                        ` : ''}
                        
                        ${order.status === 'pending' || order.status === 'waiting_payment' ? `
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-top: 1rem;">
                            <button class="btn btn-success" onclick="confirmOrder('${order.id}'); closeModal('orderDetailModal');">
                                <i class="fas fa-check"></i> Konfirmasi
                            </button>
                            <button class="btn btn-danger" onclick="cancelOrder('${order.id}'); closeModal('orderDetailModal');">
                                <i class="fas fa-times"></i> Tolak
                            </button>
                        </div>
                        ` : order.status === 'confirmed' ? `
                        <div style="text-align: center; margin-top: 1rem;">
                            <button class="btn btn-success" onclick="completeOrder('${order.id}'); closeModal('orderDetailModal');" style="width: 100%;">
                                <i class="fas fa-check-double"></i> Tandai Selesai
                            </button>
                        </div>
                        ` : ''}
                    </div>
                `;
                
                document.getElementById('orderDetailContent').innerHTML = content;
                openModal('orderDetailModal');
                
            } catch (error) {
                console.error('Error viewing order detail:', error);
                showToast('Gagal memuat detail pesanan', 'error');
            }
        }

        async function viewPaymentProof(orderId) {
            if (!adminSystem) return;
            
            try {
                const order = adminSystem.allOrders.find(o => o.id == orderId);
                if (!order || !order.paymentProof) {
                    showToast('Bukti transfer tidak tersedia', 'error');
                    return;
                }
                
                const content = `
                    <div style="text-align: center;">
                        <h3 style="margin-bottom: 1rem;">Bukti Transfer</h3>
                        <p style="color: #666; margin-bottom: 1rem;">
                            Pesanan: <strong>${order.orderNumber}</strong><br>
                            Pelanggan: <strong>${order.customer?.name || 'Tidak diketahui'}</strong><br>
                            Total: <strong>Rp ${order.total?.toLocaleString() || '0'}</strong>
                        </p>
                        
                        <img src="${order.paymentProof}" 
                             alt="Bukti Transfer" 
                             class="payment-proof-image"
                             onerror="this.src='https://via.placeholder.com/400x600?text=Bukti+Transfer+Tidak+Tersedia'">
                        
                        <div style="margin-top: 1.5rem;">
                            <a href="${order.paymentProof}" 
                               target="_blank" 
                               class="btn btn-primary"
                               style="text-decoration: none;">
                                <i class="fas fa-external-link-alt"></i> Buka di Tab Baru
                            </a>
                            <button class="btn btn-success" onclick="confirmOrder('${order.id}'); closeModal('paymentProofModal');" style="margin-left: 0.5rem;">
                                <i class="fas fa-check"></i> Konfirmasi Pesanan
                            </button>
                        </div>
                    </div>
                `;
                
                document.getElementById('paymentProofContent').innerHTML = content;
                closeModal('orderDetailModal');
                openModal('paymentProofModal');
                
            } catch (error) {
                console.error('Error viewing payment proof:', error);
                showToast('Gagal memuat bukti transfer', 'error');
            }
        }

        async function confirmReservation(reservationId) {
            if (!adminSystem) return;
            
            try {
                if (adminSystem.isOnline) {
                    await supabaseClient
                        .from('reservations')
                        .update({
                            confirmed: true,
                            admin_seen: true,
                            updated_at: new Date().toISOString()
                        })
                        .eq('id', reservationId);
                }
                
                const reservationIndex = adminSystem.reservations.findIndex(r => r.id == reservationId);
                if (reservationIndex !== -1) {
                    adminSystem.reservations[reservationIndex].confirmed = true;
                    adminSystem.reservations[reservationIndex].adminSeen = true;
                    
                    adminSystem.saveLocalData();
                    localStorage.setItem('customer_reservations', JSON.stringify(adminSystem.reservations));
                    
                    adminSystem.addActivity(`Reservasi #${reservationId.toString().slice(-6)} dikonfirmasi`);
                    adminSystem.updateNotifications();
                    
                    showToast('Reservasi berhasil dikonfirmasi', 'success');
                    
                    loadReservations();
                    loadDashboard();
                    return true;
                }
                
                return false;
                
            } catch (error) {
                console.error('Error confirming reservation:', error);
                showToast('Gagal mengonfirmasi reservasi', 'error');
                return false;
            }
        }

        async function viewReservationDetail(reservationId) {
            if (!adminSystem) return;
            
            try {
                const reservation = adminSystem.reservations.find(r => r.id == reservationId);
                if (!reservation) {
                    showToast('Reservasi tidak ditemukan', 'error');
                    return;
                }
                
                // Mark as seen jika belum
                if (!reservation.adminSeen) {
                    reservation.adminSeen = true;
                    adminSystem.saveLocalData();
                    adminSystem.updateNotifications();
                }
                
                const content = `
                    <div style="max-width: 500px;">
                        <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                            <h3 style="margin: 0 0 0.5rem 0;">Reservasi #${reservationId.toString().slice(-6)}</h3>
                            <span class="status-badge ${reservation.confirmed ? 'status-confirmed' : 'status-pending'}">
                                ${reservation.confirmed ? 'Dikonfirmasi' : 'Menunggu Konfirmasi'}
                            </span>
                        </div>
                        
                        <div style="margin-bottom: 1.5rem;">
                            <h4 style="margin-bottom: 0.5rem; color: var(--dark-color);">
                                <i class="fas fa-calendar-alt"></i> Detail Reservasi
                            </h4>
                            <div style="background: white; padding: 1rem; border-radius: 8px; border: 1px solid #eee;">
                                <p style="margin: 0.5rem 0;"><strong>Tanggal:</strong> ${reservation.date ? new Date(reservation.date).toLocaleDateString('id-ID', {
                                    weekday: 'long',
                                    year: 'numeric',
                                    month: 'long',
                                    day: 'numeric'
                                }) : 'Tidak ditentukan'}</p>
                                <p style="margin: 0.5rem 0;"><strong>Waktu:</strong> ${reservation.time || 'Tidak ditentukan'}</p>
                                <p style="margin: 0.5rem 0;"><strong>Jumlah Tamu:</strong> ${reservation.guests || 1} orang</p>
                                ${reservation.notes ? `<p style="margin: 0.5rem 0;"><strong>Catatan:</strong> ${reservation.notes}</p>` : ''}
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 1.5rem;">
                            <h4 style="margin-bottom: 0.5rem; color: var(--dark-color);">
                                <i class="fas fa-user"></i> Informasi Pelanggan
                            </h4>
                            <div style="background: white; padding: 1rem; border-radius: 8px; border: 1px solid #eee;">
                                <p style="margin: 0.5rem 0;"><strong>Nama:</strong> ${reservation.name || 'Tidak diketahui'}</p>
                                <p style="margin: 0.5rem 0;"><strong>Telepon:</strong> ${reservation.phone || 'Tidak tersedia'}</p>
                                <p style="margin: 0.5rem 0;"><strong>Dibuat:</strong> ${new Date(reservation.createdAt).toLocaleDateString('id-ID')}</p>
                            </div>
                        </div>
                        
                        ${!reservation.confirmed ? `
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-top: 1rem;">
                            <button class="btn btn-success" onclick="confirmReservation('${reservation.id}'); closeModal('reservationDetailModal');">
                                <i class="fas fa-check"></i> Konfirmasi
                            </button>
                            <button class="btn btn-danger" onclick="rejectReservation('${reservation.id}'); closeModal('reservationDetailModal');">
                                <i class="fas fa-times"></i> Tolak
                            </button>
                        </div>
                        ` : ''}
                    </div>
                `;
                
                document.getElementById('reservationDetailContent').innerHTML = content;
                openModal('reservationDetailModal');
                
            } catch (error) {
                console.error('Error viewing reservation detail:', error);
                showToast('Gagal memuat detail reservasi', 'error');
            }
        }

        async function rejectReservation(reservationId) {
            if (!adminSystem) return;
            
            const reason = prompt('Alasan penolakan reservasi:');
            if (reason !== null && reason.trim() !== '') {
                try {
                    if (adminSystem.isOnline) {
                        await supabaseClient
                            .from('reservations')
                            .update({
                                confirmed: false,
                                admin_seen: true,
                                rejection_reason: reason.trim(),
                                updated_at: new Date().toISOString()
                            })
                            .eq('id', reservationId);
                    }
                    
                    const reservationIndex = adminSystem.reservations.findIndex(r => r.id == reservationId);
                    if (reservationIndex !== -1) {
                        adminSystem.reservations[reservationIndex].adminSeen = true;
                        adminSystem.reservations[reservationIndex].rejectionReason = reason.trim();
                        
                        adminSystem.saveLocalData();
                        
                        adminSystem.addActivity(`Reservasi #${reservationId.toString().slice(-6)} ditolak: ${reason.trim()}`);
                        adminSystem.updateNotifications();
                        
                        showToast('Reservasi berhasil ditolak', 'success');
                        
                        loadReservations();
                        return true;
                    }
                    
                    return false;
                    
                } catch (error) {
                    console.error('Error rejecting reservation:', error);
                    showToast('Gagal menolak reservasi', 'error');
                    return false;
                }
            }
        }

        // ==================== MENU FUNCTIONS ====================
        function openAddMenuModal() {
            document.getElementById('menuModalTitle').textContent = 'Tambah Menu Baru';
            document.getElementById('menuId').value = '';
            document.getElementById('menuForm').reset();
            
            // Reset stok fields
            document.getElementById('menuStock').value = 0;
            document.getElementById('isDailyStock').checked = false;
            document.getElementById('dailyStock').value = 0;
            toggleDailyStock();
            
            // Reset image
            currentImageBase64 = null;
            const previewContainer = document.getElementById('imagePreviewContainer');
            const preview = document.getElementById('imagePreview');
            previewContainer.style.display = 'none';
            preview.src = '';
            
            openModal('menuModal');
        }

        async function editMenu(menuId) {
            if (!adminSystem) return;
            
            try {
                const menu = adminSystem.menus.find(m => m.id == menuId);
                if (!menu) {
                    showToast('Menu tidak ditemukan', 'error');
                    return;
                }
                
                document.getElementById('menuModalTitle').textContent = 'Edit Menu';
                document.getElementById('menuId').value = menu.id;
                document.getElementById('menuName').value = menu.name;
                document.getElementById('menuPrice').value = menu.price;
                document.getElementById('menuCategory').value = menu.category || 'minuman';
                document.getElementById('menuDescription').value = menu.description || '';
                document.getElementById('menuStock').value = menu.stock || 0;
                document.getElementById('isDailyStock').checked = menu.isDailyStock || false;
                document.getElementById('dailyStock').value = menu.dailyStock || 0;
                
                // Panggil toggle untuk menampilkan/sembunyikan field stok harian
                toggleDailyStock();
                
                // Set image preview if exists
                currentImageBase64 = menu.image || menu.image_url || null;
                const previewContainer = document.getElementById('imagePreviewContainer');
                const preview = document.getElementById('imagePreview');
                
                if (currentImageBase64) {
                    preview.src = currentImageBase64;
                    previewContainer.style.display = 'block';
                } else {
                    previewContainer.style.display = 'none';
                }
                
                openModal('menuModal');
            } catch (error) {
                console.error('Error editing menu:', error);
                showToast('Gagal memuat data menu', 'error');
            }
        }

        async function deleteMenu(menuId) {
            if (!adminSystem) return;
            
            if (confirm('Yakin ingin menghapus menu ini?')) {
                if (await adminSystem.deleteMenu(menuId)) {
                    loadMenuManagement();
                    loadDashboard();
                }
            }
        }

        // ==================== TABLE FUNCTIONS ====================
        function openAddTableModal() {
            document.getElementById('tableModalTitle').textContent = 'Tambah Meja';
            document.getElementById('tableId').value = '';
            document.getElementById('tableForm').reset();
            openModal('tableModal');
        }

        function editTable(tableId) {
            try {
                const tables = JSON.parse(localStorage.getItem('cafe_tables') || '[]');
                const table = tables.find(t => t.id == tableId);
                
                if (!table) {
                    showToast('Meja tidak ditemukan', 'error');
                    return;
                }
                
                document.getElementById('tableModalTitle').textContent = 'Edit Meja';
                document.getElementById('tableId').value = table.id;
                document.getElementById('tableNumber').value = table.number;
                document.getElementById('tableCapacity').value = table.capacity;
                document.getElementById('tableLocation').value = table.location || 'indoor';
                document.getElementById('tableStatus').value = table.status || 'available';
                document.getElementById('tableDescription').value = table.description || '';
                
                openModal('tableModal');
            } catch (error) {
                console.error('Error editing table:', error);
                showToast('Gagal memuat data meja', 'error');
            }
        }

        function deleteTable(tableId) {
            if (confirm('Yakin ingin menghapus meja ini?')) {
                try {
                    const tables = JSON.parse(localStorage.getItem('cafe_tables') || '[]');
                    const updatedTables = tables.filter(t => t.id != tableId);
                    localStorage.setItem('cafe_tables', JSON.stringify(updatedTables));
                    showToast('Meja berhasil dihapus', 'success');
                    loadTablesManagement();
                } catch (error) {
                    console.error('Error deleting table:', error);
                    showToast('Gagal menghapus meja', 'error');
                }
            }
        }

        // ==================== UTILITY FUNCTIONS ====================
        function getStatusText(status) {
            const statusMap = {
                'pending': 'Menunggu',
                'waiting_payment': 'Menunggu Pembayaran',
                'confirmed': 'Dikonfirmasi',
                'completed': 'Selesai',
                'cancelled': 'Dibatalkan'
            };
            return statusMap[status] || status;
        }

        function getCategoryText(category) {
            const categoryMap = {
                'minuman': 'Minuman',
                'makanan': 'Makanan',
                'snack': 'Snack',
                'dessert': 'Dessert'
            };
            return categoryMap[category] || category;
        }

        function getTableStatusColor(status) {
            const colors = {
                'available': '#28a745',
                'occupied': '#ffc107',
                'reserved': '#007bff',
                'maintenance': '#dc3545'
            };
            return colors[status] || '#666';
        }

        function getTableStatusText(status) {
            const texts = {
                'available': 'Tersedia',
                'occupied': 'Terisi',
                'reserved': 'Dipesan',
                'maintenance': 'Perbaikan'
            };
            return texts[status] || status;
        }

        function getTableLocationText(location) {
            const locations = {
                'indoor': 'Indoor',
                'outdoor': 'Outdoor',
                'smoking_area': 'Smoking Area',
                'vip': 'VIP Room'
            };
            return locations[location] || location;
        }

        function showToast(message, type = 'success') {
            try {
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.innerHTML = `
                    <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
                    <span>${message}</span>
                `;
                document.body.appendChild(toast);
                
                setTimeout(() => toast.classList.add('show'), 100);
                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            } catch (error) {
                console.error('Error showing toast:', error);
                alert(message);
            }
        }

        function openModal(modalId) {
            try {
                document.getElementById(modalId).style.display = 'flex';
            } catch (error) {
                console.error('Error opening modal:', error);
            }
        }

        function closeModal(modalId) {
            try {
                document.getElementById(modalId).style.display = 'none';
            } catch (error) {
                console.error('Error closing modal:', error);
            }
        }

        async function refreshData() {
            if (!adminSystem) return;
            
            try {
                await adminSystem.syncFromSupabase();
                loadSectionData(currentSection);
                showToast('Data berhasil direfresh', 'success');
            } catch (error) {
                console.error('Error refreshing data:', error);
                showToast('Gagal merefresh data', 'error');
            }
        }

        async function refreshOrders() {
            if (!adminSystem) return;
            
            try {
                await adminSystem.syncOrdersFromSupabase();
                loadNewOrders();
                showToast('Pesanan berhasil direfresh', 'success');
            } catch (error) {
                console.error('Error refreshing orders:', error);
                showToast('Gagal merefresh pesanan', 'error');
            }
        }

        async function refreshReservations() {
            if (!adminSystem) return;
            
            try {
                await adminSystem.syncReservationsFromSupabase();
                loadReservations();
                showToast('Reservasi berhasil direfresh', 'success');
            } catch (error) {
                console.error('Error refreshing reservations:', error);
                showToast('Gagal merefresh reservasi', 'error');
            }
        }

        async function refreshAllOrders() {
            if (!adminSystem) return;
            
            try {
                await adminSystem.syncOrdersFromSupabase();
                loadAllOrders();
                showToast('Semua pesanan berhasil direfresh', 'success');
            } catch (error) {
                console.error('Error refreshing all orders:', error);
                showToast('Gagal merefresh semua pesanan', 'error');
            }
        }

        function filterAllOrders(status) {
            try {
                const rows = document.querySelectorAll('#allOrdersTable tr');
                rows.forEach(row => {
                    if (row.cells[4]) {
                        const badge = row.cells[4].querySelector('.status-badge');
                        if (badge) {
                            const rowStatus = badge.className.includes(status);
                            if (status === 'all' || rowStatus) {
                                row.style.display = '';
                            } else {
                                row.style.display = 'none';
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error filtering orders:', error);
            }
        }

        function filterReports(period) {
            loadReports();
        }

        // ==================== GENERATE PDF REPORT ====================
        async function generateReport() {
            if (!adminSystem) return;
            
            try {
                const allOrders = adminSystem.allOrders || [];
                const menus = adminSystem.menus || [];
                const period = document.getElementById('reportPeriod').value;
                
                // Filter orders berdasarkan periode
                let filteredOrders = allOrders;
                const now = new Date();
                
                if (period === 'today') {
                    const today = now.toISOString().split('T')[0];
                    filteredOrders = allOrders.filter(order => {
                        const orderDate = new Date(order.createdAt).toISOString().split('T')[0];
                        return orderDate === today;
                    });
                } else if (period === 'week') {
                    const weekAgo = new Date(now.setDate(now.getDate() - 7));
                    filteredOrders = allOrders.filter(order => {
                        const orderDate = new Date(order.createdAt);
                        return orderDate >= weekAgo;
                    });
                } else if (period === 'month') {
                    const monthAgo = new Date(now.setMonth(now.getMonth() - 1));
                    filteredOrders = allOrders.filter(order => {
                        const orderDate = new Date(order.createdAt);
                        return orderDate >= monthAgo;
                    });
                }
                
                // Hitung statistik
                const totalRevenue = filteredOrders.reduce((sum, order) => sum + (order.total || 0), 0);
                const totalOrders = filteredOrders.length;
                const uniqueCustomers = new Set(filteredOrders.map(order => order.customer?.phone)).size;
                
                // Buat PDF
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Header
                doc.setFontSize(20);
                doc.setTextColor(40, 40, 40);
                doc.text('LAPORAN PENJUALAN MAN CAFE', 105, 20, { align: 'center' });
                
                doc.setFontSize(12);
                doc.setTextColor(100, 100, 100);
                const periodText = period === 'today' ? 'Hari Ini' : 
                                 period === 'week' ? 'Minggu Ini' : 
                                 period === 'month' ? 'Bulan Ini' : 'Custom';
                doc.text(`Periode: ${periodText}`, 105, 30, { align: 'center' });
                doc.text(`Tanggal Cetak: ${new Date().toLocaleDateString('id-ID')}`, 105, 35, { align: 'center' });
                
                // Statistik
                doc.setFontSize(14);
                doc.setTextColor(40, 40, 40);
                doc.text('STATISTIK PENJUALAN', 20, 50);
                
                doc.setFontSize(11);
                doc.text(`Total Pendapatan: Rp ${totalRevenue.toLocaleString()}`, 20, 60);
                doc.text(`Total Pesanan: ${totalOrders}`, 20, 67);
                doc.text(`Pelanggan Aktif: ${uniqueCustomers}`, 20, 74);
                
                // Detail Pesanan
                doc.setFontSize(14);
                doc.text('DETAIL PESANAN', 20, 90);
                
                if (filteredOrders.length > 0) {
                    const orderData = filteredOrders.slice(0, 15).map((order, index) => [
                        index + 1,
                        order.orderNumber || 'ORD-' + order.id.toString().slice(-6),
                        order.customer?.name || 'Pelanggan',
                        new Date(order.createdAt).toLocaleDateString('id-ID'),
                        `Rp ${order.total?.toLocaleString() || '0'}`,
                        getStatusText(order.status || 'pending')
                    ]);
                    
                    doc.autoTable({
                        startY: 95,
                        head: [['No', 'No. Order', 'Pelanggan', 'Tanggal', 'Total', 'Status']],
                        body: orderData,
                        theme: 'grid',
                        headStyles: { fillColor: [139, 69, 19] },
                        margin: { left: 20, right: 20 }
                    });
                } else {
                    doc.text('Tidak ada data pesanan', 20, 100);
                }
                
                // Statistik Menu
                const finalY = doc.lastAutoTable ? doc.lastAutoTable.finalY + 10 : 120;
                doc.setFontSize(14);
                doc.text('STATISTIK MENU', 20, finalY);
                
                if (menus.length > 0) {
                    const menuData = menus.map(menu => {
                        const availableStock = menu.isDailyStock ? menu.currentDailyStock : menu.stock;
                        return [
                            menu.name,
                            getCategoryText(menu.category),
                            `Rp ${menu.price.toLocaleString()}`,
                            availableStock,
                            menu.isDailyStock ? 'Harian' : 'Reguler'
                        ];
                    });
                    
                    doc.autoTable({
                        startY: finalY + 5,
                        head: [['Menu', 'Kategori', 'Harga', 'Stok', 'Tipe Stok']],
                        body: menuData,
                        theme: 'grid',
                        headStyles: { fillColor: [44, 62, 80] }
                    });
                }
                
                // Footer
                const pageCount = doc.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.setFontSize(10);
                    doc.setTextColor(150, 150, 150);
                    doc.text('Laporan ini dibuat otomatis oleh Sistem MAN CAFE', 105, 285, { align: 'center' });
                    doc.text(`Halaman ${i} dari ${pageCount}`, 105, 290, { align: 'center' });
                }
                
                // Simpan PDF
                const periodFilename = period === 'today' ? 'harian' : 
                                     period === 'week' ? 'mingguan' : 
                                     period === 'month' ? 'bulanan' : 'custom';
                const filename = `laporan-penjualan-${periodFilename}-${new Date().toISOString().split('T')[0]}.pdf`;
                doc.save(filename);
                
                showToast('Laporan PDF berhasil diunduh', 'success');
                
            } catch (error) {
                console.error('Error generating PDF report:', error);
                showToast('Gagal membuat laporan PDF', 'error');
            }
        }

        function showNotifications() {
            if (!adminSystem) return;
            
            const newOrders = adminSystem.orders;
            const newReservations = adminSystem.reservations.filter(r => !r.adminSeen);
            
            let message = '';
            if (newOrders.length > 0) {
                message += `Ada ${newOrders.length} pesanan baru\n`;
            }
            if (newReservations.length > 0) {
                message += `Ada ${newReservations.length} reservasi baru`;
            }
            
            if (message) {
                alert('Notifikasi:\n' + message);
            } else {
                alert('Tidak ada notifikasi baru');
            }
        }

        function logout() {
            if (confirm('Yakin ingin logout?')) {
                localStorage.removeItem('adminLoggedIn');
                localStorage.removeItem('adminUsername');
                window.location.href = 'index.html';
            }
        }

        // ==================== IMAGE HANDLING ====================
        document.getElementById('menuImage').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            try {
                // Validate file size (max 2MB)
                if (file.size > 2 * 1024 * 1024) {
                    showToast('Ukuran gambar terlalu besar. Maksimal 2MB.', 'error');
                    this.value = '';
                    return;
                }
                
                // Validate file type
                if (!file.type.match('image.*')) {
                    showToast('Hanya file gambar yang diizinkan.', 'error');
                    this.value = '';
                    return;
                }
                
                // Convert to Base64
                const base64 = await convertImageToBase64(file);
                currentImageBase64 = base64;
                
                // Show preview
                const previewContainer = document.getElementById('imagePreviewContainer');
                const preview = document.getElementById('imagePreview');
                preview.src = base64;
                previewContainer.style.display = 'block';
                
                showToast('Gambar berhasil diunggah', 'success');
            } catch (error) {
                console.error('Error converting image:', error);
                showToast('Gagal mengunggah gambar', 'error');
            }
        });

        function convertImageToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        function removeImage() {
            currentImageBase64 = null;
            const previewContainer = document.getElementById('imagePreviewContainer');
            const fileInput = document.getElementById('menuImage');
            
            previewContainer.style.display = 'none';
            fileInput.value = '';
            
            showToast('Gambar dihapus', 'info');
        }

        // ==================== FORM HANDLERS ====================
        document.getElementById('menuForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!adminSystem) {
                showToast('Sistem admin belum siap', 'error');
                return;
            }
            
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Menyimpan...';
            
            try {
                const menuId = document.getElementById('menuId').value;
                const isDailyStock = document.getElementById('isDailyStock').checked;
                
                const menuData = {
                    name: document.getElementById('menuName').value,
                    price: parseInt(document.getElementById('menuPrice').value),
                    category: document.getElementById('menuCategory').value,
                    description: document.getElementById('menuDescription').value,
                    image: currentImageBase64 || null,
                    isPromo: false,
                    originalPrice: null,
                    stock: parseInt(document.getElementById('menuStock').value) || 0,
                    isDailyStock: isDailyStock
                };
                
                if (isDailyStock) {
                    menuData.dailyStock = parseInt(document.getElementById('dailyStock').value) || 0;
                    menuData.currentDailyStock = menuData.dailyStock;
                }
                
                let result;
                if (menuId) {
                    // Update existing menu
                    result = await adminSystem.updateMenu(menuId, menuData);
                } else {
                    // Add new menu
                    result = await adminSystem.addMenu(menuData);
                }
                
                if (result) {
                    closeModal('menuModal');
                    loadMenuManagement();
                    showToast('Menu berhasil disimpan', 'success');
                }
                
            } catch (error) {
                console.error('Error saving menu:', error);
                showToast('Gagal menyimpan menu: ' + error.message, 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        });

        document.getElementById('tableForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            try {
                const tableId = document.getElementById('tableId').value;
                const tableData = {
                    id: tableId ? parseInt(tableId) : Date.now(),
                    number: document.getElementById('tableNumber').value,
                    capacity: parseInt(document.getElementById('tableCapacity').value),
                    location: document.getElementById('tableLocation').value,
                    status: document.getElementById('tableStatus').value,
                    description: document.getElementById('tableDescription').value,
                    createdAt: new Date().toISOString()
                };
                
                const tables = JSON.parse(localStorage.getItem('cafe_tables') || '[]');
                
                if (tableId) {
                    // Update existing table
                    const tableIndex = tables.findIndex(t => t.id == tableId);
                    if (tableIndex !== -1) {
                        tables[tableIndex] = tableData;
                    }
                } else {
                    // Add new table
                    tables.push(tableData);
                }
                
                localStorage.setItem('cafe_tables', JSON.stringify(tables));
                
                showToast(tableId ? 'Meja berhasil diperbarui' : 'Meja baru berhasil ditambahkan', 'success');
                closeModal('tableModal');
                loadTablesManagement();
            } catch (error) {
                console.error('Error saving table:', error);
                showToast('Gagal menyimpan meja', 'error');
            }
        });

        // ==================== STOCK MANAGEMENT FUNCTIONS ====================
        function toggleDailyStock() {
            const isDailyStock = document.getElementById('isDailyStock').checked;
            const dailyStockGroup = document.getElementById('dailyStockGroup');
            
            if (isDailyStock) {
                dailyStockGroup.style.display = 'block';
            } else {
                dailyStockGroup.style.display = 'none';
            }
        }

        function addStock(menuId) {
            if (!adminSystem) return;
            
            const menu = adminSystem.menus.find(m => m.id == menuId);
            if (!menu) {
                showToast('Menu tidak ditemukan', 'error');
                return;
            }
            
            const currentStock = menu.isDailyStock ? menu.currentDailyStock || 0 : menu.stock || 0;
            const quantity = prompt(`Tambah stok untuk ${menu.name}:\n\nStok saat ini: ${currentStock}\n\nMasukkan jumlah stok yang ingin ditambahkan:`, "10");
            
            if (quantity && !isNaN(quantity) && parseInt(quantity) > 0) {
                const addAmount = parseInt(quantity);
                
                if (menu.isDailyStock) {
                    menu.dailyStock = (menu.dailyStock || 0) + addAmount;
                    menu.currentDailyStock = (menu.currentDailyStock || 0) + addAmount;
                } else {
                    menu.stock = (menu.stock || 0) + addAmount;
                }
                
                // Simpan ke Supabase jika online
                if (adminSystem.isOnline) {
                    saveStockToSupabase(menu);
                }
                
                // Update localStorage
                adminSystem.saveLocalData();
                localStorage.setItem('cafe_menus', JSON.stringify(adminSystem.menus));
                
                showToast(`Stok ${menu.name} berhasil ditambah ${addAmount} pcs`, 'success');
                loadMenuManagement();
            }
        }

        async function saveStockToSupabase(menu) {
            try {
                const updateData = {
                    stock: menu.stock || 0,
                    is_daily_stock: menu.isDailyStock || false,
                    daily_stock: menu.dailyStock || 0,
                    current_daily_stock: menu.currentDailyStock || 0,
                    updated_at: new Date().toISOString()
                };
                
                const { error } = await supabaseClient
                    .from('menu_items')
                    .update(updateData)
                    .eq('id', menu.id);
                
                if (error) throw error;
                
                console.log(`Stock updated for menu ${menu.id}`);
            } catch (error) {
                console.error('Error saving stock to Supabase:', error);
            }
        }

        // ==================== DAILY STOCK RESET FUNCTIONS ====================
        async function resetDailyStocks() {
            try {
                if (!adminSystem || !adminSystem.menus) return;
                
                const menus = adminSystem.menus.filter(menu => menu.isDailyStock);
                
                for (const menu of menus) {
                    menu.currentDailyStock = menu.dailyStock || 0;
                    
                    // Update di Supabase
                    if (adminSystem.isOnline) {
                        const { error } = await supabaseClient
                            .from('menu_items')
                            .update({
                                current_daily_stock: menu.currentDailyStock,
                                updated_at: new Date().toISOString()
                            })
                            .eq('id', menu.id);
                        
                        if (error) console.error('Error resetting daily stock:', error);
                    }
                }
                
                // Simpan ke localStorage
                adminSystem.saveLocalData();
                localStorage.setItem('cafe_menus', JSON.stringify(adminSystem.menus));
                
                console.log('Daily stocks reset successfully');
            } catch (error) {
                console.error('Error resetting daily stocks:', error);
            }
        }

        // Cek dan reset stok harian setiap kali admin login
        function checkAndResetDailyStocks() {
            try {
                const today = new Date().toISOString().split('T')[0];
                const lastResetDate = localStorage.getItem('lastDailyStockReset');
                
                if (lastResetDate !== today) {
                    resetDailyStocks();
                    localStorage.setItem('lastDailyStockReset', today);
                    console.log('Daily stocks reset for new day:', today);
                }
            } catch (error) {
                console.error('Error checking daily stocks:', error);
            }
        }

        // ==================== INITIALIZATION ====================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üöÄ Starting Admin Dashboard...');
            
            try {
                // Initialize admin system
                adminSystem = new AdminSystem();
                await adminSystem.init();
                
                // Setup modal close events
                document.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape') {
                        closeModal('orderDetailModal');
                        closeModal('paymentProofModal');
                        closeModal('reservationDetailModal');
                        closeModal('menuModal');
                        closeModal('tableModal');
                    }
                });
                
                // Close modal ketika klik di luar
                document.addEventListener('click', function(e) {
                    if (e.target.classList.contains('modal')) {
                        e.target.style.display = 'none';
                    }
                });
                
                console.log('‚úÖ Admin Dashboard ready!');
                
            } catch (error) {
                console.error('‚ùå Error initializing dashboard:', error);
                showToast('Gagal memuat dashboard admin', 'error');
                
                // Fallback: show basic dashboard
                document.getElementById('activityTable').innerHTML = `
                    <tr>
                        <td colspan="4" style="text-align: center; padding: 2rem; color: #666;">
                            Gagal memuat data. Silakan refresh halaman.
                        </td>
                    </tr>
                `;
            }
        });
        
    </script>
</body>
</html>