<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MAN CAFE - Admin Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
        const SUPABASE_URL = 'https://cuwtyfggfgykgjhrvdgi.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_4e-uWWuKR2r7_jNaWHh03A_2UVQbPAx';
        
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
            auth: {
                autoRefreshToken: true,
                persistSession: true,
                detectSessionInUrl: false
            },
            db: {
                schema: 'public'
            }
        });
    </script>
    <style>
        /* ========== LOGIN PAGE STYLES ========== */
        .login-container {
            min-height: 100vh;
            background: linear-gradient(135deg, #8B4513 0%, #A0522D 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            font-family: 'Poppins', sans-serif;
        }

        .login-box {
            background: white;
            border-radius: 20px;
            padding: 40px;
            width: 100%;
            max-width: 450px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
            animation: fadeIn 0.5s ease;
        }
        /* Tambahkan di bagian CSS */
.whatsapp-modal {
    z-index: 10002 !important;
}

#whatsappMessageModal {
    z-index: 10003 !important;
}

#reservationDetailModal {
    z-index: 10001 !important;
}

#orderDetailModal {
    z-index: 10001 !important;
}

/* Pastikan modal-backdrop juga memiliki z-index yang benar */
.modal {
    z-index: 10000;
}

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ==================== LOGIN LOGO STYLES ==================== */
        .login-logo {
            text-align: center;
            margin-bottom: 2rem;
        }

        .custom-logo {
            width: 100px;
            height: 100px;
            margin: 0 auto 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border-radius: 15px;
            background: white;
            padding: 10px;
            box-shadow: 0 5px 20px rgba(139, 69, 19, 0.2);
            border: 3px solid var(--primary-color);
        }

        .custom-logo img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .login-logo h1 {
            font-size: 2.2rem;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
            font-weight: 800;
            letter-spacing: 1px;
        }

        .login-logo span {
            color: var(--dark-color);
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
            font-size: 14px;
        }

        .form-control {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s;
            background: #f9f9f9;
        }

        .form-control:focus {
            outline: none;
            border-color: #8B4513;
            background: white;
            box-shadow: 0 0 0 3px rgba(139, 69, 19, 0.1);
        }

        .btn-login {
            width: 100%;
            padding: 16px;
            background: #8B4513;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-login:hover {
            background: #A0522D;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(139, 69, 19, 0.2);
        }

        .btn-login:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .login-error {
            background: #fee;
            border: 1px solid #fcc;
            color: #c00;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
            text-align: center;
            font-size: 14px;
        }

        .login-error.show {
            display: block;
            animation: shake 0.5s;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }

        .demo-credentials {
            margin-top: 25px;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 10px;
            border-left: 4px solid #8B4513;
            font-size: 14px;
        }

        .demo-credentials h4 {
            margin: 0 0 10px 0;
            color: #333;
        }

        .demo-credentials p {
            margin: 5px 0;
            color: #666;
        }

        .demo-credentials code {
            background: #e9ecef;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
            color: #8B4513;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ========== ADMIN DASHBOARD STYLES ========== */
        .admin-container {
            display: none;
        }

        :root {
            --primary-color: #8B4513;
            --primary-light: #A0522D;
            --primary-dark: #5D2906;
            --secondary-color: #D2691E;
            --accent-color: #FFD700;
            --dark-color: #2C3E50;
            --light-color: #F8F9FA;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --info-color: #17a2b8;
            --border-radius: 10px;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: #f5f7fa;
            color: #333;
            line-height: 1.6;
            min-width: 320px;
        }

        .admin-header {
            background: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 1rem;
            text-decoration: none;
            color: var(--dark-color);
        }

        .logo i {
            font-size: 2rem;
            color: var(--primary-color);
        }

        .logo-text h1 {
            font-size: 1.5rem;
            margin: 0;
        }

        .logo-text span {
            font-size: 0.9rem;
            color: var(--primary-color);
        }

        .admin-controls {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .notification-bell {
            position: relative;
            cursor: pointer;
            font-size: 1.2rem;
            color: #666;
        }

        .notification-count {
            position: absolute;
            top: -8px;
            right: -8px;
            background: var(--danger-color);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .admin-user {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            position: relative;
        }

        .user-menu {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            min-width: 200px;
            display: none;
            z-index: 1000;
        }

        .user-menu.show {
            display: block;
            animation: fadeIn 0.2s ease;
        }

        .user-menu-item {
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            color: #333;
            text-decoration: none;
            transition: background 0.2s;
        }

        .user-menu-item:hover {
            background: #f8f9fa;
        }

        .user-menu-item.logout {
            color: var(--danger-color);
            border-top: 1px solid #eee;
        }

        .dashboard-container {
            display: flex;
            min-height: calc(100vh - 80px);
        }

        .sidebar {
            width: 250px;
            background: var(--dark-color);
            color: white;
            padding: 2rem 0;
            position: sticky;
            top: 80px;
            height: calc(100vh - 80px);
            overflow-y: auto;
            flex-shrink: 0;
        }

        .sidebar-menu {
            list-style: none;
        }

        .sidebar-menu li {
            margin-bottom: 0.5rem;
        }

        .sidebar-menu a {
            display: flex;
            align-items: center;
            padding: 0.8rem 1.5rem;
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            transition: all 0.3s;
            border-left: 3px solid transparent;
        }

        .sidebar-menu a:hover,
        .sidebar-menu a.active {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border-left-color: var(--primary-color);
        }

        .sidebar-menu i {
            width: 25px;
            margin-right: 1rem;
        }

        .main-content {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 1.5rem;
            display: flex;
            align-items: center;
            gap: 1.5rem;
            box-shadow: var(--shadow);
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
        }

        .stat-info h3 {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 0.5rem;
        }

        .stat-number {
            font-size: 1.8rem;
            font-weight: 600;
            color: var(--dark-color);
        }

        .stat-change {
            font-size: 0.9rem;
            margin-top: 0.3rem;
        }

        .stat-change.positive {
            color: var(--success-color);
        }

        .stat-change.negative {
            color: var(--danger-color);
        }

        .table-container {
            background: white;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
            width: 100%;
            overflow-x: auto;
        }

        .table-header {
            padding: 1.5rem;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .table-header h2 {
            margin: 0;
            color: var(--dark-color);
            font-size: 1.5rem;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }

        .data-table th {
            background: #f8f9fa;
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: var(--dark-color);
            border-bottom: 2px solid #eee;
            white-space: nowrap;
        }

        .data-table td {
            padding: 1rem;
            border-bottom: 1px solid #eee;
            white-space: nowrap;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        .status-badge {
            display: inline-block;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
            white-space: nowrap;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-confirmed {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status-completed {
            background: #d4edda;
            color: #155724;
        }

        .status-cancelled {
            background: #f8d7da;
            color: #721c24;
        }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            white-space: nowrap;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-success {
            background: var(--success-color);
            color: white;
        }

        .btn-danger {
            background: var(--danger-color);
            color: white;
        }

        .btn-sm {
            padding: 0.3rem 0.8rem;
            font-size: 0.8rem;
        }

        .action-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: var(--border-radius);
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-header h2 {
            margin: 0;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 0.8rem;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
        }

        .report-filters {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            align-items: flex-end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            min-width: 150px;
            flex: 1;
        }

        .file-upload-container {
            margin-bottom: 1rem;
        }

        .file-upload {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .file-upload-input {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .file-upload-label {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            border: 2px dashed #ddd;
            border-radius: 8px;
            background: #f9f9f9;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .file-upload-label:hover {
            border-color: var(--primary-color);
            background: #f0f0f0;
        }

        .file-upload-label i {
            font-size: 2rem;
            color: #666;
            margin-bottom: 0.5rem;
        }

        .file-upload-label span {
            color: #666;
            font-size: 0.9rem;
        }

        .file-upload-label small {
            color: #999;
            font-size: 0.8rem;
            margin-top: 0.5rem;
        }

        .image-preview-container {
            margin-top: 1rem;
            text-align: center;
        }

        .image-preview {
            max-width: 100%;
            max-height: 200px;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            border: 1px solid #ddd;
            background: #f9f9f9;
        }

        .remove-image-btn {
            margin-top: 0.5rem;
            background: #dc3545;
            color: white;
            border: none;
            padding: 0.3rem 0.8rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .menu-card-admin {
            background: white;
            border-radius: 8px;
            padding: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 1rem;
        }

        .stock-badge {
            display: inline-block;
            padding: 0.2rem 0.5rem;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 500;
        }

        .stock-low {
            background: #fff3cd;
            color: #856404;
        }

        .stock-empty {
            background: #f8d7da;
            color: #721c24;
        }

        .stock-good {
            background: #d4edda;
            color: #155724;
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 1rem;
            z-index: 10000;
            transform: translateX(120%);
            transition: transform 0.3s;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.success {
            border-left: 4px solid var(--success-color);
        }

        .toast.error {
            border-left: 4px solid var(--danger-color);
        }

        .dashboard-section {
            display: block;
        }

        .text-center {
            text-align: center;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .chart-container {
            background: white;
            padding: 1.5rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
            overflow-x: auto;
        }
        
        .chart-title {
            margin-bottom: 1rem;
            color: var(--dark-color);
        }
        
        .report-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .summary-card {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .summary-card h4 {
            margin-bottom: 0.5rem;
            color: #666;
            font-size: 0.9rem;
        }
        
        .summary-card .value {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--primary-color);
        }
        
        .summary-card .subtext {
            font-size: 0.8rem;
            color: #999;
            margin-top: 0.5rem;
        }

        .analytics-section {
            background: white;
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow);
            overflow-x: auto;
        }

        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }

        .analytics-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1.5rem;
            border-left: 4px solid var(--primary-color);
        }

        .analytics-card h3 {
            margin-bottom: 1rem;
            color: var(--dark-color);
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .association-rule {
            background: white;
            border-radius: 6px;
            padding: 1rem;
            margin-bottom: 0.8rem;
            border: 1px solid #eee;
        }

        .rule-confidence {
            display: inline-block;
            background: #4CAF50;
            color: white;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            margin-left: 0.5rem;
        }

        .frequent-itemset {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            background: #e9ecef;
            border-radius: 4px;
            margin-bottom: 0.5rem;
            flex-wrap: wrap;
        }

        .support-badge {
            background: #17a2b8;
            color: white;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            margin-left: auto;
        }

        .filter-controls {
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .filter-controls label {
            font-weight: 500;
            color: var(--dark-color);
        }

        /* Profile Section Styles */
        .profile-container {
            max-width: 800px;
            margin: 0 auto;
        }

        .profile-header {
            background: linear-gradient(135deg, #8B4513 0%, #A0522D 100%);
            color: white;
            padding: 2rem;
            border-radius: var(--border-radius);
            margin-bottom: 2rem;
            display: flex;
            align-items: center;
            gap: 2rem;
        }

        .profile-avatar {
            width: 120px;
            height: 120px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-color);
            font-size: 3rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .profile-info h2 {
            margin: 0;
            font-size: 1.8rem;
        }

        .profile-info p {
            margin: 0.5rem 0 0 0;
            opacity: 0.9;
        }

        .profile-badge {
            display: inline-block;
            background: rgba(255,255,255,0.2);
            padding: 0.3rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }

        .profile-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 1.5rem;
        }

        .profile-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--shadow);
        }

        .profile-card h3 {
            margin-bottom: 1.5rem;
            color: var(--dark-color);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding-bottom: 0.8rem;
            border-bottom: 2px solid #f0f0f0;
        }

        .info-group {
            margin-bottom: 1.2rem;
        }

        .info-label {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 0.3rem;
            display: block;
        }

        .info-value {
            font-size: 1.1rem;
            color: var(--dark-color);
            font-weight: 500;
        }

        .stats-group {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-top: 1rem;
        }

        .stat-item {
            text-align: center;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .stat-item .value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary-color);
            display: block;
        }

        .stat-item .label {
            font-size: 0.9rem;
            color: #666;
            margin-top: 0.3rem;
        }

        .activity-item {
            padding: 1rem;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-icon {
            width: 40px;
            height: 40px;
            background: #f0f0f0;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-color);
        }

        .activity-content {
            flex: 1;
        }

        .activity-content p {
            margin: 0;
        }

        .activity-time {
            font-size: 0.8rem;
            color: #999;
        }

        .password-form {
            margin-top: 1.5rem;
        }

        /* WhatsApp Integration Styles */
        .whatsapp-badge {
            display: inline-block;
            background: #25D366;
            color: white;
            padding: 0.2rem 0.5rem;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 500;
            margin-left: 0.5rem;
        }

        .whatsapp-info {
            background: #e8f4f8;
            padding: 0.8rem;
            border-radius: 6px;
            margin: 0.5rem 0;
            border-left: 3px solid #25D366;
        }

        .whatsapp-info p {
            margin: 0.3rem 0;
            font-size: 0.9rem;
        }

        .whatsapp-button {
            background: #25D366;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 500;
            text-decoration: none;
        }

        .whatsapp-button:hover {
            background: #128C7E;
            color: white;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
            border: none;
        }

        .btn-warning:hover {
            background: #e0a800;
            color: #212529;
        }

        .status-rejected {
            background: #f5c6cb;
            color: #721c24;
        }

        .status-waiting_payment {
            background: #ffeaa7;
            color: #856404;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .login-box {
                padding: 30px 20px;
            }
            
            .admin-header {
                padding: 1rem;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .main-content {
                padding: 1rem;
            }
            
            .sidebar {
                width: 70px;
            }
            
            .sidebar-menu a span:not(.notification-count) {
                display: none;
            }
            
            .profile-header {
                flex-direction: column;
                text-align: center;
                gap: 1rem;
            }
            
            .profile-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 576px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .sidebar-menu {
                padding: 0;
            }
            
            .profile-header {
                padding: 1.5rem;
            }
            
            .profile-avatar {
                width: 100px;
                height: 100px;
                font-size: 2.5rem;
            }
        }

        /* WhatsApp Modal Styles */
        .whatsapp-modal .modal-content {
            max-width: 600px;
        }

        .whatsapp-proof-container {
            text-align: center;
            margin: 1rem 0;
        }

        .whatsapp-proof-image {
            max-width: 100%;
            max-height: 400px;
            border-radius: 8px;
            border: 1px solid #ddd;
            margin-bottom: 1rem;
        }

        .proof-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 1.5rem;
        }

        .proof-status {
            padding: 0.5rem;
            border-radius: 6px;
            font-weight: 500;
            margin-bottom: 1rem;
            text-align: center;
        }

        .proof-status.received {
            background: #d1ecf1;
            color: #0c5460;
            border-left: 4px solid #17a2b8;
        }

        .proof-status.waiting {
            background: #fff3cd;
            color: #856404;
            border-left: 4px solid #ffc107;
        }

        .proof-status.verified {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }

        .customer-info-box {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            border: 1px solid #e9ecef;
        }

        .customer-info-box h4 {
            margin-top: 0;
            color: var(--dark-color);
            font-size: 1rem;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #e9ecef;
        }

        .info-row:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .info-label {
            font-weight: 500;
            color: #666;
        }
        /* ========== TOOLTIP STYLES ========== */
/* Tooltip untuk tombol WhatsApp */
.btn-warning[title] {
    position: relative;
    cursor: pointer;
}

.btn-warning[title]:hover::after {
    content: attr(title);
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0, 0, 0, 0.8);
    color: white;
    padding: 0.5rem 0.8rem;
    border-radius: 4px;
    font-size: 0.75rem;
    white-space: nowrap;
    z-index: 1000;
    margin-bottom: 0.5rem;
    pointer-events: none;
    animation: fadeIn 0.2s ease;
}

/* Tooltip untuk semua tombol dengan title */
.btn[title]:hover::after {
    content: attr(title);
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0, 0, 0, 0.8);
    color: white;
    padding: 0.5rem 0.8rem;
    border-radius: 4px;
    font-size: 0.75rem;
    white-space: nowrap;
    z-index: 1000;
    margin-bottom: 0.5rem;
    pointer-events: none;
    animation: fadeIn 0.2s ease;
}

/* Untuk tombol di dalam action-buttons */
.action-buttons .btn {
    position: relative;
}

/* Tambahkan juga untuk tombol lainnya jika perlu */
.btn-primary[title]:hover::after,
.btn-success[title]:hover::after,
.btn-danger[title]:hover::after {
    content: attr(title);
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0, 0, 0, 0.8);
    color: white;
    padding: 0.5rem 0.8rem;
    border-radius: 4px;
    font-size: 0.75rem;
    white-space: nowrap;
    z-index: 1000;
    margin-bottom: 0.5rem;
    pointer-events: none;
    animation: fadeIn 0.2s ease;
}

        .info-value {
            text-align: right;
            color: var(--dark-color);
        }

        .whatsapp-contact {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            background: white;
            border-radius: 6px;
            margin: 0.5rem 0;
            border: 1px solid #ddd;
        }

        .whatsapp-contact a {
            color: #25D366;
            text-decoration: none;
            font-weight: 500;
        }

        .whatsapp-contact a:hover {
            text-decoration: underline;
        }
        .whatsapp-status-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.3rem;
    padding: 0.3rem 0.6rem;
    border-radius: 12px;
    font-size: 0.8rem;
    font-weight: 500;
    white-space: nowrap;
}

.whatsapp-status-badge.verified {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.whatsapp-status-badge.received {
    background: #d1ecf1;
    color: #0c5460;
    border: 1px solid #bee5eb;
}

.whatsapp-status-badge.waiting {
    background: #fff3cd;
    color: #856404;
    border: 1px solid #ffeaa7;
}

/* Perbarui struktur tabel */
.data-table th:nth-child(6) {
    width: 120px;
}

.data-table th:nth-child(7) {
    width: 200px;
}
    </style>
</head>
<body>
    <!-- ========== LOGIN SCREEN ========== -->
    <div class="login-container" id="loginContainer">
        <div class="login-box">
           <div class="login-logo">
                <div class="custom-logo">
                    <img src="gambar/logo.jpeg" alt="MAN CAFE Logo">
                </div>
                <h1>MAN CAFE</h1>
                <span>Admin Dashboard Login</span>
            </div>
            
            <div class="login-error" id="loginError">
                <i class="fas fa-exclamation-circle"></i>
                <span id="errorText"></span>
            </div>
            
            <form id="loginForm" autocomplete="off">
                <div class="form-group">
                    <label for="loginEmail">Email</label>
                    <input type="email" id="loginEmail" class="form-control" placeholder="Masukkan email" required autocomplete="off">
                </div>
                
                <div class="form-group">
                    <label for="loginPassword">Password</label>
                    <input type="password" id="loginPassword" class="form-control" placeholder="Masukkan password" required autocomplete="off">
                </div>
                
                <button type="submit" class="btn-login" id="loginButton">
                    <span id="loginButtonText">Login ke Dashboard</span>
                </button>
            </form>
            
            
        </div>
    </div>

    <!-- ========== ADMIN DASHBOARD (Hidden by default) ========== -->
    <div class="admin-container" id="adminContainer">
        <!-- Header -->
        <header class="admin-header">
           <a href="#" class="logo" onclick="showSection('dashboard')">
                <div class="logo-icon">
                    <img src="gambar/logo.jpeg" 
                         alt="MAN CAFE Admin Logo"
                         style="width: 45px; height: 45px; object-fit: contain; border-radius: 50%;">
                </div>
                <div class="logo-text">
                    <h1>MAN CAFE</h1>
                    <span>Admin Dashboard</span>
                </div>
            </a>
            
            <div class="admin-controls">
                <div class="notification-bell" onclick="showNotifications()">
                    <i class="fas fa-bell"></i>
                    <span class="notification-count" id="notificationCount">0</span>
                </div>
                
                <div class="admin-user" onclick="toggleUserMenu()">
                    <div class="user-avatar" style="width: 40px; height: 40px; background: var(--primary-color); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white;">
                        <i class="fas fa-user"></i>
                    </div>
                    <span id="userName">Admin</span>
                    <i class="fas fa-chevron-down" style="font-size: 0.9rem;"></i>
                    <div class="user-menu" id="userMenu">
                        <div class="user-menu-item" onclick="showSection('profile')">
                            <i class="fas fa-user"></i>
                            <span>Profil Admin</span>
                        </div>
                        <div class="user-menu-item logout" onclick="logout()">
                            <i class="fas fa-sign-out-alt"></i>
                            <span>Logout</span>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Dashboard Layout -->
        <div class="dashboard-container">
            <!-- Sidebar -->
            <nav class="sidebar">
                <ul class="sidebar-menu">
                    <li><a href="#" class="active" onclick="showSection('dashboard')">
                        <i class="fas fa-tachometer-alt"></i> Dashboard
                    </a></li>
                    <li><a href="#" onclick="showSection('orders')">
                        <i class="fas fa-shopping-cart"></i> Pesanan Baru
                        <span class="notification-count" id="sidebarOrderCount" style="margin-left: auto;">0</span>
                    </a></li>
                    <li><a href="#" onclick="showSection('reservations')">
                        <i class="fas fa-calendar-check"></i> Reservasi
                        <span class="notification-count" id="sidebarReservationCount" style="margin-left: auto;">0</span>
                    </a></li>
                    <li><a href="#" onclick="showSection('all-orders')">
                        <i class="fas fa-clipboard-list"></i> Semua Pesanan
                    </a></li>
                    <li><a href="#" onclick="showSection('all-reservations')">
                        <i class="fas fa-calendar-alt"></i> Semua Reservasi
                    </a></li>
                    <li><a href="#" onclick="showSection('menu')">
                        <i class="fas fa-utensils"></i> Kelola Menu
                    </a></li>
                    <li><a href="#" onclick="showSection('tables')">
                        <i class="fas fa-chair"></i> Kelola Meja
                    </a></li>
                    <li><a href="#" onclick="showSection('reports')">
                        <i class="fas fa-chart-bar"></i> Laporan
                    </a></li>
                    <li><a href="#" onclick="showSection('analytics')">
                        <i class="fas fa-chart-pie"></i> Analisis Menu
                    </a></li>
                </ul>
            </nav>

            <!-- Main Content -->
            <main class="main-content">
                <!-- Dashboard Section -->
                <section id="dashboard-section" class="dashboard-section">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon" style="background: linear-gradient(135deg, #4CAF50, #2E8B57);">
                                <i class="fas fa-shopping-cart"></i>
                            </div>
                            <div class="stat-info">
                                <h3>Pesanan Hari Ini</h3>
                                <p class="stat-number" id="todayOrders">0</p>
                                <p class="stat-change positive">
                                    <i class="fas fa-arrow-up"></i> 
                                </p>
                            </div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-icon" style="background: linear-gradient(135deg, #2196F3, #0D47A1);">
                                <i class="fas fa-users"></i>
                            </div>
                            <div class="stat-info">
                                <h3>Pelanggan Baru</h3>
                                <p class="stat-number" id="newCustomers">0</p>
                                <p class="stat-change positive">
                                    <i class="fas fa-arrow-up"></i> 
                                </p>
                            </div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-icon" style="background: linear-gradient(135deg, #FF9800, #FF5722);">
                                <i class="fas fa-money-bill-wave"></i>
                            </div>
                            <div class="stat-info">
                                <h3>Pendapatan Hari Ini</h3>
                                <p class="stat-number" id="todayRevenue">Rp 0</p>
                                <p class="stat-change positive">
                                    <i class="fas fa-arrow-up"></i> 
                                </p>
                            </div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-icon" style="background: linear-gradient(135deg, #9C27B0, #6A1B9A);">
                                <i class="fas fa-clock"></i>
                            </div>
                            <div class="stat-info">
                                <h3>Pesanan Menunggu</h3>
                                <p class="stat-number" id="pendingOrders">0</p>
                                <p class="stat-change negative">
                                    <i class="fas fa-clock"></i> Butuh perhatian
                                </p>
                            </div>
                        </div>
                    </div>

                    <div class="table-container">
                        <div class="table-header">
                            <h2>Aktivitas Terbaru</h2>
                            <button class="btn btn-primary" onclick="refreshData()">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                        </div>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Waktu</th>
                                    <th>Aktivitas</th>
                                    <th>Detail</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="activityTable">
                                <tr>
                                    <td colspan="4" style="text-align: center; padding: 2rem;">
                                        <div class="loading"></div> Memuat aktivitas...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </section>

                <!-- New Orders Section -->
                <section id="orders-section" class="dashboard-section" style="display: none;">
                    <div class="table-container">
                        <div class="table-header">
                            <h2>Pesanan Baru</h2>
                            <div class="action-buttons">
                                <button class="btn btn-primary" onclick="refreshOrders()">
                                    <i class="fas fa-sync-alt"></i> Refresh
                                </button>
                            </div>
                        </div>
                        <table class="data-table">
                         
<thead>
    <tr>
        <th>No. Order</th>
        <th>Pelanggan</th>
        <th>Total</th>
        <th>Waktu Pesan</th>
        <th>Status Pesanan</th>
        <th>Status WhatsApp</th>
        <th>Aksi</th>
    </tr>
</thead>
                            <tbody id="newOrdersTable">
                                <tr>
                                    <td colspan="6" style="text-align: center; padding: 2rem;">
                                        <div class="loading"></div> Memuat pesanan...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </section>

                <!-- Reservations Section -->
                <section id="reservations-section" class="dashboard-section" style="display: none;">
                    <div class="table-container">
                        <div class="table-header">
                            <h2>Reservasi Baru</h2>
                            <button class="btn btn-primary" onclick="refreshReservations()">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                        </div>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>No. Reservasi</th>
                                    <th>Nama</th>
                                    <th>Tanggal</th>
                                    <th>Waktu</th>
                                    <th>Meja</th>
                                    <th>Status</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="reservationsTable">
                                <tr>
                                    <td colspan="7" style="text-align: center; padding: 2rem;">
                                        <div class="loading"></div> Memuat reservasi...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </section>

                <!-- All Orders Section -->
                <section id="all-orders-section" class="dashboard-section" style="display: none;">
                    <div class="table-container">
                        <div class="table-header">
                            <h2>Semua Pesanan</h2>
                            <div class="action-buttons">
                                <select class="form-control" style="width: 150px;" onchange="filterAllOrders(this.value)">
                                    <option value="all">Semua Status</option>
                                    <option value="pending">Menunggu</option>
                                    <option value="waiting_payment">Menunggu Pembayaran</option>
                                    <option value="confirmed">Dikonfirmasi</option>
                                    <option value="completed">Selesai</option>
                                    <option value="cancelled">Dibatalkan</option>
                                </select>
                                <button class="btn btn-primary" onclick="refreshAllOrders()">
                                    <i class="fas fa-sync-alt"></i> Refresh
                                </button>
                            </div>
                        </div>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>No. Order</th>
                                    <th>Pelanggan</th>
                                    <th>Total</th>
                                    <th>Tanggal Pesan</th>
                                    <th>Status</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="allOrdersTable">
                                <tr>
                                    <td colspan="6" style="text-align: center; padding: 2rem;">
                                        <div class="loading"></div> Memuat semua pesanan...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </section>

                <!-- All Reservations Section -->
                <section id="all-reservations-section" class="dashboard-section" style="display: none;">
                    <div class="table-container">
                        <div class="table-header">
                            <h2>Semua Reservasi</h2>
                            <div class="action-buttons">
                                <select class="form-control" style="width: 150px;" onchange="filterAllReservations(this.value)">
                                    <option value="all">Semua Status</option>
                                    <option value="pending">Menunggu</option>
                                    <option value="confirmed">Dikonfirmasi</option>
                                    <option value="cancelled">Dibatalkan</option>
                                </select>
                                <button class="btn btn-primary" onclick="refreshAllReservations()">
                                    <i class="fas fa-sync-alt"></i> Refresh
                                </button>
                            </div>
                        </div>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>No. Reservasi</th>
                                    <th>Nama</th>
                                    <th>Tanggal</th>
                                    <th>Waktu</th>
                                    <th>Meja</th>
                                    <th>Status</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="allReservationsTable">
                                <tr>
                                    <td colspan="7" style="text-align: center; padding: 2rem;">
                                        <div class="loading"></div> Memuat semua reservasi...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </section>

                <!-- Menu Management Section -->
                <section id="menu-section" class="dashboard-section" style="display: none;">
                    <div class="table-container">
                        <div class="table-header">
                            <h2>Kelola Menu</h2>
                            <button class="btn btn-primary" onclick="openAddMenuModal()">
                                <i class="fas fa-plus"></i> Tambah Menu
                            </button>
                        </div>
                        <div id="menuListContainer" style="padding: 1.5rem;">
                            <div style="text-align: center; padding: 3rem; color: #666;">
                                <div class="loading"></div>
                                <p style="margin-top: 1rem;">Memuat menu...</p>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Tables Management Section -->
                <section id="tables-section" class="dashboard-section" style="display: none;">
                    <div class="table-container">
                        <div class="table-header">
                            <h2>Kelola Meja</h2>
                            <button class="btn btn-primary" onclick="openAddTableModal()">
                                <i class="fas fa-plus"></i> Tambah Meja
                            </button>
                        </div>
                        <div id="tablesListContainer" style="padding: 1.5rem;">
                            <div style="text-align: center; padding: 3rem; color: #666;">
                                <div class="loading"></div>
                                <p style="margin-top: 1rem;">Memuat data meja...</p>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Reports Section -->
                <section id="reports-section" class="dashboard-section" style="display: none;">
                    <div class="table-container">
                        <div class="table-header">
                            <h2>Laporan Penjualan</h2>
                            <div class="action-buttons">
                                <button class="btn btn-primary" onclick="generatePDFReport()">
                                    <i class="fas fa-download"></i> Download PDF
                                </button>
                            </div>
                        </div>
                        
                        <div class="report-filters">
                            <div class="filter-group">
                                <label for="reportType">Tipe Laporan</label>
                                <select class="form-control" id="reportType" onchange="changeReportType()" style="width: 150px;">
                                    <option value="daily">Harian</option>
                                    <option value="monthly">Bulanan</option>
                                    <option value="custom">Custom Range</option>
                                </select>
                            </div>
                            
                            <div class="filter-group" id="dailyFilter">
                                <label for="reportDate">Tanggal</label>
                                <input type="date" class="form-control" id="reportDate" value="">
                            </div>
                            
                            <div class="filter-group" id="monthlyFilter" style="display: none;">
                                <label for="reportMonth">Bulan</label>
                                <input type="month" class="form-control" id="reportMonth" value="">
                            </div>
                            
                            <div class="filter-group" id="customFilter" style="display: none;">
                                <label for="startDate">Dari Tanggal</label>
                                <input type="date" class="form-control" id="startDate" value="">
                                <label for="endDate" style="margin-top: 0.5rem;">Sampai Tanggal</label>
                                <input type="date" class="form-control" id="endDate" value="">
                            </div>
                            
                            <div class="filter-group">
                                <label>&nbsp;</label>
                                <button class="btn btn-primary" onclick="loadReportData()">
                                    <i class="fas fa-filter"></i> Terapkan Filter
                                </button>
                            </div>
                        </div>

                        <div class="report-summary" id="reportSummary">
                            <div class="summary-card">
                                <h4>Total Pendapatan</h4>
                                <div class="value" id="summaryRevenue">Rp 0</div>
                                <div class="subtext">Dari semua pesanan</div>
                            </div>
                            <div class="summary-card">
                                <h4>Total Pesanan</h4>
                                <div class="value" id="summaryOrders">0</div>
                                <div class="subtext">Pesanan selesai</div>
                            </div>
                            <div class="summary-card">
                                <h4>Rata-rata Pesanan</h4>
                                <div class="value" id="summaryAverage">Rp 0</div>
                                <div class="subtext">Per transaksi</div>
                            </div>
                            <div class="summary-card">
                                <h4>Pelanggan</h4>
                                <div class="value" id="summaryCustomers">0</div>
                                <div class="subtext">Pelanggan unik</div>
                            </div>
                        </div>
                        
                        <div class="chart-container">
                            <h3 class="chart-title">Grafik Penjualan</h3>
                            <div id="salesChart" style="height: 300px; padding: 1rem; border: 1px solid #eee; border-radius: 8px;">
                                <div style="text-align: center; padding: 5rem; color: #666;">
                                    <div class="loading"></div>
                                    <p style="margin-top: 1rem;">Memuat grafik...</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="chart-container">
                            <h3 class="chart-title">Detail Laporan</h3>
                            <div style="overflow-x: auto;">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>Tanggal</th>
                                            <th>No. Order</th>
                                            <th>Pelanggan</th>
                                            <th>Items</th>
                                            <th>Total</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="reportsTable">
                                        <tr>
                                            <td colspan="6" style="text-align: center; padding: 3rem; color: #666;">
                                                <div class="loading"></div> 
                                                <p>Memuat laporan...</p>
                                                <p style="font-size: 0.9rem; margin-top: 0.5rem;">Gunakan filter di atas untuk menampilkan laporan</p>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Analytics Section -->
                <section id="analytics-section" class="dashboard-section" style="display: none;">
                    <div class="table-container">
                        <div class="table-header">
                            <h2>Analisis Pola Pembelian Menu</h2>
                            <button class="btn btn-primary" onclick="runAprioriAnalysis()">
                                <i class="fas fa-sync-alt"></i> Analisis Ulang
                            </button>
                        </div>
                        
                        <div id="analysisStatus" style="margin: 1rem 0; padding: 0.5rem; background: #f8f9fa; border-radius: 4px; display: none;">
                            <div class="loading" style="display: inline-block; margin-right: 0.5rem;"></div>
                            <span id="statusText">Menganalisis data...</span>
                        </div>
                        
                        <div class="filter-controls">
                            <div class="filter-group">
                                <label for="minSupport">Min Support (%)</label>
                                <input type="range" id="minSupport" min="1" max="30" value="10" 
                                       class="form-control" style="width: 200px;"
                                       onchange="document.getElementById('supportValue').textContent = this.value + '%'">
                                <span id="supportValue" style="font-weight: bold;">10%</span>
                            </div>
                            
                            <div class="filter-group">
                                <label for="minConfidence">Min Confidence (%)</label>
                                <input type="range" id="minConfidence" min="50" max="100" value="70" 
                                       class="form-control" style="width: 200px;"
                                       onchange="document.getElementById('confidenceValue').textContent = this.value + '%'">
                                <span id="confidenceValue" style="font-weight: bold;">70%</span>
                            </div>
                            
                            <div class="filter-group">
                                <label for="periodFilter">Periode Analisis</label>
                                <select id="periodFilter" class="form-control" style="width: 150px;">
                                    <option value="30">30 Hari Terakhir</option>
                                    <option value="7">7 Hari Terakhir</option>
                                    <option value="90">90 Hari Terakhir</option>
                                    <option value="all">Semua Data</option>
                                </select>
                            </div>
                            
                            <div class="filter-group">
                                <label>&nbsp;</label>
                                <button class="btn btn-secondary" onclick="checkDatabaseConnection()">
                                    <i class="fas fa-database"></i> Cek Data
                                </button>
                            </div>
                        </div>
                        
                        <div class="analytics-grid">
                            <div class="analytics-card">
                                <h3><i class="fas fa-boxes"></i> Itemset yang Sering Dibeli Bersama</h3>
                                <div id="frequentItemsets">
                                    <div style="text-align: center; padding: 2rem; color: #666;">
                                        <div class="loading"></div>
                                        <p>Menganalisis pola pembelian...</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="analytics-card">
                                <h3><i class="fas fa-project-diagram"></i> Aturan Asosiasi</h3>
                                <div id="associationRules">
                                    <div style="text-align: center; padding: 2rem; color: #666;">
                                        <div class="loading"></div>
                                        <p>Menghasilkan aturan asosiasi...</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="analytics-card" style="grid-column: 1 / -1;">
                                <h3><i class="fas fa-lightbulb"></i> Rekomendasi Bisnis</h3>
                                <div id="businessRecommendations">
                                    <div style="text-align: center; padding: 2rem; color: #666;">
                                        <div class="loading"></div>
                                        <p>Membuat rekomendasi...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Profile Section -->
                <section id="profile-section" class="dashboard-section" style="display: none;">
                    <div class="profile-container">
                        <div class="profile-header">
                            <div class="profile-avatar">
                                <i class="fas fa-user-shield"></i>
                            </div>
                            <div class="profile-info">
                                <h2 id="profileName">Administrator</h2>
                                <p id="profileEmail">admin@mancafe.com</p>
                                <span class="profile-badge">Super Admin</span>
                            </div>
                        </div>

                        <div class="profile-grid">
                            <div class="profile-card">
                                <h3><i class="fas fa-info-circle"></i> Informasi Profil</h3>
                                <div class="info-group">
                                    <span class="info-label">Nama Lengkap</span>
                                    <div class="info-value" id="profileFullName">Administrator Man Cafe</div>
                                </div>
                                <div class="info-group">
                                    <span class="info-label">Email</span>
                                    <div class="info-value" id="profileEmailDetail">admin@mancafe.com</div>
                                </div>
                                <div class="info-group">
                                    <span class="info-label">Role</span>
                                    <div class="info-value">Super Administrator</div>
                                </div>
                                <div class="info-group">
                                    <span class="info-label">Bergabung Sejak</span>
                                    <div class="info-value" id="profileJoinDate">1 Januari 2024</div>
                                </div>
                                <div class="info-group">
                                    <span class="info-label">Status Akun</span>
                                    <div class="info-value">
                                        <span style="color: #28a745; font-weight: bold;">
                                            <i class="fas fa-check-circle"></i> Aktif
                                        </span>
                                    </div>
                                </div>
                            </div>

                            <div class="profile-card">
                                <h3><i class="fas fa-chart-line"></i> Statistik Admin</h3>
                                <div class="stats-group">
                                    <div class="stat-item">
                                        <span class="value" id="profileTotalOrders">0</span>
                                        <span class="label">Total Pesanan Dikelola</span>
                                    </div>
                                    <div class="stat-item">
                                        <span class="value" id="profileTotalRevenue">Rp 0</span>
                                        <span class="label">Total Pendapatan</span>
                                    </div>
                                    <div class="stat-item">
                                        <span class="value" id="profileActiveMenus">0</span>
                                        <span class="label">Menu Aktif</span>
                                    </div>
                                    <div class="stat-item">
                                        <span class="value" id="profileTablesCount">0</span>
                                        <span class="label">Meja Tersedia</span>
                                    </div>
                                </div>
                                
                                <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid #eee;">
                                    <h4><i class="fas fa-cogs"></i> Sistem</h4>
                                    <div class="info-group" style="margin-bottom: 0.8rem;">
                                        <span class="info-label">Versi Dashboard</span>
                                        <div class="info-value">v2.1.0</div>
                                    </div>
                                    <div class="info-group">
                                        <span class="info-label">Mode Koneksi</span>
                                        <div class="info-value" id="profileConnectionMode">
                                            <span style="color: #28a745;">
                                                <i class="fas fa-wifi"></i> Online
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="profile-card" style="grid-column: 1 / -1;">
                                <h3><i class="fas fa-history"></i> Aktivitas Terakhir</h3>
                                <div id="profileActivities">
                                    <div class="activity-item">
                                        <div class="activity-icon">
                                            <i class="fas fa-sign-in-alt"></i>
                                        </div>
                                        <div class="activity-content">
                                            <p><strong>Login berhasil</strong></p>
                                            <p class="activity-time">Hari ini, 10:30 WIB</p>
                                        </div>
                                    </div>
                                    <div class="activity-item">
                                        <div class="activity-icon">
                                            <i class="fas fa-shopping-cart"></i>
                                        </div>
                                        <div class="activity-content">
                                            <p><strong>Mengkonfirmasi pesanan #ORD-00123</strong></p>
                                            <p class="activity-time">Kemarin, 14:45 WIB</p>
                                        </div>
                                    </div>
                                    <div class="activity-item">
                                        <div class="activity-icon">
                                            <i class="fas fa-utensils"></i>
                                        </div>
                                        <div class="activity-content">
                                            <p><strong>Menambahkan menu baru: "Cappuccino Special"</strong></p>
                                            <p class="activity-time">2 hari yang lalu, 09:15 WIB</p>
                                        </div>
                                    </div>
                                    <div class="activity-item">
                                        <div class="activity-icon">
                                            <i class="fas fa-chart-bar"></i>
                                        </div>
                                        <div class="activity-content">
                                            <p><strong>Membuat laporan penjualan bulanan</strong></p>
                                            <p class="activity-time">3 hari yang lalu, 16:30 WIB</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            </main>
        </div>

        <!-- Modals -->
        <div id="orderDetailModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Detail Pesanan</h2>
                    <button class="close-modal" onclick="closeModal('orderDetailModal')">&times;</button>
                </div>
                <div id="orderDetailContent">
                    <div style="text-align: center; padding: 2rem;">
                        <div class="loading"></div>
                        <p style="margin-top: 1rem;">Memuat detail pesanan...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- WhatsApp Transfer Proof Modal -->
        <div id="whatsappProofModal" class="modal whatsapp-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2><i class="fab fa-whatsapp" style="color: #25D366;"></i> Bukti Transfer via WhatsApp</h2>
                    <button class="close-modal" onclick="closeModal('whatsappProofModal')">&times;</button>
                </div>
                <div id="whatsappProofContent">
                    <div style="text-align: center; padding: 2rem;">
                        <div class="loading"></div>
                        <p style="margin-top: 1rem;">Memuat informasi WhatsApp...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- WhatsApp Message Modal -->
        <div id="whatsappMessageModal" class="modal">
            <div class="modal-content" style="max-width: 400px;">
                <div class="modal-header">
                    <h2><i class="fab fa-whatsapp" style="color: #25D366;"></i> Kirim Pesan WhatsApp</h2>
                    <button class="close-modal" onclick="closeModal('whatsappMessageModal')">&times;</button>
                </div>
                <div id="whatsappMessageContent">
                    <div class="form-group">
                        <label for="whatsappPhone">Nomor WhatsApp Pelanggan</label>
                        <input type="text" id="whatsappPhone" class="form-control" placeholder="Contoh: 6281234567890" required>
                    </div>
                    <div class="form-group">
                        <label for="whatsappMessage">Pesan</label>
                        <textarea id="whatsappMessage" class="form-control" rows="5" placeholder="Tulis pesan untuk pelanggan..."></textarea>
                    </div>
                    <button class="btn btn-primary" onclick="sendWhatsAppMessage()" style="width: 100%;">
                        <i class="fab fa-whatsapp"></i> Kirim ke WhatsApp
                    </button>
                </div>
            </div>
        </div>

        <!-- Confirm WhatsApp Modal -->
        <div id="confirmWhatsAppModal" class="modal">
            <div class="modal-content" style="max-width: 500px;">
                <div class="modal-header">
                    <h2><i class="fab fa-whatsapp" style="color: #25D366;"></i> Konfirmasi Bukti Transfer</h2>
                    <button class="close-modal" onclick="closeModal('confirmWhatsAppModal')">&times;</button>
                </div>
                <div id="confirmWhatsAppContent">
                    <div style="padding: 1rem;">
                        <p>Apakah pelanggan sudah mengirimkan bukti transfer melalui WhatsApp?</p>
                        <div style="margin: 1.5rem 0; padding: 1rem; background: #f8f9fa; border-radius: 8px;">
                            <p><strong>Petunjuk:</strong></p>
                            <ol style="padding-left: 1.5rem; margin: 0.5rem 0;">
                                <li>Periksa WhatsApp Admin</li>
                                <li>Cari pesan dari nomor pelanggan</li>
                                <li>Pastikan bukti transfer sudah diterima</li>
                                <li>Verifikasi jumlah dan detail transfer</li>
                            </ol>
                        </div>
                        <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                            <button class="btn btn-success" onclick="markProofReceived()" style="flex: 1;">
                                <i class="fas fa-check"></i> Sudah Dikirim
                            </button>
                            <button class="btn btn-warning" onclick="remindCustomer()" style="flex: 1;">
                                <i class="fas fa-bell"></i> Ingatkan Pelanggan
                            </button>
                            <button class="btn btn-danger" onclick="closeModal('confirmWhatsAppModal')" style="flex: 1;">
                                <i class="fas fa-times"></i> Batal
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="reservationDetailModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Detail Reservasi</h2>
                    <button class="close-modal" onclick="closeModal('reservationDetailModal')">&times;</button>
                </div>
                <div id="reservationDetailContent">
                    <div style="text-align: center; padding: 2rem;">
                        <div class="loading"></div>
                        <p style="margin-top: 1rem;">Memuat detail reservasi...</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="menuModal" class="modal">
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header">
                    <h2 id="menuModalTitle">Tambah Menu</h2>
                    <button class="close-modal" onclick="closeModal('menuModal')">&times;</button>
                </div>
                <form id="menuForm">
                    <input type="hidden" id="menuId">
                    <div class="form-group">
                        <label for="menuName">Nama Menu *</label>
                        <input type="text" class="form-control" id="menuName" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="menuPrice">Harga *</label>
                        <input type="number" class="form-control" id="menuPrice" required min="1000">
                    </div>
                    
                    <div class="form-group">
                        <label for="menuStock">Stok *</label>
                        <input type="number" class="form-control" id="menuStock" required min="0" value="10">
                    </div>
                    
                    <div class="form-group">
                        <label for="menuCategory">Kategori *</label>
                        <select class="form-control" id="menuCategory" required>
                            <option value="minuman">Minuman</option>
                            <option value="makanan">Makanan</option>
                            <option value="snack">Snack</option>
                            <option value="dessert">Dessert</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="stockManagement">Jenis Pengelolaan Stok</label>
                        <select class="form-control" id="stockManagement" onchange="toggleDailyStockOption()">
                            <option value="regular">Stok Reguler</option>
                            <option value="daily">Stok Harian</option>
                        </select>
                    </div>
                    
                    <div class="form-group" id="dailyStockContainer" style="display: none;">
                        <label for="dailyStock">Stok Harian (reset setiap hari) *</label>
                        <input type="number" class="form-control" id="dailyStock" min="0" value="0">
                        <small style="color: #666;">Stok yang akan direset setiap hari.</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="menuImage">Gambar Menu</label>
                        <div class="file-upload-container">
                            <div class="file-upload">
                                <input type="file" class="file-upload-input" id="menuImage" accept="image/*">
                                <label for="menuImage" class="file-upload-label">
                                    <i class="fas fa-cloud-upload-alt"></i>
                                    <span>Klik untuk mengunggah gambar</span>
                                    <small>Format: JPG, PNG, GIF (Maks: 2MB)</small>
                                </label>
                            </div>
                            <div class="image-preview-container" id="imagePreviewContainer" style="display: none;">
                                <img src="" alt="Preview" class="image-preview" id="imagePreview">
                                <button type="button" class="remove-image-btn" onclick="removeImage()">
                                    <i class="fas fa-trash"></i> Hapus Gambar
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="menuDescription">Deskripsi</label>
                        <textarea class="form-control" id="menuDescription" rows="3" placeholder="Deskripsi menu..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <div class="form-check" style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                            <input type="checkbox" class="form-check-input" id="menuIsPromo">
                            <label class="form-check-label" for="menuIsPromo" style="font-weight: normal;">
                                Tandai sebagai Menu Promo
                            </label>
                        </div>
                    </div>
                    
                    <div class="form-group" id="originalPriceContainer" style="display: none;">
                        <label for="menuOriginalPrice">Harga Asli (sebelum diskon)</label>
                        <input type="number" class="form-control" id="menuOriginalPrice" min="1000">
                    </div>
                    
                    <button type="submit" class="btn btn-primary" style="width: 100%;">
                        <i class="fas fa-save"></i> Simpan Menu
                    </button>
                </form>
            </div>
        </div>

        <div id="tableModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="tableModalTitle">Tambah Meja</h2>
                    <button class="close-modal" onclick="closeModal('tableModal')">&times;</button>
                </div>
                <form id="tableForm">
                    <input type="hidden" id="tableId">
                    <div class="form-group">
                        <label for="tableNumber">Nomor Meja *</label>
                        <input type="text" class="form-control" id="tableNumber" required placeholder="Misal: 1, 2, A1, B2">
                    </div>
                    <div class="form-group">
                        <label for="tableCapacity">Kapasitas *</label>
                        <input type="number" class="form-control" id="tableCapacity" required min="1" max="20" placeholder="Jumlah kursi">
                    </div>
                    <div class="form-group">
                        <label for="tableLocation">Lokasi</label>
                        <select class="form-control" id="tableLocation">
                            <option value="indoor">Indoor</option>
                            <option value="outdoor">Outdoor</option>
                            <option value="smoking_area">Smoking Area</option>
                            <option value="vip">VIP Room</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="tableStatus">Status</label>
                        <select class="form-control" id="tableStatus">
                            <option value="available">Tersedia</option>
                            <option value="occupied">Terisi</option>
                            <option value="reserved">Dipesan</option>
                            <option value="maintenance">Perbaikan</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="tableDescription">Keterangan (opsional)</label>
                        <textarea class="form-control" id="tableDescription" rows="2" placeholder="Misal: meja dekat jendela, meja romantis, dll."></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%;">
                        <i class="fas fa-save"></i> Simpan Meja
                    </button>
                </form>
            </div>
        </div>
    </div>

    <script>
        // ============================
        // GLOBAL VARIABLES
        // ============================
        let adminSystem = null;
        let currentSection = 'dashboard';
        let currentImageBase64 = null;
        let currentReportData = [];
        let currentUser = null;
        let currentOrderForWhatsApp = null;

        // ============================
        // LOGIN SYSTEM
        // ============================
        async function initLogin() {
            console.log(' Initializing login system...');
            
            // Clear login form
            document.getElementById('loginEmail').value = '';
            document.getElementById('loginPassword').value = '';
            
            // Check if user is already logged in
            const storedUser = localStorage.getItem('man_cafe_admin_user');
            if (storedUser) {
                try {
                    currentUser = JSON.parse(storedUser);
                    const { data: { session }, error } = await supabaseClient.auth.getSession();
                    
                    if (session && !error) {
                        // User has valid session, show dashboard
                        showDashboard();
                        return;
                    } else {
                        // Session expired, clear storage
                        localStorage.removeItem('man_cafe_admin_user');
                        currentUser = null;
                    }
                } catch (error) {
                    console.error('Session check error:', error);
                }
            }
            
            // Show login screen
            showLogin();
        }

        async function handleLogin(event) {
            event.preventDefault();
            
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const loginError = document.getElementById('loginError');
            const loginButton = document.getElementById('loginButton');
            const loginButtonText = document.getElementById('loginButtonText');
            
            // Show loading state
            loginButton.disabled = true;
            loginButtonText.innerHTML = '<div class="loading" style="margin-right: 8px;"></div> Logging in...';
            loginError.classList.remove('show');
            
            try {
                // Try Supabase auth first
                const { data, error } = await supabaseClient.auth.signInWithPassword({
                    email: email,
                    password: password
                });
                
                if (error) {
                    // If Supabase auth fails, use demo credentials
                    if (email === 'admin@mancafe.com' && password === 'admin123') {
                        // Demo login success
                        currentUser = {
                            id: 'demo-admin-001',
                            email: email,
                            name: 'Admin Demo',
                            role: 'admin',
                            isDemo: true,
                            joinDate: '1 Januari 2024',
                            fullName: 'Administrator Man Cafe'
                        };
                        
                        localStorage.setItem('man_cafe_admin_user', JSON.stringify(currentUser));
                        showDashboard();
                        showToast('Login berhasil! (Demo Mode)', 'success');
                        return;
                    }
                    
                    throw error;
                }
                
                // Supabase login success
                currentUser = {
                    id: data.user.id,
                    email: data.user.email,
                    name: data.user.user_metadata?.name || 'Admin',
                    fullName: data.user.user_metadata?.full_name || 'Administrator',
                    role: 'admin',
                    isDemo: false,
                    joinDate: new Date(data.user.created_at).toLocaleDateString('id-ID', {
                        day: 'numeric',
                        month: 'long',
                        year: 'numeric'
                    })
                };
                
                localStorage.setItem('man_cafe_admin_user', JSON.stringify(currentUser));
                showDashboard();
                showToast('Login berhasil!', 'success');
                
            } catch (error) {
                console.error('Login error:', error);
                
                // Show error message
                let errorMessage = 'Login gagal. ';
                if (error.message.includes('Invalid login credentials')) {
                    errorMessage += 'Email atau password salah.';
                } else if (error.message.includes('Email not confirmed')) {
                    errorMessage += 'Email belum dikonfirmasi.';
                } else if (error.message.includes('Network')) {
                    errorMessage += 'Koneksi jaringan bermasalah. Gunakan demo credentials.';
                } else {
                    errorMessage += error.message;
                }
                
                document.getElementById('errorText').textContent = errorMessage;
                loginError.classList.add('show');
                
                // Reset button
                loginButton.disabled = false;
                loginButtonText.textContent = 'Login to Dashboard';
            }
        }

        function showLogin() {
            document.getElementById('loginContainer').style.display = 'flex';
            document.getElementById('adminContainer').style.display = 'none';
            
            // Clear form
            document.getElementById('loginEmail').value = '';
            document.getElementById('loginPassword').value = '';
        }

        function showDashboard() {
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('adminContainer').style.display = 'block';
            
            // Update user info
            if (currentUser) {
                document.getElementById('userName').textContent = currentUser.name;
                document.getElementById('profileName').textContent = currentUser.name;
                document.getElementById('profileEmail').textContent = currentUser.email;
                document.getElementById('profileEmailDetail').textContent = currentUser.email;
                document.getElementById('profileFullName').textContent = currentUser.fullName || currentUser.name;
                document.getElementById('profileJoinDate').textContent = currentUser.joinDate || '1 Januari 2024';
            }
            
            // Initialize admin system
            initializeAdminSystem();
        }

        function toggleUserMenu() {
            const userMenu = document.getElementById('userMenu');
            userMenu.classList.toggle('show');
        }

        function logout() {
            if (confirm('Yakin ingin logout?')) {
                // Clear session
                localStorage.removeItem('man_cafe_admin_user');
                
                // Sign out from Supabase
                supabaseClient.auth.signOut();
                
                // Reset state
                currentUser = null;
                adminSystem = null;
                
                // Show login screen
                showLogin();
                
                // Close user menu
                document.getElementById('userMenu').classList.remove('show');
            }
        }

        // ============================
        // ADMIN SYSTEM
        // ============================
        async function initializeAdminSystem() {
            console.log(' Initializing admin system...');
            
            adminSystem = {
                orders: [],
                reservations: [],
                allReservations: [],
                allOrders: [],
                menus: [],
                activities: [],
                isOnline: true,
                autoRefreshInterval: null,
                initialized: false
            };

            try {
                // Check connection
                adminSystem.isOnline = await checkSupabaseConnection();
                console.log(adminSystem.isOnline ? ' Online mode' : ' Offline mode');
                
                // Update profile connection mode
                const connectionMode = document.getElementById('profileConnectionMode');
                if (connectionMode) {
                    connectionMode.innerHTML = adminSystem.isOnline ? 
                        '<span style="color: #28a745;"><i class="fas fa-wifi"></i> Online</span>' :
                        '<span style="color: #ffc107;"><i class="fas fa-unlink"></i> Offline</span>';
                }
                
                // Load data
                if (!adminSystem.isOnline) {
                    loadLocalData();
                } else {
                    await syncFromSupabase();
                }
                
                // Initialize
                initializeDefaultTables();
                await resetDailyStockIfNeeded();
                
                // Update UI
                updateStats();
                updateNotifications();
                updateProfileStats();
                
                // Start auto refresh
                startAutoRefresh();
                
                adminSystem.initialized = true;
                console.log(' Admin System initialized successfully');
                
                // Load dashboard
                loadDashboardSection();
                
            } catch (error) {
                console.error(' Error initializing admin system:', error);
                showToast('Gagal menginisialisasi sistem admin', 'error');
                
                // Fallback to local data
                loadLocalData();
                loadDashboardSection();
                updateProfileStats();
            }
        }

        async function checkSupabaseConnection() {
            try {
                const { data, error } = await supabaseClient
                    .from('menu_items')
                    .select('id')
                    .limit(1);
                
                if (error) {
                    console.warn('Supabase connection error, using offline mode:', error.message);
                    return false;
                }
                return true;
            } catch (error) {
                console.warn('Supabase connection error, using offline mode:', error.message);
                return false;
            }
        }

        function loadLocalData() {
            console.log(' Loading local data...');
            
            try {
                adminSystem.orders = JSON.parse(localStorage.getItem('pending_orders') || '[]');
                adminSystem.reservations = JSON.parse(localStorage.getItem('pending_reservations') || '[]');
                adminSystem.allReservations = JSON.parse(localStorage.getItem('all_reservations') || '[]');
                adminSystem.allOrders = JSON.parse(localStorage.getItem('all_orders') || '[]');
                adminSystem.menus = JSON.parse(localStorage.getItem('admin_menus') || '[]');
                adminSystem.activities = JSON.parse(localStorage.getItem('admin_activities') || '[]');
                
                const customerMenus = JSON.parse(localStorage.getItem('cafe_menus') || '[]');
                if (customerMenus.length > 0 && adminSystem.menus.length === 0) {
                    adminSystem.menus = customerMenus;
                }
                
                if (adminSystem.menus.length === 0) {
                    adminSystem.menus = getDefaultMenus();
                    localStorage.setItem('admin_menus', JSON.stringify(adminSystem.menus));
                    localStorage.setItem('cafe_menus', JSON.stringify(adminSystem.menus));
                }
                
                if (adminSystem.activities.length === 0) {
                    adminSystem.activities = getDefaultActivities();
                    localStorage.setItem('admin_activities', JSON.stringify(adminSystem.activities));
                }
                
                console.log(` Loaded: ${adminSystem.orders.length} orders, ${adminSystem.menus.length} menus`);
                
            } catch (error) {
                console.error('Error loading local data:', error);
                adminSystem.menus = getDefaultMenus();
                adminSystem.activities = getDefaultActivities();
                adminSystem.orders = [];
                adminSystem.reservations = [];
                adminSystem.allReservations = [];
                adminSystem.allOrders = [];
                
                localStorage.setItem('admin_menus', JSON.stringify(adminSystem.menus));
                localStorage.setItem('cafe_menus', JSON.stringify(adminSystem.menus));
                localStorage.setItem('admin_activities', JSON.stringify(adminSystem.activities));
            }
        }

        function getDefaultMenus() {
            return [
                {
                    id: 1,
                    name: "Espresso Premium",
                    description: "Kopi espresso dengan cita rasa kuat dan aroma harum",
                    price: 35000,
                    stock: 10,
                    dailyStock: null,
                    currentDailyStock: null,
                    category: "minuman",
                    image: "",
                    isPromo: false,
                    isActive: true,
                    isDailyStock: false
                },
                {
                    id: 2,
                    name: "Cappuccino Special",
                    description: "Espresso dengan susu steamed dan busa susu lembut",
                    price: 42000,
                    stock: 15,
                    dailyStock: null,
                    currentDailyStock: null,
                    category: "minuman",
                    image: "",
                    isPromo: false,
                    isActive: true,
                    isDailyStock: false
                },
                {
                    id: 3,
                    name: "Sandwich Ayam",
                    description: "Sandwich dengan ayam panggang dan sayuran segar",
                    price: 28000,
                    stock: 8,
                    dailyStock: null,
                    currentDailyStock: null,
                    category: "makanan",
                    image: "",
                    isPromo: true,
                    originalPrice: 35000,
                    isActive: true,
                    isDailyStock: false
                }
            ];
        }

        function getDefaultActivities() {
            return [
                {
                    id: 1,
                    message: "Sistem admin diinisialisasi",
                    time: new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' }),
                    date: new Date().toLocaleDateString('id-ID')
                }
            ];
        }

        async function syncFromSupabase() {
            console.log(' Syncing from Supabase...');
            try {
                await Promise.all([
                    syncMenusFromSupabase(),
                    syncOrdersFromSupabase(),
                    syncReservationsFromSupabase()
                ]);
                console.log(' Sync completed');
            } catch (error) {
                console.error('Error syncing from Supabase:', error);
            }
        }

        async function syncMenusFromSupabase() {
            try {
                console.log(' Syncing menus from Supabase...');
                
                let { data: menus, error } = await supabaseClient
                    .from('menu_items')
                    .select('*')
                    .order('name');
                
                if (error) {
                    console.warn('Error fetching menus, using local data:', error.message);
                    return;
                }
                
                if (menus && menus.length > 0) {
                    adminSystem.menus = menus.map(menu => ({
                        id: menu.id,
                        name: menu.name || 'Unnamed Menu',
                        price: menu.price || 0,
                        stock: menu.stock || 0,
                        dailyStock: menu.daily_stock || null,
                        currentDailyStock: menu.current_daily_stock || null,
                        isDailyStock: menu.is_daily_stock || false,
                        category: menu.category || 'minuman',
                        image: menu.image_url || menu.image || '',
                        description: menu.description || '',
                        isPromo: menu.is_promo || false,
                        originalPrice: menu.original_price || null,
                        isActive: menu.is_active !== false
                    }));
                    
                    localStorage.setItem('admin_menus', JSON.stringify(adminSystem.menus));
                    localStorage.setItem('cafe_menus', JSON.stringify(adminSystem.menus));
                    console.log(` Synced ${menus.length} menus from Supabase`);
                } else {
                    console.log(' No menus found in Supabase');
                }
                
            } catch (error) {
                console.error(' Error syncing menus:', error);
            }
        }

        async function syncOrdersFromSupabase() {
            try {
                let { data: orders, error } = await supabaseClient
                    .from('orders')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) {
                    console.warn('Error fetching orders, using local data:', error.message);
                    return;
                }
                
                if (orders && orders.length > 0) {
                    adminSystem.allOrders = orders.map(order => ({
                        id: order.id,
                        orderNumber: order.order_number || 'ORD-' + order.id.toString().slice(-6),
                        customer: {
                            name: order.customer_name || 'Pelanggan',
                            phone: order.customer_phone || '',
                            address: order.customer_address || '',
                            whatsapp: order.customer_whatsapp || order.customer_phone || ''
                        },
                        total: order.total_amount || 0,
                        status: order.status || 'pending',
                        paymentProof: order.payment_proof_url || '',
                        paymentMethod: order.payment_method || 'whatsapp',
                        paymentStatus: order.payment_status || 'pending',
                        whatsappProofReceived: order.whatsapp_proof_received || false,
                        whatsappProofVerified: order.whatsapp_proof_verified || false,
                        whatsappProofNotes: order.whatsapp_proof_notes || '',
                        createdAt: order.created_at || new Date().toISOString(),
                        adminSeen: order.admin_seen || false,
                        items: order.items || [],
                        orderType: order.order_type || 'dine_in'
                    }));
                    
                    adminSystem.orders = adminSystem.allOrders.filter(order => 
                        (order.status === 'pending' || order.status === 'waiting_payment') && 
                        !order.adminSeen
                    );
                    
                    localStorage.setItem('all_orders', JSON.stringify(adminSystem.allOrders));
                    localStorage.setItem('pending_orders', JSON.stringify(adminSystem.orders));
                    localStorage.setItem('customer_orders', JSON.stringify(adminSystem.allOrders));
                    
                    console.log(` Synced ${orders.length} orders from Supabase`);
                } else {
                    console.log(' No orders found in Supabase');
                }
                
            } catch (error) {
                console.error(' Error syncing orders:', error);
            }
        }

        async function syncReservationsFromSupabase() {
            try {
                let { data: reservations, error } = await supabaseClient
                    .from('reservations')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) {
                    console.warn('Error fetching reservations, using local data:', error.message);
                    return;
                }
                
                if (reservations && reservations.length > 0) {
                    adminSystem.allReservations = reservations.map(res => ({
                        id: res.id,
                        name: res.customer_name || '',
                        phone: res.customer_phone || '',
                        whatsapp: res.customer_whatsapp || res.customer_phone || '',
                        date: res.reservation_date || '',
                        time: res.reservation_time || '',
                        tableNumber: res.table_number || '',
                        guests: res.number_of_guests || 1,
                        notes: res.notes || '',
                        status: res.status || 'pending',
                        orderNumber: res.order_number || '',
                        adminSeen: res.admin_seen || false,
                        createdAt: res.created_at || new Date().toISOString()
                    }));
                    
                    adminSystem.reservations = adminSystem.allReservations.filter(res => 
                        !res.adminSeen && res.status === 'pending'
                    );
                    
                    localStorage.setItem('all_reservations', JSON.stringify(adminSystem.allReservations));
                    localStorage.setItem('pending_reservations', JSON.stringify(adminSystem.reservations));
                    localStorage.setItem('customer_reservations', JSON.stringify(adminSystem.allReservations));
                    
                    console.log(` Synced ${reservations.length} reservations from Supabase`);
                } else {
                    console.log(' No reservations found in Supabase');
                }
                
            } catch (error) {
                console.error(' Error syncing reservations:', error);
            }
        }

        async function resetDailyStockIfNeeded() {
            try {
                const lastResetDate = localStorage.getItem('last_daily_stock_reset');
                const today = new Date().toDateString();
                
                if (lastResetDate !== today) {
                    console.log(' Resetting daily stock...');
                    
                    if (adminSystem.isOnline) {
                        try {
                            const { error } = await supabaseClient
                                .from('menu_items')
                                .update({ 
                                    current_daily_stock: supabaseClient.raw('daily_stock')
                                })
                                .eq('is_daily_stock', true)
                                .gt('daily_stock', 0);
                            
                            if (error) {
                                console.warn('Error resetting daily stock in Supabase:', error.message);
                            }
                        } catch (error) {
                            console.warn('Error in daily stock reset:', error.message);
                        }
                    }
                    
                    adminSystem.menus.forEach(menu => {
                        if (menu.isDailyStock && menu.dailyStock > 0) {
                            menu.currentDailyStock = menu.dailyStock;
                        }
                    });
                    
                    saveLocalData();
                    localStorage.setItem('last_daily_stock_reset', today);
                    console.log(' Daily stock reset completed');
                }
            } catch (error) {
                console.error(' Error resetting daily stock:', error);
            }
        }

        function saveLocalData() {
            localStorage.setItem('pending_orders', JSON.stringify(adminSystem.orders));
            localStorage.setItem('pending_reservations', JSON.stringify(adminSystem.reservations));
            localStorage.setItem('all_reservations', JSON.stringify(adminSystem.allReservations));
            localStorage.setItem('all_orders', JSON.stringify(adminSystem.allOrders));
            localStorage.setItem('admin_menus', JSON.stringify(adminSystem.menus));
            localStorage.setItem('admin_activities', JSON.stringify(adminSystem.activities));
        }

        function addActivity(message) {
            const activity = {
                id: Date.now(),
                message: message,
                time: new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' }),
                date: new Date().toLocaleDateString('id-ID')
            };
            adminSystem.activities.unshift(activity);
            if (adminSystem.activities.length > 10) {
                adminSystem.activities = adminSystem.activities.slice(0, 10);
            }
            localStorage.setItem('admin_activities', JSON.stringify(adminSystem.activities));
        }

        function updateStats() {
            try {
                const todayOrders = getTodayOrders();
                const newCustomers = getNewCustomersToday();
                const todayRevenue = getTodayRevenue();
                const pendingOrders = getPendingOrders();
                
                document.getElementById('todayOrders').textContent = todayOrders.length;
                document.getElementById('newCustomers').textContent = newCustomers;
                document.getElementById('todayRevenue').textContent = 'Rp ' + todayRevenue.toLocaleString();
                document.getElementById('pendingOrders').textContent = pendingOrders.length;
            } catch (error) {
                console.error('Error updating stats:', error);
            }
        }

        function updateProfileStats() {
            try {
                if (!adminSystem) return;
                
                // Total orders managed
                const totalOrders = adminSystem.allOrders.length;
                document.getElementById('profileTotalOrders').textContent = totalOrders;
                
                // Total revenue
                const totalRevenue = adminSystem.allOrders
                    .filter(order => order.status === 'completed' || order.status === 'confirmed')
                    .reduce((sum, order) => sum + (order.total || 0), 0);
                document.getElementById('profileTotalRevenue').textContent = 'Rp ' + totalRevenue.toLocaleString();
                
                // Active menus
                const activeMenus = adminSystem.menus.filter(menu => menu.isActive !== false).length;
                document.getElementById('profileActiveMenus').textContent = activeMenus;
                
                // Available tables
                const tables = JSON.parse(localStorage.getItem('cafe_tables') || '[]');
                const availableTables = tables.filter(table => table.status === 'available').length;
                document.getElementById('profileTablesCount').textContent = availableTables;
                
            } catch (error) {
                console.error('Error updating profile stats:', error);
            }
        }

        function getTodayOrders() {
            const today = new Date().toISOString().split('T')[0];
            return adminSystem.allOrders.filter(order => {
                const orderDate = new Date(order.createdAt).toISOString().split('T')[0];
                return orderDate === today;
            });
        }

        function getTodayRevenue() {
            const todayOrders = getTodayOrders();
            return todayOrders.reduce((sum, order) => sum + (order.total || 0), 0);
        }

        function getNewCustomersToday() {
            try {
                const today = new Date().toISOString().split('T')[0];
                const uniqueCustomers = new Set();
                
                adminSystem.allOrders.forEach(order => {
                    const orderDate = new Date(order.createdAt).toISOString().split('T')[0];
                    if (orderDate === today && order.customer && order.customer.phone) {
                        uniqueCustomers.add(order.customer.phone);
                    }
                });
                
                adminSystem.allReservations.forEach(reservation => {
                    const resDate = new Date(reservation.createdAt).toISOString().split('T')[0];
                    if (resDate === today && reservation.phone) {
                        uniqueCustomers.add(reservation.phone);
                    }
                });
                
                return uniqueCustomers.size;
            } catch (error) {
                console.error('Error counting new customers:', error);
                return 0;
            }
        }

        function getPendingOrders() {
            return adminSystem.allOrders.filter(order => 
                order.status === 'pending' || order.status === 'waiting_payment'
            );
        }

        function updateNotifications() {
            try {
                const newOrdersCount = adminSystem.orders.filter(order => 
                    !order.adminSeen && (order.status === 'pending' || order.status === 'waiting_payment')
                ).length;
                
                const newReservationsCount = adminSystem.reservations.filter(r => 
                    !r.adminSeen && r.status === 'pending'
                ).length;
                
                const totalNotifications = newOrdersCount + newReservationsCount;
                
                document.getElementById('notificationCount').textContent = totalNotifications;
                document.getElementById('sidebarOrderCount').textContent = newOrdersCount;
                document.getElementById('sidebarReservationCount').textContent = newReservationsCount;
            } catch (error) {
                console.error('Error updating notifications:', error);
            }
        }

        function initializeDefaultTables() {
            try {
                const existingTables = JSON.parse(localStorage.getItem('cafe_tables') || '[]');
                if (existingTables.length === 0) {
                    const defaultTables = [
                        { id: 1, number: '1', capacity: 4, location: 'indoor', status: 'available', description: 'Meja dekat jendela', createdAt: new Date().toISOString() },
                        { id: 2, number: '2', capacity: 2, location: 'indoor', status: 'available', description: 'Meja romantis', createdAt: new Date().toISOString() },
                        { id: 3, number: '3', capacity: 6, location: 'outdoor', status: 'available', description: 'Meja keluarga', createdAt: new Date().toISOString() },
                    ];
                    localStorage.setItem('cafe_tables', JSON.stringify(defaultTables));
                }
            } catch (error) {
                console.error('Error initializing tables:', error);
            }
        }

        function startAutoRefresh() {
            if (adminSystem.autoRefreshInterval) {
                clearInterval(adminSystem.autoRefreshInterval);
            }
            
            adminSystem.autoRefreshInterval = setInterval(async () => {
                if (adminSystem.isOnline) {
                    await syncFromSupabase();
                    if (currentSection) {
                        loadSectionData(currentSection);
                    }
                    updateProfileStats();
                }
            }, 30000);
        }

        // ============================
        // UI FUNCTIONS
        // ============================
        function showSection(sectionId) {
            try {
                // Hide all sections
                document.querySelectorAll('.dashboard-section').forEach(section => {
                    section.style.display = 'none';
                });
                
                // Show selected section
                const sectionElement = document.getElementById(sectionId + '-section');
                if (sectionElement) {
                    sectionElement.style.display = 'block';
                }
                
                // Update active menu
                document.querySelectorAll('.sidebar-menu a').forEach(link => {
                    link.classList.remove('active');
                });
                
                const clickedLink = event.target.closest('a');
                if (clickedLink) {
                    clickedLink.classList.add('active');
                }
                
                // Update current section
                currentSection = sectionId;
                
                // Load section data
                loadSectionData(sectionId);
                
                // Specifically for analytics section, run analysis
                if (sectionId === 'analytics') {
                    setTimeout(() => {
                        runAprioriAnalysis();
                    }, 500);
                }
                
                // Update profile stats if profile section
                if (sectionId === 'profile') {
                    updateProfileStats();
                }
                
            } catch (error) {
                console.error('Error showing section:', error);
                showToast('Gagal memuat section', 'error');
            }
        }

        function loadSectionData(sectionId) {
            if (!adminSystem || !adminSystem.initialized) return;
            
            try {
                switch(sectionId) {
                    case 'dashboard':
                        loadDashboardSection();
                        break;
                    case 'orders':
                        loadNewOrders();
                        break;
                    case 'reservations':
                        loadReservations();
                        break;
                    case 'all-orders':
                        loadAllOrders();
                        break;
                    case 'all-reservations':
                        loadAllReservations();
                        break;
                    case 'menu':
                        loadMenuManagement();
                        break;
                    case 'tables':
                        loadTablesManagement();
                        break;
                    case 'reports':
                        loadReportsSection();
                        break;
                    case 'analytics':
                        document.getElementById('analysisStatus').style.display = 'block';
                        document.getElementById('statusText').textContent = 'Mempersiapkan data analisis...';
                        
                        setTimeout(() => {
                            runAprioriAnalysis();
                        }, 1000);
                        break;
                    case 'profile':
                        // Profile section already loaded from HTML
                        updateProfileStats();
                        break;
                }
            } catch (error) {
                console.error(`Error loading section ${sectionId}:`, error);
                showToast(`Gagal memuat ${sectionId}`, 'error');
            }
        }

        function loadDashboardSection() {
            if (!adminSystem) return;
            
            try {
                updateStats();
                updateNotifications();
                
                const lowStockMenus = adminSystem.menus.filter(menu => {
                    const availableStock = getAvailableStock(menu);
                    return availableStock <= 5 && availableStock > 0;
                });
                
                const outOfStockMenus = adminSystem.menus.filter(menu => {
                    const availableStock = getAvailableStock(menu);
                    return availableStock <= 0;
                });
                
                function getAvailableStock(menu) {
                    if (menu.isDailyStock && menu.currentDailyStock !== null) {
                        return menu.currentDailyStock;
                    }
                    return menu.stock || 0;
                }
                
                let activityHtml = '';
                
                if (outOfStockMenus.length > 0) {
                    activityHtml += `
                        <tr>
                            <td>${new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' })}</td>
                            <td> Stok Habis</td>
                            <td>${outOfStockMenus.map(menu => menu.name).join(', ')}</td>
                            <td>
                                <span class="status-badge status-cancelled">
                                    Perhatian
                                </span>
                            </td>
                        </tr>
                    `;
                }
                
                if (lowStockMenus.length > 0) {
                    activityHtml += `
                        <tr>
                            <td>${new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' })}</td>
                            <td> Stok Menipis</td>
                            <td>${lowStockMenus.map(menu => `${menu.name} (${getAvailableStock(menu)})`).join(', ')}</td>
                            <td>
                                <span class="status-badge status-pending">
                                    Perhatian
                                </span>
                            </td>
                        </tr>
                    `;
                }
                
                if (adminSystem.activities.length > 0) {
                    activityHtml += adminSystem.activities.map(activity => `
                        <tr>
                            <td>${activity.time}</td>
                            <td>Aktivitas Sistem</td>
                            <td>${activity.message}</td>
                            <td>
                                <span class="status-badge status-completed">
                                    Selesai
                                </span>
                            </td>
                        </tr>
                    `).join('');
                }
                
                const activityTable = document.getElementById('activityTable');
                if (activityHtml === '') {
                    activityTable.innerHTML = `
                        <tr>
                            <td colspan="4" style="text-align: center; padding: 2rem; color: #666;">
                                Tidak ada aktivitas terbaru
                            </td>
                        </tr>
                    `;
                } else {
                    activityTable.innerHTML = activityHtml;
                }
            } catch (error) {
                console.error('Error loading dashboard:', error);
                document.getElementById('activityTable').innerHTML = `
                    <tr>
                        <td colspan="4" style="text-align: center; padding: 2rem; color: #666;">
                            Gagal memuat aktivitas
                        </td>
                    </tr>
                `;
            }
        }

        function loadNewOrders() {
    if (!adminSystem) return;
    
    try {
        const newOrders = adminSystem.orders;
        const table = document.getElementById('newOrdersTable');
        
        if (newOrders.length === 0) {
            table.innerHTML = `
                <tr>
                    <td colspan="7" style="text-align: center; padding: 2rem; color: #666;">
                        Tidak ada pesanan baru
                    </td>
                </tr>
            `;
        } else {
            table.innerHTML = newOrders.map(order => {
                // Konversi waktu ke WIB (UTC+7)
                let formattedTime;
                try {
                    const orderTime = new Date(order.createdAt);
                    
                    // Konversi ke WIB (UTC+7)
                    const timeInWIB = new Date(orderTime.getTime() + (7 * 60 * 60 * 1000));
                    
                    // Format waktu menjadi HH:MM dengan 24 jam format
                    formattedTime = timeInWIB.toLocaleTimeString('id-ID', { 
                        hour: '2-digit', 
                        minute: '2-digit',
                        hour12: false,
                        timeZone: 'Asia/Jakarta'
                    });
                    
                    // Fallback jika formatting gagal
                    if (formattedTime === 'Invalid Date') {
                        formattedTime = orderTime.getHours().toString().padStart(2, '0') + ':' + 
                                       orderTime.getMinutes().toString().padStart(2, '0');
                    }
                } catch (error) {
                    console.warn('Error formatting time:', error);
                    formattedTime = '--:--';
                }
                
                // Tentukan status WhatsApp
                let whatsappStatus = '';
                let whatsappBadge = '';
                let whatsappIcon = '';
                
                if (order.paymentMethod === 'whatsapp') {
                    if (order.whatsappProofVerified) {
                        whatsappStatus = 'Terverifikasi';
                        whatsappBadge = 'verified';
                        whatsappIcon = '';
                    } else if (order.whatsappProofReceived) {
                        whatsappStatus = 'Dikirim';
                        whatsappBadge = 'received';
                        whatsappIcon = '';
                    } else {
                        whatsappStatus = 'Menunggu';
                        whatsappBadge = 'waiting';
                        whatsappIcon = '';
                    }
                }
                
                return `
                <tr>
                    <td>${order.orderNumber || 'ORD-' + order.id.toString().slice(-6)}</td>
                    <td>${order.customer?.name || 'Pelanggan'}</td>
                    <td>Rp ${order.total?.toLocaleString() || '0'}</td>
                    <td>${formattedTime}</td>
                    <td>
                        <span class="status-badge ${order.status === 'waiting_payment' ? 'status-waiting_payment' : 'status-pending'}">
                            ${order.status === 'waiting_payment' ? 'Menunggu Pembayaran' : 'Menunggu'}
                        </span>
                    </td>
                    <td>
                        ${order.paymentMethod === 'whatsapp' ? `
                        <div style="display: flex; flex-direction: column; gap: 0.3rem;">
                            <span class="whatsapp-status-badge ${whatsappBadge}">
                                <i class="fab fa-whatsapp"></i> ${whatsappIcon} ${whatsappStatus}
                            </span>
                            ${!order.whatsappProofReceived ? `
                            <small style="color: #ff9800; font-size: 0.8rem;">
                                <i class="fas fa-clock"></i> Belum ada bukti
                            </small>` : ''}
                        </div>` : `
                        <span style="color: #666; font-size: 0.9rem;">
                            Transfer Bank
                        </span>`}
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-primary btn-sm" onclick="viewOrderDetail('${order.id}')">
                                <i class="fas fa-eye"></i> Detail
                            </button>
                           ${order.paymentMethod === 'whatsapp' ? `
<button class="btn btn-warning btn-sm" 
        onclick="quickCheckWhatsAppStatus('${order.id}')"
        title="Buka WhatsApp pelanggan untuk cek bukti transfer">
    <i class="fab fa-whatsapp"></i> Cek Bukti
</button>` : ''}
                            <button class="btn btn-success btn-sm" onclick="confirmOrder('${order.id}')">
                                <i class="fas fa-check"></i> Konfirmasi
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="rejectOrder('${order.id}')">
                                <i class="fas fa-times"></i> Tolak
                            </button>
                        </div>
                    </td>
                </tr>
            `}).join('');
        }
        
        updateNotifications();
    } catch (error) {
        console.error('Error loading new orders:', error);
        document.getElementById('newOrdersTable').innerHTML = `
            <tr>
                <td colspan="7" style="text-align: center; padding: 2rem; color: #666;">
                    Gagal memuat pesanan
                </td>
            </tr>
        `;
    }
}
        function loadReservations() {
            if (!adminSystem) return;
            
            try {
                const newReservations = adminSystem.reservations;
                const table = document.getElementById('reservationsTable');
                
                if (newReservations.length === 0) {
                    table.innerHTML = `
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 2rem; color: #666;">
                                Tidak ada reservasi baru
                            </td>
                        </tr>
                    `;
                } else {
                    table.innerHTML = newReservations.map(res => `
                        <tr>
                            <td>#${res.id.toString().slice(-6)}</td>
                            <td>${res.name}</td>
                            <td>${res.date ? new Date(res.date).toLocaleDateString('id-ID') : '-'}</td>
                            <td>${res.time || '-'}</td>
                            <td>${res.tableNumber || '-'}</td>
                            <td>
                                <span class="status-badge ${res.status === 'confirmed' ? 'status-confirmed' : 'status-pending'}">
                                    ${res.status === 'confirmed' ? 'Dikonfirmasi' : 'Menunggu'}
                                </span>
                            </td>
                            <td>
                                 <div class="action-buttons">
                                    ${res.status === 'pending' ? `
                                    <button class="btn btn-success btn-sm" onclick="confirmReservation('${res.id}')">
                                        <i class="fas fa-check"></i> Konfirmasi
                                    </button>
                                    <button class="btn btn-danger btn-sm" onclick="rejectReservation('${res.id}')">
                                        <i class="fas fa-times"></i> Tolak
                                    </button>` : ''}
                                    <button class="btn btn-primary btn-sm" onclick="viewReservationDetail('${res.id}')">
                                        <i class="fas fa-eye"></i> Detail
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `).join('');
                }
                
                updateNotifications();
            } catch (error) {
                console.error('Error loading reservations:', error);
                document.getElementById('reservationsTable').innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 2rem; color: #666;">
                            Gagal memuat reservasi
                        </td>
                    </tr>
                `;
            }
        }

        function loadAllOrders() {
            if (!adminSystem) return;
            
            try {
                const table = document.getElementById('allOrdersTable');
                
                if (adminSystem.allOrders.length === 0) {
                    table.innerHTML = `
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 2rem; color: #666;">
                                Belum ada pesanan
                            </td>
                        </tr>
                    `;
                } else {
                    table.innerHTML = adminSystem.allOrders.map(order => {
                        const orderDate = new Date(order.createdAt);
                        const formattedDate = orderDate.toLocaleDateString('id-ID', {
                            day: '2-digit',
                            month: '2-digit',
                            year: 'numeric'
                        });
                        
                        // Cek status pembayaran WhatsApp
                        const whatsappStatus = order.paymentMethod === 'whatsapp' ? 
                            (order.whatsappProofReceived ? 
                                (order.whatsappProofVerified ? 
                                    '<span class="whatsapp-badge"> WhatsApp</span>' : 
                                    '<span class="whatsapp-badge" style="background: #ffc107;"> Dikirim</span>') : 
                                '') : 
                            '';
                        
                        return `
                        <tr>
                            <td>${order.orderNumber || 'ORD-' + order.id.toString().slice(-6)}</td>
                            <td>${order.customer?.name || 'Pelanggan'} ${whatsappStatus}</td>
                            <td>Rp ${order.total?.toLocaleString() || '0'}</td>
                            <td>${formattedDate}</td>
                            <td>
                                <span class="status-badge status-${order.status || 'pending'}">
                                    ${getStatusText(order.status || 'pending')}
                                </span>
                            </td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn btn-primary btn-sm" onclick="viewOrderDetail('${order.id}')">
                                        <i class="fas fa-eye"></i> Detail
                                    </button>
                                    ${order.status === 'confirmed' ? `
                                    <button class="btn btn-success btn-sm" onclick="completeOrder('${order.id}')">
                                        <i class="fas fa-check-double"></i> Selesai
                                    </button>` : ''}
                                    ${order.paymentMethod === 'whatsapp' && order.whatsappProofReceived && !order.whatsappProofVerified ? `
                                    <button class="btn btn-warning btn-sm" onclick="verifyWhatsAppProof('${order.id}')">
                                        <i class="fab fa-whatsapp"></i> Verifikasi
                                    </button>` : ''}
                                </div>
                            </td>
                        </tr>
                    `}).join('');
                }
            } catch (error) {
                console.error('Error loading all orders:', error);
                document.getElementById('allOrdersTable').innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 2rem; color: #666;">
                            Gagal memuat pesanan
                        </td>
                    </tr>
                `;
            }
        }

        function loadAllReservations() {
            if (!adminSystem) return;
            
            try {
                const table = document.getElementById('allReservationsTable');
                
                if (adminSystem.allReservations.length === 0) {
                    table.innerHTML = `
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 2rem; color: #666;">
                                Belum ada reservasi
                            </td>
                        </tr>
                    `;
                } else {
                    table.innerHTML = adminSystem.allReservations.map(res => `
                        <tr>
                            <td>#${res.id.toString().slice(-6)}</td>
                            <td>${res.name}</td>
                            <td>${res.date ? new Date(res.date).toLocaleDateString('id-ID') : '-'}</td>
                            <td>${res.time || '-'}</td>
                            <td>${res.tableNumber || '-'}</td>
                            <td>
                                <span class="status-badge ${res.status === 'confirmed' ? 'status-confirmed' : 'status-pending'}">
                                    ${res.status === 'confirmed' ? 'Dikonfirmasi' : 'Menunggu'}
                                </span>
                            </td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn btn-primary btn-sm" onclick="viewReservationDetail('${res.id}')">
                                        <i class="fas fa-eye"></i> Detail
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                console.error('Error loading all reservations:', error);
                document.getElementById('allReservationsTable').innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 2rem; color: #666;">
                            Gagal memuat reservasi
                        </td>
                    </tr>
                `;
            }
        }

        function loadMenuManagement() {
            if (!adminSystem) return;
            
            try {
                const container = document.getElementById('menuListContainer');
                
                if (adminSystem.menus.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 3rem; color: #666;">
                            <i class="fas fa-utensils" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                            <h3>Belum ada menu</h3>
                            <p>Tambahkan menu pertama Anda</p>
                            <button class="btn btn-primary" onclick="openAddMenuModal()" style="margin-top: 1rem;">
                                <i class="fas fa-plus"></i> Tambah Menu Pertama
                            </button>
                        </div>
                    `;
                } else {
                    const lowStockCount = adminSystem.menus.filter(menu => {
                        const stock = getAvailableStock(menu);
                        return stock <= 5 && stock > 0;
                    }).length;
                    
                    const outOfStockCount = adminSystem.menus.filter(menu => {
                        const stock = getAvailableStock(menu);
                        return stock <= 0;
                    }).length;
                    
                    const goodStockCount = adminSystem.menus.length - lowStockCount - outOfStockCount;
                    
                    function getAvailableStock(menu) {
                        if (menu.isDailyStock && menu.currentDailyStock !== null) {
                            return menu.currentDailyStock;
                        }
                        return menu.stock || 0;
                    }
                    
                    container.innerHTML = `
                        <div style="margin-bottom: 1.5rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                            <div>
                                <h3 style="margin: 0; font-size: 1.2rem;">Total Menu: ${adminSystem.menus.length}</h3>
                                <p style="color: #666; font-size: 0.9rem; margin: 0.3rem 0;">
                                    <span class="stock-badge stock-good">Stok Aman: ${goodStockCount}</span>
                                    <span class="stock-badge stock-low">Stok Menipis: ${lowStockCount}</span>
                                    <span class="stock-badge stock-empty">Stok Habis: ${outOfStockCount}</span>
                                </p>
                            </div>
                            <button class="btn btn-success" onclick="restockAllMenus()" style="padding: 0.8rem 1.2rem;">
                                <i class="fas fa-boxes"></i> Restock Semua
                            </button>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.5rem;">
                            ${adminSystem.menus.map(menu => `
                                <div class="menu-card-admin">
                                    ${menu.image ? 
                                        `<img src="${menu.image}" 
                                              alt="${menu.name}" 
                                              style="width: 100%; height: 150px; object-fit: cover; border-radius: 6px;"
                                              onerror="this.src='https://via.placeholder.com/300x150?text=${encodeURIComponent(menu.name)}'">` : 
                                        `<div style="height: 150px; background: #f0f0f0; border-radius: 6px; display: flex; align-items: center; justify-content: center; color: #666;">
                                            <i class="fas fa-utensils" style="font-size: 3rem;"></i>
                                        </div>`
                                    }
                                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem; margin-top: 0.5rem;">
                                        <h4 style="margin: 0; font-size: 1rem;">${menu.name}</h4>
                                        <span style="font-weight: bold; color: var(--primary-color); font-size: 0.9rem;">Rp ${menu.price.toLocaleString()}</span>
                                    </div>
                                    <p style="color: #666; font-size: 0.9rem; margin-bottom: 0.5rem; min-height: 40px;">
                                        ${menu.description || 'Tidak ada deskripsi'}
                                    </p>
                                    
                                    <div style="margin-bottom: 0.8rem;">
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.3rem;">
                                            <span style="font-size: 0.85rem; color: #666;">
                                                <i class="fas fa-box"></i> Stok:
                                                ${menu.isDailyStock ? ' Harian' : ' Reguler'}
                                            </span>
                                            <span class="stock-badge ${getStockBadgeClass(getAvailableStock(menu))}">
                                                ${getAvailableStock(menu)}${menu.isDailyStock && menu.dailyStock ? `/ ${menu.dailyStock}` : ''}
                                            </span>
                                        </div>
                                    </div>
                                    
                                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.5rem;">
                                        <span style="font-size: 0.8rem; background: #e9ecef; padding: 0.2rem 0.5rem; border-radius: 4px;">
                                            ${getCategoryText(menu.category)}
                                            ${menu.isPromo ? '  PROMO' : ''}
                                        </span>
                                        <div class="action-buttons">
                                            <button class="btn btn-primary btn-sm" onclick="editMenu('${menu.id}')">
                                                <i class="fas fa-edit"></i> Edit
                                            </button>
                                            <button class="btn btn-warning btn-sm" onclick="openRestockModal('${menu.id}')" style="background: #ffc107; color: #212529; border: none;">
                                                <i class="fas fa-plus-circle"></i> Restock
                                            </button>
                                            <button class="btn btn-danger btn-sm" onclick="deleteMenu('${menu.id}')">
                                                <i class="fas fa-trash"></i> Hapus
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading menu management:', error);
                document.getElementById('menuListContainer').innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: #666;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                        <h3>Gagal memuat menu</h3>
                        <p>Silakan refresh halaman</p>
                    </div>
                `;
            }
        }

        function getStockBadgeClass(stock) {
            if (stock <= 0) return 'stock-empty';
            if (stock <= 5) return 'stock-low';
            return 'stock-good';
        }

        function getCategoryText(category) {
            const categoryMap = {
                'minuman': 'Minuman',
                'makanan': 'Makanan',
                'snack': 'Snack',
                'dessert': 'Dessert'
            };
            return categoryMap[category] || category;
        }

        function getStatusText(status) {
            const statusMap = {
                'pending': 'Menunggu',
                'waiting_payment': 'Menunggu Pembayaran',
                'waiting_verification': 'Menunggu Verifikasi',
                'confirmed': 'Dikonfirmasi',
                'completed': 'Selesai',
                'cancelled': 'Dibatalkan',
                'rejected': 'Ditolak',
                'verified': 'Terverifikasi'
            };
            return statusMap[status] || status;
        }

        function loadTablesManagement() {
            try {
                const container = document.getElementById('tablesListContainer');
                
                const tables = JSON.parse(localStorage.getItem('cafe_tables') || '[]');
                
                if (tables.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 3rem; color: #666;">
                            <i class="fas fa-chair" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                            <h3>Belum ada meja</h3>
                            <p>Tambahkan meja pertama Anda</p>
                            <button class="btn btn-primary" onclick="openAddTableModal()" style="margin-top: 1rem;">
                                <i class="fas fa-plus"></i> Tambah Meja Pertama
                            </button>
                        </div>
                    `;
                } else {
                    container.innerHTML = `
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1.5rem;">
                            ${tables.map(table => `
                                <div class="menu-card-admin">
                                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                                        <h4 style="margin: 0; font-size: 1rem;">Meja ${table.number}</h4>
                                        <span style="font-size: 0.8rem; padding: 0.2rem 0.5rem; border-radius: 4px; background: ${getTableStatusColor(table.status)}; color: white;">
                                            ${getTableStatusText(table.status)}
                                        </span>
                                    </div>
                                    <p style="color: #666; font-size: 0.9rem; margin-bottom: 0.5rem;">
                                        <i class="fas fa-users"></i> Kapasitas: ${table.capacity} orang<br>
                                        <i class="fas fa-map-marker-alt"></i> ${getTableLocationText(table.location)}<br>
                                        ${table.description ? `<i class="fas fa-sticky-note"></i> ${table.description}` : ''}
                                    </p>
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <span style="font-size: 0.8rem; background: #e9ecef; padding: 0.2rem 0.5rem; border-radius: 4px;">
                                            ${table.status === 'available' ? ' Tersedia' : 
                                              table.status === 'occupied' ? ' Terisi' : 
                                              table.status === 'reserved' ? ' Dipesan' : ' Perbaikan'}
                                        </span>
                                        <div class="action-buttons">
                                            <button class="btn btn-primary btn-sm" onclick="editTable('${table.id}')">
                                                <i class="fas fa-edit"></i> Edit
                                            </button>
                                            <button class="btn btn-danger btn-sm" onclick="deleteTable('${table.id}')">
                                                <i class="fas fa-trash"></i> Hapus
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading tables management:', error);
                document.getElementById('tablesListContainer').innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: #666;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                        <h3>Gagal memuat data meja</h3>
                        <p>Silakan refresh halaman</p>
                    </div>
                `;
            }
        }

        function getTableStatusColor(status) {
            const colors = {
                'available': '#28a745',
                'occupied': '#ffc107',
                'reserved': '#007bff',
                'maintenance': '#dc3545'
            };
            return colors[status] || '#666';
        }

        function getTableStatusText(status) {
            const texts = {
                'available': 'Tersedia',
                'occupied': 'Terisi',
                'reserved': 'Dipesan',
                'maintenance': 'Perbaikan'
            };
            return texts[status] || status;
        }

        function getTableLocationText(location) {
            const locations = {
                'indoor': 'Indoor',
                'outdoor': 'Outdoor',
                'smoking_area': 'Smoking Area',
                'vip': 'VIP Room'
            };
            return locations[location] || location;
        }

        function loadReportsSection() {
            const today = new Date().toISOString().split('T')[0];
            const firstDayOfMonth = new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString().split('T')[0];
            
            document.getElementById('reportDate').value = today;
            document.getElementById('reportMonth').value = today.slice(0, 7);
            document.getElementById('startDate').value = firstDayOfMonth;
            document.getElementById('endDate').value = today;
            
            changeReportType();
            loadReportData();
        }

        function changeReportType() {
            const reportType = document.getElementById('reportType').value;
            
            document.getElementById('dailyFilter').style.display = reportType === 'daily' ? 'block' : 'none';
            document.getElementById('monthlyFilter').style.display = reportType === 'monthly' ? 'block' : 'none';
            document.getElementById('customFilter').style.display = reportType === 'custom' ? 'block' : 'none';
        }

        function loadReportData() {
            if (!adminSystem) return;
            
            try {
                const reportType = document.getElementById('reportType').value;
                let startDate, endDate;
                
                switch(reportType) {
                    case 'daily':
                        const selectedDate = document.getElementById('reportDate').value;
                        startDate = new Date(selectedDate);
                        endDate = new Date(selectedDate);
                        endDate.setHours(23, 59, 59, 999);
                        break;
                        
                    case 'monthly':
                        const selectedMonth = document.getElementById('reportMonth').value;
                        startDate = new Date(selectedMonth + '-01');
                        endDate = new Date(startDate.getFullYear(), startDate.getMonth() + 1, 0);
                        endDate.setHours(23, 59, 59, 999);
                        break;
                        
                    case 'custom':
                        startDate = new Date(document.getElementById('startDate').value);
                        endDate = new Date(document.getElementById('endDate').value);
                        endDate.setHours(23, 59, 59, 999);
                        break;
                }
                
                const filteredOrders = adminSystem.allOrders.filter(order => {
                    const orderDate = new Date(order.createdAt);
                    return orderDate >= startDate && orderDate <= endDate && order.status === 'completed';
                });
                
                currentReportData = filteredOrders;
                
                updateReportSummary(filteredOrders);
                updateSalesChart(filteredOrders, reportType);
                updateReportTable(filteredOrders);
                
                showToast(`Laporan berhasil dimuat (${filteredOrders.length} pesanan)`, 'success');
                
            } catch (error) {
                console.error('Error loading reports:', error);
                showToast('Gagal memuat laporan', 'error');
            }
        }

        function updateReportSummary(orders) {
            try {
                const totalRevenue = orders.reduce((sum, order) => sum + (order.total || 0), 0);
                const totalOrders = orders.length;
                const averageOrder = totalOrders > 0 ? totalRevenue / totalOrders : 0;
                
                const uniqueCustomers = new Set(orders.map(order => order.customer?.phone || order.customer?.name)).size;
                
                document.getElementById('summaryRevenue').textContent = 'Rp ' + totalRevenue.toLocaleString();
                document.getElementById('summaryOrders').textContent = totalOrders;
                document.getElementById('summaryAverage').textContent = 'Rp ' + Math.round(averageOrder).toLocaleString();
                document.getElementById('summaryCustomers').textContent = uniqueCustomers;
                
            } catch (error) {
                console.error('Error updating report summary:', error);
            }
        }

        function updateSalesChart(orders, reportType) {
            try {
                const chartContainer = document.getElementById('salesChart');
                
                if (orders.length === 0) {
                    chartContainer.innerHTML = `
                        <div style="text-align: center; padding: 5rem; color: #666;">
                            <i class="fas fa-chart-line" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                            <h3>Tidak ada data penjualan</h3>
                            <p>Tidak ada pesanan pada periode yang dipilih</p>
                        </div>
                    `;
                    return;
                }
                
                let labels = [];
                let data = [];
                
                if (reportType === 'daily') {
                    const hourlyData = {};
                    for (let i = 0; i < 24; i++) {
                        hourlyData[i] = 0;
                    }
                    
                    orders.forEach(order => {
                        const orderDate = new Date(order.createdAt);
                        const hour = orderDate.getHours();
                        hourlyData[hour] += order.total || 0;
                    });
                    
                    labels = Array.from({length: 24}, (_, i) => `${i}:00`);
                    data = Object.values(hourlyData);
                    
                } else {
                    const dailyData = {};
                    const startDate = reportType === 'monthly' ? 
                        new Date(document.getElementById('reportMonth').value + '-01') :
                        new Date(document.getElementById('startDate').value);
                    const endDate = reportType === 'monthly' ?
                        new Date(startDate.getFullYear(), startDate.getMonth() + 1, 0) :
                        new Date(document.getElementById('endDate').value);
                    
                    const currentDate = new Date(startDate);
                    
                    while (currentDate <= endDate) {
                        const dateKey = currentDate.toISOString().split('T')[0];
                        dailyData[dateKey] = 0;
                        currentDate.setDate(currentDate.getDate() + 1);
                    }
                    
                    orders.forEach(order => {
                        const orderDate = new Date(order.createdAt);
                        const dateKey = orderDate.toISOString().split('T')[0];
                        if (dailyData[dateKey] !== undefined) {
                            dailyData[dateKey] += order.total || 0;
                        }
                    });
                    
                    labels = Object.keys(dailyData).map(date => {
                        const d = new Date(date);
                        return d.getDate() + '/' + (d.getMonth() + 1);
                    });
                    data = Object.values(dailyData);
                }
                
                chartContainer.innerHTML = '';
                const maxValue = Math.max(...data, 1);
                const chartWidth = chartContainer.clientWidth - 40;
                const barWidth = Math.max(20, (chartWidth - 100) / labels.length);
                
                const chartBars = document.createElement('div');
                chartBars.style.display = 'flex';
                chartBars.style.height = 'calc(100% - 40px)';
                chartBars.style.alignItems = 'flex-end';
                chartBars.style.justifyContent = 'space-around';
                chartBars.style.padding = '0 10px';
                
                labels.forEach((label, index) => {
                    const value = data[index];
                    const height = (value / maxValue) * 180;
                    
                    const barContainer = document.createElement('div');
                    barContainer.style.display = 'flex';
                    barContainer.style.flexDirection = 'column';
                    barContainer.style.alignItems = 'center';
                    barContainer.style.justifyContent = 'flex-end';
                    barContainer.style.height = '100%';
                    barContainer.style.flex = '1';
                    
                    const bar = document.createElement('div');
                    bar.style.width = barWidth + 'px';
                    bar.style.height = height + 'px';
                    bar.style.backgroundColor = '#4CAF50';
                    bar.style.borderRadius = '4px 4px 0 0';
                    bar.style.transition = 'height 0.3s';
                    bar.title = 'Rp ' + value.toLocaleString();
                    bar.style.cursor = 'pointer';
                    bar.onmouseenter = function() {
                        this.style.backgroundColor = '#388E3C';
                    };
                    bar.onmouseleave = function() {
                        this.style.backgroundColor = '#4CAF50';
                    };
                    
                    const labelSpan = document.createElement('span');
                    labelSpan.textContent = label;
                    labelSpan.style.fontSize = '0.7rem';
                    labelSpan.style.color = '#666';
                    labelSpan.style.marginTop = '4px';
                    labelSpan.style.textAlign = 'center';
                    labelSpan.style.width = '100%';
                    
                    barContainer.appendChild(bar);
                    barContainer.appendChild(labelSpan);
                    chartBars.appendChild(barContainer);
                });
                
                chartContainer.appendChild(chartBars);
                
            } catch (error) {
                console.error('Error updating sales chart:', error);
                chartContainer.innerHTML = `
                    <div style="text-align: center; padding: 5rem; color: #666;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                        <h3>Gagal memuat grafik</h3>
                        <p>Terjadi kesalahan saat membuat grafik</p>
                    </div>
                `;
            }
        }

        function updateReportTable(orders) {
            try {
                const tableBody = document.getElementById('reportsTable');
                
                if (orders.length === 0) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 3rem; color: #666;">
                                <i class="fas fa-clipboard-list" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                                <h4>Tidak ada data</h4>
                                <p>Tidak ada pesanan pada periode yang dipilih</p>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                const sortedOrders = [...orders].sort((a, b) => 
                    new Date(b.createdAt) - new Date(a.createdAt)
                );
                
                tableBody.innerHTML = sortedOrders.map(order => `
                    <tr>
                        <td>${new Date(order.createdAt).toLocaleDateString('id-ID')}</td>
                        <td>${order.orderNumber || 'ORD-' + order.id.toString().slice(-6)}</td>
                        <td>${order.customer?.name || 'Pelanggan'}</td>
                        <td>
                            <span class="badge" style="background: #e9ecef; color: #495057; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.8rem;">
                                ${order.items?.length || 1} item
                            </span>
                        </td>
                        <td style="font-weight: 600;">Rp ${order.total?.toLocaleString() || '0'}</td>
                        <td>
                            <span class="status-badge status-completed">
                                Selesai
                            </span>
                        </td>
                    </tr>
                `).join('');
                
            } catch (error) {
                console.error('Error updating report table:', error);
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 2rem; color: #666;">
                            Gagal memuat data laporan
                        </td>
                    </tr>
                `;
            }
        }

        // ============================
        // apriori analysis
        // ============================
        class AprioriAnalyzer {
            static calculateSupport(itemset, transactions) {
                let count = 0;
                transactions.forEach(transaction => {
                    if (itemset.every(item => transaction.includes(item))) {
                        count++;
                    }
                });
                return count / transactions.length;
            }

            static runApriori(transactions, minSupport, minConfidence) {
                try {
                    if (transactions.length === 0) {
                        return { frequentItemsets: [], associationRules: [] };
                    }
                    
                    const allItems = new Set();
                    transactions.forEach(transaction => {
                        transaction.forEach(item => {
                            allItems.add(item);
                        });
                    });
                    
                    let frequentItemsets = [];
                    const itemsArray = Array.from(allItems);
                    
                    itemsArray.forEach(item => {
                        const support = AprioriAnalyzer.calculateSupport([item], transactions);
                        if (support >= minSupport) {
                            frequentItemsets.push({
                                items: [item],
                                support: support
                            });
                        }
                    });
                    
                    let k = 2;
                    let previousFrequentItemsets = frequentItemsets.filter(fi => fi.items.length === 1);
                    
                    while (previousFrequentItemsets.length > 0 && k <= 3) {
                        const candidateItemsets = [];
                        const n = previousFrequentItemsets.length;
                        
                        for (let i = 0; i < n; i++) {
                            for (let j = i + 1; j < n; j++) {
                                const itemset1 = previousFrequentItemsets[i].items;
                                const itemset2 = previousFrequentItemsets[j].items;
                                
                                if (k === 2 || itemset1.slice(0, k-2).join() === itemset2.slice(0, k-2).join()) {
                                    const candidate = [...new Set([...itemset1, ...itemset2])].sort();
                                    if (candidate.length === k) {
                                        candidateItemsets.push({ items: candidate });
                                    }
                                }
                            }
                        }
                        
                        const currentFrequentItemsets = [];
                        candidateItemsets.forEach(candidate => {
                            const support = AprioriAnalyzer.calculateSupport(candidate.items, transactions);
                            if (support >= minSupport) {
                                currentFrequentItemsets.push({
                                    items: candidate.items,
                                    support: support
                                });
                            }
                        });
                        
                        if (currentFrequentItemsets.length > 0) {
                            frequentItemsets = frequentItemsets.concat(currentFrequentItemsets);
                            previousFrequentItemsets = currentFrequentItemsets;
                        } else {
                            break;
                        }
                        
                        k++;
                    }
                    
                    const associationRules = [];
                    frequentItemsets.forEach(itemset => {
                        if (itemset.items.length > 1) {
                            const items = itemset.items;
                            const subsets = AprioriAnalyzer.getAllSubsets(items);
                            
                            subsets.forEach(subset => {
                                if (subset.length > 0 && subset.length < items.length) {
                                    const antecedent = subset;
                                    const consequent = items.filter(item => !antecedent.includes(item));
                                    
                                    const antecedentSupport = frequentItemsets.find(fi => 
                                        fi.items.length === antecedent.length && 
                                        antecedent.every(item => fi.items.includes(item))
                                    )?.support || 0;
                                    
                                    if (antecedentSupport > 0) {
                                        const confidence = itemset.support / antecedentSupport;
                                        
                                        if (confidence >= minConfidence) {
                                            associationRules.push({
                                                antecedent: antecedent,
                                                consequent: consequent,
                                                support: itemset.support,
                                                confidence: confidence
                                            });
                                        }
                                    }
                                }
                            });
                        }
                    });
                    
                    return {
                        frequentItemsets: frequentItemsets.sort((a, b) => b.support - a.support),
                        associationRules: associationRules.sort((a, b) => b.confidence - a.confidence)
                    };
                    
                } catch (error) {
                    console.error('Error in Apriori algorithm:', error);
                    return { frequentItemsets: [], associationRules: [] };
                }
            }

            static getAllSubsets(items) {
                const subsets = [];
                const n = items.length;
                
                for (let i = 1; i < (1 << n) - 1; i++) {
                    const subset = [];
                    for (let j = 0; j < n; j++) {
                        if (i & (1 << j)) {
                            subset.push(items[j]);
                        }
                    }
                    subsets.push(subset);
                }
                
                return subsets;
            }
        }

        async function getTransactionDataForAnalysis(periodDays = '30') {
            try {
                const storedOrders = JSON.parse(localStorage.getItem('customer_orders') || '[]');
                const storedAdminOrders = JSON.parse(localStorage.getItem('all_orders') || '[]');
                
                const allOrdersMap = new Map();
                
                [...storedOrders, ...storedAdminOrders].forEach(order => {
                    if (order.id && !allOrdersMap.has(order.id)) {
                        allOrdersMap.set(order.id, order);
                    }
                });
                
                const allOrders = Array.from(allOrdersMap.values());
                const completedOrders = allOrders.filter(order => 
                    order.status === 'completed' || order.status === 'confirmed'
                );
                
                console.log(` Data dari localStorage: ${completedOrders.length} order selesai`);
                
                const transactions = [];
                completedOrders.forEach(order => {
                    if (order.items && Array.isArray(order.items)) {
                        const items = order.items
                            .map(item => item.name || item.menuName || item.menu_name)
                            .filter(name => name && name.trim() !== '');
                        
                        if (items.length > 0) {
                            transactions.push(items);
                        }
                    }
                });
                
                if (transactions.length === 0) {
                    const menus = JSON.parse(localStorage.getItem('cafe_menus') || '[]');
                    const menuNames = menus.slice(0, 6).map(m => m.name);
                    
                    if (menuNames.length >= 3) {
                        return [
                            [menuNames[0], menuNames[1]],
                            [menuNames[0], menuNames[2]],
                            [menuNames[1], menuNames[2]],
                            [menuNames[0], menuNames[1], menuNames[2]],
                            [menuNames[2], menuNames[3]],
                            [menuNames[0], menuNames[3]]
                        ];
                    }
                }
                
                console.log(` Siap analisis: ${transactions.length} transaksi`);
                console.log('Contoh transaksi:', transactions.slice(0, 3));
                
                return transactions;
                
            } catch (error) {
                console.error('Error:', error);
                return [];
            }
        }

        async function runAprioriAnalysis() {
            try {
                if (!adminSystem) {
                    showToast('Sistem admin belum siap', 'error');
                    return;
                }
                
                const statusElement = document.getElementById('analysisStatus');
                const statusText = document.getElementById('statusText');
                statusElement.style.display = 'block';
                statusText.textContent = 'Mempersiapkan data...';
                
                const minSupport = parseInt(document.getElementById('minSupport').value) / 100;
                const minConfidence = parseInt(document.getElementById('minConfidence').value) / 100;
                const periodDays = document.getElementById('periodFilter').value;
                
                statusText.textContent = 'Mengambil data dari database...';
                
                const transactions = await getTransactionDataForAnalysis(periodDays);
                
                console.log(' Data transaksi untuk analisis:', {
                    jumlahTransaksi: transactions.length,
                    sampleTransaksi: transactions.slice(0, 3),
                    minSupport: minSupport,
                    minConfidence: minConfidence,
                    periode: periodDays
                });
                
                if (transactions.length === 0) {
                    statusElement.style.display = 'none';
                    
                    document.getElementById('frequentItemsets').innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: #666;">
                            <i class="fas fa-database" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                            <h4>Tidak ada data transaksi</h4>
                            <p>Tidak ditemukan transaksi yang selesai pada periode yang dipilih.</p>
                            <div style="margin-top: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 8px; text-align: left;">
                                <p><strong>Kemungkinan penyebab:</strong></p>
                                <ul style="padding-left: 1.5rem; margin-top: 0.5rem;">
                                    <li>Belum ada order dengan status "completed"</li>
                                    <li>Periode waktu terlalu pendek</li>
                                    <li>Data transaksi belum tersedia</li>
                                </ul>
                            </div>
                            <button class="btn btn-primary" onclick="checkDatabaseConnection()" style="margin-top: 1rem;">
                                <i class="fas fa-search"></i> Cek Koneksi Database
                            </button>
                        </div>
                    `;
                    
                    document.getElementById('associationRules').innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: #666;">
                            <i class="fas fa-project-diagram" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                            <h4>Data tidak cukup</h4>
                            <p>Minimal dibutuhkan 3 transaksi untuk analisis.</p>
                        </div>
                    `;
                    
                    document.getElementById('businessRecommendations').innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: #666;">
                            <i class="fas fa-lightbulb" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                            <h4>Rekomendasi Umum</h4>
                            <p>Untuk meningkatkan penjualan:</p>
                            <ul style="text-align: left; margin-top: 1rem; padding-left: 1.5rem;">
                                <li>Promosikan menu baru</li>
                                <li>Buat paket menu menarik</li>
                                <li>Tawarkan diskon untuk pembelian tertentu</li>
                                <li>Analisis akan muncul setelah ada minimal 3 transaksi selesai</li>
                            </ul>
                        </div>
                    `;
                    
                    return;
                }
                
                if (transactions.length < 3) {
                    statusText.textContent = `Data terbatas (${transactions.length} transaksi), melakukan analisis...`;
                    showToast(`Data terbatas. Disarankan minimal 3 transaksi untuk hasil optimal`, 'warning');
                } else {
                    statusText.textContent = `Menganalisis ${transactions.length} transaksi...`;
                }
                
                const result = AprioriAnalyzer.runApriori(transactions, minSupport, minConfidence);
                
                displayFrequentItemsets(result.frequentItemsets, transactions.length);
                displayAssociationRules(result.associationRules);
                displayBusinessRecommendations(result.frequentItemsets, result.associationRules, transactions.length);
                
                statusElement.style.display = 'none';
                
                showToast(`Analisis selesai! ${transactions.length} transaksi dianalisis`, 'success');
                
            } catch (error) {
                console.error(' Error running Apriori analysis:', error);
                document.getElementById('analysisStatus').style.display = 'none';
                showToast('Gagal melakukan analisis: ' + error.message, 'error');
                
                document.getElementById('frequentItemsets').innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #666;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                        <h4>Terjadi Kesalahan</h4>
                        <p>${error.message}</p>
                        <button class="btn btn-primary" onclick="runAprioriAnalysis()" style="margin-top: 1rem;">
                            <i class="fas fa-redo"></i> Coba Lagi
                        </button>
                    </div>
                `;
            }
        }

        function displayFrequentItemsets(frequentItemsets, transactionCount) {
            const container = document.getElementById('frequentItemsets');
            
            if (frequentItemsets.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #666;">
                        <i class="fas fa-filter" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                        <h4>Tidak ditemukan pola</h4>
                        <p>Tidak ada itemset yang memenuhi threshold support.</p>
                        <div style="margin-top: 1rem; padding: 0.8rem; background: #f8f9fa; border-radius: 6px; text-align: left;">
                            <p style="margin: 0; font-size: 0.9rem;">
                                <strong>Info:</strong> ${transactionCount} transaksi dianalisis.<br>
                                <strong>Saran:</strong> Turunkan threshold support atau tambah data transaksi.
                            </p>
                        </div>
                        <button class="btn btn-sm btn-outline-primary" onclick="document.getElementById('minSupport').value=5; document.getElementById('supportValue').textContent='5%'; runAprioriAnalysis()" style="margin-top: 1rem;">
                            <i class="fas fa-sliders-h"></i> Coba Support 5%
                        </button>
                    </div>
                `;
                return;
            }
            
            let html = `
                <div style="margin-bottom: 1rem; padding: 0.5rem; background: #e3f2fd; border-radius: 6px; color: #1565c0;">
                    <i class="fas fa-info-circle"></i> Berdasarkan ${transactionCount} transaksi
                </div>
            `;
            
            const singles = frequentItemsets.filter(fi => fi.items.length === 1);
            const pairs = frequentItemsets.filter(fi => fi.items.length === 2);
            const triples = frequentItemsets.filter(fi => fi.items.length === 3);
            
            if (singles.length > 0) {
                html += `<h4 style="margin-bottom: 0.5rem; color: #495057; font-size: 0.9rem;">Menu Paling Populer:</h4>`;
                singles.slice(0, 5).forEach(itemset => {
                    html += `
                        <div class="frequent-itemset">
                            <i class="fas fa-star" style="color: #FFD700;"></i>
                            <span>${itemset.items[0]}</span>
                            <span class="support-badge">${(itemset.support * 100).toFixed(1)}%</span>
                        </div>
                    `;
                });
            }
            
            if (pairs.length > 0) {
                html += `<h4 style="margin: 1rem 0 0.5rem 0; color: #495057; font-size: 0.9rem;">Kombinasi 2 Menu:</h4>`;
                pairs.slice(0, 5).forEach(itemset => {
                    html += `
                        <div class="frequent-itemset">
                            <i class="fas fa-link" style="color: #17a2b8;"></i>
                            <span>${itemset.items.join(" + ")}</span>
                            <span class="support-badge">${(itemset.support * 100).toFixed(1)}%</span>
                        </div>
                    `;
                });
            }
            
            if (triples.length > 0) {
                html += `<h4 style="margin: 1rem 0 0.5rem 0; color: #495057; font-size: 0.9rem;">Kombinasi 3 Menu:</h4>`;
                triples.slice(0, 5).forEach(itemset => {
                    html += `
                        <div class="frequent-itemset">
                            <i class="fas fa-network-wired" style="color: #8B4513;"></i>
                            <span>${itemset.items.join(" + ")}</span>
                            <span class="support-badge">${(itemset.support * 100).toFixed(1)}%</span>
                        </div>
                    `;
                });
            }
            
            html += `
                <div style="margin-top: 1rem; padding: 0.5rem; background: #e9ecef; border-radius: 4px; font-size: 0.8rem; color: #495057;">
                    <i class="fas fa-info-circle"></i> Ditemukan ${frequentItemsets.length} pola pembelian.
                </div>
            `;
            
            container.innerHTML = html;
        }

        function displayAssociationRules(rules) {
            const container = document.getElementById('associationRules');
            
            if (rules.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #666;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                        <p>Tidak ditemukan aturan asosiasi yang memenuhi threshold confidence.</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            
            rules.slice(0, 5).forEach((rule, index) => {
                const confidencePercent = (rule.confidence * 100).toFixed(1);
                const supportPercent = (rule.support * 100).toFixed(1);
                
                html += `
                    <div class="association-rule">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <strong style="color: #2C3E50;">Jika membeli:</strong>
                            <span class="rule-confidence">${confidencePercent}%</span>
                        </div>
                        <div style="background: #f8f9fa; padding: 0.5rem; border-radius: 4px; margin-bottom: 0.5rem;">
                            <i class="fas fa-shopping-cart" style="color: #8B4513; margin-right: 0.5rem;"></i>
                            ${rule.antecedent.join(", ")}
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong style="color: #2C3E50;">Maka juga membeli:</strong>
                                <div style="background: #e9ecef; padding: 0.5rem; border-radius: 4px; margin-top: 0.3rem;">
                                    <i class="fas fa-arrow-right" style="color: #28a745; margin-right: 0.5rem;"></i>
                                    ${rule.consequent.join(", ")}
                                </div>
                            </div>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-top: 0.5rem; font-size: 0.8rem; color: #666;">
                            <span>Support: ${supportPercent}%</span>
                            <span>Confidence: ${confidencePercent}%</span>
                        </div>
                    </div>
                `;
            });
            
            html += `
                <div style="margin-top: 1rem; padding: 0.5rem; background: #e9ecef; border-radius: 4px; font-size: 0.8rem; color: #495057;">
                    <i class="fas fa-info-circle"></i> Ditemukan ${rules.length} aturan asosiasi.
                </div>
            `;
            
            container.innerHTML = html;
        }

        function displayBusinessRecommendations(frequentItemsets, associationRules, transactionCount) {
            const container = document.getElementById('businessRecommendations');
            
            let html = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem;">';
            
            const topPairs = frequentItemsets.filter(fi => fi.items.length === 2).slice(0, 3);
            if (topPairs.length > 0) {
                html += `
                    <div style="background: white; border-radius: 8px; padding: 1rem; border: 1px solid #dee2e6;">
                        <h4 style="margin-bottom: 0.5rem; color: #2C3E50; display: flex; align-items: center; gap: 0.5rem;">
                             Rekomendasi Paket Menu
                        </h4>
                        <p style="color: #666; font-size: 0.9rem; margin-bottom: 1rem;">Buat paket menu dari kombinasi berikut:</p>
                        <ul style="list-style: none; padding: 0; margin: 0;">
                            ${topPairs.map(itemset => `
                                <li style="margin-bottom: 0.5rem; padding: 0.5rem; background: #f8f9fa; border-radius: 4px;">
                                    <div style="display: flex; justify-content: space-between;">
                                        <span>${itemset.items.join(" + ")}</span>
                                        <span style="font-weight: bold; color: #8B4513;">${(itemset.support * 100).toFixed(1)}%</span>
                                    </div>
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                `;
            }
            
            const topRules = associationRules.slice(0, 3);
            if (topRules.length > 0) {
                html += `
                    <div style="background: white; border-radius: 8px; padding: 1rem; border: 1px solid #dee2e6;">
                        <h4 style="margin-bottom: 0.5rem; color: #2C3E50; display: flex; align-items: center; gap: 0.5rem;">
                             Peluang Cross-Selling
                        </h4>
                        <p style="color: #666; font-size: 0.9rem; margin-bottom: 1rem;">Promosikan menu berikut kepada pelanggan:</p>
                        <ul style="list-style: none; padding: 0; margin: 0;">
                            ${topRules.map(rule => `
                                <li style="margin-bottom: 0.5rem; padding: 0.5rem; background: #f8f9fa; border-radius: 4px;">
                                    <div style="display: flex; justify-content: space-between;">
                                        <span>Jika beli <strong>${rule.antecedent.join(", ")}</strong><br>
                                         tawarkan <strong>${rule.consequent.join(", ")}</strong></span>
                                        <span style="font-weight: bold; color: #8B4513;">${(rule.confidence * 100).toFixed(1)}%</span>
                                    </div>
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                `;
            }
            
            html += `
                <div style="background: white; border-radius: 8px; padding: 1rem; border: 1px solid #dee2e6;">
                    <h4 style="margin-bottom: 0.5rem; color: #2C3E50; display: flex; align-items: center; gap: 0.5rem;">
                         Tips Penjualan
                    </h4>
                    <ul style="list-style: none; padding: 0; margin: 0;">
                        <li style="margin-bottom: 0.5rem; padding: 0.5rem; background: #f8f9fa; border-radius: 4px;">
                            <strong>Buat Bundle:</strong> Gabungkan menu yang sering dibeli bersama
                        </li>
                        <li style="margin-bottom: 0.5rem; padding: 0.5rem; background: #f8f9fa; border-radius: 4px;">
                            <strong>Diskon Paket:</strong> Berikan diskon untuk pembelian paket
                        </li>
                        <li style="margin-bottom: 0.5rem; padding: 0.5rem; background: #f8f9fa; border-radius: 4px;">
                            <strong>Penempatan Menu:</strong> Letakkan menu terkait berdekatan
                        </li>
                        <li style="padding: 0.5rem; background: #f8f9fa; border-radius: 4px;">
                            <strong>Rekomendasi:</strong> Sarankan menu terkait saat checkout
                        </li>
                    </ul>
                </div>
            `;
            
            html += '</div>';
            container.innerHTML = html;
        }

        async function checkDatabaseConnection() {
            try {
                showToast('Memeriksa koneksi database...', 'info');
                
                const { data: orders, error: ordersError } = await supabaseClient
                    .from('orders')
                    .select('id, status, created_at, order_number')
                    .eq('status', 'completed')
                    .limit(5);
                
                console.log(' Data orders (completed):', orders);
                
                const { data: orderItems, error: itemsError } = await supabaseClient
                    .from('order_items')
                    .select('id, order_id, menu_name, quantity')
                    .limit(10);
                
                console.log(' Data order_items:', orderItems);
                
                let message = ` HASIL CEK DATABASE\n\n`;
                message += `Orders (completed): ${orders?.length || 0} data\n`;
                message += `Order Items: ${orderItems?.length || 0} data\n\n`;
                
                if (orders && orders.length > 0) {
                    message += `Sample order (completed):\n`;
                    orders.forEach(order => {
                        message += `- #${order.order_number || order.id} (${new Date(order.created_at).toLocaleDateString('id-ID')})\n`;
                    });
                } else {
                    message += ` Tidak ada order dengan status "completed"\n`;
                }
                
                if (orderItems && orderItems.length > 0) {
                    message += `\nSample order items:\n`;
                    orderItems.slice(0, 5).forEach(item => {
                        message += `- Order ${item.order_id}: ${item.menu_name} (${item.quantity}x)\n`;
                    });
                } else {
                    message += `\n Tabel order_items kosong\n`;
                }
                
                message += `\n Saran:\n`;
                if (orders?.length === 0) {
                    message += ` Ubah status beberapa order menjadi "completed"\n`;
                }
                if (orderItems?.length === 0) {
                    message += ` Pastikan data item tersimpan di order_items saat order dibuat\n`;
                }
                
                alert(message);
                
                if (orders && orders.length > 0 && orderItems && orderItems.length > 0) {
                    setTimeout(() => runAprioriAnalysis(), 1000);
                }
                
            } catch (error) {
                console.error('Error checking database:', error);
                alert(` Error koneksi database:\n${error.message}\n\nPastikan:\n1. Internet tersedia\n2. Supabase URL dan API key benar\n3. Tabel orders dan order_items ada`);
            }
        }

        // ============================
        // WHATSAPP INTEGRATION FUNCTIONS
        // ============================
        function checkWhatsAppProof(orderId) {
    if (!adminSystem) return;
    
    try {
        const order = adminSystem.allOrders.find(o => o.id == orderId) || 
                      adminSystem.orders.find(o => o.id == orderId);
        
        if (!order) {
            showToast('Pesanan tidak ditemukan', 'error');
            return;
        }
        
        currentOrderForWhatsApp = order;
        
        // Tampilkan modal dengan pilihan
        const content = document.getElementById('confirmWhatsAppContent');
        content.innerHTML = `
            <div style="padding: 1rem;">
                <h3><i class="fab fa-whatsapp" style="color: #25D366;"></i> Cek Bukti Transfer WhatsApp</h3>
                
                <div class="customer-info-box">
                    <h4>Informasi Pesanan</h4>
                    <div class="info-row">
                        <span class="info-label">Order:</span>
                        <span class="info-value">${order.orderNumber || 'ORD-' + order.id.toString().slice(-6)}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Pelanggan:</span>
                        <span class="info-value">${order.customer?.name || 'Pelanggan'}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Total:</span>
                        <span class="info-value">Rp ${order.total?.toLocaleString() || '0'}</span>
                    </div>
                </div>
                
                <div style="margin: 1.5rem 0; padding: 1rem; background: #f8f9fa; border-radius: 8px;">
                    <p><strong>Langkah-langkah:</strong></p>
                    <ol style="padding-left: 1.5rem; margin: 0.5rem 0;">
                        <li>Klik "Buka WhatsApp" untuk membuka chat dengan pelanggan</li>
                        <li>Lihat bukti transfer yang dikirim pelanggan</li>
                        <li>Verifikasi jumlah dan detail transfer</li>
                        <li>Kembali ke dashboard dan pilih tindakan</li>
                    </ol>
                </div>
                
                <div style="display: flex; gap: 1rem; margin-top: 1.5rem; flex-wrap: wrap;">
                    <button class="btn" style="background: #25D366; color: white; flex: 1; min-width: 150px;" 
                            onclick="openCustomerWhatsApp('${order.id}')">
                        <i class="fab fa-whatsapp"></i> Buka WhatsApp
                    </button>
                    
                    ${!order.whatsappProofReceived ? `
                    <button class="btn btn-success" onclick="markProofReceived()" style="flex: 1; min-width: 150px;">
                        <i class="fas fa-check"></i> Sudah Dikirim
                    </button>
                    <button class="btn btn-warning" onclick="remindCustomer()" style="flex: 1; min-width: 150px;">
                        <i class="fas fa-bell"></i> Ingatkan
                    </button>` : ''}
                    
                    ${order.whatsappProofReceived && !order.whatsappProofVerified ? `
                    <button class="btn btn-primary" onclick="verifyWhatsAppProof('${order.id}')" style="flex: 1; min-width: 150px;">
                        <i class="fas fa-check-circle"></i> Verifikasi
                    </button>` : ''}
                    
                    <button class="btn btn-secondary" onclick="closeModal('confirmWhatsAppModal')" style="flex: 1; min-width: 150px;">
                        <i class="fas fa-times"></i> Tutup
                    </button>
                </div>
                
                <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #eee; font-size: 0.9rem; color: #666;">
                    <p><strong>Catatan:</strong> Setelah melihat bukti di WhatsApp, kembali ke sini untuk menandai status.</p>
                </div>
            </div>
        `;
        
        openModal('confirmWhatsAppModal');
        
    } catch (error) {
        console.error('Error checking WhatsApp proof:', error);
        showToast('Gagal memeriksa bukti WhatsApp', 'error');
    }
}
        async function markProofReceived() {
            if (!currentOrderForWhatsApp) return;
            
            try {
                const orderId = currentOrderForWhatsApp.id;
                
                if (adminSystem.isOnline) {
                    try {
                        const { error } = await supabaseClient
                            .from('orders')
                            .update({
                                whatsapp_proof_received: true,
                                whatsapp_proof_verified: false,
                                updated_at: new Date().toISOString()
                            })
                            .eq('id', orderId);
                        
                        if (error) throw error;
                    } catch (error) {
                        console.warn('Error updating WhatsApp proof in Supabase:', error.message);
                    }
                }
                
                // Update data lokal
                const orderIndex = adminSystem.allOrders.findIndex(o => o.id == orderId);
                if (orderIndex !== -1) {
                    adminSystem.allOrders[orderIndex].whatsappProofReceived = true;
                    adminSystem.allOrders[orderIndex].whatsappProofVerified = false;
                    
                    // Jika ada di pending orders, update juga
                    const pendingIndex = adminSystem.orders.findIndex(o => o.id == orderId);
                    if (pendingIndex !== -1) {
                        adminSystem.orders[pendingIndex].whatsappProofReceived = true;
                        adminSystem.orders[pendingIndex].whatsappProofVerified = false;
                    }
                    
                    saveLocalData();
                    localStorage.setItem('customer_orders', JSON.stringify(adminSystem.allOrders));
                    
                    addActivity(`Bukti WhatsApp diterima untuk pesanan #${currentOrderForWhatsApp.orderNumber}`);
                    updateProfileStats();
                    
                    showToast('Bukti WhatsApp ditandai sudah diterima', 'success');
                    
                    // Tutup modal dan refresh
                    closeModal('confirmWhatsAppModal');
                    loadNewOrders();
                    loadAllOrders();
                    loadDashboardSection();
                    
                    // Tampilkan detail untuk verifikasi
                    viewWhatsAppProofDetail(orderId);
                }
                
            } catch (error) {
                console.error('Error marking proof received:', error);
                showToast('Gagal menandai bukti diterima', 'error');
            }
        }

        function remindCustomer() {
            if (!currentOrderForWhatsApp) return;
            
            try {
                const customerPhone = currentOrderForWhatsApp.customer?.whatsapp || 
                                     currentOrderForWhatsApp.customer?.phone;
                
                if (!customerPhone) {
                    showToast('Nomor WhatsApp pelanggan tidak tersedia', 'error');
                    return;
                }
                
                // Format nomor untuk WhatsApp
                let formattedPhone = customerPhone.replace(/\D/g, '');
                if (formattedPhone.startsWith('0')) {
                    formattedPhone = '62' + formattedPhone.substring(1);
                }
                
                // Pesan default
                const message = `Halo ${currentOrderForWhatsApp.customer?.name || 'Pelanggan'}!%0A%0A` +
                               `Kami dari MAN CAFE ingin mengingatkan bahwa pesanan Anda dengan nomor ` +
                               `${currentOrderForWhatsApp.orderNumber} masih menunggu pembayaran.%0A%0A` +
                               `Total: Rp ${currentOrderForWhatsApp.total?.toLocaleString() || '0'}%0A` +
                               `Silakan kirim bukti transfer ke WhatsApp ini.%0A%0A` +
                               `Terima kasih!`;
                
                // Buka WhatsApp
                const whatsappUrl = `https://wa.me/${formattedPhone}?text=${message}`;
                window.open(whatsappUrl, '_blank');
                
                // Tandai sudah diingatkan
                addActivity(`Mengingatkan pelanggan untuk bukti transfer via WhatsApp (Order: ${currentOrderForWhatsApp.orderNumber})`);
                
                showToast('Pesan pengingat dibuka di WhatsApp', 'success');
                closeModal('confirmWhatsAppModal');
                
            } catch (error) {
                console.error('Error sending reminder:', error);
                showToast('Gagal membuka WhatsApp', 'error');
            }
        }

        function viewWhatsAppProofDetail(orderId) {
            if (!adminSystem) return;
            
            try {
                const order = adminSystem.allOrders.find(o => o.id == orderId) || 
                              adminSystem.orders.find(o => o.id == orderId);
                
                if (!order) {
                    showToast('Pesanan tidak ditemukan', 'error');
                    return;
                }
                
                const content = document.getElementById('whatsappProofContent');
                const customerPhone = order.customer?.whatsapp || order.customer?.phone || '';
                let formattedPhone = customerPhone.replace(/\D/g, '');
                if (formattedPhone.startsWith('0')) {
                    formattedPhone = '62' + formattedPhone.substring(1);
                }
                
                let proofStatus = '';
                if (order.whatsappProofVerified) {
                    proofStatus = '<div class="proof-status verified"> Bukti sudah diverifikasi</div>';
                } else if (order.whatsappProofReceived) {
                    proofStatus = '<div class="proof-status received"> Bukti sudah diterima, menunggu verifikasi</div>';
                } else {
                    proofStatus = '<div class="proof-status waiting"> Menunggu bukti transfer</div>';
                }
                
                content.innerHTML = `
                    <div style="padding: 1rem;">
                        <h3 style="color: #25D366; margin-bottom: 1rem;">
                            <i class="fab fa-whatsapp"></i> Bukti Transfer via WhatsApp
                        </h3>
                        
                        ${proofStatus}
                        
                        <div class="customer-info-box">
                            <h4><i class="fas fa-user"></i> Info Pelanggan</h4>
                            <div class="info-row">
                                <span class="info-label">Nama:</span>
                                <span class="info-value">${order.customer?.name || 'Pelanggan'}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">No. Order:</span>
                                <span class="info-value">${order.orderNumber || 'ORD-' + order.id.toString().slice(-6)}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Total:</span>
                                <span class="info-value">Rp ${order.total?.toLocaleString() || '0'}</span>
                            </div>
                            ${customerPhone ? `
                            <div class="info-row">
                                <span class="info-label">WhatsApp:</span>
                                <span class="info-value">
                                    <a href="https://wa.me/${formattedPhone}" target="_blank" style="color: #25D366;">
                                        <i class="fab fa-whatsapp"></i> ${customerPhone}
                                    </a>
                                </span>
                            </div>` : ''}
                        </div>
                        // Di dalam viewWhatsAppProofDetail(), tambahkan petunjuk:
<div style="margin: 1rem 0; padding: 1rem; background: #e3f2fd; border-radius: 8px;">
    <h4><i class="fas fa-info-circle"></i> Cara Cek Bukti Transfer:</h4>
    <ol style="padding-left: 1.5rem; margin: 0.5rem 0;">
        <li><strong>Klik "Buka WhatsApp"</strong> di bawah</li>
        <li>WhatsApp akan terbuka dengan chat pelanggan</li>
        <li><strong>Scroll ke atas</strong> untuk melihat bukti transfer yang dikirim</li>
        <li>Verifikasi jumlah, nama rekening, dan waktu transfer</li>
        <li>Kembali ke halaman ini untuk update status</li>
    </ol>
    ${customerPhone ? `
    <div style="margin-top: 0.5rem; padding: 0.5rem; background: white; border-radius: 4px;">
        <strong>Nomor Pelanggan:</strong> ${customerPhone}
    </div>` : ''}
</div>

<div class="proof-actions">
    <button class="btn" style="background: #25D366; color: white;" 
            onclick="openCustomerWhatsApp('${order.id}')">
        <i class="fab fa-whatsapp"></i> Buka WhatsApp Pelanggan
    </button>
    
    <!-- Tombol lainnya tetap... -->
</div>
                        <div style="margin: 1.5rem 0;">
                            <h4><i class="fas fa-tasks"></i> Langkah Verifikasi</h4>
                            <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-top: 0.5rem;">
                                <ol style="padding-left: 1.5rem; margin: 0;">
                                    <li style="margin-bottom: 0.5rem;">Buka WhatsApp Admin di ponsel</li>
                                    <li style="margin-bottom: 0.5rem;">Cari chat dengan nomor ${customerPhone || 'pelanggan'}</li>
                                    <li style="margin-bottom: 0.5rem;">Periksa bukti transfer yang dikirim</li>
                                    <li>Verifikasi jumlah dan detail transfer</li>
                                </ol>
                            </div>
                        </div>
                        
                        ${order.whatsappProofNotes ? `
                        <div style="margin: 1rem 0; padding: 1rem; background: #e8f4f8; border-radius: 8px;">
                            <h4><i class="fas fa-sticky-note"></i> Catatan Verifikasi</h4>
                            <p>${order.whatsappProofNotes}</p>
                        </div>` : ''}
                        
                        <div class="proof-actions">
                            ${!order.whatsappProofReceived ? `
                            <button class="btn btn-success" onclick="markProofReceived()">
                                <i class="fas fa-check"></i> Sudah Dikirim
                            </button>` : ''}
                            
                            ${order.whatsappProofReceived && !order.whatsappProofVerified ? `
                            <button class="btn btn-primary" onclick="verifyWhatsAppProof('${order.id}')">
                                <i class="fas fa-check-circle"></i> Verifikasi Bukti
                            </button>
                            <button class="btn btn-warning" onclick="addProofNotes('${order.id}')">
                                <i class="fas fa-edit"></i> Tambah Catatan
                            </button>` : ''}
                            
                            <button class="btn btn-secondary" onclick="closeModal('whatsappProofModal')">
                                <i class="fas fa-times"></i> Tutup
                            </button>
                        </div>
                    </div>
                `;
                
                openModal('whatsappProofModal');
                
            } catch (error) {
                console.error('Error viewing WhatsApp proof:', error);
                showToast('Gagal memuat detail WhatsApp', 'error');
            }
        }
        function openCustomerWhatsApp(orderId) {
    if (!adminSystem) return;
    
    try {
        const order = adminSystem.allOrders.find(o => o.id == orderId) || 
                      adminSystem.orders.find(o => o.id == orderId);
        
        if (!order) {
            showToast('Pesanan tidak ditemukan', 'error');
            return;
        }
        
        const customerPhone = order.customer?.whatsapp || order.customer?.phone;
        
        if (!customerPhone) {
            showToast('Nomor WhatsApp pelanggan tidak tersedia', 'error');
            return;
        }
        
        // Format nomor untuk WhatsApp
        let formattedPhone = customerPhone.replace(/\D/g, '');
        if (formattedPhone.startsWith('0')) {
            formattedPhone = '62' + formattedPhone.substring(1);
        }
        
        // Buka WhatsApp langsung ke chat dengan pelanggan
        const whatsappUrl = `https://wa.me/${formattedPhone}`;
        window.open(whatsappUrl, '_blank');
        
        // Tandai bahwa admin sudah cek WhatsApp
        addActivity(`Membuka WhatsApp pelanggan untuk cek bukti transfer (Order: ${order.orderNumber})`);
        
        showToast('Membuka WhatsApp pelanggan...', 'info');
        
    } catch (error) {
        console.error('Error opening WhatsApp:', error);
        showToast('Gagal membuka WhatsApp', 'error');
    }
}

        async function verifyWhatsAppProof(orderId) {
            if (!adminSystem) return;
            
            const verificationNotes = prompt('Catatan verifikasi (opsional):', '');
            
            if (verificationNotes === null) return; // User cancelled
            
            try {
                if (adminSystem.isOnline) {
                    try {
                        const { error } = await supabaseClient
                            .from('orders')
                            .update({
                                whatsapp_proof_verified: true,
                                whatsapp_proof_notes: verificationNotes || '',
                                payment_status: 'verified',
                                updated_at: new Date().toISOString()
                            })
                            .eq('id', orderId);
                        
                        if (error) throw error;
                    } catch (error) {
                        console.warn('Error verifying WhatsApp proof in Supabase:', error.message);
                    }
                }
                
                // Update data lokal
                const orderIndex = adminSystem.allOrders.findIndex(o => o.id == orderId);
                if (orderIndex !== -1) {
                    adminSystem.allOrders[orderIndex].whatsappProofVerified = true;
                    adminSystem.allOrders[orderIndex].whatsappProofNotes = verificationNotes || '';
                    adminSystem.allOrders[orderIndex].paymentStatus = 'verified';
                    
                    // Jika ada di pending orders, update juga
                    const pendingIndex = adminSystem.orders.findIndex(o => o.id == orderId);
                    if (pendingIndex !== -1) {
                        adminSystem.orders[pendingIndex].whatsappProofVerified = true;
                        adminSystem.orders[pendingIndex].whatsappProofNotes = verificationNotes || '';
                        adminSystem.orders[pendingIndex].paymentStatus = 'verified';
                    }
                    
                    saveLocalData();
                    localStorage.setItem('customer_orders', JSON.stringify(adminSystem.allOrders));
                    
                    addActivity(`Bukti WhatsApp diverifikasi untuk pesanan #${adminSystem.allOrders[orderIndex].orderNumber}`);
                    updateProfileStats();
                    
                    showToast('Bukti WhatsApp berhasil diverifikasi', 'success');
                    
                    // Tutup modal dan refresh
                    closeModal('whatsappProofModal');
                    loadNewOrders();
                    loadAllOrders();
                    loadDashboardSection();
                }
                
            } catch (error) {
                console.error('Error verifying WhatsApp proof:', error);
                showToast('Gagal memverifikasi bukti WhatsApp', 'error');
            }
        }

        function addProofNotes(orderId) {
            if (!adminSystem) return;
            
            const notes = prompt('Tambahkan catatan verifikasi:', '');
            
            if (notes === null) return; // User cancelled
            
            try {
                const orderIndex = adminSystem.allOrders.findIndex(o => o.id == orderId);
                if (orderIndex !== -1) {
                    adminSystem.allOrders[orderIndex].whatsappProofNotes = notes;
                    
                    // Jika ada di pending orders, update juga
                    const pendingIndex = adminSystem.orders.findIndex(o => o.id == orderId);
                    if (pendingIndex !== -1) {
                        adminSystem.orders[pendingIndex].whatsappProofNotes = notes;
                    }
                    
                    saveLocalData();
                    localStorage.setItem('customer_orders', JSON.stringify(adminSystem.allOrders));
                    
                    showToast('Catatan berhasil ditambahkan', 'success');
                    
                    // Refresh tampilan
                    viewWhatsAppProofDetail(orderId);
                }
            } catch (error) {
                console.error('Error adding proof notes:', error);
                showToast('Gagal menambahkan catatan', 'error');
            }
        }

        function sendWhatsAppMessage() {
            const phone = document.getElementById('whatsappPhone').value;
            const message = document.getElementById('whatsappMessage').value;
            
            if (!phone || !message) {
                showToast('Harap isi nomor dan pesan', 'error');
                return;
            }
            
            // Format nomor
            let formattedPhone = phone.replace(/\D/g, '');
            if (formattedPhone.startsWith('0')) {
                formattedPhone = '62' + formattedPhone.substring(1);
            }
            
            // Encode message untuk URL
            const encodedMessage = encodeURIComponent(message);
            
            // Buka WhatsApp
            const whatsappUrl = `https://wa.me/${formattedPhone}?text=${encodedMessage}`;
            window.open(whatsappUrl, '_blank');
            
            showToast('WhatsApp dibuka untuk mengirim pesan', 'success');
            closeModal('whatsappMessageModal');
        }

        function openWhatsAppMessageModal(phone = '', message = '') {
            document.getElementById('whatsappPhone').value = phone;
            document.getElementById('whatsappMessage').value = message;
            openModal('whatsappMessageModal');
        }

        // ============================
        // ACTION FUNCTIONS
        // ============================
        async function confirmOrder(orderId) {
            if (!adminSystem) return;
            
            // Cek apakah pesanan menggunakan WhatsApp dan belum ada bukti
            const order = adminSystem.allOrders.find(o => o.id == orderId) || 
                          adminSystem.orders.find(o => o.id == orderId);
            
            if (order && order.paymentMethod === 'whatsapp' && !order.whatsappProofReceived) {
                if (!confirm('Pesanan ini menggunakan WhatsApp transfer. Apakah bukti transfer sudah diterima di WhatsApp?')) {
                    // Arahkan ke cek WhatsApp proof
                    checkWhatsAppProof(orderId);
                    return;
                }
            }
            
            if (confirm('Konfirmasi pesanan ini?')) {
                try {
                    if (adminSystem.isOnline) {
                        try {
                            const { error } = await supabaseClient
                                .from('orders')
                                .update({
                                    status: 'confirmed',
                                    admin_seen: true,
                                    updated_at: new Date().toISOString()
                                })
                                .eq('id', orderId);
                            
                            if (error) throw error;
                        } catch (error) {
                            console.warn('Error confirming order in Supabase:', error.message);
                        }
                    }
                    
                    const orderIndex = adminSystem.allOrders.findIndex(o => o.id == orderId);
                    if (orderIndex !== -1) {
                        adminSystem.allOrders[orderIndex].status = 'confirmed';
                        adminSystem.allOrders[orderIndex].adminSeen = true;
                        
                        const pendingIndex = adminSystem.orders.findIndex(o => o.id == orderId);
                        if (pendingIndex !== -1) {
                            adminSystem.orders.splice(pendingIndex, 1);
                        }
                        
                        saveLocalData();
                        localStorage.setItem('customer_orders', JSON.stringify(adminSystem.allOrders));
                        
                        addActivity(`Pesanan #${adminSystem.allOrders[orderIndex].orderNumber} dikonfirmasi`);
                        updateNotifications();
                        updateProfileStats();
                        
                        showToast('Pesanan berhasil dikonfirmasi', 'success');
                        loadNewOrders();
                        loadAllOrders();
                        loadDashboardSection();
                    }
                } catch (error) {
                    console.error('Error confirming order:', error);
                    showToast('Gagal mengonfirmasi pesanan', 'error');
                }
            }
        }

        async function rejectOrder(orderId) {
            if (!adminSystem) return;
            
            const reason = prompt('Alasan menolak pesanan:', '');
            if (reason === null) return; // User cancelled
            if (!reason || reason.trim() === '') {
                showToast('Harap isi alasan penolakan', 'error');
                return;
            }
            
            if (confirm(`Yakin ingin menolak pesanan ini?\n\nAlasan: ${reason}`)) {
                try {
                    if (adminSystem.isOnline) {
                        try {
                            const { error } = await supabaseClient
                                .from('orders')
                                .update({
                                    status: 'rejected',
                                    admin_seen: true,
                                    cancellation_reason: reason,
                                    updated_at: new Date().toISOString()
                                })
                                .eq('id', orderId);
                            
                            if (error) throw error;
                        } catch (error) {
                            console.warn('Error rejecting order in Supabase:', error.message);
                        }
                    }
                    
                    const orderIndex = adminSystem.allOrders.findIndex(o => o.id == orderId);
                    if (orderIndex !== -1) {
                        adminSystem.allOrders[orderIndex].status = 'rejected';
                        adminSystem.allOrders[orderIndex].adminSeen = true;
                        adminSystem.allOrders[orderIndex].cancellationReason = reason;
                        
                        const pendingIndex = adminSystem.orders.findIndex(o => o.id == orderId);
                        if (pendingIndex !== -1) {
                            adminSystem.orders.splice(pendingIndex, 1);
                        }
                        
                        saveLocalData();
                        localStorage.setItem('customer_orders', JSON.stringify(adminSystem.allOrders));
                        
                        addActivity(`Pesanan #${adminSystem.allOrders[orderIndex].orderNumber} ditolak`);
                        updateNotifications();
                        updateProfileStats();
                        
                        showToast('Pesanan berhasil ditolak', 'success');
                        loadNewOrders();
                        loadAllOrders();
                        loadDashboardSection();
                    }
                } catch (error) {
                    console.error('Error rejecting order:', error);
                    showToast('Gagal menolak pesanan', 'error');
                }
            }
        }

        async function reopenOrder(orderId) {
            if (!adminSystem) return;
            
            if (confirm('Yakin ingin membuka kembali pesanan ini?')) {
                try {
                    if (adminSystem.isOnline) {
                        try {
                            const { error } = await supabaseClient
                                .from('orders')
                                .update({
                                    status: 'pending',
                                    admin_seen: false,
                                    cancellation_reason: null,
                                    updated_at: new Date().toISOString()
                                })
                                .eq('id', orderId);
                            
                            if (error) throw error;
                        } catch (error) {
                            console.warn('Error reopening order in Supabase:', error.message);
                        }
                    }
                    
                    const orderIndex = adminSystem.allOrders.findIndex(o => o.id == orderId);
                    if (orderIndex !== -1) {
                        adminSystem.allOrders[orderIndex].status = 'pending';
                        adminSystem.allOrders[orderIndex].adminSeen = false;
                        adminSystem.allOrders[orderIndex].cancellationReason = null;
                        
                        // Tambahkan ke pesanan baru jika belum ada
                        const existsInOrders = adminSystem.orders.some(o => o.id == orderId);
                        if (!existsInOrders) {
                            adminSystem.orders.push(adminSystem.allOrders[orderIndex]);
                        }
                        
                        saveLocalData();
                        localStorage.setItem('customer_orders', JSON.stringify(adminSystem.allOrders));
                        
                        addActivity(`Pesanan #${adminSystem.allOrders[orderIndex].orderNumber} dibuka kembali`);
                        updateNotifications();
                        updateProfileStats();
                        
                        showToast('Pesanan berhasil dibuka kembali', 'success');
                        loadNewOrders();
                        loadAllOrders();
                        loadDashboardSection();
                    }
                } catch (error) {
                    console.error('Error reopening order:', error);
                    showToast('Gagal membuka kembali pesanan', 'error');
                }
            }
        }

        async function completeOrder(orderId) {
            if (!adminSystem) return;
            
            if (confirm('Tandai pesanan ini sebagai selesai?')) {
                try {
                    if (adminSystem.isOnline) {
                        try {
                            const { error } = await supabaseClient
                                .from('orders')
                                .update({
                                    status: 'completed',
                                    updated_at: new Date().toISOString()
                                })
                                .eq('id', orderId);
                            
                            if (error) throw error;
                        } catch (error) {
                            console.warn('Error completing order in Supabase:', error.message);
                        }
                    }
                    
                    const orderIndex = adminSystem.allOrders.findIndex(o => o.id == orderId);
                    if (orderIndex !== -1) {
                        adminSystem.allOrders[orderIndex].status = 'completed';
                        
                        const pendingIndex = adminSystem.orders.findIndex(o => o.id == orderId);
                        if (pendingIndex !== -1) {
                            adminSystem.orders.splice(pendingIndex, 1);
                        }
                        
                        saveLocalData();
                        localStorage.setItem('customer_orders', JSON.stringify(adminSystem.allOrders));
                        
                        addActivity(`Pesanan #${adminSystem.allOrders[orderIndex].orderNumber} diselesaikan`);
                        updateNotifications();
                        updateProfileStats();
                        
                        showToast('Pesanan berhasil diselesaikan', 'success');
                        loadAllOrders();
                        loadDashboardSection();
                    }
                } catch (error) {
                    console.error('Error completing order:', error);
                    showToast('Gagal menyelesaikan pesanan', 'error');
                }
            }
        }

        async function confirmReservation(reservationId) {
            if (!adminSystem) return;
            
            if (confirm('Konfirmasi reservasi ini?')) {
                try {
                    if (adminSystem.isOnline) {
                        try {
                            const { error } = await supabaseClient
                                .from('reservations')
                                .update({
                                    status: 'confirmed',
                                    admin_seen: true,
                                    updated_at: new Date().toISOString()
                                })
                                .eq('id', reservationId);
                            
                            if (error) throw error;
                        } catch (error) {
                            console.warn('Error confirming reservation in Supabase:', error.message);
                        }
                    }
                    
                    const resIndex = adminSystem.allReservations.findIndex(r => r.id == reservationId);
                    if (resIndex !== -1) {
                        adminSystem.allReservations[resIndex].status = 'confirmed';
                        adminSystem.allReservations[resIndex].adminSeen = true;
                        
                        const pendingIndex = adminSystem.reservations.findIndex(r => r.id == reservationId);
                        if (pendingIndex !== -1) {
                            adminSystem.reservations.splice(pendingIndex, 1);
                        }
                        
                        saveLocalData();
                        localStorage.setItem('customer_reservations', JSON.stringify(adminSystem.allReservations));
                        
                        addActivity(`Reservasi #${reservationId} dikonfirmasi`);
                        updateNotifications();
                        updateProfileStats();
                        
                        showToast('Reservasi berhasil dikonfirmasi', 'success');
                        loadReservations();
                        loadAllReservations();
                        loadDashboardSection();
                    }
                } catch (error) {
                    console.error('Error confirming reservation:', error);
                    showToast(`Gagal mengonfirmasi reservasi`, 'error');
                }
            }
        }

        async function rejectReservation(reservationId) {
            if (!adminSystem) return;
            
            const reason = prompt('Alasan menolak reservasi:', '');
            if (reason === null) return; // User cancelled
            if (!reason || reason.trim() === '') {
                showToast('Harap isi alasan penolakan', 'error');
                return;
            }
            
            if (confirm(`Yakin ingin menolak reservasi ini?\n\nAlasan: ${reason}`)) {
                try {
                    if (adminSystem.isOnline) {
                        try {
                            const { error } = await supabaseClient
                                .from('reservations')
                                .update({
                                    status: 'rejected',
                                    admin_seen: true,
                                    cancellation_reason: reason,
                                    updated_at: new Date().toISOString()
                                })
                                .eq('id', reservationId);
                            
                            if (error) throw error;
                        } catch (error) {
                            console.warn('Error rejecting reservation in Supabase:', error.message);
                        }
                    }
                    
                    const resIndex = adminSystem.allReservations.findIndex(r => r.id == reservationId);
                    if (resIndex !== -1) {
                        adminSystem.allReservations[resIndex].status = 'rejected';
                        adminSystem.allReservations[resIndex].adminSeen = true;
                        adminSystem.allReservations[resIndex].cancellationReason = reason;
                        
                        const pendingIndex = adminSystem.reservations.findIndex(r => r.id == reservationId);
                        if (pendingIndex !== -1) {
                            adminSystem.reservations.splice(pendingIndex, 1);
                        }
                        
                        saveLocalData();
                        localStorage.setItem('customer_reservations', JSON.stringify(adminSystem.allReservations));
                        
                        addActivity(`Reservasi #${reservationId} ditolak`);
                        updateNotifications();
                        updateProfileStats();
                        
                        showToast('Reservasi berhasil ditolak', 'success');
                        loadReservations();
                        loadAllReservations();
                        loadDashboardSection();
                    }
                } catch (error) {
                    console.error('Error rejecting reservation:', error);
                    showToast('Gagal menolak reservasi', 'error');
                }
            }
        }

        async function reopenReservation(reservationId) {
            if (!adminSystem) return;
            
            if (confirm('Yakin ingin membuka kembali reservasi ini?')) {
                try {
                    if (adminSystem.isOnline) {
                        try {
                            const { error } = await supabaseClient
                                .from('reservations')
                                .update({
                                    status: 'pending',
                                    admin_seen: false,
                                    cancellation_reason: null,
                                    updated_at: new Date().toISOString()
                                })
                                .eq('id', reservationId);
                            
                            if (error) throw error;
                        } catch (error) {
                            console.warn('Error reopening reservation in Supabase:', error.message);
                        }
                    }
                    
                    const resIndex = adminSystem.allReservations.findIndex(r => r.id == reservationId);
                    if (resIndex !== -1) {
                        adminSystem.allReservations[resIndex].status = 'pending';
                        adminSystem.allReservations[resIndex].adminSeen = false;
                        adminSystem.allReservations[resIndex].cancellationReason = null;
                        
                        // Tambahkan ke reservasi baru jika belum ada
                        const existsInReservations = adminSystem.reservations.some(r => r.id == reservationId);
                        if (!existsInReservations) {
                            adminSystem.reservations.push(adminSystem.allReservations[resIndex]);
                        }
                        
                        saveLocalData();
                        localStorage.setItem('customer_reservations', JSON.stringify(adminSystem.allReservations));
                        
                        addActivity(`Reservasi #${reservationId} dibuka kembali`);
                        updateNotifications();
                        updateProfileStats();
                        
                        showToast('Reservasi berhasil dibuka kembali', 'success');
                        loadReservations();
                        loadAllReservations();
                        loadDashboardSection();
                    }
                } catch (error) {
                    console.error('Error reopening reservation:', error);
                    showToast('Gagal membuka kembali reservasi', 'error');
                }
            }
        }

        // ============================
        // MENU FUNCTIONS
        // ============================
        function openAddMenuModal() {
            document.getElementById('menuModalTitle').textContent = 'Tambah Menu';
            document.getElementById('menuId').value = '';
            document.getElementById('menuForm').reset();
            
            document.getElementById('stockManagement').value = 'regular';
            document.getElementById('dailyStockContainer').style.display = 'none';
            document.getElementById('dailyStock').value = '';
            
            document.getElementById('menuIsPromo').checked = false;
            document.getElementById('originalPriceContainer').style.display = 'none';
            document.getElementById('menuOriginalPrice').value = '';
            
            currentImageBase64 = null;
            const previewContainer = document.getElementById('imagePreviewContainer');
            const preview = document.getElementById('imagePreview');
            previewContainer.style.display = 'none';
            preview.src = '';
            
            openModal('menuModal');
        }

        async function editMenu(menuId) {
            if (!adminSystem) return;
            
            try {
                const menu = adminSystem.menus.find(m => m.id == menuId);
                if (!menu) {
                    showToast('Menu tidak ditemukan', 'error');
                    return;
                }
                
                document.getElementById('menuModalTitle').textContent = 'Edit Menu';
                document.getElementById('menuId').value = menu.id;
                document.getElementById('menuName').value = menu.name;
                document.getElementById('menuPrice').value = menu.price;
                document.getElementById('menuStock').value = menu.stock || 0;
                document.getElementById('menuCategory').value = menu.category || 'minuman';
                document.getElementById('menuDescription').value = menu.description || '';
                document.getElementById('menuIsPromo').checked = menu.isPromo || false;
                
                if (menu.isDailyStock) {
                    document.getElementById('stockManagement').value = 'daily';
                    document.getElementById('dailyStockContainer').style.display = 'block';
                    document.getElementById('dailyStock').value = menu.dailyStock || 0;
                } else {
                    document.getElementById('stockManagement').value = 'regular';
                    document.getElementById('dailyStockContainer').style.display = 'none';
                    document.getElementById('dailyStock').value = '';
                }
                
                if (menu.isPromo && menu.originalPrice) {
                    document.getElementById('originalPriceContainer').style.display = 'block';
                    document.getElementById('menuOriginalPrice').value = menu.originalPrice;
                } else {
                    document.getElementById('originalPriceContainer').style.display = 'none';
                    document.getElementById('menuOriginalPrice').value = '';
                }
                
                currentImageBase64 = menu.image || null;
                const previewContainer = document.getElementById('imagePreviewContainer');
                const preview = document.getElementById('imagePreview');
                
                if (currentImageBase64) {
                    preview.src = currentImageBase64;
                    previewContainer.style.display = 'block';
                } else {
                    previewContainer.style.display = 'none';
                }
                
                openModal('menuModal');
            } catch (error) {
                console.error('Error editing menu:', error);
                showToast('Gagal memuat data menu', 'error');
            }
        }

        async function deleteMenu(menuId) {
            if (!adminSystem) return;
            
            if (confirm('Yakin ingin menghapus menu ini?')) {
                try {
                    if (adminSystem.isOnline) {
                        try {
                            const { error } = await supabaseClient
                                .from('menu_items')
                                .update({
                                    is_active: false,
                                    updated_at: new Date().toISOString()
                                })
                                .eq('id', menuId);
                            
                            if (error) throw error;
                        } catch (error) {
                            console.warn('Error deleting menu from Supabase:', error.message);
                        }
                    }
                    
                    const menuIndex = adminSystem.menus.findIndex(m => m.id == menuId);
                    if (menuIndex !== -1) {
                        const menuName = adminSystem.menus[menuIndex].name;
                        adminSystem.menus.splice(menuIndex, 1);
                        saveLocalData();
                        
                        localStorage.setItem('cafe_menus', JSON.stringify(adminSystem.menus));
                        addActivity(`Menu "${menuName}" dihapus`);
                        updateProfileStats();
                        
                        showToast('Menu berhasil dihapus', 'success');
                        loadMenuManagement();
                        loadDashboardSection();
                    }
                } catch (error) {
                    console.error('Error deleting menu:', error);
                    showToast('Gagal menghapus menu', 'error');
                }
            }
        }

        function openRestockModal(menuId) {
            const menu = adminSystem.menus.find(m => m.id == menuId);
            if (!menu) return;
            
            const quantity = prompt(`Restock ${menu.name}\n\nStok saat ini: ${getAvailableStock(menu)}\nJumlah tambahan:`, "10");
            
            if (quantity && !isNaN(quantity) && parseInt(quantity) > 0) {
                restockMenu(menuId, parseInt(quantity));
            }
        }

        function getAvailableStock(menu) {
            if (menu.isDailyStock && menu.currentDailyStock !== null) {
                return menu.currentDailyStock;
            }
            return menu.stock || 0;
        }

        async function restockMenu(menuId, quantity) {
            if (!adminSystem) return;
            
            try {
                const menu = adminSystem.menus.find(m => m.id == menuId);
                if (!menu) return;
                
                const newStock = (menu.stock || 0) + quantity;
                const menuData = {
                    ...menu,
                    stock: newStock
                };
                
                if (adminSystem.isOnline) {
                    try {
                        const { error } = await supabaseClient
                            .from('menu_items')
                            .update({
                                stock: newStock,
                                updated_at: new Date().toISOString()
                            })
                            .eq('id', menuId);
                        
                        if (error) throw error;
                    } catch (error) {
                        console.warn('Error updating menu stock in Supabase:', error.message);
                    }
                }
                
                adminSystem.menus = adminSystem.menus.map(m => 
                    m.id == menuId ? { ...m, stock: newStock } : m
                );
                
                saveLocalData();
                localStorage.setItem('cafe_menus', JSON.stringify(adminSystem.menus));
                updateProfileStats();
                
                showToast(`Menu "${menu.name}" berhasil direstock +${quantity}`, 'success');
                loadMenuManagement();
                loadDashboardSection();
                
            } catch (error) {
                console.error('Error restocking menu:', error);
                showToast('Gagal melakukan restock', 'error');
            }
        }

        async function restockAllMenus() {
            if (!adminSystem) return;
            
            const quantity = prompt('Jumlah stok yang akan ditambahkan ke semua menu:', "10");
            
            if (quantity && !isNaN(quantity) && parseInt(quantity) > 0) {
                if (confirm(`Tambahkan ${quantity} stok ke semua menu?`)) {
                    const qty = parseInt(quantity);
                    
                    for (const menu of adminSystem.menus) {
                        const newStock = (menu.stock || 0) + qty;
                        const menuData = { ...menu, stock: newStock };
                        
                        if (adminSystem.isOnline) {
                            try {
                                await supabaseClient
                                    .from('menu_items')
                                    .update({
                                        stock: newStock,
                                        updated_at: new Date().toISOString()
                                    })
                                    .eq('id', menu.id);
                            } catch (error) {
                                console.warn('Error updating menu stock in Supabase:', error.message);
                            }
                        }
                        
                        menu.stock = newStock;
                    }
                    
                    saveLocalData();
                    localStorage.setItem('cafe_menus', JSON.stringify(adminSystem.menus));
                    updateProfileStats();
                    
                    showToast(`Semua menu berhasil direstock +${qty}`, 'success');
                    loadMenuManagement();
                    loadDashboardSection();
                }
            }
        }

        // ============================
        // TABLE FUNCTIONS
        // ============================
        function openAddTableModal() {
            document.getElementById('tableModalTitle').textContent = 'Tambah Meja';
            document.getElementById('tableId').value = '';
            document.getElementById('tableForm').reset();
            openModal('tableModal');
        }

        function editTable(tableId) {
            try {
                const tables = JSON.parse(localStorage.getItem('cafe_tables') || '[]');
                const table = tables.find(t => t.id == tableId);
                
                if (!table) {
                    showToast('Meja tidak ditemukan', 'error');
                    return;
                }
                
                document.getElementById('tableModalTitle').textContent = 'Edit Meja';
                document.getElementById('tableId').value = table.id;
                document.getElementById('tableNumber').value = table.number;
                document.getElementById('tableCapacity').value = table.capacity;
                document.getElementById('tableLocation').value = table.location || 'indoor';
                document.getElementById('tableStatus').value = table.status || 'available';
                document.getElementById('tableDescription').value = table.description || '';
                
                openModal('tableModal');
            } catch (error) {
                console.error('Error editing table:', error);
                showToast('Gagal memuat data meja', 'error');
            }
        }

        function deleteTable(tableId) {
            if (confirm('Yakin ingin menghapus meja ini?')) {
                try {
                    const tables = JSON.parse(localStorage.getItem('cafe_tables') || '[]');
                    const updatedTables = tables.filter(t => t.id != tableId);
                    localStorage.setItem('cafe_tables', JSON.stringify(updatedTables));
                    updateProfileStats();
                    showToast('Meja berhasil dihapus', 'success');
                    loadTablesManagement();
                } catch (error) {
                    console.error('Error deleting table:', error);
                    showToast('Gagal menghapus meja', 'error');
                }
            }
        }

        // ============================
        // UTILITY FUNCTIONS
        // ============================
        function toggleDailyStockOption() {
            const stockManagement = document.getElementById('stockManagement').value;
            const dailyStockContainer = document.getElementById('dailyStockContainer');
            
            if (stockManagement === 'daily') {
                dailyStockContainer.style.display = 'block';
                document.getElementById('dailyStock').required = true;
            } else {
                dailyStockContainer.style.display = 'none';
                document.getElementById('dailyStock').required = false;
            }
        }

        function showToast(message, type = 'success') {
            try {
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.innerHTML = `
                    <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
                    <span>${message}</span>
                `;
                document.body.appendChild(toast);
                
                setTimeout(() => toast.classList.add('show'), 100);
                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            } catch (error) {
                console.error('Error showing toast:', error);
                alert(message);
            }
        }

        function openModal(modalId) {
            try {
                document.getElementById(modalId).style.display = 'flex';
            } catch (error) {
                console.error('Error opening modal:', error);
            }
        }

        function closeModal(modalId) {
            try {
                document.getElementById(modalId).style.display = 'none';
            } catch (error) {
                console.error('Error closing modal:', error);
            }
        }

        async function refreshData() {
            if (!adminSystem) return;
            
            try {
                await syncFromSupabase();
                loadSectionData(currentSection);
                updateProfileStats();
                showToast('Data berhasil direfresh', 'success');
            } catch (error) {
                console.error('Error refreshing data:', error);
                showToast('Gagal merefresh data', 'error');
            }
        }

        async function refreshOrders() {
            if (!adminSystem) return;
            
            try {
                await syncOrdersFromSupabase();
                loadNewOrders();
                updateProfileStats();
                showToast('Pesanan berhasil direfresh', 'success');
            } catch (error) {
                console.error('Error refreshing orders:', error);
                showToast('Gagal merefresh pesanan', 'error');
            }
        }

        async function refreshReservations() {
            if (!adminSystem) return;
            
            try {
                await syncReservationsFromSupabase();
                loadReservations();
                updateProfileStats();
                showToast('Reservasi berhasil direfresh', 'success');
            } catch (error) {
                console.error('Error refreshing reservations:', error);
                showToast('Gagal merefresh reservasi', 'error');
            }
        }

        async function refreshAllOrders() {
            if (!adminSystem) return;
            
            try {
                await syncOrdersFromSupabase();
                loadAllOrders();
                updateProfileStats();
                showToast('Semua pesanan berhasil direfresh', 'success');
            } catch (error) {
                console.error('Error refreshing all orders:', error);
                showToast('Gagal merefresh semua pesanan', 'error');
            }
        }

        async function refreshAllReservations() {
            if (!adminSystem) return;
            
            try {
                await syncReservationsFromSupabase();
                loadAllReservations();
                updateProfileStats();
                showToast('Semua reservasi berhasil direfresh', 'success');
            } catch (error) {
                console.error('Error refreshing all reservations:', error);
                showToast('Gagal merefresh semua reservasi', 'error');
            }
        }

        function filterAllOrders(status) {
            try {
                const rows = document.querySelectorAll('#allOrdersTable tr');
                rows.forEach(row => {
                    if (row.cells[4]) {
                        const badge = row.cells[4].querySelector('.status-badge');
                        if (badge) {
                            const rowStatus = badge.className.includes('status-' + status);
                            if (status === 'all' || rowStatus) {
                                row.style.display = '';
                            } else {
                                row.style.display = 'none';
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error filtering orders:', error);
            }
        }

        function filterAllReservations(status) {
            try {
                const rows = document.querySelectorAll('#allReservationsTable tr');
                rows.forEach(row => {
                    if (row.cells[5]) {
                        const badge = row.cells[5].querySelector('.status-badge');
                        if (badge) {
                            const rowStatus = badge.className.includes(status);
                            if (status === 'all' || rowStatus) {
                                row.style.display = '';
                            } else {
                                row.style.display = 'none';
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error filtering reservations:', error);
            }
        }

        function showNotifications() {
            if (!adminSystem) return;
            
            const newOrders = adminSystem.orders.filter(order => 
                !order.adminSeen && (order.status === 'pending' || order.status === 'waiting_payment')
            );
            
            const newReservations = adminSystem.reservations.filter(r => 
                !r.adminSeen && r.status === 'pending'
            );
            
            let message = '';
            if (newOrders.length > 0) {
                message += ` ${newOrders.length} pesanan baru menunggu konfirmasi\n`;
            }
            if (newReservations.length > 0) {
                message += ` ${newReservations.length} reservasi baru menunggu konfirmasi`;
            }
            
            if (message) {
                alert(' Notifikasi:\n' + message);
                newOrders.forEach(order => order.adminSeen = true);
                newReservations.forEach(res => res.adminSeen = true);
                updateNotifications();
            } else {
                alert(' Tidak ada notifikasi baru');
            }
        }
function viewOrderDetail(orderId) {
    if (!adminSystem) return;
    
    try {
        const order = adminSystem.allOrders.find(o => o.id == orderId) || 
                      adminSystem.orders.find(o => o.id == orderId);
        
        if (!order) {
            showToast('Pesanan tidak ditemukan', 'error');
            return;
        }
        
        const modal = document.getElementById('orderDetailModal');
        const content = document.getElementById('orderDetailContent');
        
        // Format waktu
        let formattedTime = 'Waktu tidak tersedia';
        try {
            if (order.createdAt) {
                const orderDate = new Date(order.createdAt);
                formattedTime = orderDate.toLocaleString('id-ID', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }
        } catch (e) {
            console.warn('Error formatting time:', e);
        }
        
        // Tentukan status WhatsApp
        let whatsappStatusHTML = '';
        if (order.paymentMethod === 'whatsapp') {
            let statusText = '';
            let statusClass = '';
            let statusIcon = '';
            
            if (order.whatsappProofVerified) {
                statusText = ' Bukti transfer sudah diverifikasi';
                statusClass = 'verified';
                statusIcon = 'fa-check-circle';
            } else if (order.whatsappProofReceived) {
                statusText = ' Bukti transfer sudah diterima, menunggu verifikasi';
                statusClass = 'received';
                statusIcon = 'fa-check';
            } else {
                statusText = ' Menunggu bukti transfer dari pelanggan';
                statusClass = 'waiting';
                statusIcon = 'fa-clock';
            }
            
            whatsappStatusHTML = `
                <div class="whatsapp-info ${statusClass}" style="margin: 1rem 0;">
                    <p><i class="fas ${statusIcon}"></i> <strong>Status WhatsApp:</strong> ${statusText}</p>
                    ${order.whatsappProofNotes ? `
                    <div style="margin-top: 0.5rem; padding: 0.5rem; background: rgba(255,255,255,0.5); border-radius: 4px;">
                        <strong>Catatan:</strong> ${order.whatsappProofNotes}
                    </div>` : ''}
                </div>
            `;
        }
        
        let html = `
            <div style="padding: 1rem;">
                <h3 style="margin-bottom: 1rem; color: #8B4513;">Detail Pesanan</h3>
                
                <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                        <div>
                            <strong>No. Order:</strong><br>
                            ${order.orderNumber || 'ORD-' + (order.id || '').toString().slice(-6)}
                        </div>
                        <div>
                            <strong>Tanggal:</strong><br>
                            ${formattedTime}
                        </div>
                        <div>
                            <strong>Pelanggan:</strong><br>
                            ${order.customer?.name || 'Pelanggan'}
                        </div>
                        <div>
                            <strong>Total:</strong><br>
                            Rp ${(order.total || 0).toLocaleString()}
                        </div>
                        <div>
                            <strong>Status Pesanan:</strong><br>
                            <span class="status-badge status-${order.status || 'pending'}">
                                ${getStatusText(order.status || 'pending')}
                            </span>
                        </div>
                        <div>
                            <strong>Metode Pembayaran:</strong><br>
                            ${order.paymentMethod === 'whatsapp' ? 'Transfer via WhatsApp' : 'Transfer Bank'}
                        </div>
                    </div>
                </div>
                
                ${whatsappStatusHTML}
                
                <div style="margin-bottom: 1rem;">
                    <h4 style="color: #495057; margin-bottom: 0.5rem;">
                        <i class="fas fa-boxes"></i> Items Pesanan
                    </h4>
                    <div style="background: white; padding: 1rem; border-radius: 8px; border: 1px solid #ddd;">
        `;
        
        if (order.items && order.items.length > 0) {
            order.items.forEach(item => {
                const itemName = item.name || item.menu_name || 'Item';
                const quantity = item.quantity || 1;
                const price = item.price || item.unit_price || 0;
                const total = price * quantity;
                
                html += `
                    <div style="display: flex; justify-content: space-between; padding: 0.3rem 0; border-bottom: 1px solid #f0f0f0;">
                        <span>${itemName} (${quantity}x)</span>
                        <span>Rp ${total.toLocaleString()}</span>
                    </div>
                `;
            });
        } else {
            html += `<p style="text-align: center; color: #666;">Tidak ada detail items</p>`;
        }
        
        html += `
                        <div style="display: flex; justify-content: space-between; padding-top: 0.5rem; margin-top: 0.5rem; border-top: 2px solid #ddd; font-weight: bold;">
                            <span>TOTAL</span>
                            <span>Rp ${(order.total || 0).toLocaleString()}</span>
                        </div>
                    </div>
                </div>
                
                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 1.5rem;">
        `;
        
        // Tombol aksi berdasarkan status
        if (order.status === 'pending' || order.status === 'waiting_payment') {
            html += `
    <button class="btn" style="background: #25D366; color: white;" 
            onclick="openCustomerWhatsApp('${orderId}')"
            title="Buka WhatsApp pelanggan untuk melihat bukti transfer">
        <i class="fab fa-whatsapp"></i> Lihat WhatsApp
    </button>
`;
        }
        
        // Tombol khusus WhatsApp
        if (order.paymentMethod === 'whatsapp') {
            html += `
                <button class="btn btn-warning" onclick="viewWhatsAppProofDetail('${orderId}')">
                    <i class="fab fa-whatsapp"></i> Detail Bukti WhatsApp
                </button>
            `;
        }
        
        // Tombol WhatsApp jika pelanggan memiliki nomor
        if (order.customer?.whatsapp || order.customer?.phone) {
            const phone = order.customer.whatsapp || order.customer.phone;
            html += `
                <button class="btn" style="background: #25D366; color: white;" 
                        onclick="openWhatsAppMessageModal('${phone}', 'Halo ${order.customer?.name || 'Pelanggan'}, mengenai pesanan ${order.orderNumber || ''} di MAN CAFE  akan segera kami konfirmasi... Terimakasih sudah memesan di MAN cafe, silahkan jika ingin melakukan reservasi meja setelah kami konfirmasi')">
                    <i class="fab fa-whatsapp"></i> Chat Pelanggan
                </button>
            `;
        }
        
        html += `
                    <button class="btn btn-secondary" onclick="closeModal('orderDetailModal')" style="margin-left: auto;">
                        <i class="fas fa-times"></i> Tutup
                    </button>
                </div>
            </div>
        `;
        
        content.innerHTML = html;
        modal.style.display = 'flex';
        
    } catch (error) {
        console.error('Error viewing order detail:', error);
        showToast('Gagal memuat detail pesanan', 'error');
    }
}

function quickCheckWhatsAppStatus(orderId) {
    if (!adminSystem) return;
    
    try {
        const order = adminSystem.allOrders.find(o => o.id == orderId) || 
                      adminSystem.orders.find(o => o.id == orderId);
        
        if (!order) {
            showToast('Pesanan tidak ditemukan', 'error');
            return;
        }
        
        if (order.paymentMethod !== 'whatsapp') {
            showToast('Pesanan ini tidak menggunakan WhatsApp transfer', 'info');
            return;
        }
        
        let message = ` Status WhatsApp Transfer\n\n`;
        message += `Order: ${order.orderNumber || 'ORD-' + order.id.toString().slice(-6)}\n`;
        message += `Pelanggan: ${order.customer?.name || 'Pelanggan'}\n`;
        message += `Total: Rp ${order.total?.toLocaleString() || '0'}\n\n`;
        message += `Status Bukti Transfer:\n`;
        
        if (order.whatsappProofVerified) {
            message += ` Sudah diverifikasi\n`;
            if (order.whatsappProofNotes) {
                message += `Catatan: ${order.whatsappProofNotes}\n`;
            }
        } else if (order.whatsappProofReceived) {
            message += ` Sudah dikirim, menunggu verifikasi\n`;
            if (order.whatsappProofNotes) {
                message += `Catatan: ${order.whatsappProofNotes}\n`;
            }
        } else {
            message += ` Belum ada bukti transfer\n`;
            message += `\nLangkah:\n`;
            message += `1. Buka WhatsApp Admin\n`;
            message += `2. Cari pesan dari ${order.customer?.whatsapp || order.customer?.phone || 'pelanggan'}\n`;
            message += `3. Periksa apakah bukti sudah dikirim\n`;
        }
        
        // Tampilkan alert dengan opsi
        const userChoice = confirm(message + '\n\nKlik OK untuk melihat detail lengkap, atau Cancel untuk tetap di sini.');
        
        if (userChoice) {
            viewWhatsAppProofDetail(orderId);
        }
        
    } catch (error) {
        console.error('Error in quick check:', error);
        showToast('Gagal memeriksa status WhatsApp', 'error');
    }
}

        function viewReservationDetail(reservationId) {
            if (!adminSystem) return;
            
            try {
                const reservation = adminSystem.allReservations.find(r => r.id == reservationId) || 
                                  adminSystem.reservations.find(r => r.id == reservationId);
                if (!reservation) return;
                
                const content = document.getElementById('reservationDetailContent');
                content.innerHTML = `
                    <div style="padding: 1rem 0;">
                        <h3 style="margin-bottom: 1rem;">Detail Reservasi</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                            <div>
                                <strong>No. Reservasi:</strong><br>
                                #${reservation.id.toString().slice(-6)}
                            </div>
                            <div>
                                <strong>Tanggal:</strong><br>
                                ${reservation.date ? new Date(reservation.date).toLocaleDateString('id-ID') : '-'}
                            </div>
                            <div>
                                <strong>Nama:</strong><br>
                                ${reservation.name}
                            </div>
                            <div>
                                <strong>Telepon:</strong><br>
                                ${reservation.phone}
                            </div>
                            <div>
                                <strong>Waktu:</strong><br>
                                ${reservation.time || '-'}
                            </div>
                            <div>
                                <strong>Meja:</strong><br>
                                ${reservation.tableNumber || '-'}
                            </div>
                        </div>
                        
                        ${reservation.cancellationReason ? `
                        <div style="margin: 1rem 0; padding: 0.8rem; background: #f8d7da; border-radius: 6px; border-left: 4px solid #dc3545;">
                            <strong><i class="fas fa-exclamation-triangle"></i> Alasan Ditolak:</strong><br>
                            ${reservation.cancellationReason}
                        </div>` : ''}
                        
                        ${reservation.notes ? `
                        <div style="margin-bottom: 1rem;">
                            <strong>Catatan:</strong><br>
                            ${reservation.notes}
                        </div>` : ''}
                        
                        <div style="margin-bottom: 1rem;">
                            <strong>Status:</strong><br>
                            <span class="status-badge ${reservation.status === 'confirmed' ? 'status-confirmed' : 
                                                     reservation.status === 'cancelled' ? 'status-cancelled' : 
                                                     'status-pending'}">
                                ${reservation.status === 'confirmed' ? 'Dikonfirmasi' : 
                                 reservation.status === 'cancelled' ? 'Ditolak' : 
                                 'Menunggu'}
                            </span>
                        </div>
                        
                        <div style="display: flex; gap: 0.8rem; margin-top: 1.5rem;">
                            ${reservation.status === 'pending' ? `
                            <button class="btn btn-success" onclick="confirmReservation('${reservation.id}')">
                                <i class="fas fa-check"></i> Konfirmasi
                            </button>
                            <button class="btn btn-danger" onclick="rejectReservation('${reservation.id}')">
                                <i class="fas fa-times"></i> Tolak
                            </button>` : ''}
                            
                            ${reservation.status === 'cancelled' ? `
                            <button class="btn btn-warning" onclick="reopenReservation('${reservation.id}')" style="background: #ffc107; color: #212529;">
                                <i class="fas fa-redo"></i> Buka Kembali
                            </button>` : ''}
                            
                            ${reservation.whatsapp ? `
                            <button class="btn" style="background: #25D366; color: white;" onclick="openWhatsAppMessageModal('${reservation.whatsapp}', 'Halo ${reservation.name}, mengenai reservasi Anda di MAN CAFE...')">
                                <i class="fab fa-whatsapp"></i> WhatsApp
                            </button>` : ''}
                        </div>
                    </div>
                `;
                
                openModal('reservationDetailModal');
            } catch (error) {
                console.error('Error viewing reservation detail:', error);
                showToast('Gagal memuat detail reservasi', 'error');
            }
        }

        // ============================
        // IMAGE HANDLING
        // ============================
        document.getElementById('menuImage')?.addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            try {
                if (file.size > 2 * 1024 * 1024) {
                    showToast('Ukuran gambar terlalu besar. Maksimal 2MB.', 'error');
                    this.value = '';
                    return;
                }
                
                if (!file.type.match('image.*')) {
                    showToast('Hanya file gambar yang diizinkan.', 'error');
                    this.value = '';
                    return;
                }
                
                const base64 = await convertImageToBase64(file);
                currentImageBase64 = base64;
                
                const previewContainer = document.getElementById('imagePreviewContainer');
                const preview = document.getElementById('imagePreview');
                preview.src = base64;
                previewContainer.style.display = 'block';
                
                showToast('Gambar berhasil diunggah', 'success');
            } catch (error) {
                console.error('Error converting image:', error);
                showToast('Gagal mengunggah gambar', 'error');
            }
        });

        function convertImageToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        function removeImage() {
            currentImageBase64 = null;
            const previewContainer = document.getElementById('imagePreviewContainer');
            const fileInput = document.getElementById('menuImage');
            
            previewContainer.style.display = 'none';
            fileInput.value = '';
            
            showToast('Gambar dihapus', 'info');
        }

        // ============================
        // FORM HANDLERS
        // ============================
        document.getElementById('menuForm')?.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!adminSystem) {
                showToast('Sistem admin belum siap', 'error');
                return;
            }
            
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Menyimpan...';
            
            try {
                const menuId = document.getElementById('menuId').value;
                const isDailyStock = document.getElementById('stockManagement').value === 'daily';
                const dailyStock = isDailyStock ? parseInt(document.getElementById('dailyStock').value) || 0 : null;
                const isPromo = document.getElementById('menuIsPromo').checked;
                const originalPrice = isPromo ? parseInt(document.getElementById('menuOriginalPrice').value) || null : null;
                
                const menuData = {
                    name: document.getElementById('menuName').value,
                    price: parseInt(document.getElementById('menuPrice').value),
                    stock: parseInt(document.getElementById('menuStock').value) || 0,
                    dailyStock: dailyStock,
                    currentDailyStock: dailyStock,
                    isDailyStock: isDailyStock,
                    category: document.getElementById('menuCategory').value,
                    description: document.getElementById('menuDescription').value,
                    image: currentImageBase64 || null,
                    isPromo: isPromo,
                    originalPrice: originalPrice
                };
                
                if (menuId) {
                    // Update existing menu
                    if (adminSystem.isOnline) {
                        try {
                            const updateData = {
                                name: menuData.name,
                                price: menuData.price,
                                stock: menuData.stock || 0,
                                daily_stock: menuData.dailyStock || null,
                                current_daily_stock: menuData.currentDailyStock || null,
                                is_daily_stock: menuData.isDailyStock || false,
                                category: menuData.category,
                                description: menuData.description || '',
                                image_url: menuData.image || '',
                                is_promo: menuData.isPromo || false,
                                original_price: menuData.originalPrice || null,
                                updated_at: new Date().toISOString()
                            };
                            
                            const { error } = await supabaseClient
                                .from('menu_items')
                                .update(updateData)
                                .eq('id', menuId);
                            
                            if (error) throw error;
                        } catch (error) {
                            console.warn('Error updating menu in Supabase:', error.message);
                        }
                    }
                    
                    const menuIndex = adminSystem.menus.findIndex(m => m.id == menuId);
                    if (menuIndex !== -1) {
                        adminSystem.menus[menuIndex] = { ...adminSystem.menus[menuIndex], ...menuData };
                        saveLocalData();
                        
                        localStorage.setItem('cafe_menus', JSON.stringify(adminSystem.menus));
                        addActivity(`Menu "${menuData.name}" diperbarui`);
                        updateProfileStats();
                        
                        showToast('Menu berhasil diperbarui', 'success');
                    }
                } else {
                    // Add new menu
                    let supabaseId = null;
                    
                    if (adminSystem.isOnline) {
                        try {
                            const menuToInsert = {
                                name: menuData.name,
                                price: menuData.price,
                                stock: menuData.stock || 0,
                                daily_stock: menuData.dailyStock || null,
                                current_daily_stock: menuData.dailyStock || null,
                                is_daily_stock: menuData.isDailyStock || false,
                                category: menuData.category,
                                description: menuData.description || '',
                                image_url: menuData.image || '',
                                is_promo: menuData.isPromo || false,
                                original_price: menuData.originalPrice || null,
                                is_active: true
                            };
                            
                            const { data, error } = await supabaseClient
                                .from('menu_items')
                                .insert([menuToInsert])
                                .select()
                                .single();
                            
                            if (error) throw error;
                            
                            supabaseId = data.id;
                            console.log(' Menu inserted to Supabase with ID:', supabaseId);
                        } catch (error) {
                            console.warn('Error adding menu to Supabase, saving locally:', error.message);
                        }
                    }
                    
                    const menu = {
                        id: supabaseId || Date.now(),
                        ...menuData,
                        isActive: true
                    };
                    
                    adminSystem.menus.push(menu);
                    saveLocalData();
                    localStorage.setItem('cafe_menus', JSON.stringify(adminSystem.menus));
                    updateProfileStats();
                    
                    addActivity(`Menu "${menuData.name}" ditambahkan (Stok: ${menuData.stock})`);
                    showToast('Menu berhasil ditambahkan', 'success');
                }
                
                closeModal('menuModal');
                loadMenuManagement();
                
            } catch (error) {
                console.error('Error saving menu:', error);
                showToast('Gagal menyimpan menu: ' + error.message, 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        });

        document.getElementById('tableForm')?.addEventListener('submit', function(e) {
            e.preventDefault();
            
            try {
                const tableId = document.getElementById('tableId').value;
                const tableData = {
                    id: tableId ? parseInt(tableId) : Date.now(),
                    number: document.getElementById('tableNumber').value,
                    capacity: parseInt(document.getElementById('tableCapacity').value),
                    location: document.getElementById('tableLocation').value,
                    status: document.getElementById('tableStatus').value,
                    description: document.getElementById('tableDescription').value,
                    createdAt: new Date().toISOString()
                };
                
                const tables = JSON.parse(localStorage.getItem('cafe_tables') || '[]');
                
                if (tableId) {
                    const tableIndex = tables.findIndex(t => t.id == tableId);
                    if (tableIndex !== -1) {
                        tables[tableIndex] = tableData;
                    }
                } else {
                    tables.push(tableData);
                }
                
                localStorage.setItem('cafe_tables', JSON.stringify(tables));
                updateProfileStats();
                
                showToast(tableId ? 'Meja berhasil diperbarui' : 'Meja baru berhasil ditambahkan', 'success');
                closeModal('tableModal');
                loadTablesManagement();
            } catch (error) {
                console.error('Error saving table:', error);
                showToast('Gagal menyimpan meja', 'error');
            }
        });

        // ============================
        // PDF REPORT FUNCTIONS
        // ============================
        async function generatePDFReport() {
            try {
                if (currentReportData.length === 0) {
                    showToast('Tidak ada data untuk diunduh', 'warning');
                    return;
                }
                
                const button = event.target.closest('button');
                const originalText = button.innerHTML;
                button.disabled = true;
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Membuat PDF...';
                
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');
                const pageWidth = doc.internal.pageSize.width;
                const margin = 15;
                let yPos = 20;
                
                doc.setFontSize(18);
                doc.setFont('helvetica', 'bold');
                doc.text('LAPORAN PENJUALAN MAN CAFE', pageWidth / 2, yPos, { align: 'center' });
                
                yPos += 8;
                doc.setFontSize(11);
                doc.setFont('helvetica', 'normal');
                
                const reportType = document.getElementById('reportType').value;
                let dateRange = '';
                
                switch(reportType) {
                    case 'daily':
                        dateRange = 'Tanggal: ' + document.getElementById('reportDate').value;
                        break;
                    case 'monthly':
                        dateRange = 'Bulan: ' + document.getElementById('reportMonth').value;
                        break;
                    case 'custom':
                        dateRange = 'Periode: ' + document.getElementById('startDate').value + ' s/d ' + document.getElementById('endDate').value;
                        break;
                }
                
                doc.text(dateRange, margin, yPos);
                yPos += 6;
                doc.text('Dibuat: ' + new Date().toLocaleString('id-ID'), margin, yPos);
                yPos += 12;
                
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.text('Ringkasan', margin, yPos);
                yPos += 8;
                
                doc.setFontSize(11);
                doc.setFont('helvetica', 'normal');
                
                const totalRevenue = currentReportData.reduce((sum, order) => sum + (order.total || 0), 0);
                const totalOrders = currentReportData.length;
                const averageOrder = totalOrders > 0 ? totalRevenue / totalOrders : 0;
                const uniqueCustomers = new Set(currentReportData.map(order => order.customer?.phone || order.customer?.name)).size;
                
                const summaryData = [
                    ['Total Pendapatan', 'Rp ' + totalRevenue.toLocaleString()],
                    ['Total Pesanan', totalOrders + ' pesanan'],
                    ['Rata-rata Pesanan', 'Rp ' + Math.round(averageOrder).toLocaleString()],
                    ['Jumlah Pelanggan', uniqueCustomers + ' pelanggan']
                ];
                
                summaryData.forEach(row => {
                    doc.text(row[0] + ': ' + row[1], margin, yPos);
                    yPos += 6;
                });
                
                yPos += 10;
                
                if (currentReportData.length > 0) {
                    doc.setFontSize(14);
                    doc.setFont('helvetica', 'bold');
                    doc.text('Detail Transaksi', margin, yPos);
                    yPos += 8;
                    
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'normal');
                    
                    const headers = ['Tanggal', 'No. Order', 'Pelanggan', 'Items', 'Total', 'Status'];
                    const colWidths = [25, 35, 40, 30, 30, 25];
                    let xPos = margin;
                    
                    headers.forEach((header, i) => {
                        doc.setFont('helvetica', 'bold');
                        doc.text(header, xPos, yPos);
                        xPos += colWidths[i];
                    });
                    
                    yPos += 6;
                    xPos = margin;
                    
                    doc.setLineWidth(0.2);
                    doc.line(margin, yPos - 2, pageWidth - margin, yPos - 2);
                    
                    currentReportData.slice(0, 30).forEach((order, index) => {
                        if (yPos > 270) {
                            doc.addPage();
                            yPos = 20;
                        }
                        
                        xPos = margin;
                        
                        const rowData = [
                            new Date(order.createdAt).toLocaleDateString('id-ID'),
                            order.orderNumber || 'ORD-' + order.id.toString().slice(-6),
                            order.customer?.name?.substring(0, 15) || 'Pelanggan',
                            (order.items?.length || 1) + ' item',
                            'Rp ' + (order.total || 0).toLocaleString(),
                            getStatusText(order.status)
                        ];
                        
                        rowData.forEach((text, i) => {
                            doc.setFont('helvetica', 'normal');
                            doc.text(text.toString(), xPos, yPos);
                            xPos += colWidths[i];
                        });
                        
                        yPos += 8;
                    });
                    
                    if (currentReportData.length > 30) {
                        doc.text(`... dan ${currentReportData.length - 30} transaksi lainnya`, margin, yPos);
                    }
                }
                
                const totalPages = doc.internal.getNumberOfPages();
                for (let i = 1; i <= totalPages; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.text(
                        `Halaman ${i} dari ${totalPages}`,
                        pageWidth - margin,
                        doc.internal.pageSize.height - 10,
                        { align: 'right' }
                    );
                    doc.text(
                        ' MAN CAFE - Laporan Penjualan',
                        margin,
                        doc.internal.pageSize.height - 10
                    );
                }
                
                const fileName = `Laporan_${reportType}_${new Date().toISOString().slice(0,10)}.pdf`;
                doc.save(fileName);
                
                showToast(`PDF berhasil diunduh: ${fileName}`, 'success');
                
            } catch (error) {
                console.error('Error generating PDF:', error);
                showToast('Gagal membuat PDF: ' + error.message, 'error');
            } finally {
                const button = document.querySelector('#reports-section .btn-primary');
                if (button) {
                    button.disabled = false;
                    button.innerHTML = '<i class="fas fa-download"></i> Download PDF';
                }
            }
        }

        // ============================
        // INITIALIZATION
        // ============================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log(' Starting Admin Dashboard...');
            
            // Setup event listeners
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            
            // Check for Escape key to close modals
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeModal('orderDetailModal');
                    closeModal('reservationDetailModal');
                    closeModal('menuModal');
                    closeModal('tableModal');
                    closeModal('whatsappProofModal');
                    closeModal('whatsappMessageModal');
                    closeModal('confirmWhatsAppModal');
                }
            });
            
            // Close modal when clicking outside
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('modal')) {
                    e.target.style.display = 'none';
                }
                
                // Close user menu when clicking outside
                const userMenu = document.getElementById('userMenu');
                const adminUser = document.querySelector('.admin-user');
                if (userMenu.classList.contains('show') && !adminUser.contains(e.target)) {
                    userMenu.classList.remove('show');
                }
            });
            
            // Setup promo checkbox event
            const menuIsPromo = document.getElementById('menuIsPromo');
            if (menuIsPromo) {
                menuIsPromo.addEventListener('change', function() {
                    const originalPriceContainer = document.getElementById('originalPriceContainer');
                    if (this.checked) {
                        originalPriceContainer.style.display = 'block';
                    } else {
                        originalPriceContainer.style.display = 'none';
                    }
                });
            }
            
            // Initialize login system
            await initLogin();
            
            console.log(' Admin Dashboard ready!');
        });
    </script>
</body>
</html>