<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Admin - MAN CAFE</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
        const SUPABASE_URL = 'https://cuwtyfggfgykgjhrvdgi.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_4e-uWWuKR2r7_jNaWHh03A_2UVQbPAx';
        
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
            auth: {
                autoRefreshToken: true,
                persistSession: true,
                detectSessionInUrl: false
            },
            db: {
                schema: 'public'
            }
        });
        
        console.log('âœ… Supabase client initialized');
    </script>
    <style>
        /* CSS tetap sama seperti sebelumnya */
        :root {
            --primary-color: #8B4513;
            --primary-light: #A0522D;
            --primary-dark: #5D2906;
            --secondary-color: #D2691E;
            --accent-color: #FFD700;
            --dark-color: #2C3E50;
            --light-color: #F8F9FA;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --info-color: #17a2b8;
            --border-radius: 10px;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: #f5f7fa;
            color: #333;
            line-height: 1.6;
            min-width: 320px;
        }

        .admin-header {
            background: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 1rem;
            text-decoration: none;
            color: var(--dark-color);
        }

        .logo i {
            font-size: 2rem;
            color: var(--primary-color);
        }

        .logo-text h1 {
            font-size: 1.5rem;
            margin: 0;
        }

        .logo-text span {
            font-size: 0.9rem;
            color: var(--primary-color);
        }

        .admin-controls {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .notification-bell {
            position: relative;
            cursor: pointer;
            font-size: 1.2rem;
            color: #666;
        }

        .notification-count {
            position: absolute;
            top: -8px;
            right: -8px;
            background: var(--danger-color);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .admin-user {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
        }

        .dashboard-container {
            display: flex;
            min-height: calc(100vh - 80px);
        }

        .sidebar {
            width: 250px;
            background: var(--dark-color);
            color: white;
            padding: 2rem 0;
            position: sticky;
            top: 80px;
            height: calc(100vh - 80px);
            overflow-y: auto;
            flex-shrink: 0;
        }

        .sidebar-menu {
            list-style: none;
        }

        .sidebar-menu li {
            margin-bottom: 0.5rem;
        }

        .sidebar-menu a {
            display: flex;
            align-items: center;
            padding: 0.8rem 1.5rem;
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            transition: all 0.3s;
            border-left: 3px solid transparent;
        }

        .sidebar-menu a:hover,
        .sidebar-menu a.active {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border-left-color: var(--primary-color);
        }

        .sidebar-menu i {
            width: 25px;
            margin-right: 1rem;
        }

        .main-content {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 1.5rem;
            display: flex;
            align-items: center;
            gap: 1.5rem;
            box-shadow: var(--shadow);
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
        }

        .stat-info h3 {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 0.5rem;
        }

        .stat-number {
            font-size: 1.8rem;
            font-weight: 600;
            color: var(--dark-color);
        }

        .stat-change {
            font-size: 0.9rem;
            margin-top: 0.3rem;
        }

        .stat-change.positive {
            color: var(--success-color);
        }

        .stat-change.negative {
            color: var(--danger-color);
        }

        .table-container {
            background: white;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
            width: 100%;
            overflow-x: auto;
        }

        .table-header {
            padding: 1.5rem;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .table-header h2 {
            margin: 0;
            color: var(--dark-color);
            font-size: 1.5rem;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }

        .data-table th {
            background: #f8f9fa;
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: var(--dark-color);
            border-bottom: 2px solid #eee;
            white-space: nowrap;
        }

        .data-table td {
            padding: 1rem;
            border-bottom: 1px solid #eee;
            white-space: nowrap;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        .status-badge {
            display: inline-block;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
            white-space: nowrap;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-confirmed {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status-completed {
            background: #d4edda;
            color: #155724;
        }

        .status-cancelled {
            background: #f8d7da;
            color: #721c24;
        }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            white-space: nowrap;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-success {
            background: var(--success-color);
            color: white;
        }

        .btn-danger {
            background: var(--danger-color);
            color: white;
        }

        .btn-sm {
            padding: 0.3rem 0.8rem;
            font-size: 0.8rem;
        }

        .action-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: var(--border-radius);
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-header h2 {
            margin: 0;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 0.8rem;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
        }

        .report-filters {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            align-items: flex-end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            min-width: 150px;
            flex: 1;
        }

        .file-upload-container {
            margin-bottom: 1rem;
        }

        .file-upload {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .file-upload-input {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .file-upload-label {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            border: 2px dashed #ddd;
            border-radius: 8px;
            background: #f9f9f9;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .file-upload-label:hover {
            border-color: var(--primary-color);
            background: #f0f0f0;
        }

        .file-upload-label i {
            font-size: 2rem;
            color: #666;
            margin-bottom: 0.5rem;
        }

        .file-upload-label span {
            color: #666;
            font-size: 0.9rem;
        }

        .file-upload-label small {
            color: #999;
            font-size: 0.8rem;
            margin-top: 0.5rem;
        }

        .image-preview-container {
            margin-top: 1rem;
            text-align: center;
        }

        .image-preview {
            max-width: 100%;
            max-height: 200px;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            border: 1px solid #ddd;
            background: #f9f9f9;
        }

        .remove-image-btn {
            margin-top: 0.5rem;
            background: #dc3545;
            color: white;
            border: none;
            padding: 0.3rem 0.8rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .menu-card-admin {
            background: white;
            border-radius: 8px;
            padding: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 1rem;
        }

        .stock-badge {
            display: inline-block;
            padding: 0.2rem 0.5rem;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 500;
        }

        .stock-low {
            background: #fff3cd;
            color: #856404;
        }

        .stock-empty {
            background: #f8d7da;
            color: #721c24;
        }

        .stock-good {
            background: #d4edda;
            color: #155724;
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 1rem;
            z-index: 10000;
            transform: translateX(120%);
            transition: transform 0.3s;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.success {
            border-left: 4px solid var(--success-color);
        }

        .toast.error {
            border-left: 4px solid var(--danger-color);
        }

        .proof-badge {
            cursor: pointer;
            color: #007bff;
            text-decoration: underline;
            font-size: 0.85rem;
        }

        .payment-proof-modal .modal-content {
            max-width: 600px;
        }

        .payment-proof-image {
            max-width: 100%;
            max-height: 400px;
            border-radius: 8px;
            margin: 1rem 0;
            border: 1px solid #ddd;
            background: #f9f9f9;
        }

        .no-payment-proof {
            text-align: center;
            padding: 2rem;
            color: #666;
        }

        .no-payment-proof i {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: #ddd;
        }

        .dashboard-section {
            display: block;
        }

        .text-center {
            text-align: center;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .chart-container {
            background: white;
            padding: 1.5rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
            overflow-x: auto;
        }
        
        .chart-title {
            margin-bottom: 1rem;
            color: var(--dark-color);
        }
        
        .report-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .summary-card {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .summary-card h4 {
            margin-bottom: 0.5rem;
            color: #666;
            font-size: 0.9rem;
        }
        
        .summary-card .value {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--primary-color);
        }
        
        .summary-card .subtext {
            font-size: 0.8rem;
            color: #999;
            margin-top: 0.5rem;
        }

        .analytics-section {
            background: white;
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow);
            overflow-x: auto;
        }

        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }

        .analytics-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1.5rem;
            border-left: 4px solid var(--primary-color);
        }

        .analytics-card h3 {
            margin-bottom: 1rem;
            color: var(--dark-color);
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .association-rule {
            background: white;
            border-radius: 6px;
            padding: 1rem;
            margin-bottom: 0.8rem;
            border: 1px solid #eee;
        }

        .rule-confidence {
            display: inline-block;
            background: #4CAF50;
            color: white;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            margin-left: 0.5rem;
        }

        .frequent-itemset {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            background: #e9ecef;
            border-radius: 4px;
            margin-bottom: 0.5rem;
            flex-wrap: wrap;
        }

        .support-badge {
            background: #17a2b8;
            color: white;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            margin-left: auto;
        }

        .filter-controls {
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .filter-controls label {
            font-weight: 500;
            color: var(--dark-color);
        }

        /* PERBAIKAN UNTUK MOBILE */
        @media (max-width: 1200px) {
            .sidebar {
                width: 70px;
            }
            
            .sidebar-menu a span:not(.notification-count) {
                display: none;
            }
            
            .sidebar-menu i {
                margin-right: 0;
                width: auto;
            }
            
            .sidebar-menu .notification-count {
                position: absolute;
                right: 5px;
                top: 50%;
                transform: translateY(-50%);
            }
        }

        @media (max-width: 992px) {
            .dashboard-container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: auto;
                position: static;
                padding: 1rem 0;
            }
            
            .sidebar-menu {
                display: flex;
                overflow-x: auto;
                padding: 0 1rem;
            }
            
            .sidebar-menu li {
                margin-bottom: 0;
                margin-right: 1rem;
            }
            
            .sidebar-menu a {
                padding: 0.8rem 1rem;
                white-space: nowrap;
            }
            
            .main-content {
                padding: 1.5rem;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 1rem;
            }
            
            .stat-card {
                padding: 1rem;
                gap: 1rem;
            }
            
            .stat-icon {
                width: 50px;
                height: 50px;
                font-size: 1.2rem;
            }
            
            .stat-number {
                font-size: 1.5rem;
            }
            
            .table-header {
                padding: 1rem;
            }
            
            .report-filters {
                padding: 1rem;
            }
            
            .filter-group {
                min-width: 120px;
            }
        }

        @media (max-width: 768px) {
            .admin-header {
                padding: 1rem;
                flex-wrap: wrap;
                gap: 1rem;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .report-filters {
                flex-direction: column;
            }
            
            .filter-group {
                min-width: 100%;
            }
            
            .action-buttons {
                gap: 0.3rem;
            }
            
            .btn {
                padding: 0.4rem 0.8rem;
                font-size: 0.85rem;
            }
            
            .modal-content {
                padding: 1.5rem;
                margin: 1rem;
            }
            
            .analytics-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .form-control {
                font-size: 16px; /* Mencegah zoom di iOS */
            }
        }

        @media (max-width: 576px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .report-summary {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .table-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
            
            .table-header h2 {
                font-size: 1.3rem;
            }
            
            .sidebar-menu {
                flex-wrap: wrap;
            }
            
            .admin-controls {
                gap: 1rem;
            }
            
            .logo-text h1 {
                font-size: 1.2rem;
            }
            
            .main-content {
                padding: 1rem;
            }
        }

        /* PERBAIKAN UNTUK MENU GRID DI MOBILE */
        @media (max-width: 768px) {
            #menuListContainer .menu-card-admin {
                margin-bottom: 1rem;
            }
            
            #menuListContainer > div > div:last-child {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
                gap: 1rem;
            }
            
            .menu-card-admin {
                padding: 0.8rem;
            }
            
            .menu-card-admin .action-buttons {
                flex-wrap: wrap;
            }
            
            .menu-card-admin .action-buttons .btn {
                margin-bottom: 0.3rem;
            }
        }

        /* OPTIMASI UNTUK TABEL DI MOBILE */
        @media (max-width: 768px) {
            .data-table {
                font-size: 0.9rem;
            }
            
            .data-table th,
            .data-table td {
                padding: 0.8rem 0.5rem;
            }
            
            .status-badge {
                font-size: 0.7rem;
                padding: 0.2rem 0.5rem;
            }
        }

        /* PERBAIKAN SCROLLING */
        .table-container,
        .chart-container,
        .analytics-section {
            -webkit-overflow-scrolling: touch;
        }

        /* FIX UNTUK IOS ZOOM */
        input[type="text"],
        input[type="number"],
        input[type="tel"],
        input[type="date"],
        input[type="month"],
        select,
        textarea {
            font-size: 16px;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="admin-header">
        <a href="#" class="logo">
            <i class="fas fa-coffee"></i>
            <div class="logo-text">
                <h1>MAN CAFE</h1>
                <span>Admin Dashboard</span>
            </div>
        </a>
        
        <div class="admin-controls">
            <div class="notification-bell" onclick="showNotifications()">
                <i class="fas fa-bell"></i>
                <span class="notification-count" id="notificationCount">0</span>
            </div>
            
            <div class="admin-user" onclick="logout()">
                <div style="width: 40px; height: 40px; background: var(--primary-color); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white;">
                    <i class="fas fa-user"></i>
                </div>
                <span>Admin</span>
            </div>
        </div>
    </header>

    <!-- Dashboard Layout -->
    <div class="dashboard-container">
        <!-- Sidebar -->
        <nav class="sidebar">
            <ul class="sidebar-menu">
                <li><a href="#" class="active" onclick="showSection('dashboard')">
                    <i class="fas fa-tachometer-alt"></i> Dashboard
                </a></li>
                <li><a href="#" onclick="showSection('orders')">
                    <i class="fas fa-shopping-cart"></i> Pesanan Baru
                    <span class="notification-count" id="sidebarOrderCount" style="margin-left: auto;">0</span>
                </a></li>
                <li><a href="#" onclick="showSection('reservations')">
                    <i class="fas fa-calendar-check"></i> Reservasi
                    <span class="notification-count" id="sidebarReservationCount" style="margin-left: auto;">0</span>
                </a></li>
                <li><a href="#" onclick="showSection('all-orders')">
                    <i class="fas fa-clipboard-list"></i> Semua Pesanan
                </a></li>
                <li><a href="#" onclick="showSection('all-reservations')">
                    <i class="fas fa-calendar-alt"></i> Semua Reservasi
                </a></li>
                <li><a href="#" onclick="showSection('menu')">
                    <i class="fas fa-utensils"></i> Kelola Menu
                </a></li>
                <li><a href="#" onclick="showSection('tables')">
                    <i class="fas fa-chair"></i> Kelola Meja
                </a></li>
                <li><a href="#" onclick="showSection('reports')">
                    <i class="fas fa-chart-bar"></i> Laporan
                </a></li>
                <li><a href="#" onclick="showSection('analytics')">
                    <i class="fas fa-chart-pie"></i> Analisis Menu
                </a></li>
                <li><a href="#" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </a></li>
            </ul>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Dashboard Section -->
            <section id="dashboard-section" class="dashboard-section">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #4CAF50, #2E8B57);">
                            <i class="fas fa-shopping-cart"></i>
                        </div>
                        <div class="stat-info">
                            <h3>Pesanan Hari Ini</h3>
                            <p class="stat-number" id="todayOrders">0</p>
                            <p class="stat-change positive">
                                <i class="fas fa-arrow-up"></i> 12% dari kemarin
                            </p>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #2196F3, #0D47A1);">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-info">
                            <h3>Pelanggan Baru</h3>
                            <p class="stat-number" id="newCustomers">0</p>
                            <p class="stat-change positive">
                                <i class="fas fa-arrow-up"></i> 8% dari minggu lalu
                            </p>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #FF9800, #FF5722);">
                            <i class="fas fa-money-bill-wave"></i>
                        </div>
                        <div class="stat-info">
                            <h3>Pendapatan Hari Ini</h3>
                            <p class="stat-number" id="todayRevenue">Rp 0</p>
                            <p class="stat-change positive">
                                <i class="fas fa-arrow-up"></i> 15% dari kemarin
                            </p>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #9C27B0, #6A1B9A);">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="stat-info">
                            <h3>Pesanan Menunggu</h3>
                            <p class="stat-number" id="pendingOrders">0</p>
                            <p class="stat-change negative">
                                <i class="fas fa-clock"></i> Butuh perhatian
                            </p>
                        </div>
                    </div>
                </div>

                <div class="table-container">
                    <div class="table-header">
                        <h2>Aktivitas Terbaru</h2>
                        <button class="btn btn-primary" onclick="refreshData()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Waktu</th>
                                <th>Aktivitas</th>
                                <th>Detail</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="activityTable">
                            <tr>
                                <td colspan="4" style="text-align: center; padding: 2rem;">
                                    <div class="loading"></div> Memuat aktivitas...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- New Orders Section -->
            <section id="orders-section" class="dashboard-section" style="display: none;">
                <div class="table-container">
                    <div class="table-header">
                        <h2>Pesanan Baru</h2>
                        <div class="action-buttons">
                            <button class="btn btn-primary" onclick="refreshOrders()">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                        </div>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>No. Order</th>
                                <th>Pelanggan</th>
                                <th>Total</th>
                                <th>Waktu</th>
                                <th>Status</th>
                                <th>Bukti Transfer</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="newOrdersTable">
                            <tr>
                                <td colspan="7" style="text-align: center; padding: 2rem;">
                                    <div class="loading"></div> Memuat pesanan...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Reservations Section -->
            <section id="reservations-section" class="dashboard-section" style="display: none;">
                <div class="table-container">
                    <div class="table-header">
                        <h2>Reservasi Baru</h2>
                        <button class="btn btn-primary" onclick="refreshReservations()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>No. Reservasi</th>
                                <th>Nama</th>
                                <th>Tanggal</th>
                                <th>Waktu</th>
                                <th>Meja</th>
                                <th>Status</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="reservationsTable">
                            <tr>
                                <td colspan="7" style="text-align: center; padding: 2rem;">
                                    <div class="loading"></div> Memuat reservasi...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- All Orders Section -->
            <section id="all-orders-section" class="dashboard-section" style="display: none;">
                <div class="table-container">
                    <div class="table-header">
                        <h2>Semua Pesanan</h2>
                        <div class="action-buttons">
                            <select class="form-control" style="width: 150px;" onchange="filterAllOrders(this.value)">
                                <option value="all">Semua Status</option>
                                <option value="pending">Menunggu</option>
                                <option value="confirmed">Dikonfirmasi</option>
                                <option value="completed">Selesai</option>
                                <option value="cancelled">Dibatalkan</option>
                            </select>
                            <button class="btn btn-primary" onclick="refreshAllOrders()">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                        </div>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>No. Order</th>
                                <th>Pelanggan</th>
                                <th>Total</th>
                                <th>Tanggal</th>
                                <th>Status</th>
                                <th>Bukti Transfer</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="allOrdersTable">
                            <tr>
                                <td colspan="7" style="text-align: center; padding: 2rem;">
                                    <div class="loading"></div> Memuat semua pesanan...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- All Reservations Section -->
            <section id="all-reservations-section" class="dashboard-section" style="display: none;">
                <div class="table-container">
                    <div class="table-header">
                        <h2>Semua Reservasi</h2>
                        <div class="action-buttons">
                            <select class="form-control" style="width: 150px;" onchange="filterAllReservations(this.value)">
                                <option value="all">Semua Status</option>
                                <option value="pending">Menunggu</option>
                                <option value="confirmed">Dikonfirmasi</option>
                                <option value="cancelled">Dibatalkan</option>
                            </select>
                            <button class="btn btn-primary" onclick="refreshAllReservations()">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                        </div>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>No. Reservasi</th>
                                <th>Nama</th>
                                <th>Tanggal</th>
                                <th>Waktu</th>
                                <th>Meja</th>
                                <th>Status</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="allReservationsTable">
                            <tr>
                                <td colspan="7" style="text-align: center; padding: 2rem;">
                                    <div class="loading"></div> Memuat semua reservasi...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Menu Management Section -->
            <section id="menu-section" class="dashboard-section" style="display: none;">
                <div class="table-container">
                    <div class="table-header">
                        <h2>Kelola Menu</h2>
                        <button class="btn btn-primary" onclick="openAddMenuModal()">
                            <i class="fas fa-plus"></i> Tambah Menu
                        </button>
                    </div>
                    <div id="menuListContainer" style="padding: 1.5rem;">
                        <div style="text-align: center; padding: 3rem; color: #666;">
                            <div class="loading"></div>
                            <p style="margin-top: 1rem;">Memuat menu...</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Tables Management Section -->
            <section id="tables-section" class="dashboard-section" style="display: none;">
                <div class="table-container">
                    <div class="table-header">
                        <h2>Kelola Meja</h2>
                        <button class="btn btn-primary" onclick="openAddTableModal()">
                            <i class="fas fa-plus"></i> Tambah Meja
                        </button>
                    </div>
                    <div id="tablesListContainer" style="padding: 1.5rem;">
                        <div style="text-align: center; padding: 3rem; color: #666;">
                            <div class="loading"></div>
                            <p style="margin-top: 1rem;">Memuat data meja...</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Reports Section -->
            <section id="reports-section" class="dashboard-section" style="display: none;">
                <div class="table-container">
                    <div class="table-header">
                        <h2>Laporan Penjualan</h2>
                        <div class="action-buttons">
                            <button class="btn btn-primary" onclick="generatePDFReport()">
                                <i class="fas fa-download"></i> Download PDF
                            </button>
                        </div>
                    </div>
                    
                    <div class="report-filters">
                        <div class="filter-group">
                            <label for="reportType">Tipe Laporan</label>
                            <select class="form-control" id="reportType" onchange="changeReportType()" style="width: 150px;">
                                <option value="daily">Harian</option>
                                <option value="monthly">Bulanan</option>
                                <option value="custom">Custom Range</option>
                            </select>
                        </div>
                        
                        <div class="filter-group" id="dailyFilter">
                            <label for="reportDate">Tanggal</label>
                            <input type="date" class="form-control" id="reportDate" value="">
                        </div>
                        
                        <div class="filter-group" id="monthlyFilter" style="display: none;">
                            <label for="reportMonth">Bulan</label>
                            <input type="month" class="form-control" id="reportMonth" value="">
                        </div>
                        
                        <div class="filter-group" id="customFilter" style="display: none;">
                            <label for="startDate">Dari Tanggal</label>
                            <input type="date" class="form-control" id="startDate" value="">
                            <label for="endDate" style="margin-top: 0.5rem;">Sampai Tanggal</label>
                            <input type="date" class="form-control" id="endDate" value="">
                        </div>
                        
                        <div class="filter-group">
                            <label>&nbsp;</label>
                            <button class="btn btn-primary" onclick="loadReportData()">
                                <i class="fas fa-filter"></i> Terapkan Filter
                            </button>
                        </div>
                    </div>

                    <div class="report-summary" id="reportSummary">
                        <div class="summary-card">
                            <h4>Total Pendapatan</h4>
                            <div class="value" id="summaryRevenue">Rp 0</div>
                            <div class="subtext">Dari semua pesanan</div>
                        </div>
                        <div class="summary-card">
                            <h4>Total Pesanan</h4>
                            <div class="value" id="summaryOrders">0</div>
                            <div class="subtext">Pesanan selesai</div>
                        </div>
                        <div class="summary-card">
                            <h4>Rata-rata Pesanan</h4>
                            <div class="value" id="summaryAverage">Rp 0</div>
                            <div class="subtext">Per transaksi</div>
                        </div>
                        <div class="summary-card">
                            <h4>Pelanggan</h4>
                            <div class="value" id="summaryCustomers">0</div>
                            <div class="subtext">Pelanggan unik</div>
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        <h3 class="chart-title">Grafik Penjualan</h3>
                        <div id="salesChart" style="height: 300px; padding: 1rem; border: 1px solid #eee; border-radius: 8px;">
                            <div style="text-align: center; padding: 5rem; color: #666;">
                                <div class="loading"></div>
                                <p style="margin-top: 1rem;">Memuat grafik...</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        <h3 class="chart-title">Detail Laporan</h3>
                        <div style="overflow-x: auto;">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Tanggal</th>
                                        <th>No. Order</th>
                                        <th>Pelanggan</th>
                                        <th>Items</th>
                                        <th>Total</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="reportsTable">
                                    <tr>
                                        <td colspan="6" style="text-align: center; padding: 3rem; color: #666;">
                                            <div class="loading"></div> 
                                            <p>Memuat laporan...</p>
                                            <p style="font-size: 0.9rem; margin-top: 0.5rem;">Gunakan filter di atas untuk menampilkan laporan</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Analytics Section -->
            <section id="analytics-section" class="dashboard-section" style="display: none;">
                <div class="table-container">
                    <div class="table-header">
                        <h2>Analisis Pola Pembelian Menu</h2>
                        <button class="btn btn-primary" onclick="runAprioriAnalysis()">
                            <i class="fas fa-sync-alt"></i> Analisis Ulang
                        </button>
                    </div>
                    
                    <!-- Status analisis -->
                    <div id="analysisStatus" style="margin: 1rem 0; padding: 0.5rem; background: #f8f9fa; border-radius: 4px; display: none;">
                        <div class="loading" style="display: inline-block; margin-right: 0.5rem;"></div>
                        <span id="statusText">Menganalisis data...</span>
                    </div>
                    
                    <div class="filter-controls">
                        <div class="filter-group">
                            <label for="minSupport">Min Support (%)</label>
                            <input type="range" id="minSupport" min="1" max="30" value="10" 
                                   class="form-control" style="width: 200px;"
                                   onchange="document.getElementById('supportValue').textContent = this.value + '%'">
                            <span id="supportValue" style="font-weight: bold;">10%</span>
                        </div>
                        
                        <div class="filter-group">
                            <label for="minConfidence">Min Confidence (%)</label>
                            <input type="range" id="minConfidence" min="50" max="100" value="70" 
                                   class="form-control" style="width: 200px;"
                                   onchange="document.getElementById('confidenceValue').textContent = this.value + '%'">
                            <span id="confidenceValue" style="font-weight: bold;">70%</span>
                        </div>
                        
                        <div class="filter-group">
                            <label for="periodFilter">Periode Analisis</label>
                            <select id="periodFilter" class="form-control" style="width: 150px;">
                                <option value="30">30 Hari Terakhir</option>
                                <option value="7">7 Hari Terakhir</option>
                                <option value="90">90 Hari Terakhir</option>
                                <option value="all">Semua Data</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="analytics-grid">
                        <div class="analytics-card">
                            <h3><i class="fas fa-boxes"></i> Itemset yang Sering Dibeli Bersama</h3>
                            <div id="frequentItemsets">
                                <div style="text-align: center; padding: 2rem; color: #666;">
                                    <div class="loading"></div>
                                    <p>Menganalisis pola pembelian...</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="analytics-card">
                            <h3><i class="fas fa-project-diagram"></i> Aturan Asosiasi</h3>
                            <div id="associationRules">
                                <div style="text-align: center; padding: 2rem; color: #666;">
                                    <div class="loading"></div>
                                    <p>Menghasilkan aturan asosiasi...</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="analytics-card" style="grid-column: 1 / -1;">
                            <h3><i class="fas fa-lightbulb"></i> Rekomendasi Bisnis</h3>
                            <div id="businessRecommendations">
                                <div style="text-align: center; padding: 2rem; color: #666;">
                                    <div class="loading"></div>
                                    <p>Membuat rekomendasi...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Order Detail Modal -->
    <div id="orderDetailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Detail Pesanan</h2>
                <button class="close-modal" onclick="closeModal('orderDetailModal')">&times;</button>
            </div>
            <div id="orderDetailContent">
                <div style="text-align: center; padding: 2rem;">
                    <div class="loading"></div>
                    <p style="margin-top: 1rem;">Memuat detail pesanan...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Payment Proof Modal -->
    <div id="paymentProofModal" class="modal payment-proof-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Bukti Transfer</h2>
                <button class="close-modal" onclick="closeModal('paymentProofModal')">&times;</button>
            </div>
            <div id="paymentProofContent">
                <div style="text-align: center; padding: 2rem;">
                    <div class="loading"></div>
                    <p style="margin-top: 1rem;">Memuat bukti transfer...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Reservation Detail Modal -->
    <div id="reservationDetailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Detail Reservasi</h2>
                <button class="close-modal" onclick="closeModal('reservationDetailModal')">&times;</button>
            </div>
            <div id="reservationDetailContent">
                <div style="text-align: center; padding: 2rem;">
                    <div class="loading"></div>
                    <p style="margin-top: 1rem;">Memuat detail reservasi...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Menu Modal -->
    <div id="menuModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2 id="menuModalTitle">Tambah Menu</h2>
                <button class="close-modal" onclick="closeModal('menuModal')">&times;</button>
            </div>
            <form id="menuForm">
                <input type="hidden" id="menuId">
                <div class="form-group">
                    <label for="menuName">Nama Menu *</label>
                    <input type="text" class="form-control" id="menuName" required>
                </div>
                
                <div class="form-group">
                    <label for="menuPrice">Harga *</label>
                    <input type="number" class="form-control" id="menuPrice" required min="1000">
                </div>
                
                <div class="form-group">
                    <label for="menuStock">Stok *</label>
                    <input type="number" class="form-control" id="menuStock" required min="0" value="10">
                </div>
                
                <div class="form-group">
                    <label for="menuCategory">Kategori *</label>
                    <select class="form-control" id="menuCategory" required>
                        <option value="minuman">Minuman</option>
                        <option value="makanan">Makanan</option>
                        <option value="snack">Snack</option>
                        <option value="dessert">Dessert</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="stockManagement">Jenis Pengelolaan Stok</label>
                    <select class="form-control" id="stockManagement" onchange="toggleDailyStockOption()">
                        <option value="regular">Stok Reguler</option>
                        <option value="daily">Stok Harian</option>
                    </select>
                </div>
                
                <div class="form-group" id="dailyStockContainer" style="display: none;">
                    <label for="dailyStock">Stok Harian (reset setiap hari) *</label>
                    <input type="number" class="form-control" id="dailyStock" min="0" value="0">
                    <small style="color: #666;">Stok yang akan direset setiap hari.</small>
                </div>
                
                <div class="form-group">
                    <label for="menuImage">Gambar Menu</label>
                    <div class="file-upload-container">
                        <div class="file-upload">
                            <input type="file" class="file-upload-input" id="menuImage" accept="image/*">
                            <label for="menuImage" class="file-upload-label">
                                <i class="fas fa-cloud-upload-alt"></i>
                                <span>Klik untuk mengunggah gambar</span>
                                <small>Format: JPG, PNG, GIF (Maks: 2MB)</small>
                            </label>
                        </div>
                        <div class="image-preview-container" id="imagePreviewContainer" style="display: none;">
                            <img src="" alt="Preview" class="image-preview" id="imagePreview">
                            <button type="button" class="remove-image-btn" onclick="removeImage()">
                                <i class="fas fa-trash"></i> Hapus Gambar
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="menuDescription">Deskripsi</label>
                    <textarea class="form-control" id="menuDescription" rows="3" placeholder="Deskripsi menu..."></textarea>
                </div>
                
                <div class="form-group">
                    <div class="form-check" style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                        <input type="checkbox" class="form-check-input" id="menuIsPromo">
                        <label class="form-check-label" for="menuIsPromo" style="font-weight: normal;">
                            Tandai sebagai Menu Promo
                        </label>
                    </div>
                </div>
                
                <div class="form-group" id="originalPriceContainer" style="display: none;">
                    <label for="menuOriginalPrice">Harga Asli (sebelum diskon)</label>
                    <input type="number" class="form-control" id="menuOriginalPrice" min="1000">
                </div>
                
                <button type="submit" class="btn btn-primary" style="width: 100%;">
                    <i class="fas fa-save"></i> Simpan Menu
                </button>
            </form>
        </div>
    </div>

    <!-- Table Modal -->
    <div id="tableModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="tableModalTitle">Tambah Meja</h2>
                <button class="close-modal" onclick="closeModal('tableModal')">&times;</button>
            </div>
            <form id="tableForm">
                <input type="hidden" id="tableId">
                <div class="form-group">
                    <label for="tableNumber">Nomor Meja *</label>
                    <input type="text" class="form-control" id="tableNumber" required placeholder="Misal: 1, 2, A1, B2">
                </div>
                <div class="form-group">
                    <label for="tableCapacity">Kapasitas *</label>
                    <input type="number" class="form-control" id="tableCapacity" required min="1" max="20" placeholder="Jumlah kursi">
                </div>
                <div class="form-group">
                    <label for="tableLocation">Lokasi</label>
                    <select class="form-control" id="tableLocation">
                        <option value="indoor">Indoor</option>
                        <option value="outdoor">Outdoor</option>
                        <option value="smoking_area">Smoking Area</option>
                        <option value="vip">VIP Room</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="tableStatus">Status</label>
                    <select class="form-control" id="tableStatus">
                        <option value="available">Tersedia</option>
                        <option value="occupied">Terisi</option>
                        <option value="reserved">Dipesan</option>
                        <option value="maintenance">Perbaikan</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="tableDescription">Keterangan (opsional)</label>
                    <textarea class="form-control" id="tableDescription" rows="2" placeholder="Misal: meja dekat jendela, meja romantis, dll."></textarea>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">
                    <i class="fas fa-save"></i> Simpan Meja
                </button>
            </form>
        </div>
    </div>

    <script>
        // ============================
        // GLOBAL VARIABLES
        // ============================
        let adminSystem = null;
        let currentSection = 'dashboard';
        let currentImageBase64 = null;
        let currentReportData = [];

        // ============================
        // ADMIN SYSTEM CLASS - DIPERBAIKI
        // ============================
        class AdminSystem {
            constructor() {
                this.orders = [];
                this.reservations = [];
                this.allReservations = [];
                this.allOrders = [];
                this.menus = [];
                this.activities = [];
                this.isOnline = true;
                this.autoRefreshInterval = null;
                this.initialized = false;
            }

            async init() {
                console.log('ðŸ”„ Initializing Admin System...');
                
                try {
                    // Check login status
                    const isLoggedIn = localStorage.getItem('adminLoggedIn');
                    if (isLoggedIn !== 'true') {
                        if (confirm('Ingin login sebagai admin? (Demo Mode)')) {
                            localStorage.setItem('adminLoggedIn', 'true');
                            localStorage.setItem('adminUsername', 'admin');
                        } else {
                            window.location.href = 'index.html';
                            return;
                        }
                    }
                    
                    // Check connection
                    this.isOnline = await this.checkSupabaseConnection();
                    console.log(this.isOnline ? 'âœ… Online mode' : 'âš ï¸ Offline mode');
                    
                    // Load data
                    if (!this.isOnline) {
                        this.loadLocalData();
                    } else {
                        await this.syncFromSupabase();
                    }
                    
                    // Initialize
                    this.initializeDefaultTables();
                    await this.resetDailyStockIfNeeded();
                    
                    // Update UI
                    this.updateStats();
                    this.updateNotifications();
                    
                    // Start auto refresh
                    this.startAutoRefresh();
                    
                    this.initialized = true;
                    console.log('âœ… Admin System initialized successfully');
                    
                    // Load dashboard
                    loadDashboard();
                    
                } catch (error) {
                    console.error('âŒ Error initializing admin system:', error);
                    showToast('Gagal menginisialisasi sistem admin', 'error');
                    
                    // Fallback to local data
                    this.loadLocalData();
                    loadDashboard();
                }
            }

            async checkSupabaseConnection() {
                try {
                    // Try to query a simple table
                    const { data, error } = await supabaseClient
                        .from('menu_items')
                        .select('id')
                        .limit(1);
                    
                    if (error) {
                        console.warn('Supabase connection error, using offline mode:', error.message);
                        return false;
                    }
                    return true;
                } catch (error) {
                    console.warn('Supabase connection error, using offline mode:', error.message);
                    return false;
                }
            }

            loadLocalData() {
                console.log('ðŸ“¥ Loading local data...');
                
                try {
                    // Load all data from localStorage
                    this.orders = JSON.parse(localStorage.getItem('pending_orders') || '[]');
                    this.reservations = JSON.parse(localStorage.getItem('pending_reservations') || '[]');
                    this.allReservations = JSON.parse(localStorage.getItem('all_reservations') || '[]');
                    this.allOrders = JSON.parse(localStorage.getItem('all_orders') || '[]');
                    this.menus = JSON.parse(localStorage.getItem('admin_menus') || '[]');
                    this.activities = JSON.parse(localStorage.getItem('admin_activities') || '[]');
                    
                    // If no menus, load from customer menus
                    const customerMenus = JSON.parse(localStorage.getItem('cafe_menus') || '[]');
                    if (customerMenus.length > 0 && this.menus.length === 0) {
                        this.menus = customerMenus;
                    }
                    
                    // If still no menus, create default
                    if (this.menus.length === 0) {
                        this.menus = this.getDefaultMenus();
                        localStorage.setItem('admin_menus', JSON.stringify(this.menus));
                        localStorage.setItem('cafe_menus', JSON.stringify(this.menus));
                    }
                    
                    // If no activities, create default
                    if (this.activities.length === 0) {
                        this.activities = this.getDefaultActivities();
                        localStorage.setItem('admin_activities', JSON.stringify(this.activities));
                    }
                    
                    console.log(`ðŸ“Š Loaded: ${this.orders.length} orders, ${this.menus.length} menus`);
                    
                } catch (error) {
                    console.error('Error loading local data:', error);
                    // Create fresh data
                    this.menus = this.getDefaultMenus();
                    this.activities = this.getDefaultActivities();
                    this.orders = [];
                    this.reservations = [];
                    this.allReservations = [];
                    this.allOrders = [];
                    
                    // Save to localStorage
                    localStorage.setItem('admin_menus', JSON.stringify(this.menus));
                    localStorage.setItem('cafe_menus', JSON.stringify(this.menus));
                    localStorage.setItem('admin_activities', JSON.stringify(this.activities));
                }
            }

            getDefaultMenus() {
                return [
                    {
                        id: 1,
                        name: "Espresso Premium",
                        description: "Kopi espresso dengan cita rasa kuat dan aroma harum",
                        price: 35000,
                        stock: 10,
                        dailyStock: null,
                        currentDailyStock: null,
                        category: "minuman",
                        image: "",
                        isPromo: false,
                        isActive: true,
                        isDailyStock: false
                    },
                    {
                        id: 2,
                        name: "Cappuccino Special",
                        description: "Espresso dengan susu steamed dan busa susu lembut",
                        price: 42000,
                        stock: 15,
                        dailyStock: null,
                        currentDailyStock: null,
                        category: "minuman",
                        image: "",
                        isPromo: false,
                        isActive: true,
                        isDailyStock: false
                    },
                    {
                        id: 3,
                        name: "Sandwich Ayam",
                        description: "Sandwich dengan ayam panggang dan sayuran segar",
                        price: 28000,
                        stock: 8,
                        dailyStock: null,
                        currentDailyStock: null,
                        category: "makanan",
                        image: "",
                        isPromo: true,
                        originalPrice: 35000,
                        isActive: true,
                        isDailyStock: false
                    }
                ];
            }

            getDefaultActivities() {
                return [
                    {
                        id: 1,
                        message: "Sistem admin diinisialisasi",
                        time: new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' }),
                        date: new Date().toLocaleDateString('id-ID')
                    }
                ];
            }

            async syncFromSupabase() {
                console.log('ðŸ”„ Syncing from Supabase...');
                try {
                    await Promise.all([
                        this.syncMenusFromSupabase(),
                        this.syncOrdersFromSupabase(),
                        this.syncReservationsFromSupabase()
                    ]);
                    console.log('âœ… Sync completed');
                } catch (error) {
                    console.error('Error syncing from Supabase:', error);
                }
            }

            async syncMenusFromSupabase() {
                try {
                    console.log('ðŸ”„ Syncing menus from Supabase...');
                    
                    let { data: menus, error } = await supabaseClient
                        .from('menu_items')
                        .select('*')
                        .order('name');
                    
                    if (error) {
                        console.warn('Error fetching menus, using local data:', error.message);
                        return;
                    }
                    
                    if (menus && menus.length > 0) {
                        this.menus = menus.map(menu => ({
                            id: menu.id,
                            name: menu.name || 'Unnamed Menu',
                            price: menu.price || 0,
                            stock: menu.stock || 0,
                            dailyStock: menu.daily_stock || null,
                            currentDailyStock: menu.current_daily_stock || null,
                            isDailyStock: menu.is_daily_stock || false,
                            category: menu.category || 'minuman',
                            image: menu.image_url || menu.image || '',
                            description: menu.description || '',
                            isPromo: menu.is_promo || false,
                            originalPrice: menu.original_price || null,
                            isActive: menu.is_active !== false
                        }));
                        
                        localStorage.setItem('admin_menus', JSON.stringify(this.menus));
                        localStorage.setItem('cafe_menus', JSON.stringify(this.menus));
                        console.log(`âœ… Synced ${menus.length} menus from Supabase`);
                    } else {
                        console.log('âš ï¸ No menus found in Supabase');
                    }
                    
                } catch (error) {
                    console.error('âŒ Error syncing menus:', error);
                }
            }

            async syncOrdersFromSupabase() {
                try {
                    let { data: orders, error } = await supabaseClient
                        .from('orders')
                        .select('*')
                        .order('created_at', { ascending: false });
                    
                    if (error) {
                        console.warn('Error fetching orders, using local data:', error.message);
                        return;
                    }
                    
                    if (orders && orders.length > 0) {
                        this.allOrders = orders.map(order => ({
                            id: order.id,
                            orderNumber: order.order_number || 'ORD-' + order.id.toString().slice(-6),
                            customer: {
                                name: order.customer_name || 'Pelanggan',
                                phone: order.customer_phone || '',
                                address: order.customer_address || ''
                            },
                            total: order.total_amount || 0,
                            status: order.status || 'pending',
                            paymentProof: order.payment_proof_url || '',
                            createdAt: order.created_at || new Date().toISOString(),
                            adminSeen: order.admin_seen || false,
                            items: order.items || [],
                            orderType: order.order_type || 'dine_in'
                        }));
                        
                        this.orders = this.allOrders.filter(order => 
                            (order.status === 'pending' || order.status === 'waiting_payment') && 
                            !order.adminSeen
                        );
                        
                        localStorage.setItem('all_orders', JSON.stringify(this.allOrders));
                        localStorage.setItem('pending_orders', JSON.stringify(this.orders));
                        localStorage.setItem('customer_orders', JSON.stringify(this.allOrders));
                        
                        console.log(`âœ… Synced ${orders.length} orders from Supabase`);
                    } else {
                        console.log('âš ï¸ No orders found in Supabase');
                    }
                    
                } catch (error) {
                    console.error('âŒ Error syncing orders:', error);
                }
            }

            async syncReservationsFromSupabase() {
                try {
                    let { data: reservations, error } = await supabaseClient
                        .from('reservations')
                        .select('*')
                        .order('created_at', { ascending: false });
                    
                    if (error) {
                        console.warn('Error fetching reservations, using local data:', error.message);
                        return;
                    }
                    
                    if (reservations && reservations.length > 0) {
                        this.allReservations = reservations.map(res => ({
                            id: res.id,
                            name: res.customer_name || '',
                            phone: res.customer_phone || '',
                            date: res.reservation_date || '',
                            time: res.reservation_time || '',
                            tableNumber: res.table_number || '',
                            guests: res.number_of_guests || 1,
                            notes: res.notes || '',
                            status: res.status || 'pending',
                            orderNumber: res.order_number || '',
                            adminSeen: res.admin_seen || false,
                            createdAt: res.created_at || new Date().toISOString()
                        }));
                        
                        this.reservations = this.allReservations.filter(res => 
                            !res.adminSeen && res.status === 'pending'
                        );
                        
                        localStorage.setItem('all_reservations', JSON.stringify(this.allReservations));
                        localStorage.setItem('pending_reservations', JSON.stringify(this.reservations));
                        localStorage.setItem('customer_reservations', JSON.stringify(this.allReservations));
                        
                        console.log(`âœ… Synced ${reservations.length} reservations from Supabase`);
                    } else {
                        console.log('âš ï¸ No reservations found in Supabase');
                    }
                    
                } catch (error) {
                    console.error('âŒ Error syncing reservations:', error);
                }
            }

            async resetDailyStockIfNeeded() {
                try {
                    const lastResetDate = localStorage.getItem('last_daily_stock_reset');
                    const today = new Date().toDateString();
                    
                    if (lastResetDate !== today) {
                        console.log('ðŸ”„ Resetting daily stock...');
                        
                        if (this.isOnline) {
                            try {
                                const { error } = await supabaseClient
                                    .from('menu_items')
                                    .update({ 
                                        current_daily_stock: supabaseClient.raw('daily_stock')
                                    })
                                    .eq('is_daily_stock', true)
                                    .gt('daily_stock', 0);
                                
                                if (error) {
                                    console.warn('Error resetting daily stock in Supabase:', error.message);
                                }
                            } catch (error) {
                                console.warn('Error in daily stock reset:', error.message);
                            }
                        }
                        
                        // Update local menus
                        this.menus.forEach(menu => {
                            if (menu.isDailyStock && menu.dailyStock > 0) {
                                menu.currentDailyStock = menu.dailyStock;
                            }
                        });
                        
                        this.saveLocalData();
                        localStorage.setItem('last_daily_stock_reset', today);
                        console.log('âœ… Daily stock reset completed');
                    }
                } catch (error) {
                    console.error('âŒ Error resetting daily stock:', error);
                }
            }

            async addMenu(menuData) {
                try {
                    console.log('âž• Adding menu:', menuData.name);
                    
                    let supabaseId = null;
                    
                    if (this.isOnline) {
                        try {
                            const menuToInsert = {
                                name: menuData.name,
                                price: menuData.price,
                                stock: menuData.stock || 0,
                                daily_stock: menuData.dailyStock || null,
                                current_daily_stock: menuData.dailyStock || null,
                                is_daily_stock: menuData.isDailyStock || false,
                                category: menuData.category,
                                description: menuData.description || '',
                                image_url: menuData.image || '',
                                is_promo: menuData.isPromo || false,
                                original_price: menuData.originalPrice || null,
                                is_active: true
                            };
                            
                            const { data, error } = await supabaseClient
                                .from('menu_items')
                                .insert([menuToInsert])
                                .select()
                                .single();
                            
                            if (error) throw error;
                            
                            supabaseId = data.id;
                            console.log('âœ… Menu inserted to Supabase with ID:', supabaseId);
                        } catch (error) {
                            console.warn('Error adding menu to Supabase, saving locally:', error.message);
                        }
                    }
                    
                    const menu = {
                        id: supabaseId || Date.now(),
                        ...menuData,
                        isActive: true
                    };
                    
                    this.menus.push(menu);
                    this.saveLocalData();
                    localStorage.setItem('cafe_menus', JSON.stringify(this.menus));
                    
                    this.addActivity(`Menu "${menuData.name}" ditambahkan (Stok: ${menuData.stock})`);
                    showToast('Menu berhasil ditambahkan', 'success');
                    
                    return menu;
                    
                } catch (error) {
                    console.error('âŒ Error adding menu:', error);
                    
                    // Fallback to local storage
                    const menu = {
                        id: Date.now(),
                        ...menuData,
                        isActive: true
                    };
                    
                    this.menus.push(menu);
                    this.saveLocalData();
                    localStorage.setItem('cafe_menus', JSON.stringify(this.menus));
                    
                    showToast('Menu disimpan secara lokal', 'info');
                    return menu;
                }
            }

            async updateMenu(menuId, menuData) {
                try {
                    if (this.isOnline) {
                        try {
                            const updateData = {
                                name: menuData.name,
                                price: menuData.price,
                                stock: menuData.stock || 0,
                                daily_stock: menuData.dailyStock || null,
                                current_daily_stock: menuData.currentDailyStock || null,
                                is_daily_stock: menuData.isDailyStock || false,
                                category: menuData.category,
                                description: menuData.description || '',
                                image_url: menuData.image || '',
                                is_promo: menuData.isPromo || false,
                                original_price: menuData.originalPrice || null,
                                updated_at: new Date().toISOString()
                            };
                            
                            const { error } = await supabaseClient
                                .from('menu_items')
                                .update(updateData)
                                .eq('id', menuId);
                            
                            if (error) throw error;
                        } catch (error) {
                            console.warn('Error updating menu in Supabase:', error.message);
                        }
                    }
                    
                    const menuIndex = this.menus.findIndex(m => m.id == menuId);
                    if (menuIndex !== -1) {
                        this.menus[menuIndex] = { ...this.menus[menuIndex], ...menuData };
                        this.saveLocalData();
                        
                        localStorage.setItem('cafe_menus', JSON.stringify(this.menus));
                        this.addActivity(`Menu "${menuData.name}" diperbarui`);
                        
                        showToast('Menu berhasil diperbarui', 'success');
                        return true;
                    }
                    
                    return false;
                    
                } catch (error) {
                    console.error('Error updating menu:', error);
                    showToast('Gagal memperbarui menu', 'error');
                    return false;
                }
            }

            async deleteMenu(menuId) {
                try {
                    if (this.isOnline) {
                        try {
                            const { error } = await supabaseClient
                                .from('menu_items')
                                .update({
                                    is_active: false,
                                    updated_at: new Date().toISOString()
                                })
                                .eq('id', menuId);
                            
                            if (error) throw error;
                        } catch (error) {
                            console.warn('Error deleting menu from Supabase:', error.message);
                        }
                    }
                    
                    const menuIndex = this.menus.findIndex(m => m.id == menuId);
                    if (menuIndex !== -1) {
                        const menuName = this.menus[menuIndex].name;
                        this.menus.splice(menuIndex, 1);
                        this.saveLocalData();
                        
                        localStorage.setItem('cafe_menus', JSON.stringify(this.menus));
                        this.addActivity(`Menu "${menuName}" dihapus`);
                        
                        showToast('Menu berhasil dihapus', 'success');
                        return true;
                    }
                    
                    return false;
                    
                } catch (error) {
                    console.error('Error deleting menu:', error);
                    showToast('Gagal menghapus menu', 'error');
                    return false;
                }
            }

            async confirmOrder(orderId) {
                try {
                    console.log(`Confirming order ${orderId}...`);
                    
                    if (this.isOnline) {
                        try {
                            const { error } = await supabaseClient
                                .from('orders')
                                .update({
                                    status: 'confirmed',
                                    admin_seen: true,
                                    updated_at: new Date().toISOString()
                                })
                                .eq('id', orderId);
                            
                            if (error) throw error;
                        } catch (error) {
                            console.warn('Error confirming order in Supabase:', error.message);
                        }
                    }
                    
                    const orderIndex = this.allOrders.findIndex(o => o.id == orderId);
                    if (orderIndex !== -1) {
                        this.allOrders[orderIndex].status = 'confirmed';
                        this.allOrders[orderIndex].adminSeen = true;
                        
                        const pendingIndex = this.orders.findIndex(o => o.id == orderId);
                        if (pendingIndex !== -1) {
                            this.orders.splice(pendingIndex, 1);
                        }
                        
                        this.saveLocalData();
                        localStorage.setItem('customer_orders', JSON.stringify(this.allOrders));
                        
                        this.addActivity(`Pesanan #${this.allOrders[orderIndex].orderNumber} dikonfirmasi`);
                        this.updateNotifications();
                        
                        showToast('Pesanan berhasil dikonfirmasi', 'success');
                        return true;
                    }
                    
                    return false;
                    
                } catch (error) {
                    console.error('Error confirming order:', error);
                    showToast('Gagal mengonfirmasi pesanan', 'error');
                    return false;
                }
            }

            async completeOrder(orderId) {
                try {
                    console.log(`Completing order ${orderId}...`);
                    
                    if (this.isOnline) {
                        try {
                            const { error } = await supabaseClient
                                .from('orders')
                                .update({
                                    status: 'completed',
                                    updated_at: new Date().toISOString()
                                })
                                .eq('id', orderId);
                            
                            if (error) throw error;
                        } catch (error) {
                            console.warn('Error completing order in Supabase:', error.message);
                        }
                    }
                    
                    const orderIndex = this.allOrders.findIndex(o => o.id == orderId);
                    if (orderIndex !== -1) {
                        this.allOrders[orderIndex].status = 'completed';
                        
                        const pendingIndex = this.orders.findIndex(o => o.id == orderId);
                        if (pendingIndex !== -1) {
                            this.orders.splice(pendingIndex, 1);
                        }
                        
                        this.saveLocalData();
                        localStorage.setItem('customer_orders', JSON.stringify(this.allOrders));
                        
                        this.addActivity(`Pesanan #${this.allOrders[orderIndex].orderNumber} diselesaikan`);
                        this.updateNotifications();
                        
                        showToast('Pesanan berhasil diselesaikan', 'success');
                        return true;
                    }
                    
                    return false;
                    
                } catch (error) {
                    console.error('Error completing order:', error);
                    showToast('Gagal menyelesaikan pesanan', 'error');
                    return false;
                }
            }

            async confirmReservation(reservationId) {
                try {
                    console.log(`Confirming reservation ${reservationId}...`);
                    
                    if (this.isOnline) {
                        try {
                            const { error } = await supabaseClient
                                .from('reservations')
                                .update({
                                    status: 'confirmed',
                                    admin_seen: true,
                                    updated_at: new Date().toISOString()
                                })
                                .eq('id', reservationId);
                            
                            if (error) throw error;
                        } catch (error) {
                            console.warn('Error confirming reservation in Supabase:', error.message);
                        }
                    }
                    
                    const resIndex = this.allReservations.findIndex(r => r.id == reservationId);
                    if (resIndex !== -1) {
                        this.allReservations[resIndex].status = 'confirmed';
                        this.allReservations[resIndex].adminSeen = true;
                        
                        const pendingIndex = this.reservations.findIndex(r => r.id == reservationId);
                        if (pendingIndex !== -1) {
                            this.reservations.splice(pendingIndex, 1);
                        }
                        
                        this.saveLocalData();
                        localStorage.setItem('customer_reservations', JSON.stringify(this.allReservations));
                        
                        this.addActivity(`Reservasi #${reservationId} dikonfirmasi`);
                        this.updateNotifications();
                        
                        showToast('Reservasi berhasil dikonfirmasi', 'success');
                        return true;
                    }
                    
                    return false;
                    
                } catch (error) {
                    console.error('Error confirming reservation:', error);
                    showToast(`Gagal mengonfirmasi reservasi`, 'error');
                    return false;
                }
            }

            saveLocalData() {
                localStorage.setItem('pending_orders', JSON.stringify(this.orders));
                localStorage.setItem('pending_reservations', JSON.stringify(this.reservations));
                localStorage.setItem('all_reservations', JSON.stringify(this.allReservations));
                localStorage.setItem('all_orders', JSON.stringify(this.allOrders));
                localStorage.setItem('admin_menus', JSON.stringify(this.menus));
                localStorage.setItem('admin_activities', JSON.stringify(this.activities));
            }

            addActivity(message) {
                const activity = {
                    id: Date.now(),
                    message: message,
                    time: new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' }),
                    date: new Date().toLocaleDateString('id-ID')
                };
                this.activities.unshift(activity);
                if (this.activities.length > 10) {
                    this.activities = this.activities.slice(0, 10);
                }
                localStorage.setItem('admin_activities', JSON.stringify(this.activities));
            }

            getNewOrders() {
                return this.orders.filter(order => 
                    !order.adminSeen && 
                    (order.status === 'pending' || order.status === 'waiting_payment')
                );
            }

            getPendingOrders() {
                return this.allOrders.filter(order => 
                    order.status === 'pending' || order.status === 'waiting_payment'
                );
            }

            getTodayOrders() {
                const today = new Date().toISOString().split('T')[0];
                return this.allOrders.filter(order => {
                    const orderDate = new Date(order.createdAt).toISOString().split('T')[0];
                    return orderDate === today && order.status === 'completed';
                });
            }

            getTodayRevenue() {
                const todayOrders = this.getTodayOrders();
                return todayOrders.reduce((sum, order) => sum + (order.total || 0), 0);
            }

            getLowStockMenus() {
                return this.menus.filter(menu => {
                    const availableStock = this.getAvailableStock(menu);
                    return availableStock <= 5 && availableStock > 0;
                });
            }

            getOutOfStockMenus() {
                return this.menus.filter(menu => {
                    const availableStock = this.getAvailableStock(menu);
                    return availableStock <= 0;
                });
            }

            getAvailableStock(menu) {
                if (menu.isDailyStock && menu.currentDailyStock !== null) {
                    return menu.currentDailyStock;
                }
                return menu.stock || 0;
            }

            updateStats() {
                try {
                    document.getElementById('todayOrders').textContent = this.getTodayOrders().length;
                    document.getElementById('newCustomers').textContent = Math.floor(Math.random() * 10) + 1;
                    document.getElementById('todayRevenue').textContent = 'Rp ' + this.getTodayRevenue().toLocaleString();
                    document.getElementById('pendingOrders').textContent = this.getPendingOrders().length;
                } catch (error) {
                    console.error('Error updating stats:', error);
                }
            }

            updateNotifications() {
                try {
                    const newOrdersCount = this.getNewOrders().length;
                    const newReservationsCount = this.reservations.filter(r => 
                        !r.adminSeen && r.status === 'pending'
                    ).length;
                    const totalNotifications = newOrdersCount + newReservationsCount;
                    
                    document.getElementById('notificationCount').textContent = totalNotifications;
                    document.getElementById('sidebarOrderCount').textContent = newOrdersCount;
                    document.getElementById('sidebarReservationCount').textContent = newReservationsCount;
                } catch (error) {
                    console.error('Error updating notifications:', error);
                }
            }

            initializeDefaultTables() {
                try {
                    const existingTables = JSON.parse(localStorage.getItem('cafe_tables') || '[]');
                    if (existingTables.length === 0) {
                        const defaultTables = [
                            { id: 1, number: '1', capacity: 4, location: 'indoor', status: 'available', description: 'Meja dekat jendela', createdAt: new Date().toISOString() },
                            { id: 2, number: '2', capacity: 2, location: 'indoor', status: 'available', description: 'Meja romantis', createdAt: new Date().toISOString() },
                            { id: 3, number: '3', capacity: 6, location: 'outdoor', status: 'available', description: 'Meja keluarga', createdAt: new Date().toISOString() },
                        ];
                        localStorage.setItem('cafe_tables', JSON.stringify(defaultTables));
                    }
                } catch (error) {
                    console.error('Error initializing tables:', error);
                }
            }

            startAutoRefresh() {
                if (this.autoRefreshInterval) {
                    clearInterval(this.autoRefreshInterval);
                }
                
                this.autoRefreshInterval = setInterval(async () => {
                    if (this.isOnline) {
                        await this.syncFromSupabase();
                        if (currentSection) {
                            loadSectionData(currentSection);
                        }
                    }
                }, 30000);
            }
        }

        // ============================
        // APRIORI ANALYSIS - DIPERBAIKI
        // ============================
        class AprioriAnalyzer {
            static calculateSupport(itemset, transactions) {
                let count = 0;
                transactions.forEach(transaction => {
                    if (itemset.every(item => transaction.includes(item))) {
                        count++;
                    }
                });
                return count / transactions.length;
            }

            static runApriori(transactions, minSupport, minConfidence) {
                try {
                    if (transactions.length === 0) {
                        return { frequentItemsets: [], associationRules: [] };
                    }
                    
                    // Get all unique items
                    const allItems = new Set();
                    transactions.forEach(transaction => {
                        transaction.forEach(item => {
                            allItems.add(item);
                        });
                    });
                    
                    // Generate frequent 1-itemsets
                    let frequentItemsets = [];
                    const itemsArray = Array.from(allItems);
                    
                    itemsArray.forEach(item => {
                        const support = AprioriAnalyzer.calculateSupport([item], transactions);
                        if (support >= minSupport) {
                            frequentItemsets.push({
                                items: [item],
                                support: support
                            });
                        }
                    });
                    
                    // Generate candidate itemsets of size k
                    let k = 2;
                    let previousFrequentItemsets = frequentItemsets.filter(fi => fi.items.length === 1);
                    
                    while (previousFrequentItemsets.length > 0 && k <= 3) {
                        const candidateItemsets = [];
                        const n = previousFrequentItemsets.length;
                        
                        // Generate candidates
                        for (let i = 0; i < n; i++) {
                            for (let j = i + 1; j < n; j++) {
                                const itemset1 = previousFrequentItemsets[i].items;
                                const itemset2 = previousFrequentItemsets[j].items;
                                
                                // Check if first k-2 items are the same
                                if (k === 2 || itemset1.slice(0, k-2).join() === itemset2.slice(0, k-2).join()) {
                                    const candidate = [...new Set([...itemset1, ...itemset2])].sort();
                                    if (candidate.length === k) {
                                        candidateItemsets.push({ items: candidate });
                                    }
                                }
                            }
                        }
                        
                        // Calculate support for candidates
                        const currentFrequentItemsets = [];
                        candidateItemsets.forEach(candidate => {
                            const support = AprioriAnalyzer.calculateSupport(candidate.items, transactions);
                            if (support >= minSupport) {
                                currentFrequentItemsets.push({
                                    items: candidate.items,
                                    support: support
                                });
                            }
                        });
                        
                        if (currentFrequentItemsets.length > 0) {
                            frequentItemsets = frequentItemsets.concat(currentFrequentItemsets);
                            previousFrequentItemsets = currentFrequentItemsets;
                        } else {
                            break;
                        }
                        
                        k++;
                    }
                    
                    // Generate association rules
                    const associationRules = [];
                    frequentItemsets.forEach(itemset => {
                        if (itemset.items.length > 1) {
                            const items = itemset.items;
                            const subsets = AprioriAnalyzer.getAllSubsets(items);
                            
                            subsets.forEach(subset => {
                                if (subset.length > 0 && subset.length < items.length) {
                                    const antecedent = subset;
                                    const consequent = items.filter(item => !antecedent.includes(item));
                                    
                                    // Find antecedent support
                                    const antecedentSupport = frequentItemsets.find(fi => 
                                        fi.items.length === antecedent.length && 
                                        antecedent.every(item => fi.items.includes(item))
                                    )?.support || 0;
                                    
                                    if (antecedentSupport > 0) {
                                        const confidence = itemset.support / antecedentSupport;
                                        
                                        if (confidence >= minConfidence) {
                                            associationRules.push({
                                                antecedent: antecedent,
                                                consequent: consequent,
                                                support: itemset.support,
                                                confidence: confidence
                                            });
                                        }
                                    }
                                }
                            });
                        }
                    });
                    
                    return {
                        frequentItemsets: frequentItemsets.sort((a, b) => b.support - a.support),
                        associationRules: associationRules.sort((a, b) => b.confidence - a.confidence)
                    };
                    
                } catch (error) {
                    console.error('Error in Apriori algorithm:', error);
                    return { frequentItemsets: [], associationRules: [] };
                }
            }

            static getAllSubsets(items) {
                const subsets = [];
                const n = items.length;
                
                for (let i = 1; i < (1 << n) - 1; i++) {
                    const subset = [];
                    for (let j = 0; j < n; j++) {
                        if (i & (1 << j)) {
                            subset.push(items[j]);
                        }
                    }
                    subsets.push(subset);
                }
                
                return subsets;
            }
        }

        async function getTransactionDataForAnalysis(periodDays = '30') {
            try {
                const transactions = [];
                
                // Try to get data from Supabase
                let orders = [];
                if (adminSystem.isOnline) {
                    const { data, error } = await supabaseClient
                        .from('orders')
                        .select('items')
                        .eq('status', 'completed')
                        .order('created_at', { ascending: false })
                        .limit(100);
                    
                    if (!error && data) {
                        orders = data;
                    }
                }
                
                // If no Supabase data, use local data
                if (orders.length === 0 && adminSystem.allOrders.length > 0) {
                    orders = adminSystem.allOrders
                        .filter(order => order.status === 'completed')
                        .map(order => ({ items: order.items || [] }));
                }
                
                // If still no data, use demo data
                if (orders.length === 0) {
                    console.log('Using demo data for analysis');
                    return [
                        ['Espresso', 'Croissant'],
                        ['Cappuccino', 'Sandwich'],
                        ['Latte', 'Muffin'],
                        ['Espresso', 'Muffin'],
                        ['Cappuccino', 'Croissant'],
                        ['Latte', 'Sandwich'],
                        ['Espresso', 'Sandwich'],
                        ['Cappuccino', 'Muffin'],
                        ['Latte', 'Croissant'],
                        ['Espresso', 'Cappuccino']
                    ];
                }
                
                // Process transactions
                orders.forEach(order => {
                    if (order.items && Array.isArray(order.items)) {
                        const transactionItems = [];
                        order.items.forEach(item => {
                            if (item.name) {
                                transactionItems.push(item.name);
                            } else if (item.menuName) {
                                transactionItems.push(item.menuName);
                            }
                        });
                        
                        if (transactionItems.length > 0) {
                            transactions.push(transactionItems);
                        }
                    }
                });
                
                return transactions;
                
            } catch (error) {
                console.error('Error getting transaction data:', error);
                return [];
            }
        }

        async function runAprioriAnalysis() {
            try {
                if (!adminSystem) {
                    showToast('Sistem admin belum siap', 'error');
                    return;
                }
                
                // Show loading status
                document.getElementById('analysisStatus').style.display = 'block';
                document.getElementById('statusText').textContent = 'Menganalisis data...';
                
                // Get parameters
                const minSupport = parseInt(document.getElementById('minSupport').value) / 100;
                const minConfidence = parseInt(document.getElementById('minConfidence').value) / 100;
                const periodDays = document.getElementById('periodFilter').value;
                
                // Get transaction data
                const transactions = await getTransactionDataForAnalysis(periodDays);
                
                if (transactions.length === 0) {
                    document.getElementById('analysisStatus').style.display = 'none';
                    showToast('Tidak ada data transaksi untuk dianalisis', 'warning');
                    
                    document.getElementById('frequentItemsets').innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: #666;">
                            <i class="fas fa-chart-bar" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                            <h4>Tidak ada data transaksi</h4>
                            <p>Tidak ada data pembelian yang cukup untuk dianalisis.</p>
                        </div>
                    `;
                    
                    document.getElementById('associationRules').innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: #666;">
                            <i class="fas fa-project-diagram" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                            <h4>Tidak dapat menghasilkan aturan</h4>
                            <p>Data transaksi tidak cukup untuk analisis.</p>
                        </div>
                    `;
                    
                    document.getElementById('businessRecommendations').innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: #666;">
                            <i class="fas fa-lightbulb" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                            <h4>Rekomendasi Umum</h4>
                            <p>Untuk meningkatkan penjualan:</p>
                            <ul style="text-align: left; margin-top: 1rem; padding-left: 1.5rem;">
                                <li>Promosikan menu baru</li>
                                <li>Buat paket menu menarik</li>
                                <li>Tawarkan diskon untuk pembelian tertentu</li>
                            </ul>
                        </div>
                    `;
                    
                    return;
                }
                
                // Run Apriori algorithm
                const result = AprioriAnalyzer.runApriori(transactions, minSupport, minConfidence);
                
                // Display results
                displayFrequentItemsets(result.frequentItemsets);
                displayAssociationRules(result.associationRules);
                displayBusinessRecommendations(result.frequentItemsets, result.associationRules, transactions.length);
                
                // Hide loading status
                document.getElementById('analysisStatus').style.display = 'none';
                
                showToast(`Analisis selesai! ${transactions.length} transaksi dianalisis`, 'success');
                
            } catch (error) {
                console.error('Error running Apriori analysis:', error);
                document.getElementById('analysisStatus').style.display = 'none';
                showToast('Gagal melakukan analisis: ' + error.message, 'error');
            }
        }

        function displayFrequentItemsets(frequentItemsets) {
            const container = document.getElementById('frequentItemsets');
            
            if (frequentItemsets.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #666;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                        <p>Tidak ditemukan itemset yang memenuhi threshold support.</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            
            // Separate itemsets by size
            const singles = frequentItemsets.filter(fi => fi.items.length === 1);
            const pairs = frequentItemsets.filter(fi => fi.items.length === 2);
            const triples = frequentItemsets.filter(fi => fi.items.length === 3);
            
            if (singles.length > 0) {
                html += `<h4 style="margin-bottom: 0.5rem; color: #495057; font-size: 0.9rem;">Menu Paling Populer:</h4>`;
                singles.slice(0, 5).forEach(itemset => {
                    html += `
                        <div class="frequent-itemset">
                            <i class="fas fa-star" style="color: #FFD700;"></i>
                            <span>${itemset.items[0]}</span>
                            <span class="support-badge">${(itemset.support * 100).toFixed(1)}%</span>
                        </div>
                    `;
                });
            }
            
            if (pairs.length > 0) {
                html += `<h4 style="margin: 1rem 0 0.5rem 0; color: #495057; font-size: 0.9rem;">Kombinasi 2 Menu:</h4>`;
                pairs.slice(0, 5).forEach(itemset => {
                    html += `
                        <div class="frequent-itemset">
                            <i class="fas fa-link" style="color: #17a2b8;"></i>
                            <span>${itemset.items.join(" + ")}</span>
                            <span class="support-badge">${(itemset.support * 100).toFixed(1)}%</span>
                        </div>
                    `;
                });
            }
            
            if (triples.length > 0) {
                html += `<h4 style="margin: 1rem 0 0.5rem 0; color: #495057; font-size: 0.9rem;">Kombinasi 3 Menu:</h4>`;
                triples.slice(0, 5).forEach(itemset => {
                    html += `
                        <div class="frequent-itemset">
                            <i class="fas fa-network-wired" style="color: #8B4513;"></i>
                            <span>${itemset.items.join(" + ")}</span>
                            <span class="support-badge">${(itemset.support * 100).toFixed(1)}%</span>
                        </div>
                    `;
                });
            }
            
            html += `
                <div style="margin-top: 1rem; padding: 0.5rem; background: #e9ecef; border-radius: 4px; font-size: 0.8rem; color: #495057;">
                    <i class="fas fa-info-circle"></i> Ditemukan ${frequentItemsets.length} pola pembelian.
                </div>
            `;
            
            container.innerHTML = html;
        }

        function displayAssociationRules(rules) {
            const container = document.getElementById('associationRules');
            
            if (rules.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #666;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                        <p>Tidak ditemukan aturan asosiasi yang memenuhi threshold confidence.</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            
            rules.slice(0, 5).forEach((rule, index) => {
                const confidencePercent = (rule.confidence * 100).toFixed(1);
                const supportPercent = (rule.support * 100).toFixed(1);
                
                html += `
                    <div class="association-rule">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <strong style="color: #2C3E50;">Jika membeli:</strong>
                            <span class="rule-confidence">${confidencePercent}%</span>
                        </div>
                        <div style="background: #f8f9fa; padding: 0.5rem; border-radius: 4px; margin-bottom: 0.5rem;">
                            <i class="fas fa-shopping-cart" style="color: #8B4513; margin-right: 0.5rem;"></i>
                            ${rule.antecedent.join(", ")}
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong style="color: #2C3E50;">Maka juga membeli:</strong>
                                <div style="background: #e9ecef; padding: 0.5rem; border-radius: 4px; margin-top: 0.3rem;">
                                    <i class="fas fa-arrow-right" style="color: #28a745; margin-right: 0.5rem;"></i>
                                    ${rule.consequent.join(", ")}
                                </div>
                            </div>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-top: 0.5rem; font-size: 0.8rem; color: #666;">
                            <span>Support: ${supportPercent}%</span>
                            <span>Confidence: ${confidencePercent}%</span>
                        </div>
                    </div>
                `;
            });
            
            html += `
                <div style="margin-top: 1rem; padding: 0.5rem; background: #e9ecef; border-radius: 4px; font-size: 0.8rem; color: #495057;">
                    <i class="fas fa-info-circle"></i> Ditemukan ${rules.length} aturan asosiasi.
                </div>
            `;
            
            container.innerHTML = html;
        }

        function displayBusinessRecommendations(frequentItemsets, associationRules, transactionCount) {
            const container = document.getElementById('businessRecommendations');
            
            let html = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem;">';
            
            // Package recommendations
            const topPairs = frequentItemsets.filter(fi => fi.items.length === 2).slice(0, 3);
            if (topPairs.length > 0) {
                html += `
                    <div style="background: white; border-radius: 8px; padding: 1rem; border: 1px solid #dee2e6;">
                        <h4 style="margin-bottom: 0.5rem; color: #2C3E50; display: flex; align-items: center; gap: 0.5rem;">
                            ðŸ“¦ Rekomendasi Paket Menu
                        </h4>
                        <p style="color: #666; font-size: 0.9rem; margin-bottom: 1rem;">Buat paket menu dari kombinasi berikut:</p>
                        <ul style="list-style: none; padding: 0; margin: 0;">
                            ${topPairs.map(itemset => `
                                <li style="margin-bottom: 0.5rem; padding: 0.5rem; background: #f8f9fa; border-radius: 4px;">
                                    <div style="display: flex; justify-content: space-between;">
                                        <span>${itemset.items.join(" + ")}</span>
                                        <span style="font-weight: bold; color: #8B4513;">${(itemset.support * 100).toFixed(1)}%</span>
                                    </div>
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                `;
            }
            
            // Cross-selling recommendations
            const topRules = associationRules.slice(0, 3);
            if (topRules.length > 0) {
                html += `
                    <div style="background: white; border-radius: 8px; padding: 1rem; border: 1px solid #dee2e6;">
                        <h4 style="margin-bottom: 0.5rem; color: #2C3E50; display: flex; align-items: center; gap: 0.5rem;">
                            ðŸ”„ Peluang Cross-Selling
                        </h4>
                        <p style="color: #666; font-size: 0.9rem; margin-bottom: 1rem;">Promosikan menu berikut kepada pelanggan:</p>
                        <ul style="list-style: none; padding: 0; margin: 0;">
                            ${topRules.map(rule => `
                                <li style="margin-bottom: 0.5rem; padding: 0.5rem; background: #f8f9fa; border-radius: 4px;">
                                    <div style="display: flex; justify-content: space-between;">
                                        <span>Jika beli <strong>${rule.antecedent.join(", ")}</strong><br>
                                        â†’ tawarkan <strong>${rule.consequent.join(", ")}</strong></span>
                                        <span style="font-weight: bold; color: #8B4513;">${(rule.confidence * 100).toFixed(1)}%</span>
                                    </div>
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                `;
            }
            
            // General recommendations
            html += `
                <div style="background: white; border-radius: 8px; padding: 1rem; border: 1px solid #dee2e6;">
                    <h4 style="margin-bottom: 0.5rem; color: #2C3E50; display: flex; align-items: center; gap: 0.5rem;">
                        ðŸ’¡ Tips Penjualan
                    </h4>
                    <ul style="list-style: none; padding: 0; margin: 0;">
                        <li style="margin-bottom: 0.5rem; padding: 0.5rem; background: #f8f9fa; border-radius: 4px;">
                            <strong>Buat Bundle:</strong> Gabungkan menu yang sering dibeli bersama
                        </li>
                        <li style="margin-bottom: 0.5rem; padding: 0.5rem; background: #f8f9fa; border-radius: 4px;">
                            <strong>Diskon Paket:</strong> Berikan diskon untuk pembelian paket
                        </li>
                        <li style="margin-bottom: 0.5rem; padding: 0.5rem; background: #f8f9fa; border-radius: 4px;">
                            <strong>Penempatan Menu:</strong> Letakkan menu terkait berdekatan
                        </li>
                        <li style="padding: 0.5rem; background: #f8f9fa; border-radius: 4px;">
                            <strong>Rekomendasi:</strong> Sarankan menu terkait saat checkout
                        </li>
                    </ul>
                </div>
            `;
            
            html += '</div>';
            container.innerHTML = html;
        }

        // ============================
        // UI FUNCTIONS
        // ============================
        function showSection(sectionId) {
            try {
                // Hide all sections
                document.querySelectorAll('.dashboard-section').forEach(section => {
                    section.style.display = 'none';
                });
                
                // Show selected section
                const sectionElement = document.getElementById(sectionId + '-section');
                if (sectionElement) {
                    sectionElement.style.display = 'block';
                }
                
                // Update active menu
                document.querySelectorAll('.sidebar-menu a').forEach(link => {
                    link.classList.remove('active');
                });
                
                const clickedLink = event.target.closest('a');
                if (clickedLink) {
                    clickedLink.classList.add('active');
                }
                
                // Update current section
                currentSection = sectionId;
                
                // Load section data
                loadSectionData(sectionId);
                
            } catch (error) {
                console.error('Error showing section:', error);
                showToast('Gagal memuat section', 'error');
            }
        }

        function loadSectionData(sectionId) {
            if (!adminSystem || !adminSystem.initialized) return;
            
            try {
                switch(sectionId) {
                    case 'dashboard':
                        loadDashboard();
                        break;
                    case 'orders':
                        loadNewOrders();
                        break;
                    case 'reservations':
                        loadReservations();
                        break;
                    case 'all-orders':
                        loadAllOrders();
                        break;
                    case 'all-reservations':
                        loadAllReservations();
                        break;
                    case 'menu':
                        loadMenuManagement();
                        break;
                    case 'tables':
                        loadTablesManagement();
                        break;
                    case 'reports':
                        loadReportsSection();
                        break;
                    case 'analytics':
                        // Run analysis when section is shown
                        setTimeout(() => runAprioriAnalysis(), 100);
                        break;
                }
            } catch (error) {
                console.error(`Error loading section ${sectionId}:`, error);
                showToast(`Gagal memuat ${sectionId}`, 'error');
            }
        }

        function loadDashboard() {
            if (!adminSystem) return;
            
            try {
                // Update stats
                adminSystem.updateStats();
                adminSystem.updateNotifications();
                
                // Get stock alerts
                const lowStockMenus = adminSystem.getLowStockMenus();
                const outOfStockMenus = adminSystem.getOutOfStockMenus();
                
                let activityHtml = '';
                
                // Add stock alerts
                if (outOfStockMenus.length > 0) {
                    activityHtml += `
                        <tr>
                            <td>${new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' })}</td>
                            <td>âš ï¸ Stok Habis</td>
                            <td>${outOfStockMenus.map(menu => menu.name).join(', ')}</td>
                            <td>
                                <span class="status-badge status-cancelled">
                                    Perhatian
                                </span>
                            </td>
                        </tr>
                    `;
                }
                
                if (lowStockMenus.length > 0) {
                    activityHtml += `
                        <tr>
                            <td>${new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' })}</td>
                            <td>ðŸ“¦ Stok Menipis</td>
                            <td>${lowStockMenus.map(menu => `${menu.name} (${adminSystem.getAvailableStock(menu)})`).join(', ')}</td>
                            <td>
                                <span class="status-badge status-pending">
                                    Perhatian
                                </span>
                            </td>
                        </tr>
                    `;
                }
                
                // Add system activities
                if (adminSystem.activities.length > 0) {
                    activityHtml += adminSystem.activities.map(activity => `
                        <tr>
                            <td>${activity.time}</td>
                            <td>Aktivitas Sistem</td>
                            <td>${activity.message}</td>
                            <td>
                                <span class="status-badge status-completed">
                                    Selesai
                                </span>
                            </td>
                        </tr>
                    `).join('');
                }
                
                // Update table
                const activityTable = document.getElementById('activityTable');
                if (activityHtml === '') {
                    activityTable.innerHTML = `
                        <tr>
                            <td colspan="4" style="text-align: center; padding: 2rem; color: #666;">
                                Tidak ada aktivitas terbaru
                            </td>
                        </tr>
                    `;
                } else {
                    activityTable.innerHTML = activityHtml;
                }
            } catch (error) {
                console.error('Error loading dashboard:', error);
                document.getElementById('activityTable').innerHTML = `
                    <tr>
                        <td colspan="4" style="text-align: center; padding: 2rem; color: #666;">
                            Gagal memuat aktivitas
                        </td>
                    </tr>
                `;
            }
        }

        function loadNewOrders() {
            if (!adminSystem) return;
            
            try {
                const newOrders = adminSystem.orders;
                const table = document.getElementById('newOrdersTable');
                
                if (newOrders.length === 0) {
                    table.innerHTML = `
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 2rem; color: #666;">
                                Tidak ada pesanan baru
                            </td>
                        </tr>
                    `;
                } else {
                    table.innerHTML = newOrders.map(order => `
                        <tr>
                            <td>${order.orderNumber || 'ORD-' + order.id.toString().slice(-6)}</td>
                            <td>${order.customer?.name || 'Pelanggan'}</td>
                            <td>Rp ${order.total?.toLocaleString() || '0'}</td>
                            <td>${new Date(order.createdAt).toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' })}</td>
                            <td>
                                <span class="status-badge ${order.status === 'waiting_payment' ? 'status-pending' : 'status-pending'}">
                                    ${order.status === 'waiting_payment' ? 'Menunggu Pembayaran' : 'Menunggu'}
                                </span>
                            </td>
                            <td>
                                ${order.paymentProof ? 
                                    `<span class="proof-badge" onclick="viewPaymentProof('${order.id}')">
                                        <i class="fas fa-receipt"></i> Lihat Bukti
                                    </span>` : 
                                    '<span style="color: #666; font-size: 0.85rem;">Belum ada</span>'
                                }
                            </td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn btn-success btn-sm" onclick="confirmOrder('${order.id}')">
                                        <i class="fas fa-check"></i> Konfirmasi
                                    </button>
                                    <button class="btn btn-primary btn-sm" onclick="viewOrderDetail('${order.id}')">
                                        <i class="fas fa-eye"></i> Detail
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `).join('');
                }
                
                adminSystem.updateNotifications();
            } catch (error) {
                console.error('Error loading new orders:', error);
                document.getElementById('newOrdersTable').innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 2rem; color: #666;">
                            Gagal memuat pesanan
                        </td>
                    </tr>
                `;
            }
        }

        function loadReservations() {
            if (!adminSystem) return;
            
            try {
                const newReservations = adminSystem.reservations;
                const table = document.getElementById('reservationsTable');
                
                if (newReservations.length === 0) {
                    table.innerHTML = `
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 2rem; color: #666;">
                                Tidak ada reservasi baru
                            </td>
                        </tr>
                    `;
                } else {
                    table.innerHTML = newReservations.map(res => `
                        <tr>
                            <td>#${res.id.toString().slice(-6)}</td>
                            <td>${res.name}</td>
                            <td>${res.date ? new Date(res.date).toLocaleDateString('id-ID') : '-'}</td>
                            <td>${res.time || '-'}</td>
                            <td>${res.tableNumber || '-'}</td>
                            <td>
                                <span class="status-badge ${res.status === 'confirmed' ? 'status-confirmed' : 'status-pending'}">
                                    ${res.status === 'confirmed' ? 'Dikonfirmasi' : 'Menunggu'}
                                </span>
                            </td>
                            <td>
                                <div class="action-buttons">
                                    ${res.status === 'pending' ? `
                                    <button class="btn btn-success btn-sm" onclick="confirmReservation('${res.id}')">
                                        <i class="fas fa-check"></i> Konfirmasi
                                    </button>` : ''}
                                    <button class="btn btn-primary btn-sm" onclick="viewReservationDetail('${res.id}')">
                                        <i class="fas fa-eye"></i> Detail
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `).join('');
                }
                
                adminSystem.updateNotifications();
            } catch (error) {
                console.error('Error loading reservations:', error);
                document.getElementById('reservationsTable').innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 2rem; color: #666;">
                            Gagal memuat reservasi
                        </td>
                    </tr>
                `;
            }
        }

        function loadAllOrders() {
            if (!adminSystem) return;
            
            try {
                const table = document.getElementById('allOrdersTable');
                
                if (adminSystem.allOrders.length === 0) {
                    table.innerHTML = `
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 2rem; color: #666;">
                                Belum ada pesanan
                            </td>
                        </tr>
                    `;
                } else {
                    table.innerHTML = adminSystem.allOrders.map(order => `
                        <tr>
                            <td>${order.orderNumber || 'ORD-' + order.id.toString().slice(-6)}</td>
                            <td>${order.customer?.name || 'Pelanggan'}</td>
                            <td>Rp ${order.total?.toLocaleString() || '0'}</td>
                            <td>${new Date(order.createdAt).toLocaleDateString('id-ID')}</td>
                            <td>
                                <span class="status-badge status-${order.status || 'pending'}">
                                    ${getStatusText(order.status || 'pending')}
                                </span>
                            </td>
                            <td>
                                ${order.paymentProof ? 
                                    `<span class="proof-badge" onclick="viewPaymentProof('${order.id}')">
                                        <i class="fas fa-receipt"></i> Lihat Bukti
                                    </span>` : 
                                    '<span style="color: #666; font-size: 0.85rem;">Tidak ada</span>'
                                }
                            </td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn btn-primary btn-sm" onclick="viewOrderDetail('${order.id}')">
                                        <i class="fas fa-eye"></i> Detail
                                    </button>
                                    ${order.status === 'confirmed' ? `
                                    <button class="btn btn-success btn-sm" onclick="completeOrder('${order.id}')">
                                        <i class="fas fa-check-double"></i> Selesai
                                    </button>` : ''}
                                </div>
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                console.error('Error loading all orders:', error);
                document.getElementById('allOrdersTable').innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 2rem; color: #666;">
                            Gagal memuat pesanan
                        </td>
                    </tr>
                `;
            }
        }

        function loadAllReservations() {
            if (!adminSystem) return;
            
            try {
                const table = document.getElementById('allReservationsTable');
                
                if (adminSystem.allReservations.length === 0) {
                    table.innerHTML = `
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 2rem; color: #666;">
                                Belum ada reservasi
                            </td>
                        </tr>
                    `;
                } else {
                    table.innerHTML = adminSystem.allReservations.map(res => `
                        <tr>
                            <td>#${res.id.toString().slice(-6)}</td>
                            <td>${res.name}</td>
                            <td>${res.date ? new Date(res.date).toLocaleDateString('id-ID') : '-'}</td>
                            <td>${res.time || '-'}</td>
                            <td>${res.tableNumber || '-'}</td>
                            <td>
                                <span class="status-badge ${res.status === 'confirmed' ? 'status-confirmed' : 'status-pending'}">
                                    ${res.status === 'confirmed' ? 'Dikonfirmasi' : 'Menunggu'}
                                </span>
                            </td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn btn-primary btn-sm" onclick="viewReservationDetail('${res.id}')">
                                        <i class="fas fa-eye"></i> Detail
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                console.error('Error loading all reservations:', error);
                document.getElementById('allReservationsTable').innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 2rem; color: #666;">
                            Gagal memuat reservasi
                        </td>
                    </tr>
                `;
            }
        }

        function loadMenuManagement() {
            if (!adminSystem) return;
            
            try {
                const container = document.getElementById('menuListContainer');
                
                if (adminSystem.menus.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 3rem; color: #666;">
                            <i class="fas fa-utensils" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                            <h3>Belum ada menu</h3>
                            <p>Tambahkan menu pertama Anda</p>
                            <button class="btn btn-primary" onclick="openAddMenuModal()" style="margin-top: 1rem;">
                                <i class="fas fa-plus"></i> Tambah Menu Pertama
                            </button>
                        </div>
                    `;
                } else {
                    const lowStockCount = adminSystem.getLowStockMenus().length;
                    const outOfStockCount = adminSystem.getOutOfStockMenus().length;
                    const goodStockCount = adminSystem.menus.length - lowStockCount - outOfStockCount;
                    
                    container.innerHTML = `
                        <div style="margin-bottom: 1.5rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                            <div>
                                <h3 style="margin: 0; font-size: 1.2rem;">Total Menu: ${adminSystem.menus.length}</h3>
                                <p style="color: #666; font-size: 0.9rem; margin: 0.3rem 0;">
                                    <span class="stock-badge stock-good">Stok Aman: ${goodStockCount}</span>
                                    <span class="stock-badge stock-low">Stok Menipis: ${lowStockCount}</span>
                                    <span class="stock-badge stock-empty">Stok Habis: ${outOfStockCount}</span>
                                </p>
                            </div>
                            <button class="btn btn-success" onclick="restockAllMenus()" style="padding: 0.8rem 1.2rem;">
                                <i class="fas fa-boxes"></i> Restock Semua
                            </button>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.5rem;">
                            ${adminSystem.menus.map(menu => `
                                <div class="menu-card-admin">
                                    ${menu.image ? 
                                        `<img src="${menu.image}" 
                                              alt="${menu.name}" 
                                              style="width: 100%; height: 150px; object-fit: cover; border-radius: 6px;"
                                              onerror="this.src='https://via.placeholder.com/300x150?text=${encodeURIComponent(menu.name)}'">` : 
                                        `<div style="height: 150px; background: #f0f0f0; border-radius: 6px; display: flex; align-items: center; justify-content: center; color: #666;">
                                            <i class="fas fa-utensils" style="font-size: 3rem;"></i>
                                        </div>`
                                    }
                                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem; margin-top: 0.5rem;">
                                        <h4 style="margin: 0; font-size: 1rem;">${menu.name}</h4>
                                        <span style="font-weight: bold; color: var(--primary-color); font-size: 0.9rem;">Rp ${menu.price.toLocaleString()}</span>
                                    </div>
                                    <p style="color: #666; font-size: 0.9rem; margin-bottom: 0.5rem; min-height: 40px;">
                                        ${menu.description || 'Tidak ada deskripsi'}
                                    </p>
                                    
                                    <div style="margin-bottom: 0.8rem;">
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.3rem;">
                                            <span style="font-size: 0.85rem; color: #666;">
                                                <i class="fas fa-box"></i> Stok:
                                                ${menu.isDailyStock ? ' Harian' : ' Reguler'}
                                            </span>
                                            <span class="stock-badge ${getStockBadgeClass(adminSystem.getAvailableStock(menu))}">
                                                ${adminSystem.getAvailableStock(menu)}${menu.isDailyStock && menu.dailyStock ? `/ ${menu.dailyStock}` : ''}
                                            </span>
                                        </div>
                                    </div>
                                    
                                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.5rem;">
                                        <span style="font-size: 0.8rem; background: #e9ecef; padding: 0.2rem 0.5rem; border-radius: 4px;">
                                            ${getCategoryText(menu.category)}
                                            ${menu.isPromo ? ' â€¢ PROMO' : ''}
                                        </span>
                                        <div class="action-buttons">
                                            <button class="btn btn-primary btn-sm" onclick="editMenu('${menu.id}')">
                                                <i class="fas fa-edit"></i> Edit
                                            </button>
                                            <button class="btn btn-warning btn-sm" onclick="openRestockModal('${menu.id}')" style="background: #ffc107; color: #212529; border: none;">
                                                <i class="fas fa-plus-circle"></i> Restock
                                            </button>
                                            <button class="btn btn-danger btn-sm" onclick="deleteMenu('${menu.id}')">
                                                <i class="fas fa-trash"></i> Hapus
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading menu management:', error);
                document.getElementById('menuListContainer').innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: #666;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                        <h3>Gagal memuat menu</h3>
                        <p>Silakan refresh halaman</p>
                    </div>
                `;
            }
        }

        function getStockBadgeClass(stock) {
            if (stock <= 0) return 'stock-empty';
            if (stock <= 5) return 'stock-low';
            return 'stock-good';
        }

        function loadTablesManagement() {
            try {
                const container = document.getElementById('tablesListContainer');
                
                const tables = JSON.parse(localStorage.getItem('cafe_tables') || '[]');
                
                if (tables.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 3rem; color: #666;">
                            <i class="fas fa-chair" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                            <h3>Belum ada meja</h3>
                            <p>Tambahkan meja pertama Anda</p>
                            <button class="btn btn-primary" onclick="openAddTableModal()" style="margin-top: 1rem;">
                                <i class="fas fa-plus"></i> Tambah Meja Pertama
                            </button>
                        </div>
                    `;
                } else {
                    container.innerHTML = `
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1.5rem;">
                            ${tables.map(table => `
                                <div class="menu-card-admin">
                                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                                        <h4 style="margin: 0; font-size: 1rem;">Meja ${table.number}</h4>
                                        <span style="font-size: 0.8rem; padding: 0.2rem 0.5rem; border-radius: 4px; background: ${getTableStatusColor(table.status)}; color: white;">
                                            ${getTableStatusText(table.status)}
                                        </span>
                                    </div>
                                    <p style="color: #666; font-size: 0.9rem; margin-bottom: 0.5rem;">
                                        <i class="fas fa-users"></i> Kapasitas: ${table.capacity} orang<br>
                                        <i class="fas fa-map-marker-alt"></i> ${getTableLocationText(table.location)}<br>
                                        ${table.description ? `<i class="fas fa-sticky-note"></i> ${table.description}` : ''}
                                    </p>
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <span style="font-size: 0.8rem; background: #e9ecef; padding: 0.2rem 0.5rem; border-radius: 4px;">
                                            ${table.status === 'available' ? 'âœ… Tersedia' : 
                                              table.status === 'occupied' ? 'ðŸŸ¡ Terisi' : 
                                              table.status === 'reserved' ? 'ðŸ”µ Dipesan' : 'ðŸ”´ Perbaikan'}
                                        </span>
                                        <div class="action-buttons">
                                            <button class="btn btn-primary btn-sm" onclick="editTable('${table.id}')">
                                                <i class="fas fa-edit"></i> Edit
                                            </button>
                                            <button class="btn btn-danger btn-sm" onclick="deleteTable('${table.id}')">
                                                <i class="fas fa-trash"></i> Hapus
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading tables management:', error);
                document.getElementById('tablesListContainer').innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: #666;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                        <h3>Gagal memuat data meja</h3>
                        <p>Silakan refresh halaman</p>
                    </div>
                `;
            }
        }

        function loadReportsSection() {
            const today = new Date().toISOString().split('T')[0];
            const firstDayOfMonth = new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString().split('T')[0];
            
            document.getElementById('reportDate').value = today;
            document.getElementById('reportMonth').value = today.slice(0, 7);
            document.getElementById('startDate').value = firstDayOfMonth;
            document.getElementById('endDate').value = today;
            
            changeReportType();
            loadReportData();
        }

        function changeReportType() {
            const reportType = document.getElementById('reportType').value;
            
            document.getElementById('dailyFilter').style.display = reportType === 'daily' ? 'block' : 'none';
            document.getElementById('monthlyFilter').style.display = reportType === 'monthly' ? 'block' : 'none';
            document.getElementById('customFilter').style.display = reportType === 'custom' ? 'block' : 'none';
        }

        function loadReportData() {
            if (!adminSystem) return;
            
            try {
                const reportType = document.getElementById('reportType').value;
                let startDate, endDate;
                
                switch(reportType) {
                    case 'daily':
                        const selectedDate = document.getElementById('reportDate').value;
                        startDate = new Date(selectedDate);
                        endDate = new Date(selectedDate);
                        endDate.setHours(23, 59, 59, 999);
                        break;
                        
                    case 'monthly':
                        const selectedMonth = document.getElementById('reportMonth').value;
                        startDate = new Date(selectedMonth + '-01');
                        endDate = new Date(startDate.getFullYear(), startDate.getMonth() + 1, 0);
                        endDate.setHours(23, 59, 59, 999);
                        break;
                        
                    case 'custom':
                        startDate = new Date(document.getElementById('startDate').value);
                        endDate = new Date(document.getElementById('endDate').value);
                        endDate.setHours(23, 59, 59, 999);
                        break;
                }
                
                const filteredOrders = adminSystem.allOrders.filter(order => {
                    const orderDate = new Date(order.createdAt);
                    return orderDate >= startDate && orderDate <= endDate && order.status === 'completed';
                });
                
                currentReportData = filteredOrders;
                
                updateReportSummary(filteredOrders);
                updateSalesChart(filteredOrders, reportType);
                updateReportTable(filteredOrders);
                
                showToast(`Laporan berhasil dimuat (${filteredOrders.length} pesanan)`, 'success');
                
            } catch (error) {
                console.error('Error loading reports:', error);
                showToast('Gagal memuat laporan', 'error');
            }
        }

        function updateReportSummary(orders) {
            try {
                const totalRevenue = orders.reduce((sum, order) => sum + (order.total || 0), 0);
                const totalOrders = orders.length;
                const averageOrder = totalOrders > 0 ? totalRevenue / totalOrders : 0;
                
                const uniqueCustomers = new Set(orders.map(order => order.customer?.phone || order.customer?.name)).size;
                
                document.getElementById('summaryRevenue').textContent = 'Rp ' + totalRevenue.toLocaleString();
                document.getElementById('summaryOrders').textContent = totalOrders;
                document.getElementById('summaryAverage').textContent = 'Rp ' + Math.round(averageOrder).toLocaleString();
                document.getElementById('summaryCustomers').textContent = uniqueCustomers;
                
            } catch (error) {
                console.error('Error updating report summary:', error);
            }
        }

        function updateSalesChart(orders, reportType) {
            try {
                const chartContainer = document.getElementById('salesChart');
                
                if (orders.length === 0) {
                    chartContainer.innerHTML = `
                        <div style="text-align: center; padding: 5rem; color: #666;">
                            <i class="fas fa-chart-line" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                            <h3>Tidak ada data penjualan</h3>
                            <p>Tidak ada pesanan pada periode yang dipilih</p>
                        </div>
                    `;
                    return;
                }
                
                let labels = [];
                let data = [];
                
                if (reportType === 'daily') {
                    const hourlyData = {};
                    for (let i = 0; i < 24; i++) {
                        hourlyData[i] = 0;
                    }
                    
                    orders.forEach(order => {
                        const orderDate = new Date(order.createdAt);
                        const hour = orderDate.getHours();
                        hourlyData[hour] += order.total || 0;
                    });
                    
                    labels = Array.from({length: 24}, (_, i) => `${i}:00`);
                    data = Object.values(hourlyData);
                    
                } else {
                    const dailyData = {};
                    const startDate = reportType === 'monthly' ? 
                        new Date(document.getElementById('reportMonth').value + '-01') :
                        new Date(document.getElementById('startDate').value);
                    const endDate = reportType === 'monthly' ?
                        new Date(startDate.getFullYear(), startDate.getMonth() + 1, 0) :
                        new Date(document.getElementById('endDate').value);
                    
                    const currentDate = new Date(startDate);
                    
                    while (currentDate <= endDate) {
                        const dateKey = currentDate.toISOString().split('T')[0];
                        dailyData[dateKey] = 0;
                        currentDate.setDate(currentDate.getDate() + 1);
                    }
                    
                    orders.forEach(order => {
                        const orderDate = new Date(order.createdAt);
                        const dateKey = orderDate.toISOString().split('T')[0];
                        if (dailyData[dateKey] !== undefined) {
                            dailyData[dateKey] += order.total || 0;
                        }
                    });
                    
                    labels = Object.keys(dailyData).map(date => {
                        const d = new Date(date);
                        return d.getDate() + '/' + (d.getMonth() + 1);
                    });
                    data = Object.values(dailyData);
                }
                
                chartContainer.innerHTML = '';
                const maxValue = Math.max(...data, 1);
                const chartWidth = chartContainer.clientWidth - 40;
                const barWidth = Math.max(20, (chartWidth - 100) / labels.length);
                
                const chartBars = document.createElement('div');
                chartBars.style.display = 'flex';
                chartBars.style.height = 'calc(100% - 40px)';
                chartBars.style.alignItems = 'flex-end';
                chartBars.style.justifyContent = 'space-around';
                chartBars.style.padding = '0 10px';
                
                labels.forEach((label, index) => {
                    const value = data[index];
                    const height = (value / maxValue) * 180;
                    
                    const barContainer = document.createElement('div');
                    barContainer.style.display = 'flex';
                    barContainer.style.flexDirection = 'column';
                    barContainer.style.alignItems = 'center';
                    barContainer.style.justifyContent = 'flex-end';
                    barContainer.style.height = '100%';
                    barContainer.style.flex = '1';
                    
                    const bar = document.createElement('div');
                    bar.style.width = barWidth + 'px';
                    bar.style.height = height + 'px';
                    bar.style.backgroundColor = '#4CAF50';
                    bar.style.borderRadius = '4px 4px 0 0';
                    bar.style.transition = 'height 0.3s';
                    bar.title = 'Rp ' + value.toLocaleString();
                    bar.style.cursor = 'pointer';
                    bar.onmouseenter = function() {
                        this.style.backgroundColor = '#388E3C';
                    };
                    bar.onmouseleave = function() {
                        this.style.backgroundColor = '#4CAF50';
                    };
                    
                    const labelSpan = document.createElement('span');
                    labelSpan.textContent = label;
                    labelSpan.style.fontSize = '0.7rem';
                    labelSpan.style.color = '#666';
                    labelSpan.style.marginTop = '4px';
                    labelSpan.style.textAlign = 'center';
                    labelSpan.style.width = '100%';
                    
                    barContainer.appendChild(bar);
                    barContainer.appendChild(labelSpan);
                    chartBars.appendChild(barContainer);
                });
                
                chartContainer.appendChild(chartBars);
                
            } catch (error) {
                console.error('Error updating sales chart:', error);
                chartContainer.innerHTML = `
                    <div style="text-align: center; padding: 5rem; color: #666;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                        <h3>Gagal memuat grafik</h3>
                        <p>Terjadi kesalahan saat membuat grafik</p>
                    </div>
                `;
            }
        }

        function updateReportTable(orders) {
            try {
                const tableBody = document.getElementById('reportsTable');
                
                if (orders.length === 0) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 3rem; color: #666;">
                                <i class="fas fa-clipboard-list" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                                <h4>Tidak ada data</h4>
                                <p>Tidak ada pesanan pada periode yang dipilih</p>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                const sortedOrders = [...orders].sort((a, b) => 
                    new Date(b.createdAt) - new Date(a.createdAt)
                );
                
                tableBody.innerHTML = sortedOrders.map(order => `
                    <tr>
                        <td>${new Date(order.createdAt).toLocaleDateString('id-ID')}</td>
                        <td>${order.orderNumber || 'ORD-' + order.id.toString().slice(-6)}</td>
                        <td>${order.customer?.name || 'Pelanggan'}</td>
                        <td>
                            <span class="badge" style="background: #e9ecef; color: #495057; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.8rem;">
                                ${order.items?.length || 1} item
                            </span>
                        </td>
                        <td style="font-weight: 600;">Rp ${order.total?.toLocaleString() || '0'}</td>
                        <td>
                            <span class="status-badge status-completed">
                                Selesai
                            </span>
                        </td>
                    </tr>
                `).join('');
                
            } catch (error) {
                console.error('Error updating report table:', error);
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 2rem; color: #666;">
                            Gagal memuat data laporan
                        </td>
                    </tr>
                `;
            }
        }

        // ============================
        // ACTION FUNCTIONS
        // ============================
        async function confirmOrder(orderId) {
            if (!adminSystem) return;
            
            if (confirm('Konfirmasi pesanan ini?')) {
                if (await adminSystem.confirmOrder(orderId)) {
                    loadNewOrders();
                    loadAllOrders();
                    loadDashboard();
                }
            }
        }

        async function completeOrder(orderId) {
            if (!adminSystem) return;
            
            if (confirm('Tandai pesanan ini sebagai selesai?')) {
                if (await adminSystem.completeOrder(orderId)) {
                    loadAllOrders();
                    loadDashboard();
                }
            }
        }

        async function confirmReservation(reservationId) {
            if (!adminSystem) return;
            
            if (confirm('Konfirmasi reservasi ini?')) {
                if (await adminSystem.confirmReservation(reservationId)) {
                    loadReservations();
                    loadAllReservations();
                    loadDashboard();
                }
            }
        }

        // ============================
        // MENU FUNCTIONS
        // ============================
        function openAddMenuModal() {
            document.getElementById('menuModalTitle').textContent = 'Tambah Menu';
            document.getElementById('menuId').value = '';
            document.getElementById('menuForm').reset();
            
            document.getElementById('stockManagement').value = 'regular';
            document.getElementById('dailyStockContainer').style.display = 'none';
            document.getElementById('dailyStock').value = '';
            
            document.getElementById('menuIsPromo').checked = false;
            document.getElementById('originalPriceContainer').style.display = 'none';
            document.getElementById('menuOriginalPrice').value = '';
            
            currentImageBase64 = null;
            const previewContainer = document.getElementById('imagePreviewContainer');
            const preview = document.getElementById('imagePreview');
            previewContainer.style.display = 'none';
            preview.src = '';
            
            openModal('menuModal');
        }

        async function editMenu(menuId) {
            if (!adminSystem) return;
            
            try {
                const menu = adminSystem.menus.find(m => m.id == menuId);
                if (!menu) {
                    showToast('Menu tidak ditemukan', 'error');
                    return;
                }
                
                document.getElementById('menuModalTitle').textContent = 'Edit Menu';
                document.getElementById('menuId').value = menu.id;
                document.getElementById('menuName').value = menu.name;
                document.getElementById('menuPrice').value = menu.price;
                document.getElementById('menuStock').value = menu.stock || 0;
                document.getElementById('menuCategory').value = menu.category || 'minuman';
                document.getElementById('menuDescription').value = menu.description || '';
                document.getElementById('menuIsPromo').checked = menu.isPromo || false;
                
                if (menu.isDailyStock) {
                    document.getElementById('stockManagement').value = 'daily';
                    document.getElementById('dailyStockContainer').style.display = 'block';
                    document.getElementById('dailyStock').value = menu.dailyStock || 0;
                } else {
                    document.getElementById('stockManagement').value = 'regular';
                    document.getElementById('dailyStockContainer').style.display = 'none';
                    document.getElementById('dailyStock').value = '';
                }
                
                if (menu.isPromo && menu.originalPrice) {
                    document.getElementById('originalPriceContainer').style.display = 'block';
                    document.getElementById('menuOriginalPrice').value = menu.originalPrice;
                } else {
                    document.getElementById('originalPriceContainer').style.display = 'none';
                    document.getElementById('menuOriginalPrice').value = '';
                }
                
                currentImageBase64 = menu.image || null;
                const previewContainer = document.getElementById('imagePreviewContainer');
                const preview = document.getElementById('imagePreview');
                
                if (currentImageBase64) {
                    preview.src = currentImageBase64;
                    previewContainer.style.display = 'block';
                } else {
                    previewContainer.style.display = 'none';
                }
                
                openModal('menuModal');
            } catch (error) {
                console.error('Error editing menu:', error);
                showToast('Gagal memuat data menu', 'error');
            }
        }

        async function deleteMenu(menuId) {
            if (!adminSystem) return;
            
            if (confirm('Yakin ingin menghapus menu ini?')) {
                if (await adminSystem.deleteMenu(menuId)) {
                    loadMenuManagement();
                    loadDashboard();
                }
            }
        }

        function openRestockModal(menuId) {
            const menu = adminSystem.menus.find(m => m.id == menuId);
            if (!menu) return;
            
            const quantity = prompt(`Restock ${menu.name}\n\nStok saat ini: ${adminSystem.getAvailableStock(menu)}\nJumlah tambahan:`, "10");
            
            if (quantity && !isNaN(quantity) && parseInt(quantity) > 0) {
                restockMenu(menuId, parseInt(quantity));
            }
        }

        async function restockMenu(menuId, quantity) {
            if (!adminSystem) return;
            
            try {
                const menu = adminSystem.menus.find(m => m.id == menuId);
                if (!menu) return;
                
                const newStock = (menu.stock || 0) + quantity;
                const menuData = {
                    ...menu,
                    stock: newStock
                };
                
                await adminSystem.updateMenu(menuId, menuData);
                
                showToast(`Menu "${menu.name}" berhasil direstock +${quantity}`, 'success');
                loadMenuManagement();
                loadDashboard();
                
            } catch (error) {
                console.error('Error restocking menu:', error);
                showToast('Gagal melakukan restock', 'error');
            }
        }

        async function restockAllMenus() {
            if (!adminSystem) return;
            
            const quantity = prompt('Jumlah stok yang akan ditambahkan ke semua menu:', "10");
            
            if (quantity && !isNaN(quantity) && parseInt(quantity) > 0) {
                if (confirm(`Tambahkan ${quantity} stok ke semua menu?`)) {
                    const qty = parseInt(quantity);
                    
                    for (const menu of adminSystem.menus) {
                        const newStock = (menu.stock || 0) + qty;
                        const menuData = { ...menu, stock: newStock };
                        await adminSystem.updateMenu(menu.id, menuData);
                    }
                    
                    showToast(`Semua menu berhasil direstock +${qty}`, 'success');
                    loadMenuManagement();
                    loadDashboard();
                }
            }
        }

        // ============================
        // TABLE FUNCTIONS
        // ============================
        function openAddTableModal() {
            document.getElementById('tableModalTitle').textContent = 'Tambah Meja';
            document.getElementById('tableId').value = '';
            document.getElementById('tableForm').reset();
            openModal('tableModal');
        }

        function editTable(tableId) {
            try {
                const tables = JSON.parse(localStorage.getItem('cafe_tables') || '[]');
                const table = tables.find(t => t.id == tableId);
                
                if (!table) {
                    showToast('Meja tidak ditemukan', 'error');
                    return;
                }
                
                document.getElementById('tableModalTitle').textContent = 'Edit Meja';
                document.getElementById('tableId').value = table.id;
                document.getElementById('tableNumber').value = table.number;
                document.getElementById('tableCapacity').value = table.capacity;
                document.getElementById('tableLocation').value = table.location || 'indoor';
                document.getElementById('tableStatus').value = table.status || 'available';
                document.getElementById('tableDescription').value = table.description || '';
                
                openModal('tableModal');
            } catch (error) {
                console.error('Error editing table:', error);
                showToast('Gagal memuat data meja', 'error');
            }
        }

        function deleteTable(tableId) {
            if (confirm('Yakin ingin menghapus meja ini?')) {
                try {
                    const tables = JSON.parse(localStorage.getItem('cafe_tables') || '[]');
                    const updatedTables = tables.filter(t => t.id != tableId);
                    localStorage.setItem('cafe_tables', JSON.stringify(updatedTables));
                    showToast('Meja berhasil dihapus', 'success');
                    loadTablesManagement();
                } catch (error) {
                    console.error('Error deleting table:', error);
                    showToast('Gagal menghapus meja', 'error');
                }
            }
        }

        // ============================
        // UTILITY FUNCTIONS
        // ============================
        function getStatusText(status) {
            const statusMap = {
                'pending': 'Menunggu',
                'waiting_payment': 'Menunggu Pembayaran',
                'confirmed': 'Dikonfirmasi',
                'completed': 'Selesai',
                'cancelled': 'Dibatalkan'
            };
            return statusMap[status] || status;
        }

        function getCategoryText(category) {
            const categoryMap = {
                'minuman': 'Minuman',
                'makanan': 'Makanan',
                'snack': 'Snack',
                'dessert': 'Dessert'
            };
            return categoryMap[category] || category;
        }

        function getTableStatusColor(status) {
            const colors = {
                'available': '#28a745',
                'occupied': '#ffc107',
                'reserved': '#007bff',
                'maintenance': '#dc3545'
            };
            return colors[status] || '#666';
        }

        function getTableStatusText(status) {
            const texts = {
                'available': 'Tersedia',
                'occupied': 'Terisi',
                'reserved': 'Dipesan',
                'maintenance': 'Perbaikan'
            };
            return texts[status] || status;
        }

        function getTableLocationText(location) {
            const locations = {
                'indoor': 'Indoor',
                'outdoor': 'Outdoor',
                'smoking_area': 'Smoking Area',
                'vip': 'VIP Room'
            };
            return locations[location] || location;
        }

        function toggleDailyStockOption() {
            const stockManagement = document.getElementById('stockManagement').value;
            const dailyStockContainer = document.getElementById('dailyStockContainer');
            
            if (stockManagement === 'daily') {
                dailyStockContainer.style.display = 'block';
                document.getElementById('dailyStock').required = true;
            } else {
                dailyStockContainer.style.display = 'none';
                document.getElementById('dailyStock').required = false;
            }
        }

        document.getElementById('menuIsPromo').addEventListener('change', function() {
            const originalPriceContainer = document.getElementById('originalPriceContainer');
            if (this.checked) {
                originalPriceContainer.style.display = 'block';
            } else {
                originalPriceContainer.style.display = 'none';
            }
        });

        function showToast(message, type = 'success') {
            try {
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.innerHTML = `
                    <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
                    <span>${message}</span>
                `;
                document.body.appendChild(toast);
                
                setTimeout(() => toast.classList.add('show'), 100);
                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            } catch (error) {
                console.error('Error showing toast:', error);
                alert(message);
            }
        }

        function openModal(modalId) {
            try {
                document.getElementById(modalId).style.display = 'flex';
            } catch (error) {
                console.error('Error opening modal:', error);
            }
        }

        function closeModal(modalId) {
            try {
                document.getElementById(modalId).style.display = 'none';
            } catch (error) {
                console.error('Error closing modal:', error);
            }
        }

        async function refreshData() {
            if (!adminSystem) return;
            
            try {
                await adminSystem.syncFromSupabase();
                loadSectionData(currentSection);
                showToast('Data berhasil direfresh', 'success');
            } catch (error) {
                console.error('Error refreshing data:', error);
                showToast('Gagal merefresh data', 'error');
            }
        }

        async function refreshOrders() {
            if (!adminSystem) return;
            
            try {
                await adminSystem.syncOrdersFromSupabase();
                loadNewOrders();
                showToast('Pesanan berhasil direfresh', 'success');
            } catch (error) {
                console.error('Error refreshing orders:', error);
                showToast('Gagal merefresh pesanan', 'error');
            }
        }

        async function refreshReservations() {
            if (!adminSystem) return;
            
            try {
                await adminSystem.syncReservationsFromSupabase();
                loadReservations();
                showToast('Reservasi berhasil direfresh', 'success');
            } catch (error) {
                console.error('Error refreshing reservations:', error);
                showToast('Gagal merefresh reservasi', 'error');
            }
        }

        async function refreshAllOrders() {
            if (!adminSystem) return;
            
            try {
                await adminSystem.syncOrdersFromSupabase();
                loadAllOrders();
                showToast('Semua pesanan berhasil direfresh', 'success');
            } catch (error) {
                console.error('Error refreshing all orders:', error);
                showToast('Gagal merefresh semua pesanan', 'error');
            }
        }

        async function refreshAllReservations() {
            if (!adminSystem) return;
            
            try {
                await adminSystem.syncReservationsFromSupabase();
                loadAllReservations();
                showToast('Semua reservasi berhasil direfresh', 'success');
            } catch (error) {
                console.error('Error refreshing all reservations:', error);
                showToast('Gagal merefresh semua reservasi', 'error');
            }
        }

        function filterAllOrders(status) {
            try {
                const rows = document.querySelectorAll('#allOrdersTable tr');
                rows.forEach(row => {
                    if (row.cells[4]) {
                        const badge = row.cells[4].querySelector('.status-badge');
                        if (badge) {
                            const rowStatus = badge.className.includes('status-' + status);
                            if (status === 'all' || rowStatus) {
                                row.style.display = '';
                            } else {
                                row.style.display = 'none';
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error filtering orders:', error);
            }
        }

        function filterAllReservations(status) {
            try {
                const rows = document.querySelectorAll('#allReservationsTable tr');
                rows.forEach(row => {
                    if (row.cells[5]) {
                        const badge = row.cells[5].querySelector('.status-badge');
                        if (badge) {
                            const rowStatus = badge.className.includes(status);
                            if (status === 'all' || rowStatus) {
                                row.style.display = '';
                            } else {
                                row.style.display = 'none';
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error filtering reservations:', error);
            }
        }

        function showNotifications() {
            if (!adminSystem) return;
            
            const newOrders = adminSystem.getNewOrders();
            const newReservations = adminSystem.reservations.filter(r => 
                !r.adminSeen && r.status === 'pending'
            );
            
            let message = '';
            if (newOrders.length > 0) {
                message += `â€¢ ${newOrders.length} pesanan baru menunggu konfirmasi\n`;
            }
            if (newReservations.length > 0) {
                message += `â€¢ ${newReservations.length} reservasi baru menunggu konfirmasi`;
            }
            
            if (message) {
                alert('ðŸ“¢ Notifikasi:\n' + message);
                newOrders.forEach(order => order.adminSeen = true);
                newReservations.forEach(res => res.adminSeen = true);
                adminSystem.updateNotifications();
            } else {
                alert('ðŸ“­ Tidak ada notifikasi baru');
            }
        }

        function logout() {
            if (confirm('Yakin ingin logout?')) {
                localStorage.removeItem('adminLoggedIn');
                localStorage.removeItem('adminUsername');
                window.location.href = 'index.html';
            }
        }

        // ============================
        // IMAGE HANDLING
        // ============================
        document.getElementById('menuImage').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            try {
                if (file.size > 2 * 1024 * 1024) {
                    showToast('Ukuran gambar terlalu besar. Maksimal 2MB.', 'error');
                    this.value = '';
                    return;
                }
                
                if (!file.type.match('image.*')) {
                    showToast('Hanya file gambar yang diizinkan.', 'error');
                    this.value = '';
                    return;
                }
                
                const base64 = await convertImageToBase64(file);
                currentImageBase64 = base64;
                
                const previewContainer = document.getElementById('imagePreviewContainer');
                const preview = document.getElementById('imagePreview');
                preview.src = base64;
                previewContainer.style.display = 'block';
                
                showToast('Gambar berhasil diunggah', 'success');
            } catch (error) {
                console.error('Error converting image:', error);
                showToast('Gagal mengunggah gambar', 'error');
            }
        });

        function convertImageToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        function removeImage() {
            currentImageBase64 = null;
            const previewContainer = document.getElementById('imagePreviewContainer');
            const fileInput = document.getElementById('menuImage');
            
            previewContainer.style.display = 'none';
            fileInput.value = '';
            
            showToast('Gambar dihapus', 'info');
        }

        // ============================
        // FORM HANDLERS
        // ============================
        document.getElementById('menuForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!adminSystem) {
                showToast('Sistem admin belum siap', 'error');
                return;
            }
            
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Menyimpan...';
            
            try {
                const menuId = document.getElementById('menuId').value;
                const isDailyStock = document.getElementById('stockManagement').value === 'daily';
                const dailyStock = isDailyStock ? parseInt(document.getElementById('dailyStock').value) || 0 : null;
                const isPromo = document.getElementById('menuIsPromo').checked;
                const originalPrice = isPromo ? parseInt(document.getElementById('menuOriginalPrice').value) || null : null;
                
                const menuData = {
                    name: document.getElementById('menuName').value,
                    price: parseInt(document.getElementById('menuPrice').value),
                    stock: parseInt(document.getElementById('menuStock').value) || 0,
                    dailyStock: dailyStock,
                    currentDailyStock: dailyStock,
                    isDailyStock: isDailyStock,
                    category: document.getElementById('menuCategory').value,
                    description: document.getElementById('menuDescription').value,
                    image: currentImageBase64 || null,
                    isPromo: isPromo,
                    originalPrice: originalPrice
                };
                
                if (menuId) {
                    await adminSystem.updateMenu(menuId, menuData);
                } else {
                    await adminSystem.addMenu(menuData);
                }
                
                closeModal('menuModal');
                loadMenuManagement();
                
            } catch (error) {
                console.error('Error saving menu:', error);
                showToast('Gagal menyimpan menu: ' + error.message, 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        });

        document.getElementById('tableForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            try {
                const tableId = document.getElementById('tableId').value;
                const tableData = {
                    id: tableId ? parseInt(tableId) : Date.now(),
                    number: document.getElementById('tableNumber').value,
                    capacity: parseInt(document.getElementById('tableCapacity').value),
                    location: document.getElementById('tableLocation').value,
                    status: document.getElementById('tableStatus').value,
                    description: document.getElementById('tableDescription').value,
                    createdAt: new Date().toISOString()
                };
                
                const tables = JSON.parse(localStorage.getItem('cafe_tables') || '[]');
                
                if (tableId) {
                    const tableIndex = tables.findIndex(t => t.id == tableId);
                    if (tableIndex !== -1) {
                        tables[tableIndex] = tableData;
                    }
                } else {
                    tables.push(tableData);
                }
                
                localStorage.setItem('cafe_tables', JSON.stringify(tables));
                
                showToast(tableId ? 'Meja berhasil diperbarui' : 'Meja baru berhasil ditambahkan', 'success');
                closeModal('tableModal');
                loadTablesManagement();
            } catch (error) {
                console.error('Error saving table:', error);
                showToast('Gagal menyimpan meja', 'error');
            }
        });

        // ============================
        // VIEW DETAIL FUNCTIONS
        // ============================
        function viewOrderDetail(orderId) {
            if (!adminSystem) return;
            
            try {
                const order = adminSystem.allOrders.find(o => o.id == orderId) || 
                             adminSystem.orders.find(o => o.id == orderId);
                
                if (!order) {
                    showToast('Pesanan tidak ditemukan', 'error');
                    return;
                }
                
                const content = document.getElementById('orderDetailContent');
                content.innerHTML = `
                    <div style="padding: 1rem 0;">
                        <h3 style="margin-bottom: 1rem;">Detail Pesanan</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                            <div>
                                <strong>No. Order:</strong><br>
                                ${order.orderNumber || 'ORD-' + order.id.toString().slice(-6)}
                            </div>
                            <div>
                                <strong>Tanggal:</strong><br>
                                ${new Date(order.createdAt).toLocaleString('id-ID')}
                            </div>
                            <div>
                                <strong>Pelanggan:</strong><br>
                                ${order.customer?.name || 'Tidak diketahui'}
                            </div>
                            <div>
                                <strong>Telepon:</strong><br>
                                ${order.customer?.phone || 'Tidak diketahui'}
                            </div>
                            <div>
                                <strong>Status:</strong><br>
                                <span class="status-badge status-${order.status}">
                                    ${getStatusText(order.status)}
                                </span>
                            </div>
                            <div>
                                <strong>Total:</strong><br>
                                Rp ${order.total?.toLocaleString() || '0'}
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                            ${order.status === 'pending' || order.status === 'waiting_payment' ? `
                            <button class="btn btn-success" onclick="confirmOrder('${order.id}'); closeModal('orderDetailModal')">
                                <i class="fas fa-check"></i> Konfirmasi Pesanan
                            </button>` : ''}
                            
                            ${order.status === 'confirmed' ? `
                            <button class="btn btn-success" onclick="completeOrder('${order.id}'); closeModal('orderDetailModal')">
                                <i class="fas fa-check-double"></i> Tandai Selesai
                            </button>` : ''}
                        </div>
                    </div>
                `;
                
                openModal('orderDetailModal');
            } catch (error) {
                console.error('Error viewing order detail:', error);
                showToast('Gagal memuat detail pesanan', 'error');
            }
        }

        function viewPaymentProof(orderId) {
            if (!adminSystem) return;
            
            try {
                const order = adminSystem.allOrders.find(o => o.id == orderId);
                if (!order) return;
                
                const content = document.getElementById('paymentProofContent');
                
                if (order.paymentProof) {
                    content.innerHTML = `
                        <div style="padding: 1rem 0;">
                            <h3 style="margin-bottom: 1rem;">Bukti Transfer</h3>
                            <div style="margin-bottom: 1rem;">
                                <strong>No. Order:</strong> ${order.orderNumber || 'ORD-' + order.id.toString().slice(-6)}<br>
                                <strong>Pelanggan:</strong> ${order.customer?.name || 'Tidak diketahui'}<br>
                                <strong>Total:</strong> Rp ${order.total?.toLocaleString() || '0'}<br>
                                <strong>Waktu Transfer:</strong> ${new Date(order.createdAt).toLocaleString('id-ID')}
                            </div>
                            <div style="text-align: center;">
                                <img src="${order.paymentProof}" alt="Bukti Transfer" class="payment-proof-image">
                            </div>
                        </div>
                    `;
                } else {
                    content.innerHTML = `
                        <div class="no-payment-proof">
                            <i class="fas fa-receipt"></i>
                            <h3>Tidak ada bukti transfer</h3>
                            <p>Pelanggan belum mengunggah bukti transfer</p>
                        </div>
                    `;
                }
                
                openModal('paymentProofModal');
            } catch (error) {
                console.error('Error viewing payment proof:', error);
                showToast('Gagal memuat bukti transfer', 'error');
            }
        }

        function viewReservationDetail(reservationId) {
            if (!adminSystem) return;
            
            try {
                const reservation = adminSystem.allReservations.find(r => r.id == reservationId) || 
                                  adminSystem.reservations.find(r => r.id == reservationId);
                if (!reservation) return;
                
                const content = document.getElementById('reservationDetailContent');
                content.innerHTML = `
                    <div style="padding: 1rem 0;">
                        <h3 style="margin-bottom: 1rem;">Detail Reservasi</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                            <div>
                                <strong>No. Reservasi:</strong><br>
                                #${reservation.id.toString().slice(-6)}
                            </div>
                            <div>
                                <strong>Tanggal:</strong><br>
                                ${reservation.date ? new Date(reservation.date).toLocaleDateString('id-ID') : '-'}
                            </div>
                            <div>
                                <strong>Nama:</strong><br>
                                ${reservation.name}
                            </div>
                            <div>
                                <strong>Telepon:</strong><br>
                                ${reservation.phone}
                            </div>
                            <div>
                                <strong>Waktu:</strong><br>
                                ${reservation.time || '-'}
                            </div>
                            <div>
                                <strong>Meja:</strong><br>
                                ${reservation.tableNumber || '-'}
                            </td>
                        </div>
                        
                        ${reservation.notes ? `
                        <div style="margin-bottom: 1rem;">
                            <strong>Catatan:</strong><br>
                            ${reservation.notes}
                        </div>` : ''}
                        
                        <div style="margin-bottom: 1rem;">
                            <strong>Status:</strong><br>
                            <span class="status-badge ${reservation.status === 'confirmed' ? 'status-confirmed' : 'status-pending'}">
                                ${reservation.status === 'confirmed' ? 'Dikonfirmasi' : 'Menunggu'}
                            </span>
                        </div>
                        
                        ${reservation.status === 'pending' ? `
                        <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                            <button class="btn btn-success" onclick="confirmReservation('${reservation.id}'); closeModal('reservationDetailModal')">
                                <i class="fas fa-check"></i> Konfirmasi Reservasi
                            </button>
                        </div>` : ''}
                    </div>
                `;
                
                openModal('reservationDetailModal');
            } catch (error) {
                console.error('Error viewing reservation detail:', error);
                showToast('Gagal memuat detail reservasi', 'error');
            }
        }

        // ============================
        // INITIALIZATION
        // ============================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('ðŸš€ Starting Admin Dashboard...');
            
            try {
                // Initialize admin system
                adminSystem = new AdminSystem();
                await adminSystem.init();
                
                // Add event listeners
                document.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape') {
                        closeModal('orderDetailModal');
                        closeModal('paymentProofModal');
                        closeModal('reservationDetailModal');
                        closeModal('menuModal');
                        closeModal('tableModal');
                    }
                });
                
                document.addEventListener('click', function(e) {
                    if (e.target.classList.contains('modal')) {
                        e.target.style.display = 'none';
                    }
                });
                
                console.log('âœ… Admin Dashboard ready!');
                
            } catch (error) {
                console.error('âŒ Error initializing dashboard:', error);
                showToast('Gagal memuat dashboard admin', 'error');
                
                // Show error message
                document.getElementById('activityTable').innerHTML = `
                    <tr>
                        <td colspan="4" style="text-align: center; padding: 2rem; color: #666;">
                            Gagal memuat data. Silakan refresh halaman.
                        </td>
                    </tr>
                `;
            }
        });
    </script>
</body>
</html>